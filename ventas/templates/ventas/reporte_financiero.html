{% extends "base.html" %}
{% load humanize %}

{% block title %}Reporte Financiero{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0 text-info"><i class="fas fa-chart-line"></i> Reporte Financiero Consolidado</h1>
        <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Volver al Dashboard
        </a>
    </div>
    
    <div class="card p-4 shadow-lg mb-5 border-info">
        <h2 class="card-title text-center mb-4 text-info">Resumen Total de la Agencia</h2>
        <hr>
        
        <div class="row text-center g-4">
            <div class="col-md-4">
                <div class="p-3 border rounded bg-primary text-white h-100 d-flex flex-column justify-content-center">
                    <p class="mb-1 h6"><i class="fas fa-handshake"></i> Ingreso Bruto Total</p>
                    <h3 class="fw-bold">${{ total_ventas|default:"0.00"|floatformat:2|intcomma }} MXN</h3>
                    <p class="small mb-0">Suma de todos los costos finales de venta.</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 border rounded bg-success text-white h-100 d-flex flex-column justify-content-center">
                    <p class="mb-1 h6"><i class="fas fa-wallet"></i> Total Pagos Recibidos</p>
                    <h3 class="fw-bold">${{ total_pagado|default:"0.00"|floatformat:2|intcomma }} MXN</h3>
                    <p class="small mb-0">Dinero que ha entrado a la agencia (Abonos).</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 border rounded bg-danger text-white h-100 d-flex flex-column justify-content-center">
                    <p class="mb-1 h6"><i class="fas fa-exclamation-triangle"></i> SALDO PENDIENTE (CxC)</p>
                    <h3 class="fw-bold">${{ saldo_pendiente|default:"0.00"|floatformat:2|intcomma }} MXN</h3>
                    <p class="small mb-0">Total que los clientes a칰n deben a la agencia.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card p-4 shadow-sm border-secondary">
        <h2 class="card-title text-secondary"><i class="fas fa-clipboard-check"></i> Verificaci칩n de Consistencia</h2>
        <p class="text-muted">
            Esta secci칩n asegura que el saldo registrado en el sistema es matem치ticamente consistente con los pagos y las ventas.
        </p>

        <table class="table table-sm table-hover mt-3 align-middle">
            <thead class="table-dark">
                <tr>
                    <th>C치lculo</th>
                    <th class="text-end">Monto</th>
                    <th style="width: 120px;" class="text-center">Resultado</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><i class="fas fa-money-check-alt"></i> Pagos Reales (Suma de Abonos)</td>
                    <td class="text-end fw-bold">${{ consistencia.real|default:"0.00"|floatformat:2|intcomma }}</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td><i class="fas fa-equals"></i> Pagos Esperados (Total Venta - Saldo Pendiente)</td>
                    <td class="text-end fw-bold">${{ consistencia.esperado|default:"0.00"|floatformat:2|intcomma }}</td>
                    <td>-</td>
                </tr>
                <tr class="{% if not consistencia.es_consistente %}table-danger{% else %}table-success{% endif %}">
                    <td class="fw-bold">Estado de Consistencia</td>
                    <td class="text-end fw-bold">
                        Diferencia: 
                        {% if consistencia.diferencia > 0 %}<span class="text-success">+</span>{% endif %}
                        {% if consistencia.diferencia < 0 %}<span class="text-danger">-</span>{% endif %}
                        ${{ consistencia.diferencia|default:"0.00"|floatformat:2|intcomma|cut:"-" }}
                    </td>
                    <td class="text-center">
                        {% if consistencia.es_consistente %}
                            <span class="badge bg-success">游녨 OK</span>
                        {% else %}
                            <span class="badge bg-danger">丘멆잺 ERROR</span>
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>
        
        {% if not consistencia.es_consistente %}
            <div class="alert alert-danger mt-3">
                <i class="fas fa-bug"></i> Alerta: 춰Se detect칩 una inconsistencia financiera! La diferencia es de 
                <span class="fw-bold">${{ consistencia.diferencia|floatformat:2|intcomma }}</span>. Por favor, revise el c치lculo y los abonos de las ventas.
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" 
          integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMD/cd2jBDEXk4B7Hw22Z5+gD5b7t9R1B1xR1wM8t7j07JtMv0jXw4W5r3v5sXw==" 
          crossorigin="anonymous" referrerpolicy="no-referrer" />
{% endblock %}