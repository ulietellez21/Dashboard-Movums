{% extends "base.html" %}
{% load humanize %}

{% block title %}Reporte de Comisiones{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="text-primary">
        <i class="fas fa-hand-holding-usd"></i> {{ titulo_reporte }} 
    </h1>
    {% if user_rol == 'JEFE' %}
        <span class="badge bg-warning text-dark p-2 shadow">Vista de Gesti贸n (JEFE)</span>
    {% endif %}
</div>

{% if user_rol == 'JEFE' %}
<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <div>
            <h2 class="h5 mb-0">Equipo de Ejecutivos</h2>
            <small class="text-muted">Administra los ejecutivos autorizados para vender.</small>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#ejecutivoModal" data-mode="create">
            <i class="fas fa-user-plus me-2"></i>Agregar Nuevo Ejecutivo
        </button>
    </div>
    <div class="card-body">
        {% if ejecutivos %}
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Nombre</th>
                            <th>Tel茅fono</th>
                            <th>Ubicaci贸n Asignada</th>
                            <th>Sueldo Base</th>
                            <th>Usuario</th>
                            <th>Contrase帽a</th>
                            <th>Correo</th>
                            <th>Documento</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ejecutivo in ejecutivos %}
                        <tr>
                            <td>
                                <strong>{{ ejecutivo.nombre_completo }}</strong><br>
                                <small class="text-muted">{{ ejecutivo.direccion|linebreaksbr }}</small>
                            </td>
                            <td>{{ ejecutivo.telefono }}</td>
                            <td>{{ ejecutivo.ubicacion_asignada }}</td>
                            <td>${{ ejecutivo.sueldo_base|floatformat:2|intcomma }}</td>
                            <td>
                                {% if ejecutivo.usuario %}
                                    <span class="badge bg-light text-dark">{{ ejecutivo.usuario.username }}</span>
                                {% else %}
                                    <span class="text-muted">Pendiente</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if ejecutivo.ultima_contrasena %}
                                    <span class="badge bg-success text-white">{{ ejecutivo.ultima_contrasena }}</span>
                                {% else %}
                                    <span class="text-muted">No disponible</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if ejecutivo.email %}
                                    <a href="mailto:{{ ejecutivo.email }}">{{ ejecutivo.email }}</a>
                                {% else %}
                                    <span class="text-muted">No registrado</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if ejecutivo.documento_pdf %}
                                    <a href="{{ ejecutivo.documento_pdf.url }}" target="_blank" class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-file-pdf"></i> Ver PDF
                                    </a>
                                {% else %}
                                    <span class="badge bg-light text-muted">Sin documento</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <button
                                    type="button"
                                    class="btn btn-outline-secondary btn-sm me-2"
                                    data-bs-toggle="modal"
                                    data-bs-target="#ejecutivoModal"
                                    data-mode="edit"
                                    data-id="{{ ejecutivo.id }}"
                                    data-nombre="{{ ejecutivo.nombre_completo|escape }}"
                                    data-direccion="{{ ejecutivo.direccion|escape }}"
                                    data-telefono="{{ ejecutivo.telefono|escape }}"
                                    data-email="{{ ejecutivo.email|default_if_none:''|escape }}"
                                    data-sueldo="{{ ejecutivo.sueldo_base }}"
                                    data-ubicacion="{{ ejecutivo.ubicacion_asignada|escape }}"
                                    data-documento-url="{% if ejecutivo.documento_pdf %}{{ ejecutivo.documento_pdf.url }}{% endif %}"
                                >
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <form method="post" action="{% url 'reporte_comisiones' %}" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="ejecutivo_action" value="eliminar">
                                    <input type="hidden" name="ejecutivo_id" value="{{ ejecutivo.id }}">
                                    <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('驴Eliminar al ejecutivo {{ ejecutivo.nombre_completo }}?');">
                                        <i class="fas fa-user-minus"></i> Eliminar
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-light border">
                <i class="fas fa-users-slash"></i> A煤n no hay ejecutivos registrados.
            </div>
        {% endif %}
    </div>
</div>

<!-- Modal para crear/editar ejecutivos -->
<div class="modal fade" id="ejecutivoModal" tabindex="-1" aria-labelledby="ejecutivoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ejecutivoModalLabel">Agregar Nuevo Ejecutivo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form method="post" action="{% url 'reporte_comisiones' %}" enctype="multipart/form-data">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" name="ejecutivo_action" id="ejecutivoAction" value="crear">
                    <input type="hidden" name="ejecutivo_id" id="ejecutivoId">
                    {% if ejecutivo_form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ ejecutivo_form.non_field_errors }}
                        </div>
                    {% endif %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Nombre Completo</label>
                            {{ ejecutivo_form.nombre_completo }}
                            {{ ejecutivo_form.nombre_completo.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Tel茅fono</label>
                            {{ ejecutivo_form.telefono }}
                            {{ ejecutivo_form.telefono.errors }}
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-semibold">Direcci贸n</label>
                            {{ ejecutivo_form.direccion }}
                            {{ ejecutivo_form.direccion.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Correo Electr贸nico</label>
                            {{ ejecutivo_form.email }}
                            {{ ejecutivo_form.email.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Ubicaci贸n Asignada</label>
                            {{ ejecutivo_form.ubicacion_asignada }}
                            {{ ejecutivo_form.ubicacion_asignada.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Sueldo Base</label>
                            {{ ejecutivo_form.sueldo_base }}
                            {{ ejecutivo_form.sueldo_base.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Documentos Personales (PDF)</label>
                            {{ ejecutivo_form.documento_pdf }}
                            <div class="form-text">{{ ejecutivo_form.documento_pdf.help_text }}</div>
                            {{ ejecutivo_form.documento_pdf.errors }}
                        </div>
                    </div>
                    <div class="mt-3 d-none" id="documentoActualContainer">
                        <div class="alert alert-secondary mb-0">
                            Documento cargado: <a href="#" target="_blank" id="documentoActualLink">Ver PDF</a>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="submitEjecutivoBtn">
                        Guardar Ejecutivo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<div class="row mb-5">
    <div class="col-lg-12">
        <div class="alert alert-info shadow-sm" role="alert">
            <h5 class="alert-heading"><i class="fas fa-info-circle"></i> Nota sobre el C谩lculo</h5>
            <p class="mb-0">
                Este reporte estima las comisiones basadas en las **ventas que han sido pagadas al 100%**. 
                El sueldo base y el porcentaje de comisi贸n son valores fijos definidos en el sistema.
            </p>
        </div>
    </div>
</div>

{% if lista_comisiones %}
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle shadow-lg rounded-3 overflow-hidden">
            <thead class="table-dark">
                <tr>
                    <th>Vendedor</th>
                    <th class="text-end">Sueldo Base</th>
                    <th class="text-end">Total de Ventas Pagadas (Base de Comisi贸n)</th>
                    <th class="text-end">Comisi贸n (%)</th>
                    <th class="text-end">Comisi贸n Ganada</th>
                    <th class="text-end bg-success text-white">Ingreso Total Estimado (Base + Comisi贸n)</th>
                </tr>
            </thead>
            <tbody>
                {% for data in lista_comisiones %}
                <tr {% if data.es_usuario_actual %}class="table-primary fw-bold"{% endif %}>
                    <td>
                        <i class="fas fa-user-tag"></i> {{ data.vendedor.first_name }} {{ data.vendedor.last_name }} ({{ data.vendedor.username }})
                    </td>
                    <td class="text-end">${{ data.sueldo_base|floatformat:2|intcomma }}</td>
                    <td class="text-end text-primary">${{ data.total_ventas_pagadas|floatformat:2|intcomma }}</td>
                    <td class="text-end">{{ data.comision_porcentaje|floatformat:2 }}%</td>
                    <td class="text-end text-success">${{ data.comision_ganada|floatformat:2|intcomma }}</td>
                    <td class="text-end bg-success-light text-success fw-bold">${{ data.ingreso_total_estimado|floatformat:2|intcomma }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <div class="alert alert-warning">
        <i class="fas fa-search"></i> No se encontraron datos de comisiones para tu rol.
    </div>
{% endif %}

{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" 
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        .bg-success-light {
            background-color: #d1e7dd !important; /* Un verde muy suave para destacar el total */
        }
        .text-success {
            color: #157347 !important;
        }
    </style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var modalEl = document.getElementById('ejecutivoModal');
        if (!modalEl) { return; }
        var modal = new bootstrap.Modal(modalEl);
        var actionInput = document.getElementById('ejecutivoAction');
        var idInput = document.getElementById('ejecutivoId');
        var titleEl = document.getElementById('ejecutivoModalLabel');
        var submitBtn = document.getElementById('submitEjecutivoBtn');
        var nombreInput = modalEl.querySelector('[name="nombre_completo"]');
        var direccionInput = modalEl.querySelector('[name="direccion"]');
        var telefonoInput = modalEl.querySelector('[name="telefono"]');
        var emailInput = modalEl.querySelector('[name="email"]');
        var ubicacionInput = modalEl.querySelector('[name="ubicacion_asignada"]');
        var sueldoInput = modalEl.querySelector('[name="sueldo_base"]');
        var documentoInfo = document.getElementById('documentoActualContainer');
        var documentoLink = document.getElementById('documentoActualLink');

        modalEl.addEventListener('show.bs.modal', function(event) {
            var button = event.relatedTarget;
            if (!button || button.getAttribute('data-mode') === 'create') {
                actionInput.value = 'crear';
                idInput.value = '';
                titleEl.textContent = 'Agregar Nuevo Ejecutivo';
                submitBtn.textContent = 'Guardar Ejecutivo';
                nombreInput.value = '';
                direccionInput.value = '';
                telefonoInput.value = '';
                emailInput.value = '';
                ubicacionInput.value = '';
                sueldoInput.value = '';
                if (documentoInfo) {
                    documentoInfo.classList.add('d-none');
                }
                modalEl.querySelector('[name="documento_pdf"]').value = '';
                return;
            }

            actionInput.value = 'editar';
            idInput.value = button.getAttribute('data-id');
            titleEl.textContent = 'Editar Ejecutivo';
            submitBtn.textContent = 'Actualizar Ejecutivo';
            nombreInput.value = button.getAttribute('data-nombre') || '';
            direccionInput.value = button.getAttribute('data-direccion') || '';
            telefonoInput.value = button.getAttribute('data-telefono') || '';
            emailInput.value = button.getAttribute('data-email') || '';
            ubicacionInput.value = button.getAttribute('data-ubicacion') || '';
            sueldoInput.value = button.getAttribute('data-sueldo') || '';
            var documentoUrl = button.getAttribute('data-documento-url');
            if (documentoUrl) {
                documentoInfo.classList.remove('d-none');
                documentoLink.href = documentoUrl;
            } else {
                documentoInfo.classList.add('d-none');
            }
            modalEl.querySelector('[name="documento_pdf"]').value = '';
        });

        {% if mostrar_modal_ejecutivo %}
            modal.show();
        {% endif %}
    });
</script>
{% endblock %}
