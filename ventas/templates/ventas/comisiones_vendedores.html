{% extends "base.html" %}
{% load humanize %}

{% block title %}Reporte de Comisiones{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="text-primary">
        <i class="fas fa-hand-holding-usd"></i> {{ titulo_reporte }} üí∞
    </h1>
    {% if user_rol == 'JEFE' %}
        <span class="badge bg-warning text-dark p-2 shadow">Vista de Gesti√≥n (JEFE)</span>
    {% endif %}
</div>

{# Filtros por mes y a√±o #}
<div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
        <form method="get" action="{% url 'reporte_comisiones' %}" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="mes" class="form-label fw-bold">Mes</label>
                <select name="mes" id="mes" class="form-select">
                    <option value="1" {% if mes_filtro == 1 %}selected{% endif %}>Enero</option>
                    <option value="2" {% if mes_filtro == 2 %}selected{% endif %}>Febrero</option>
                    <option value="3" {% if mes_filtro == 3 %}selected{% endif %}>Marzo</option>
                    <option value="4" {% if mes_filtro == 4 %}selected{% endif %}>Abril</option>
                    <option value="5" {% if mes_filtro == 5 %}selected{% endif %}>Mayo</option>
                    <option value="6" {% if mes_filtro == 6 %}selected{% endif %}>Junio</option>
                    <option value="7" {% if mes_filtro == 7 %}selected{% endif %}>Julio</option>
                    <option value="8" {% if mes_filtro == 8 %}selected{% endif %}>Agosto</option>
                    <option value="9" {% if mes_filtro == 9 %}selected{% endif %}>Septiembre</option>
                    <option value="10" {% if mes_filtro == 10 %}selected{% endif %}>Octubre</option>
                    <option value="11" {% if mes_filtro == 11 %}selected{% endif %}>Noviembre</option>
                    <option value="12" {% if mes_filtro == 12 %}selected{% endif %}>Diciembre</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="anio" class="form-label fw-bold">A√±o</label>
                <input type="number" name="anio" id="anio" class="form-control" value="{{ anio_filtro }}" min="2020" max="2100" required>
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-filter me-2"></i>Filtrar
                </button>
            </div>
        </form>
        <div class="mt-2">
            <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Mostrando comisiones para: <strong>{{ fecha_desde|date:"F Y" }}</strong>
            </small>
        </div>
    </div>
</div>

{% if user_rol == 'JEFE' %}
<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <div>
            <h2 class="h5 mb-0">Equipo de Ejecutivos</h2>
            <small class="text-muted">Administra los ejecutivos autorizados para vender.</small>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#ejecutivoModal" data-mode="create">
            <i class="fas fa-user-plus me-2"></i>Agregar Nuevo Ejecutivo
        </button>
    </div>
    <div class="card-body">
        {% if ejecutivos %}
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Nombre</th>
                            <th>Tel√©fono</th>
                            <th>Tipo de Vendedor</th>
                            <th>Ubicaci√≥n Asignada</th>
                            <th>Sueldo Base</th>
                            <th>Usuario</th>
                            <th>Contrase√±a</th>
                            <th>Correo</th>
                            <th>Documento</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ejecutivo in ejecutivos %}
                        <tr>
                            <td>
                                <strong>{{ ejecutivo.nombre_completo }}</strong><br>
                                <small class="text-muted">{{ ejecutivo.direccion|linebreaksbr }}</small>
                            </td>
                            <td>{{ ejecutivo.telefono }}</td>
                            <td>
                                {% with ejecutivo.usuario.perfil.rol|default:""|upper as rol_ej %}
                                    {% if rol_ej == 'CONTADOR' %}
                                        <span class="badge bg-secondary text-white">Contador</span>
                                    {% elif ejecutivo.tipo_vendedor == 'OFICINA' %}
                                        <span class="badge bg-info text-white">Ventas Internas</span>
                                    {% elif ejecutivo.tipo_vendedor == 'CALLE' %}
                                        <span class="badge bg-warning text-dark">Ventas de Campo</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ ejecutivo.get_tipo_vendedor_display }}</span>
                                    {% endif %}
                                {% endwith %}
                            </td>
                            <td>{{ ejecutivo.ubicacion_asignada }}</td>
                            <td>${{ ejecutivo.sueldo_base|floatformat:2|intcomma }}</td>
                            <td>
                                {% if ejecutivo.usuario %}
                                    <span class="badge bg-light text-dark">{{ ejecutivo.usuario.username }}</span>
                                {% else %}
                                    <span class="text-muted">Pendiente</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if ejecutivo.ultima_contrasena %}
                                    <span class="badge bg-success text-white">{{ ejecutivo.ultima_contrasena }}</span>
                                {% else %}
                                    <span class="text-muted">No disponible</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if ejecutivo.email %}
                                    <a href="mailto:{{ ejecutivo.email }}">{{ ejecutivo.email }}</a>
                                {% else %}
                                    <span class="text-muted">No registrado</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if ejecutivo.documento_pdf %}
                                    <a href="{{ ejecutivo.documento_pdf.url }}" target="_blank" class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-file-pdf"></i> Ver PDF
                                    </a>
                                {% else %}
                                    <span class="badge bg-light text-muted">Sin documento</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <button
                                    type="button"
                                    class="btn btn-outline-secondary btn-sm me-2"
                                    data-bs-toggle="modal"
                                    data-bs-target="#ejecutivoModal"
                                    data-mode="edit"
                                    data-id="{{ ejecutivo.id }}"
                                    data-nombre="{{ ejecutivo.nombre_completo|escape }}"
                                    data-direccion="{{ ejecutivo.direccion|escape }}"
                                    data-telefono="{{ ejecutivo.telefono|escape }}"
                                    data-email="{{ ejecutivo.email|default_if_none:''|escape }}"
                                    data-sueldo="{{ ejecutivo.sueldo_base }}"
                                    data-tipo-vendedor="{{ ejecutivo.tipo_vendedor }}"
                                    data-ubicacion="{{ ejecutivo.ubicacion_asignada|escape }}"
                                    data-documento-url="{% if ejecutivo.documento_pdf %}{{ ejecutivo.documento_pdf.url }}{% endif %}"
                                >
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <form method="post" action="{% url 'reporte_comisiones' %}" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="ejecutivo_action" value="eliminar">
                                    <input type="hidden" name="ejecutivo_id" value="{{ ejecutivo.id }}">
                                    <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('¬øEliminar al ejecutivo {{ ejecutivo.nombre_completo }}?');">
                                        <i class="fas fa-user-minus"></i> Eliminar
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-light border">
                <i class="fas fa-users-slash"></i> A√∫n no hay ejecutivos registrados.
            </div>
        {% endif %}
    </div>
</div>

<!-- Variable para controlar si se debe mostrar el modal autom√°ticamente -->
<div id="modal-config" data-mostrar-modal="{% if mostrar_modal_ejecutivo %}true{% else %}false{% endif %}" style="display: none;"></div>

<!-- Modal para crear/editar ejecutivos -->
<div class="modal fade" id="ejecutivoModal" tabindex="-1" aria-labelledby="ejecutivoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ejecutivoModalLabel">Agregar Nuevo Ejecutivo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form method="post" action="{% url 'reporte_comisiones' %}" enctype="multipart/form-data">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" name="ejecutivo_action" id="ejecutivoAction" value="crear">
                    <input type="hidden" name="ejecutivo_id" id="ejecutivoId">
                    {% if ejecutivo_form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ ejecutivo_form.non_field_errors }}
                        </div>
                    {% endif %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Nombre Completo</label>
                            {{ ejecutivo_form.nombre_completo }}
                            {{ ejecutivo_form.nombre_completo.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Tel√©fono</label>
                            {{ ejecutivo_form.telefono }}
                            {{ ejecutivo_form.telefono.errors }}
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-semibold">Direcci√≥n</label>
                            {{ ejecutivo_form.direccion }}
                            {{ ejecutivo_form.direccion.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Correo Electr√≥nico</label>
                            {{ ejecutivo_form.email }}
                            {{ ejecutivo_form.email.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Tipo de Usuario</label>
                            {{ ejecutivo_form.tipo_usuario }}
                            <div class="form-text">{{ ejecutivo_form.tipo_usuario.help_text }}</div>
                            {{ ejecutivo_form.tipo_usuario.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Ubicaci√≥n Asignada</label>
                            {{ ejecutivo_form.ubicacion_asignada }}
                            {{ ejecutivo_form.ubicacion_asignada.errors }}
                        </div>
                        <div class="col-md-6" id="tipoVendedorContainer">
                            <label class="form-label fw-semibold" id="tipoVendedorLabel">Tipo de Vendedor</label>
                            {{ ejecutivo_form.tipo_vendedor }}
                            <div class="form-text">Determina el sistema de comisiones aplicable</div>
                            {{ ejecutivo_form.tipo_vendedor.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Sueldo Base</label>
                            {{ ejecutivo_form.sueldo_base }}
                            {{ ejecutivo_form.sueldo_base.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Documentos Personales (PDF)</label>
                            {{ ejecutivo_form.documento_pdf }}
                            <div class="form-text">{{ ejecutivo_form.documento_pdf.help_text }}</div>
                            {{ ejecutivo_form.documento_pdf.errors }}
                        </div>
                    </div>
                    <div class="mt-3 d-none" id="documentoActualContainer">
                        <div class="alert alert-secondary mb-0">
                            Documento cargado: <a href="#" target="_blank" id="documentoActualLink">Ver PDF</a>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="submitEjecutivoBtn">
                        Guardar Ejecutivo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% if lista_comisiones %}
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle shadow-lg rounded-3 overflow-hidden">
            <thead class="table-dark">
                <tr>
                    <th>Vendedor</th>
                    <th>Tipo</th>
                    <th class="text-end">Sueldo Base</th>
                    <th class="text-end">Total de Ventas Pagadas (Base de Comisi√≥n)</th>
                    <th class="text-end">Comisi√≥n (%)</th>
                    <th class="text-end">Comisi√≥n Ganada</th>
                    <th class="text-end bg-success text-white">Ingreso Total Estimado (Base + Comisi√≥n)</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for data in lista_comisiones %}
                <tr {% if data.es_usuario_actual %}class="table-primary fw-bold"{% endif %}>
                    <td>
                        <i class="fas fa-user-tag"></i> {{ data.vendedor.first_name }} {{ data.vendedor.last_name }} ({{ data.vendedor.username }})
                    </td>
                    <td>
                        {% with data.vendedor.perfil.rol|default:""|upper as rol_vendedor %}
                            {% if rol_vendedor == 'CONTADOR' %}
                                <span class="badge bg-secondary text-white">Contador</span>
                            {% elif data.tipo_vendedor == 'OFICINA' %}
                                <span class="badge bg-info text-white">Internas</span>
                            {% elif data.tipo_vendedor == 'CALLE' %}
                                <span class="badge bg-warning text-dark">Campo</span>
                            {% else %}
                                <span class="badge bg-secondary">N/A</span>
                            {% endif %}
                        {% endwith %}
                    </td>
                    <td class="text-end">${{ data.sueldo_base|floatformat:2|intcomma }}</td>
                    <td class="text-end text-primary">${{ data.total_ventas_pagadas|floatformat:2|intcomma }}</td>
                    <td class="text-end">{{ data.comision_porcentaje|floatformat:2 }}%</td>
                    <td class="text-end text-success">${{ data.comision_ganada|floatformat:2|intcomma }}</td>
                    <td class="text-end bg-success-light text-success fw-bold">${{ data.ingreso_total_estimado|floatformat:2|intcomma }}</td>
                    <td class="text-center">
                        <div class="btn-group" role="group">
                            <a href="{% url 'detalle_comisiones' data.vendedor.pk %}?mes={{ mes_filtro }}&anio={{ anio_filtro }}" 
                               class="btn btn-sm btn-info" 
                               title="Ver detalle">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{% url 'exportar_comisiones_excel' data.vendedor.pk %}?mes={{ mes_filtro }}&anio={{ anio_filtro }}" 
                               class="btn btn-sm btn-success" 
                               title="Exportar a Excel">
                                <i class="fas fa-file-excel"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <div class="alert alert-warning">
        <i class="fas fa-search"></i> No se encontraron datos de comisiones para tu rol.
    </div>
{% endif %}

{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" 
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        .bg-success-light {
            background-color: #d1e7dd !important; /* Un verde muy suave para destacar el total */
        }
        .text-success {
            color: #157347 !important;
        }
        
        /* FORZAR que el modal sea visible cuando tiene la clase show */
        #ejecutivoModal.show,
        #ejecutivoModal.show.show {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 1055 !important;
            pointer-events: auto !important;
        }
        
        /* Asegurar que el modal-dialog y modal-content sean interactivos */
        #ejecutivoModal.show .modal-dialog,
        #ejecutivoModal.show .modal-content {
            pointer-events: auto !important;
        }
        
        /* Asegurar que el overlay nunca bloquee el modal */
        body.modal-open #pageTransitionOverlay,
        #ejecutivoModal.show ~ #pageTransitionOverlay,
        #ejecutivoModal.show + #pageTransitionOverlay {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
            z-index: -1 !important;
        }
    </style>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    'use strict';
    
    // DEBUGGING EXTENSIVO
    console.log('[MODAL DEBUG] Iniciando script de modal ejecutivo');
    console.log('[MODAL DEBUG] Bootstrap disponible:', typeof bootstrap !== 'undefined');
    console.log('[MODAL DEBUG] Bootstrap.Modal disponible:', typeof bootstrap !== 'undefined' && typeof bootstrap.Modal !== 'undefined');
    
    // Funci√≥n global para manejar la visibilidad del campo "Tipo de Vendedor" seg√∫n "Tipo de Usuario"
    function toggleTipoVendedorVisibility() {
        // Buscar elementos dentro del modal (puede estar en el body despu√©s de moverlo)
        var tipoUsuarioInput = document.querySelector('#ejecutivoModal [name="tipo_usuario"]');
        var tipoVendedorInput = document.querySelector('#ejecutivoModal [name="tipo_vendedor"]');
        var tipoVendedorContainer = document.querySelector('#ejecutivoModal #tipoVendedorContainer');
        var tipoVendedorLabel = document.querySelector('#ejecutivoModal #tipoVendedorLabel');
        
        console.log('[TIPO VENDEDOR DEBUG] Buscando elementos:', {
            tipoUsuarioInput: !!tipoUsuarioInput,
            tipoVendedorInput: !!tipoVendedorInput,
            tipoVendedorContainer: !!tipoVendedorContainer,
            tipoVendedorLabel: !!tipoVendedorLabel
        });
        
        if (!tipoUsuarioInput || !tipoVendedorInput || !tipoVendedorContainer) {
            console.warn('[TIPO VENDEDOR DEBUG] No se encontraron todos los elementos necesarios');
            return;
        }
        
        var tipoUsuario = tipoUsuarioInput.value;
        console.log('[TIPO VENDEDOR DEBUG] Tipo de usuario seleccionado:', tipoUsuario);
        
        if (tipoUsuario === 'CONTADOR') {
            // Ocultar y deshabilitar el campo "Tipo de Vendedor" para contadores
            tipoVendedorContainer.style.opacity = '0.5';
            tipoVendedorContainer.style.pointerEvents = 'none';
            tipoVendedorInput.disabled = true;
            tipoVendedorInput.required = false;
            // Limpiar el valor si estaba seleccionado
            tipoVendedorInput.value = '';
            if (tipoVendedorLabel) {
                tipoVendedorLabel.style.opacity = '0.5';
            }
            console.log('[TIPO VENDEDOR DEBUG] Tipo de Vendedor deshabilitado (usuario es Contador)');
        } else {
            // Mostrar y habilitar el campo "Tipo de Vendedor" para vendedores
            tipoVendedorContainer.style.opacity = '1';
            tipoVendedorContainer.style.pointerEvents = 'auto';
            tipoVendedorInput.disabled = false;
            if (tipoVendedorLabel) {
                tipoVendedorLabel.style.opacity = '1';
            }
            console.log('[TIPO VENDEDOR DEBUG] Tipo de Vendedor habilitado (usuario es Vendedor)');
        }
    }
    
    function initModalEjecutivo() {
        console.log('[MODAL DEBUG] initModalEjecutivo ejecutado');
        
        var modalEl = document.getElementById('ejecutivoModal');
        console.log('[MODAL DEBUG] Modal encontrado:', !!modalEl);
        if (!modalEl) {
            console.error('[MODAL DEBUG] ERROR: Modal #ejecutivoModal no encontrado en el DOM');
            return;
        }
        
        // SOLUCI√ìN: Mover el modal fuera del #main-content al body para evitar problemas de stacking context
        if (modalEl.parentElement && modalEl.parentElement.id === 'main-content') {
            document.body.appendChild(modalEl);
            console.log('[MODAL DEBUG] Modal movido al body para evitar stacking context');
        }
        
        // Verificar que Bootstrap est√© cargado
        if (typeof bootstrap === 'undefined') {
            console.error('[MODAL DEBUG] ERROR: Bootstrap no est√° cargado');
            alert('Error: Bootstrap no est√° disponible. Recarga la p√°gina.');
            return;
        }
        
        // Variables del formulario
        var actionInput = document.getElementById('ejecutivoAction');
        var idInput = document.getElementById('ejecutivoId');
        var titleEl = document.getElementById('ejecutivoModalLabel');
        var submitBtn = document.getElementById('submitEjecutivoBtn');
        var documentoInfo = document.getElementById('documentoActualContainer');
        var documentoLink = document.getElementById('documentoActualLink');
        
        // Usar delegaci√≥n de eventos para manejar cambios en "Tipo de Usuario"
        // Esto funciona incluso si el modal se mueve o se recrea
        modalEl.addEventListener('change', function(e) {
            if (e.target && e.target.name === 'tipo_usuario') {
                console.log('[TIPO VENDEDOR DEBUG] Cambio detectado en tipo_usuario');
                toggleTipoVendedorVisibility();
            }
        });
        
        // Agregar listener cuando el modal se muestra para aplicar el estado inicial
        modalEl.addEventListener('shown.bs.modal', function() {
            console.log('[TIPO VENDEDOR DEBUG] Modal mostrado, aplicando estado inicial');
            setTimeout(toggleTipoVendedorVisibility, 150);
        });
        
        console.log('[MODAL DEBUG] Elementos del formulario encontrados:', {
            actionInput: !!actionInput,
            idInput: !!idInput,
            titleEl: !!titleEl,
            submitBtn: !!submitBtn
        });
        
        // Asegurar que el overlay est√© oculto
        var overlay = document.getElementById('pageTransitionOverlay');
        if (overlay) {
            overlay.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; z-index: -1 !important;';
            overlay.classList.remove('active');
            console.log('[MODAL DEBUG] Overlay ocultado');
        }
        
        // Encontrar todos los botones que abren el modal
        var modalButtons = document.querySelectorAll('[data-bs-toggle="modal"][data-bs-target="#ejecutivoModal"]');
        console.log('[MODAL DEBUG] Botones encontrados:', modalButtons.length);
        
        // Agregar listener directo a cada bot√≥n para debugging
        modalButtons.forEach(function(button, index) {
            console.log('[MODAL DEBUG] Configurando bot√≥n', index, button);
            
            // Listener en mousedown para debugging
            button.addEventListener('mousedown', function(e) {
                console.log('[MODAL DEBUG] mousedown en bot√≥n', index);
                var overlay = document.getElementById('pageTransitionOverlay');
                if (overlay) {
                    overlay.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; z-index: -9999 !important;';
                    overlay.classList.remove('active');
                }
            }, true);
            
            // NO interceptar el click - dejar que Bootstrap maneje todo normalmente
        });
        
        // NO interceptar clicks - dejar que Bootstrap maneje todo
        // Solo asegurar que el overlay est√© oculto cuando se hace click
        modalButtons.forEach(function(button, index) {
            button.addEventListener('mousedown', function(e) {
                // Ocultar overlay ANTES del click (mousedown se ejecuta antes)
                var overlay = document.getElementById('pageTransitionOverlay');
                if (overlay) {
                    overlay.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; z-index: -9999 !important;';
                    overlay.classList.remove('active');
                }
                window._modalIsOpening = true;
            }, true);
        });
        
        // Usar el evento show.bs.modal de Bootstrap para llenar el formulario
        modalEl.addEventListener('show.bs.modal', function(event) {
            // SOLUCI√ìN RADICAL: Remover el overlay del DOM completamente cuando se abre el modal
            var overlay = document.getElementById('pageTransitionOverlay');
            if (overlay) {
                overlay.remove(); // Remover completamente del DOM
                console.log('[MODAL DEBUG] Overlay removido del DOM en show.bs.modal');
            }
            
            try {
                
                // Tambi√©n verificar despu√©s de un delay
                setTimeout(function() {
                    try {
                        console.log('[MODAL DEBUG] Verificando estado del modal despu√©s de show.bs.modal');
                        console.log('[MODAL DEBUG] Modal classes:', modalEl.className);
                        console.log('[MODAL DEBUG] Modal display:', window.getComputedStyle(modalEl).display);
                        console.log('[MODAL DEBUG] Modal visibility:', window.getComputedStyle(modalEl).visibility);
                        console.log('[MODAL DEBUG] Modal z-index:', window.getComputedStyle(modalEl).zIndex);
                        console.log('[MODAL DEBUG] Body tiene modal-open:', document.body.classList.contains('modal-open'));
                        
                        // Verificar backdrop
                        var backdrop = document.querySelector('.modal-backdrop');
                        console.log('[MODAL DEBUG] Backdrop encontrado:', !!backdrop);
                        if (backdrop) {
                            console.log('[MODAL DEBUG] Backdrop z-index:', window.getComputedStyle(backdrop).zIndex);
                        }
                        
                    // Forzar visibilidad del modal con setAttribute para aplicar !important correctamente
                    var currentStyle = modalEl.getAttribute('style') || '';
                    modalEl.setAttribute('style', currentStyle + ' display: block !important; visibility: visible !important; opacity: 1 !important; z-index: 1055 !important; pointer-events: auto !important;');
                    modalEl.classList.add('show');
                    modalEl.setAttribute('aria-hidden', 'false');
                    modalEl.setAttribute('aria-modal', 'true');
                    
                    // Asegurar que el overlay est√© oculto con z-index muy bajo
                    if (overlay) {
                        overlay.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; z-index: -9999 !important;';
                        overlay.classList.remove('active');
                    }
                    
                    // CR√çTICO: Asegurar que el modal-dialog est√© por encima del backdrop
                    var modalDialog = modalEl.querySelector('.modal-dialog');
                    var modalContent = modalEl.querySelector('.modal-content');
                    if (modalDialog) {
                        modalDialog.style.cssText += ' z-index: 1056 !important; position: relative !important; pointer-events: auto !important;';
                    }
                    if (modalContent) {
                        modalContent.style.cssText += ' pointer-events: auto !important; position: relative !important;';
                    }
                    
                    // El backdrop debe estar debajo pero permitir clicks para cerrar
                    var backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.style.cssText += ' z-index: 1050 !important; pointer-events: auto !important;';
                    }
                    
                    console.log('[MODAL DEBUG] Modal verificado y forzado a visible');
                    console.log('[MODAL DEBUG] Modal display despu√©s de forzar:', window.getComputedStyle(modalEl).display);
                    } catch (err) {
                        console.error('[MODAL DEBUG] Error en setTimeout:', err);
                    }
                }, 50);
                
                // Obtener los inputs cuando el modal se muestra
                var nombreInput = modalEl.querySelector('[name="nombre_completo"]');
                var direccionInput = modalEl.querySelector('[name="direccion"]');
                var telefonoInput = modalEl.querySelector('[name="telefono"]');
                var emailInput = modalEl.querySelector('[name="email"]');
                var ubicacionInput = modalEl.querySelector('[name="ubicacion_asignada"]');
                var tipoVendedorInput = modalEl.querySelector('[name="tipo_vendedor"]');
                var sueldoInput = modalEl.querySelector('[name="sueldo_base"]');
                var documentoInput = modalEl.querySelector('[name="documento_pdf"]');
                var tipoUsuarioInput = modalEl.querySelector('[name="tipo_usuario"]');
                
                var button = event.relatedTarget;
                console.log('[MODAL DEBUG] Bot√≥n relacionado:', button);
                
                if (!button || button.getAttribute('data-mode') === 'create') {
                    // Modo crear
                    console.log('[MODAL DEBUG] Modo crear');
                    if (actionInput) actionInput.value = 'crear';
                    if (idInput) idInput.value = '';
                    if (titleEl) titleEl.textContent = 'Agregar Nuevo Ejecutivo';
                    if (submitBtn) submitBtn.textContent = 'Guardar Ejecutivo';
                    
                    if (nombreInput) nombreInput.value = '';
                    if (direccionInput) direccionInput.value = '';
                    if (telefonoInput) telefonoInput.value = '';
                    if (emailInput) emailInput.value = '';
                    if (ubicacionInput) ubicacionInput.value = '';
                    if (tipoUsuarioInput) tipoUsuarioInput.value = 'VENDEDOR';
                    if (tipoVendedorInput) tipoVendedorInput.value = 'OFICINA';
                    if (sueldoInput) sueldoInput.value = '';
                    if (documentoInput) documentoInput.value = '';
                    if (documentoInfo) {
                        documentoInfo.classList.add('d-none');
                    }
                    // Aplicar visibilidad del campo tipo_vendedor seg√∫n tipo_usuario
                    // Se aplicar√° autom√°ticamente en shown.bs.modal
                    console.log('[MODAL DEBUG] Formulario limpiado para crear');
                return;
                }

                // Modo editar
                console.log('[MODAL DEBUG] Modo editar');
                if (actionInput) actionInput.value = 'editar';
                if (idInput) idInput.value = button.getAttribute('data-id') || '';
                if (titleEl) titleEl.textContent = 'Editar Ejecutivo';
                if (submitBtn) submitBtn.textContent = 'Actualizar Ejecutivo';
                
                if (nombreInput) nombreInput.value = button.getAttribute('data-nombre') || '';
                if (direccionInput) direccionInput.value = button.getAttribute('data-direccion') || '';
                if (telefonoInput) telefonoInput.value = button.getAttribute('data-telefono') || '';
                if (emailInput) emailInput.value = button.getAttribute('data-email') || '';
                if (ubicacionInput) ubicacionInput.value = button.getAttribute('data-ubicacion') || '';
                if (tipoVendedorInput) tipoVendedorInput.value = button.getAttribute('data-tipo-vendedor') || 'OFICINA';
                if (sueldoInput) sueldoInput.value = button.getAttribute('data-sueldo') || '';
                if (documentoInput) documentoInput.value = '';
                
                // El tipo_usuario se carga desde el formulario Django (ya viene con el valor correcto)
                // Solo necesitamos aplicar la visibilidad despu√©s de que se carguen todos los valores
                
                var documentoUrl = button.getAttribute('data-documento-url');
                if (documentoUrl && documentoInfo && documentoLink) {
                    documentoInfo.classList.remove('d-none');
                    documentoLink.href = documentoUrl;
                } else if (documentoInfo) {
                    documentoInfo.classList.add('d-none');
                }
                // Aplicar visibilidad del campo tipo_vendedor seg√∫n tipo_usuario al editar
                // Se aplicar√° autom√°ticamente en shown.bs.modal
                console.log('[MODAL DEBUG] Formulario llenado para editar');
            } catch (err) {
                console.error('[MODAL DEBUG] ========== ERROR CR√çTICO ==========');
                console.error('[MODAL DEBUG] ERROR:', err);
                console.error('[MODAL DEBUG] Mensaje:', err.message);
                console.error('[MODAL DEBUG] Stack:', err.stack);
                console.error('[MODAL DEBUG] ====================================');
            }
            console.log('[MODAL DEBUG] ========== FIN show.bs.modal ==========');
        });
        
        // Escuchar cuando el modal se muestra completamente
        modalEl.addEventListener('shown.bs.modal', function(event) {
            console.log('[MODAL DEBUG] shown.bs.modal disparado - modal completamente visible');
            
            // Asegurar que el overlay est√© completamente oculto y removido del flujo
            var overlay = document.getElementById('pageTransitionOverlay');
            if (overlay) {
                overlay.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; z-index: -9999 !important; position: fixed !important;';
                overlay.classList.remove('active');
                // Remover del DOM temporalmente para asegurar que no bloquee
                overlay.style.display = 'none';
            }
            
            // Forzar visibilidad del modal
            var currentStyle = modalEl.getAttribute('style') || '';
            modalEl.setAttribute('style', currentStyle + ' display: block !important; visibility: visible !important; opacity: 1 !important; z-index: 1055 !important; pointer-events: auto !important;');
            modalEl.classList.add('show');
            modalEl.setAttribute('aria-hidden', 'false');
            modalEl.setAttribute('aria-modal', 'true');
            
            // CR√çTICO: Asegurar que el modal-dialog est√© por encima del backdrop
            var modalDialog = modalEl.querySelector('.modal-dialog');
            var modalContent = modalEl.querySelector('.modal-content');
            if (modalDialog) {
                modalDialog.style.cssText += ' z-index: 1056 !important; position: relative !important; pointer-events: auto !important;';
            }
            if (modalContent) {
                modalContent.style.cssText += ' pointer-events: auto !important; position: relative !important;';
            }
            
            // El backdrop debe estar debajo del modal
            var backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.style.cssText = 'position: fixed; top: 0; left: 0; z-index: 1050 !important; width: 100vw; height: 100vh; background-color: rgba(0, 0, 0, 0.5); pointer-events: auto !important;';
                console.log('[MODAL DEBUG] Backdrop configurado, z-index:', window.getComputedStyle(backdrop).zIndex);
            }
            
            // CR√çTICO: Asegurar que el modal-dialog est√© POR ENCIMA del backdrop
            if (modalDialog) {
                modalDialog.style.cssText = 'position: relative !important; z-index: 1056 !important; pointer-events: auto !important; margin: 1.75rem auto !important;';
                console.log('[MODAL DEBUG] Modal-dialog z-index forzado:', window.getComputedStyle(modalDialog).zIndex);
            }
            if (modalContent) {
                modalContent.style.cssText = 'pointer-events: auto !important; position: relative !important;';
            }
            
            // El overlay ya fue removido en show.bs.modal, verificar que no exista
            var overlay = document.getElementById('pageTransitionOverlay');
            if (overlay) {
                overlay.remove();
                console.log('[MODAL DEBUG] Overlay encontrado y removido en shown.bs.modal');
            }
            
            // Verificar qu√© elementos est√°n bloqueando
            setTimeout(function() {
                console.log('[MODAL DEBUG] ========== DIAGN√ìSTICO DE BLOQUEO ==========');
                console.log('[MODAL DEBUG] Elementos con position fixed:');
                var fixedElements = document.querySelectorAll('[style*="position: fixed"], [style*="position:fixed"]');
                fixedElements.forEach(function(el) {
                    var zIndex = window.getComputedStyle(el).zIndex;
                    var pointerEvents = window.getComputedStyle(el).pointerEvents;
                    var display = window.getComputedStyle(el).display;
                    console.log('[MODAL DEBUG] -', el.id || el.className, 'z-index:', zIndex, 'pointer-events:', pointerEvents, 'display:', display);
                });
                
                console.log('[MODAL DEBUG] Overlay estado final:');
                if (overlay) {
                    console.log('[MODAL DEBUG] - display:', window.getComputedStyle(overlay).display);
                    console.log('[MODAL DEBUG] - z-index:', window.getComputedStyle(overlay).zIndex);
                    console.log('[MODAL DEBUG] - pointer-events:', window.getComputedStyle(overlay).pointerEvents);
                }
                
                console.log('[MODAL DEBUG] Backdrop estado final:');
                if (backdrop) {
                    console.log('[MODAL DEBUG] - z-index:', window.getComputedStyle(backdrop).zIndex);
                    console.log('[MODAL DEBUG] - pointer-events:', window.getComputedStyle(backdrop).pointerEvents);
                }
                
                console.log('[MODAL DEBUG] Modal estado final:');
                console.log('[MODAL DEBUG] - display:', window.getComputedStyle(modalEl).display);
                console.log('[MODAL DEBUG] - z-index:', window.getComputedStyle(modalEl).zIndex);
                console.log('[MODAL DEBUG] - pointer-events:', window.getComputedStyle(modalEl).pointerEvents);
                
                console.log('[MODAL DEBUG] Modal-dialog estado final:');
                if (modalDialog) {
                    console.log('[MODAL DEBUG] - z-index:', window.getComputedStyle(modalDialog).zIndex);
                    console.log('[MODAL DEBUG] - pointer-events:', window.getComputedStyle(modalDialog).pointerEvents);
                }
                
                console.log('[MODAL DEBUG] ============================================');
            }, 300);
            
            console.log('[MODAL DEBUG] Modal forzado a visible en shown.bs.modal');
        });
        
        // Limpiar formulario al cerrar y restaurar overlay si es necesario
        modalEl.addEventListener('hidden.bs.modal', function() {
            console.log('[MODAL DEBUG] Modal cerrado');
            var form = modalEl.querySelector('form');
            if (form) {
                form.reset();
            }
            
            // Restaurar el overlay si fue removido (aunque no deber√≠a ser necesario)
            var overlay = document.getElementById('pageTransitionOverlay');
            if (!overlay) {
                // Recrear el overlay si fue removido (solo para mantener la estructura)
                var newOverlay = document.createElement('div');
                newOverlay.id = 'pageTransitionOverlay';
                newOverlay.className = 'page-transition-overlay';
                newOverlay.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; z-index: -9999 !important; position: fixed !important;';
                var spinner = document.createElement('div');
                spinner.className = 'page-transition-spinner';
                newOverlay.appendChild(spinner);
                document.body.appendChild(newOverlay);
            }
        });
        
        // Si se debe mostrar el modal autom√°ticamente (despu√©s de un error de validaci√≥n)
        // Leer la variable desde un atributo data para evitar errores del linter con tags de Django
        var modalConfigEl = document.getElementById('modal-config');
        var mostrarModalEjecutivo = modalConfigEl && modalConfigEl.getAttribute('data-mostrar-modal') === 'true';
        if (mostrarModalEjecutivo) {
            setTimeout(function() {
                try {
                    var bootstrapModal = bootstrap.Modal.getOrCreateInstance(modalEl);
                    bootstrapModal.show();
                } catch (err) {
                    console.error('[MODAL DEBUG] ERROR:', err);
                    var bootstrapModal = new bootstrap.Modal(modalEl);
                    bootstrapModal.show();
                }
            }, 100);
        }
        
        console.log('[MODAL DEBUG] Inicializaci√≥n completa');
    }
    
    // Ejecutar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initModalEjecutivo);
    } else {
        initModalEjecutivo();
    }
    
    // Tambi√©n intentar despu√©s de un delay adicional
    setTimeout(function() {
        console.log('[MODAL DEBUG] Verificaci√≥n tard√≠a');
        var modalEl = document.getElementById('ejecutivoModal');
        if (modalEl) {
            console.log('[MODAL DEBUG] Modal encontrado en verificaci√≥n tard√≠a');
        } else {
            console.error('[MODAL DEBUG] Modal NO encontrado en verificaci√≥n tard√≠a');
        }
    }, 2000);
})();
</script>
{% endblock %}
