{% extends "base.html" %}
{% load widget_tweaks %}
{% load humanize %}
{% load venta_filters %}
{% load static %}

{% block title %}
{% if object %}Editar Venta {{ object.folio|default:object.id }}{% else %}Crear Nueva Venta{% endif %}
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-10 offset-md-1">

        <h1 class="mb-4 text-primary fw-bold">
            {% if object %}
            <i class="fas fa-edit"></i> Editar Venta de Viaje <span class="badge bg-primary fs-5">{{ object.folio|default:object.id }}</span>
            {% else %}
            <i class="fas fa-plane-departure"></i> Registrar Nueva Venta de Viaje
            {% endif %}
        </h1>
        {% url 'cliente_kilometros_resumen' cliente_id=0 as kilometros_resumen_url %}

        {# Mensajes de Django #}
        {% if messages %}
        {# Mostrar mensajes: para mensajes de abono, mostrar solo el √∫ltimo; para otros, mostrar todos #}
        {% regroup messages by message as grouped_messages %}
        {% for group in grouped_messages %}
        {# Verificar si el mensaje contiene "Abono" #}
        {% if "Abono" in group.grouper|stringformat:"s" %}
        {# Para mensajes de abono, mostrar solo el √∫ltimo grupo (forloop.last) #}
        {% if forloop.last %}
        <div class="alert alert-{{ group.grouper.tags }} alert-dismissible fade show" role="alert">
            {{ group.grouper }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}
        {% else %}
        {# Para otros mensajes, mostrar todos #}
        <div class="alert alert-{{ group.grouper.tags }} alert-dismissible fade show" role="alert">
            {{ group.grouper }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}
        {% endfor %}
        {% endif %}

        <div id="kilometrosBannerContainer" class="mb-4" data-api-url="{{ kilometros_resumen_url }}"
            data-valor-km="{{ kilometros_meta.valor_por_km|floatformat:2 }}"
            data-max-redencion="{{ kilometros_meta.max_porcentaje|floatformat:0 }}"
            data-cliente-inicial="{{ cliente_preseleccionado.pk|default_if_none:'' }}"
            data-credito-inicial="{% if kilometros_cliente %}{{ kilometros_cliente.valor_equivalente|default_if_none:'0'|floatformat:2 }}{% else %}0{% endif %}">
            {% if kilometros_cliente %}
            <div class="alert alert-info shadow-sm">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div>
                        <h5 class="mb-1 text-primary">
                            <i class="fas fa-route me-2"></i>Saldo Kil√≥metros Movums de {{ cliente_preseleccionado }}
                        </h5>
                        <p class="mb-0 text-muted small">
                            1 km = ${{ kilometros_meta.valor_por_km|floatformat:2 }} MXN ¬∑ M√°x redenci√≥n: {{ kilometros_meta.max_porcentaje|floatformat:0 }}% del valor de la venta
                        </p>
                    </div>
                    <div class="text-end">
                        <p class="mb-0 fw-bold">{{ kilometros_cliente.disponible|floatformat:2|intcomma }} km disponibles</p>
                        <small class="text-muted">‚âà ${{ kilometros_cliente.valor_equivalente|floatformat:2|intcomma }} MXN aplicables</small>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-light border shadow-sm text-muted" id="kilometrosEmptyState">
                <i class="fas fa-info-circle me-2"></i> Selecciona un cliente para consultar su saldo de Kil√≥metros
                Movums.
            </div>
            {% endif %}
        </div>

        <div class="card p-4 shadow-lg mb-4 border-0 rounded-3">
            <form method="post" enctype="multipart/form-data" id="ventaForm">
                {% csrf_token %}

                {# ------------------- Secci√≥n 1: Cliente e Informaci√≥n General ------------------- #}
                <h4 class="mb-3 text-secondary border-bottom pb-2">1. Datos del Cliente y Contrato</h4>

                <div class="row">
                    {# Cliente Asociado #}
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.cliente.id_for_label }}" class="form-label fw-bold text-secondary">
                            {{ form.cliente.label }}<span class="text-danger">*</span>
                        </label>
                        {{ form.cliente|add_class:"form-select select2" }}
                        <div class="form-text text-muted">{{ form.cliente.help_text }}</div>
                        {% for error in form.cliente.errors %}
                        <div class="invalid-feedback d-block"><i class="fas fa-exclamation-circle me-1"></i> {{ error }}
                        </div>
                        {% endfor %}
                    </div>

                    {# Tipo de Viaje (Plantilla de Contrato) #}
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.tipo_viaje.id_for_label }}" class="form-label fw-bold text-secondary">
                            {{ form.tipo_viaje.label }}<span class="text-danger">*</span>
                        </label>
                        {{ form.tipo_viaje|add_class:"form-select" }}
                        {% for error in form.tipo_viaje.errors %}
                        <div class="invalid-feedback d-block"><i class="fas fa-exclamation-circle me-1"></i> {{ error }}
                        </div>
                        {% endfor %}
                    </div>
                </div>

                {# Secci√≥n para Ventas Internacionales (USD) - Solo visible cuando tipo_viaje == 'INT' #}
                {% with valor_tipo=form.initial.tipo_viaje|default:form.instance.tipo_viaje|default:"" %}
                <div id="seccionVentaInternacional"
                    class="card p-4 shadow-sm border-primary mb-4"{% if valor_tipo != 'INT' %} style="display: none;"{% endif %}>
                    <h5 class="text-primary fw-bold mb-3">
                        <i class="fas fa-globe-americas me-2"></i>Informaci√≥n de Venta Internacional (USD)
                    </h5>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.tarifa_base_usd.id_for_label }}"
                                class="form-label fw-bold text-secondary">
                                {{ form.tarifa_base_usd.label }}<span class="text-danger">*</span>
                            </label>
                            {{ form.tarifa_base_usd|add_class:"form-control" }}
                            {% for error in form.tarifa_base_usd.errors %}
                            <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.impuestos_usd.id_for_label }}"
                                class="form-label fw-bold text-secondary">
                                {{ form.impuestos_usd.label }}<span class="text-danger">*</span>
                            </label>
                            {{ form.impuestos_usd|add_class:"form-control" }}
                            {% for error in form.impuestos_usd.errors %}
                            <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.suplementos_usd.id_for_label }}"
                                class="form-label fw-bold text-secondary">
                                {{ form.suplementos_usd.label }}<span class="text-danger">*</span>
                            </label>
                            {{ form.suplementos_usd|add_class:"form-control" }}
                            {% for error in form.suplementos_usd.errors %}
                            <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.tours_usd.id_for_label }}" class="form-label fw-bold text-secondary">
                                {{ form.tours_usd.label }}<span class="text-danger">*</span>
                            </label>
                            {{ form.tours_usd|add_class:"form-control" }}
                            {% for error in form.tours_usd.errors %}
                            <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.tipo_cambio.id_for_label }}" class="form-label fw-bold text-secondary">
                                {{ form.tipo_cambio.label }}<span class="text-danger">*</span>
                            </label>
                            {{ form.tipo_cambio|add_class:"form-control" }}
                            <div class="form-text text-muted">Tipo de cambio del d√≠a para convertir d√≥lares a pesos
                                mexicanos.</div>
                            {% for error in form.tipo_cambio.errors %}
                            <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold text-secondary">Total en USD</label>
                            <div class="input-group">
                                <span class="input-group-text">USD $</span>
                                <input type="text" class="form-control" id="totalUsdCalculado" readonly value="0.00">
                            </div>
                            <div class="form-text text-muted">Total calculado autom√°ticamente (Tarifa Base + Impuestos +
                                Suplementos + Tours)</div>
                        </div>
                    </div>
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Nota:</strong> Los valores se convertir√°n autom√°ticamente a pesos mexicanos (MXN) al
                        guardar usando el tipo de cambio especificado.
                    </div>
                </div>
                {% endwith %}

                {# Pasajeros (Campo nuevo - Textarea) #}
                <div class="mb-4">
                    <label for="{{ form.pasajeros.id_for_label }}" class="form-label fw-bold text-secondary">
                        {{ form.pasajeros.label }}
                    </label>
                    {{ form.pasajeros|add_class:"form-control" }}
                    {% if form.pasajeros.help_text %}
                    <div class="form-text text-muted">{{ form.pasajeros.help_text }}</div>
                    {% endif %}
                    {% for error in form.pasajeros.errors %}
                    <div class="invalid-feedback d-block"><i class="fas fa-exclamation-circle me-1"></i> {{ error }}
                    </div>
                    {% endfor %}
                </div>

                {# Menores: nombre y edad #}
                <div class="mb-4">
                    <label for="{{ form.edades_menores.id_for_label }}" class="form-label fw-bold text-secondary">
                        Menores (nombre y edad, si aplica)
                    </label>
                    {{ form.edades_menores|add_class:"form-control" }}
                    <div class="form-text text-muted">Ejemplo: Juan P√©rez - 5; Ana L√≥pez - 8</div>
                    {% for error in form.edades_menores.errors %}
                    <div class="invalid-feedback d-block"><i class="fas fa-exclamation-circle me-1"></i> {{ error }}
                    </div>
                    {% endfor %}
                </div>
                {# Script para establecer edades de menores si viene de cotizaci√≥n #}
                {% if cotizacion_origen and cotizacion_origen.edades_menores %}
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        const edadesField = document.getElementById('{{ form.edades_menores.id_for_label }}');
                        if (edadesField && !edadesField.value) {
                            // Obtener edades de la cotizaci√≥n y formatearlas con saltos de l√≠nea
                            const edadesCotizacion = '{{ cotizacion_origen.edades_menores|escapejs }}';
                            if (edadesCotizacion && edadesCotizacion.trim()) {
                                // Separar por comas y filtrar valores vac√≠os
                                const edades = edadesCotizacion.split(',').map(e => e.trim()).filter(e => e);
                                if (edades.length > 0) {
                                    // Crear formato con saltos de l√≠nea para cualquier cantidad de menores
                                    const edadesLista = edades.map((edad, i) => `Menor ${i + 1} - ${edad}`).join('\n');
                                    edadesField.value = edadesLista;
                                }
                            }
                        }
                    });
                </script>
                {% endif %}

                {# ------------------- Secci√≥n 2: Servicios Incluidos ------------------- #}
                <h4 class="mb-3 mt-4 text-secondary border-bottom pb-2">2. Servicios Contratados</h4>

                {# Selector de Servicios con Checkboxes Colapsable #}
                <div class="mb-4">
                    <div class="card border-secondary">
                        <div class="card-header bg-light p-2" style="cursor: pointer;" data-bs-toggle="collapse"
                            data-bs-target="#serviciosCollapse"
                            aria-expanded="{% if object.cotizacion_origen or cotizacion_origen %}true{% else %}false{% endif %}"
                            aria-controls="serviciosCollapse">
                            <div class="d-flex align-items-center">
                                <span class="fw-bold text-secondary">
                                    <i class="fas {% if object.cotizacion_origen or cotizacion_origen %}fa-chevron-up{% else %}fa-chevron-down{% endif %} me-2"
                                        id="serviciosIcon"></i>
                                    {{ form.servicios_seleccionados.label }}
                                </span>
                            </div>
                        </div>
                        <div class="collapse {% if object.cotizacion_origen or cotizacion_origen %}show{% endif %}"
                            id="serviciosCollapse">
                            <div class="card-body">
                                <div class="row g-3" id="serviciosCheckboxes">
                                    {% for checkbox in form.servicios_seleccionados %}
                                    <div class="col-md-6 col-lg-4">
                                        <div class="form-check">
                                            {{ checkbox.tag }}
                                            <label class="form-check-label" for="{{ checkbox.id_for_label }}">
                                                {{ checkbox.choice_label }}
                                            </label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="form-text text-muted mt-2">{{ form.servicios_seleccionados.help_text }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% for error in form.servicios_seleccionados.errors %}
                    <div class="invalid-feedback d-block mt-2"><i class="fas fa-exclamation-circle me-1"></i> {{ error
                        }}</div>
                    {% endfor %}
                </div>

                {# Campo condicional para tipo de tr√°mite de documentaci√≥n #}
                <div class="mb-4" id="tipoTramiteContainer" style="display: none;">
                    <div class="card border-warning">
                        <div class="card-body">
                            <label for="{{ form.tipo_tramite_documentacion.id_for_label }}"
                                class="form-label fw-bold text-secondary">
                                {{ form.tipo_tramite_documentacion.label }}<span class="text-danger">*</span>
                            </label>
                            {{ form.tipo_tramite_documentacion|add_class:"form-select" }}
                            {% if form.tipo_tramite_documentacion.help_text %}
                            <div class="form-text text-muted">{{ form.tipo_tramite_documentacion.help_text }}</div>
                            {% endif %}
                            {% for error in form.tipo_tramite_documentacion.errors %}
                            <div class="invalid-feedback d-block mt-2"><i class="fas fa-exclamation-circle me-1"></i> {{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                {# ------------------- Secci√≥n 2.1: Proveedores por Servicio ------------------- #}
                <div class="mb-4" id="proveedoresSection" style="display: none;">
                    <h5 class="mb-3 text-secondary"><i class="fas fa-handshake me-2"></i>Proveedores por Servicio</h5>
                    <div class="card border-info">
                        <div class="card-body">
                            <div class="row g-3" id="proveedoresContainer">
                                {# Campos de proveedor - Renderizados manualmente seg√∫n tipo #}
                                {% for field_name, field in form.fields.items %}
                                {% if "proveedor_" in field_name and "_opcion" not in field_name %}
                                {# Extraer el nombre del servicio del label (ej: "Proveedor de Vuelo" -> "Vuelo") #}
                                {% with servicio_nombre=field.label|slice:"12:"|striptags %}
                                <div class="col-md-6 proveedor-field-wrapper" data-servicio="{{ servicio_nombre|striptags }}"
                                    data-field-name="{{ field_name }}" style="display: none;">
                                    <div class="proveedor-field" data-servicio="{{ servicio_nombre|striptags }}"
                                        data-field-name="{{ field_name }}">
                                        <label for="id_{{ field_name }}" class="form-label fw-bold text-secondary">
                                            {{ field.label }}
                                        </label>
                                        {# Renderizar seg√∫n el tipo de campo #}
                                        {% if "proveedor-select" in field.widget.attrs.class %}
                                        {# Campo de selecci√≥n (dropdown) para Vuelo, Hospedaje, Tour #}
                                        {# Obtener el valor inicial del proveedor - usar field.initial o form.initial #}
                                        {% with selected_proveedor=form.initial|get_item:field_name|default:field.initial %}
                                        <select name="{{ field_name }}" id="id_{{ field_name }}"
                                            class="form-select proveedor-select">
                                            <option value="">Selecciona un proveedor</option>
                                            {% for proveedor in field.queryset %}
                                            {% if selected_proveedor %}
                                            {% if selected_proveedor.pk == proveedor.pk %}
                                            <option value="{{ proveedor.pk }}" selected>{{ proveedor.nombre }}</option>
                                            {% else %}
                                            <option value="{{ proveedor.pk }}">{{ proveedor.nombre }}</option>
                                            {% endif %}
                                            {% else %}
                                            <option value="{{ proveedor.pk }}">{{ proveedor.nombre }}</option>
                                            {% endif %}
                                            {% endfor %}
                                        </select>
                                        {% endwith %}
                                        {% else %}
                                        {# Campo de texto para otros servicios #}
                                        {% with text_value=form.initial|get_item:field_name %}
                                        <input type="text" name="{{ field_name }}" id="id_{{ field_name }}"
                                            class="form-control" {% if text_value %}value="{{ text_value }}" {% endif %}
                                            placeholder="{{ field.widget.attrs.placeholder|default:'' }}">
                                        {% endwith %}
                                        {% endif %}
                                        {# Mostrar errores si existen #}
                                        {% if form.errors %}
                                        {% for error_key, error_list in form.errors.items %}
                                        {% if error_key == field_name %}
                                        {% for error in error_list %}
                                        <div class="invalid-feedback d-block"><i class="fas fa-exclamation-circle me-1"></i>
                                            {{ error }}</div>
                                        {% endfor %}
                                        {% endif %}
                                        {% endfor %}
                                        {% endif %}
                                    </div>
                                    {# Campo de opci√≥n que aparece cuando se selecciona un proveedor #}
                                    {% with opcion_field_name=field_name|add:"_opcion" %}
                                    {% if opcion_field_name in form.fields %}
                                    {% with opcion_field=form.fields|get_item:opcion_field_name %}
                                    {% with opcion_value=form.initial|get_item:opcion_field_name %}
                                    <div class="proveedor-opcion-field mt-3" data-proveedor-field="{{ field_name }}" 
                                         style="display: none;">
                                        <label for="id_{{ opcion_field_name }}" class="form-label fw-semibold text-muted">
                                            {{ opcion_field.label }}
                                        </label>
                                        <input type="text" name="{{ opcion_field_name }}" id="id_{{ opcion_field_name }}"
                                            class="form-control proveedor-opcion-input" 
                                            {% if opcion_value %}value="{{ opcion_value }}" {% endif %}
                                            placeholder="{{ opcion_field.widget.attrs.placeholder|default:'Ej. Nombre del hotel, aerol√≠nea, etc.' }}">
                                        {% if opcion_field.help_text %}
                                        <small class="form-text text-muted">{{ opcion_field.help_text }}</small>
                                        {% endif %}
                                        {# Mostrar errores si existen #}
                                        {% if form.errors %}
                                        {% for error_key, error_list in form.errors.items %}
                                        {% if error_key == opcion_field_name %}
                                        {% for error in error_list %}
                                        <div class="invalid-feedback d-block"><i class="fas fa-exclamation-circle me-1"></i>
                                            {{ error }}</div>
                                        {% endfor %}
                                        {% endif %}
                                        {% endfor %}
                                        {% endif %}
                                    </div>
                                    {% endwith %}
                                    {% endwith %}
                                    {% endif %}
                                    {% endwith %}
                                </div>
                                {% endwith %}
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                {# ------------------- Secci√≥n 3: Fechas y Finanzas ------------------- #}
                <h4 class="mb-3 mt-4 text-secondary border-bottom pb-2">3. Fechas y Financiero</h4>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        {# Fecha Inicio Viaje - Renderizado manual con formato ISO #}
                        <label for="id_fecha_inicio_viaje" class="form-label fw-bold text-secondary">{{ form.fecha_inicio_viaje.label }}<span class="text-danger">*</span></label>
                        <input type="date" name="fecha_inicio_viaje" id="id_fecha_inicio_viaje" class="form-control"{% if form.fecha_inicio_viaje.value %} value="{{ form.fecha_inicio_viaje.value|date:'Y-m-d' }}"{% endif %} required>
                        {% if form.fecha_inicio_viaje.errors %}
                        <div class="text-danger small">{{ form.fecha_inicio_viaje.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4 mb-3">
                        {# Fecha Fin Viaje - Renderizado manual con formato ISO #}
                        <label for="id_fecha_fin_viaje" class="form-label fw-bold text-secondary">{{ form.fecha_fin_viaje.label }}</label>
                        <input type="date" name="fecha_fin_viaje" id="id_fecha_fin_viaje" class="form-control"{% if form.fecha_fin_viaje.value %} value="{{ form.fecha_fin_viaje.value|date:'Y-m-d' }}"{% endif %}>
                        {% if form.fecha_fin_viaje.errors %}
                        <div class="text-danger small">{{ form.fecha_fin_viaje.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4 mb-3">
                        {# Fecha Vencimiento Pago - Renderizado manual con formato ISO #}
                        <label for="id_fecha_vencimiento_pago" class="form-label fw-bold text-secondary">{{ form.fecha_vencimiento_pago.label }}</label>
                        <input type="date" name="fecha_vencimiento_pago" id="id_fecha_vencimiento_pago" class="form-control"{% if form.fecha_vencimiento_pago.value %} value="{{ form.fecha_vencimiento_pago.value|date:'Y-m-d' }}"{% endif %}>
                        {% if form.fecha_vencimiento_pago.errors %}
                        <div class="text-danger small">{{ form.fecha_vencimiento_pago.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        {# Costo Venta Final (Precio Cliente) #}
                        <label for="{{ form.costo_venta_final.id_for_label }}"
                            class="form-label fw-bold text-secondary">{{ form.costo_venta_final.label }}<span
                                class="text-danger">*</span></label>
                        {{ form.costo_venta_final|add_class:"form-control" }}
                        <div class="form-text text-muted">{{ form.costo_venta_final.help_text }}</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        {# Cantidad de Apertura/Anticipo #}
                        <label for="{{ form.cantidad_apertura.id_for_label }}"
                            class="form-label fw-bold text-secondary">
                            <span id="labelCantidadApertura">{{ form.cantidad_apertura.label }}</span>
                        </label>
                        {{ form.cantidad_apertura|add_class:"form-control" }}
                        <div class="form-text text-muted" id="helpTextApertura">Cantidad de apertura o anticipo</div>
                        {% for error in form.cantidad_apertura.errors %}
                        <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-md-4 mb-3">
                        {# Modo de Pago de Apertura #}
                        <label for="{{ form.modo_pago_apertura.id_for_label }}"
                            class="form-label fw-bold text-secondary">{{ form.modo_pago_apertura.label }}</label>
                        {{ form.modo_pago_apertura|add_class:"form-select" }}
                        {% if form.modo_pago_apertura.help_text %}
                        <div class="form-text">{{ form.modo_pago_apertura.help_text }}</div>
                        {% endif %}
                        {% for error in form.modo_pago_apertura.errors %}
                        <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-md-4 mb-3">
                        {# Costo Neto (Costo Agencia) #}
                        <label for="{{ form.costo_neto.id_for_label }}" class="form-label fw-bold text-secondary">
                            <span id="labelCostoNeto">{{ form.costo_neto.label }}</span><span
                                class="text-danger">*</span>
                        </label>
                        {{ form.costo_neto|add_class:"form-control" }}
                        <div class="form-text text-muted" id="helpTextCostoNeto">{{ form.costo_neto.help_text }}</div>
                    </div>
                </div>

                <div id="promoPreviewContainer">
                    {% if form.promos_calculadas %}
                    {% include 'ventas/partials/promo_preview.html' with promos=form.promos_calculadas
                    total_desc=form.total_descuento_promos %}
                    {% endif %}
                </div>

                {# Secci√≥n de Kil√≥metros Movums - Ocultar para ventas internacionales #}
                <div class="card p-3 shadow-sm border-success-subtle mb-4" id="descuentoKilometrosCard">
                    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between">
                        <div class="form-check form-switch mb-2 mb-md-0">
                            {{ form.aplica_descuento_kilometros|add_class:"form-check-input" }}
                            <label for="{{ form.aplica_descuento_kilometros.id_for_label }}"
                                class="form-check-label fw-bold text-success ms-2">
                                Aplicar descuento Kil√≥metros Movums (10%)
                            </label>
                        </div>
                        <p class="text-muted small mb-0">
                            Disponible como beneficio de fidelidad. El descuento se calcula sobre el costo venta final
                            de la venta (10% del total).
                        </p>
                    </div>
                    {% for error in form.aplica_descuento_kilometros.errors %}
                    <div class="text-danger small mt-2"><i class="fas fa-exclamation-circle me-1"></i> {{ error }}</div>
                    {% endfor %}
                    {{ form.descuento_kilometros_mxn }}
                    <div class="text-muted small mt-2">
                        Saldo disponible Kil√≥metros: <strong id="saldoKilometrosDisponible">$0.00 MXN</strong>
                    </div>
                    <div class="row text-center mt-3">
                        <div class="col-md-4 mb-3 mb-md-0">
                            <p class="text-muted mb-1">Subtotal venta</p>
                            <h5 id="subtotalVenta" class="fw-bold text-secondary">$0.00 MXN</h5>
                        </div>
                        <div class="col-md-4 mb-3 mb-md-0">
                            <p class="text-muted mb-1">Descuento (10%)</p>
                            <h5 id="descuentoCalculado" class="fw-bold text-success">-$0.00 MXN</h5>
                        </div>
                        <div class="col-md-4">
                            <p class="text-muted mb-1">Total con descuento</p>
                            <h5 id="totalConDescuento" class="fw-bold text-primary">$0.00 MXN</h5>
                        </div>
                    </div>
                </div>

                {# Campo de Costo de Modificaci√≥n - Solo visible al editar #}
                {% if form.costo_modificacion %}
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="alert alert-warning mb-0">
                            <label for="{{ form.costo_modificacion.id_for_label }}"
                                class="form-label fw-bold text-secondary">
                                <i class="fas fa-edit me-1"></i>{{ form.costo_modificacion.label }}
                            </label>
                            {{ form.costo_modificacion|add_class:"form-control" }}
                            {% if form.costo_modificacion.help_text %}
                            <div class="form-text text-muted mt-2">{{ form.costo_modificacion.help_text }}</div>
                            {% endif %}
                            {% for error in form.costo_modificacion.errors %}
                            <div class="text-danger small mt-1">{{ error }}</div>
                            {% endfor %}
                            {% if form.instance.costo_modificacion and form.instance.costo_modificacion > 0 %}
                            <div class="alert alert-info mt-2 mb-0">
                                <small><i class="fas fa-info-circle"></i> Costo de modificaci√≥n actual: ${{ form.instance.costo_modificacion|floatformat:2|intcomma }}</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                {# ------------------- Secci√≥n 4: Documentos (Campo File) ------------------- #}
                <h4 class="mb-3 mt-4 text-secondary border-bottom pb-2">4. Archivos Adjuntos</h4>

                <div class="mb-3">
                    <label for="{{ form.documentos_cliente.id_for_label }}" class="form-label fw-bold text-secondary">
                        {{ form.documentos_cliente.label }}
                    </label>
                    {# El widget MultipleFileInput permite seleccionar m√∫ltiples archivos #}
                    {{ form.documentos_cliente }}
                    {% if form.documentos_cliente.help_text %}
                    <div class="form-text text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        {{ form.documentos_cliente.help_text }}
                    </div>
                    {% endif %}
                    {% for error in form.documentos_cliente.errors %}
                    <div class="invalid-feedback d-block"><i class="fas fa-exclamation-circle me-1"></i> {{ error }}
                    </div>
                    {% endfor %}
                </div>


                <hr class="my-4">

                <div class="d-flex justify-content-between mt-4">
                    <a href="{% url 'lista_ventas' %}" class="btn btn-outline-secondary px-4">
                        <i class="fas fa-arrow-left me-2"></i> Volver
                    </a>
                    <div class="d-flex gap-2">
                        {% if object %}
                        {# Bot√≥n de Cancelar Venta - Solo visible al editar #}
                        <button type="button" class="btn btn-danger px-4 shadow-sm" data-bs-toggle="modal"
                            data-bs-target="#cancelarVentaModal">
                            <i class="fas fa-times-circle me-2"></i> Cancelar Venta
                        </button>
                        {% endif %}
                        <button type="submit" class="btn btn-success px-4 shadow-sm">
                            <i class="fas fa-save me-2"></i>
                            {% if object %}Actualizar Venta{% else %}Guardar Venta{% endif %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

{# Modal de Confirmaci√≥n para Cancelar Venta - Solo visible al editar #}
{% if object %}
<div class="modal fade" id="cancelarVentaModal" tabindex="-1" aria-labelledby="cancelarVentaModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="cancelarVentaModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Cancelaci√≥n de Venta
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¬øEst√°s seguro de que deseas cancelar la <strong>Venta #{{ object.pk }}</strong>?</p>
                <p class="text-muted small mb-0">
                    <i class="fas fa-info-circle me-1"></i>
                    Al cancelar, el estado de la venta cambiar√° a "Cancelada". Esta acci√≥n puede revertirse editando la
                    venta nuevamente.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> No Cancelar
                </button>
                <form method="post" action="{% url 'cancelar_venta' pk=object.pk %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-check me-1"></i> S√≠, Cancelar Venta
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMD/cd2jBDEXk4B7Hw22Z5+gD5b7t9R1B1xR1wM8t7j07JtMv0jXw4W5r3v5sXw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />

{# Carga de Select2 para mejorar la interfaz de selecci√≥n de cliente y servicios #}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    /* Estilos minimalistas y modernos para Select2 */
    .select2-container {
        width: 100% !important;
    }

    .select2-container--default .select2-selection--single {
        border: 1px solid #ced4da;
        border-radius: 6px;
        height: 38px;
        transition: all 0.2s ease;
    }

    .select2-container--default .select2-selection--single:hover {
        border-color: #86b7fe;
    }

    .select2-container--default.select2-container--focus .select2-selection--single {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.1);
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 36px;
        padding-left: 12px;
        color: #212529;
        font-size: 1em;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 36px;
        right: 10px;
    }

    .select2-dropdown {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        margin-top: 4px;
    }

    .select2-results__option--highlighted[aria-selected] {
        background-color: #f8f9fa;
        color: #212529;
    }

    .select2-results__option[aria-selected=true] {
        background-color: #e7f1ff;
        color: #0d6efd;
    }

    .select2-results__option {
        font-size: 1em;
    }
</style>
{% endblock %}

{% block extra_js %}
{# Cargar jQuery antes de Select2 #}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function () {
        const clienteSelect = $('#id_cliente');

        // Inicializar Select2 con estilo minimalista
        clienteSelect.select2({
            placeholder: "Selecciona un cliente",
            allowClear: true,
            width: '100%',
            templateResult: function (data) {
                if (!data.id) {
                    return data.text;
                }
                const $result = $('<span></span>');
                $result.text(data.text);
                // Fuente al mismo tama√±o que el resto del formulario
                $result.css({
                    'font-size': '1em',
                    'line-height': '1.5'
                });
                return $result;
            },
            templateSelection: function (data) {
                if (!data.id) {
                    return data.text;
                }
                const $selection = $('<span></span>');
                $selection.text(data.text);
                $selection.css({
                    'font-size': '1em'
                });
                return $selection;
            }
        });

        // Aplicar estilos minimalistas cuando se abre el dropdown
        clienteSelect.on('select2:open', function () {
            setTimeout(function () {
                // Estilizar los grupos (optgroups) de forma minimalista
                $('.select2-results__group').each(function () {
                    const $group = $(this);
                    $group.css({
                        'font-weight': '600',
                        'font-size': '0.95em',
                        'text-transform': 'uppercase',
                        'letter-spacing': '0.5px',
                        'color': '#6c757d',
                        'padding': '6px 12px',
                        'background-color': 'transparent',
                        'border-bottom': 'none',
                        'margin-top': '8px',
                        'margin-bottom': '4px'
                    });
                });

                // Estilizar las opciones individuales de forma minimalista
                $('.select2-results__option').each(function () {
                    const $option = $(this);
                    const text = $option.text();

                    // Ignorar los grupos y la opci√≥n vac√≠a
                    if ($option.hasClass('select2-results__group') || text === '---------') {
                        return;
                    }

                    // Estilo base minimalista para todas las opciones
                    $option.css({
                        'padding': '8px 12px',
                        'font-size': '1em',
                        'transition': 'all 0.2s ease',
                        'border-radius': '4px',
                        'margin': '2px 8px'
                    });

                    // Colores sutiles basados en el tipo
                    if (text.includes('üè¢')) {
                        // Empresa - color azul sutil
                        $option.css({
                            'color': '#495057',
                            'background-color': 'transparent'
                        });

                        // Hover sutil para empresas
                        $option.hover(
                            function () {
                                $(this).css({
                                    'background-color': '#f0f7ff',
                                    'color': '#0d6efd'
                                });
                            },
                            function () {
                                $(this).css({
                                    'background-color': 'transparent',
                                    'color': '#495057'
                                });
                            }
                        );
                    } else if (text.includes('üë§')) {
                        // Particular - color verde sutil
                        $option.css({
                            'color': '#495057',
                            'background-color': 'transparent'
                        });

                        // Hover sutil para particulares
                        $option.hover(
                            function () {
                                $(this).css({
                                    'background-color': '#f0fdf4',
                                    'color': '#16a34a'
                                });
                            },
                            function () {
                                $(this).css({
                                    'background-color': 'transparent',
                                    'color': '#495057'
                                });
                            }
                        );
                    }
                });
            }, 10);
        });

        // Permitir scroll dentro de la lista Select2 sin mover la p√°gina
        $(document).on('wheel', '.select2-results__options', function (e) {
            const deltaY = e.originalEvent.deltaY;
            const maxScroll = this.scrollHeight - this.clientHeight;
            const current = this.scrollTop;
            e.preventDefault();
            e.stopPropagation();
            this.scrollTop = Math.min(maxScroll, Math.max(0, current + deltaY));
        });

        // Aplicar estilos al contenedor de Select2 para un look m√°s moderno
        clienteSelect.on('select2:select', function () {
            $('.select2-selection__rendered').css({
                'font-size': '0.95em',
                'color': '#212529'
            });
        });

        const currencyFormatter = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', minimumFractionDigits: 2 });
        const numberFormatter = new Intl.NumberFormat('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const toNumber = (value) => {
            if (value === null || value === undefined) return 0;
            const normalized = typeof value === 'string' ? value.replace(/[^0-9.\-]/g, '') : value;
            const parsed = Number.parseFloat(normalized);
            return Number.isFinite(parsed) ? parsed : 0;
        };

        const kmContainer = document.getElementById('kilometrosBannerContainer');
        const kmConfig = kmContainer ? {
            apiTemplate: kmContainer.dataset.apiUrl || '',
            valorKm: toNumber(kmContainer.dataset.valorKm || '0.05'),
            maxRedencion: toNumber(kmContainer.dataset.maxRedencion || '10'),
            clienteInicial: kmContainer.dataset.clienteInicial,
            creditoInicial: toNumber(kmContainer.dataset.creditoInicial || '0')
        } : null;
        let kmCreditoDisponible = kmConfig ? kmConfig.creditoInicial : 0;
        const saldoDisponibleLabel = document.getElementById('saldoKilometrosDisponible');

        function updateSaldoDisponibleText() {
            if (!saldoDisponibleLabel) return;
            const value = Math.max(0, kmCreditoDisponible || 0);
            saldoDisponibleLabel.textContent = `${currencyFormatter.format(value)} MXN`;
        }
        updateSaldoDisponibleText();

        function renderDefaultKmBanner() {
            if (!kmContainer) return;
            kmCreditoDisponible = 0;
            kmContainer.innerHTML = `
                    <div class="alert alert-light border shadow-sm text-muted">
                        <i class="fas fa-info-circle me-2"></i> Selecciona un cliente para consultar su saldo de Kil√≥metros Movums.
                    </div>
                `;
            updateSaldoDisponibleText();
            recalculateDescuento();
        }

        function renderKmError(message) {
            if (!kmContainer) return;
            kmCreditoDisponible = 0;
            kmContainer.innerHTML = `
                    <div class="alert alert-warning shadow-sm">
                        <i class="fas fa-exclamation-triangle me-2"></i> ${message}
                    </div>
                `;
            updateSaldoDisponibleText();
            recalculateDescuento();
        }

        function renderKilometrosBanner(payload) {
            if (!kmContainer) { return; }
            if (!payload) {
                renderDefaultKmBanner();
                return;
            }
            if (payload.participa === false) {
                kmCreditoDisponible = 0;
                kmContainer.innerHTML = `
                        <div class="alert alert-secondary shadow-sm">
                            <i class="fas fa-ban me-2"></i> ${payload.cliente} no participa en el programa Kil√≥metros Movums.
                        </div>
                    `;
                updateSaldoDisponibleText();
                recalculateDescuento();
                return;
            }

            const kmDisponibles = toNumber(payload.disponible);
            const valorEquivalente = toNumber(payload.valor_equivalente);

            if (kmDisponibles <= 0 || valorEquivalente <= 0) {
                kmCreditoDisponible = 0;
                kmContainer.innerHTML = `
                        <div class="alert alert-primary shadow-sm">
                            <div class="d-flex justify-content-between align-items-center flex-wrap">
                                <div>
                                    <h5 class="mb-1 text-primary">
                                        <i class="fas fa-star me-2"></i> ${payload.cliente}
                                    </h5>
                                    <p class="mb-0 text-muted small">Cliente nuevo en Kil√≥metros Movums.</p>
                                </div>
                                <div class="text-end">
                                    <p class="mb-0 fw-bold text-success">¬°Bienvenido!</p>
                                    <small class="text-muted">A√∫n no tiene saldo disponible.</small>
                                </div>
                            </div>
                        </div>
                    `;
                updateSaldoDisponibleText();
                recalculateDescuento();
                return;
            }

            const valorKm = kmConfig ? kmConfig.valorKm.toFixed(2) : '0.05';
            const maxRedencion = kmConfig ? kmConfig.maxRedencion.toFixed(0) : '10';
            kmCreditoDisponible = Math.max(0, valorEquivalente);

            kmContainer.innerHTML = `
                    <div class="alert alert-info shadow-sm">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <div>
                                <h5 class="mb-1 text-primary">
                                    <i class="fas fa-route me-2"></i>Saldo Kil√≥metros Movums de ${payload.cliente}
                                </h5>
                                <p class="mb-0 text-muted small">
                                    1 km = $${valorKm} MXN ¬∑ M√°x redenci√≥n: ${maxRedencion}% del valor de la venta
                                </p>
                            </div>
                            <div class="text-end">
                                <p class="mb-0 fw-bold">${numberFormatter.format(kmDisponibles)} km disponibles</p>
                                <small class="text-muted">‚âà ${currencyFormatter.format(valorEquivalente)} MXN aplicables</small>
                            </div>
                        </div>
                    </div>
                `;
            updateSaldoDisponibleText();
            recalculateDescuento();
        }

        function fetchKilometrosCliente(clienteId) {
            if (!kmContainer || !kmConfig || !kmConfig.apiTemplate) {
                console.warn('Configuraci√≥n de kil√≥metros no disponible');
                return;
            }
            if (!clienteId || clienteId === '' || clienteId === '0') {
                renderDefaultKmBanner();
                return;
            }
            const endpoint = kmConfig.apiTemplate.replace('/0/', `/${clienteId}/`);
            if (!endpoint || endpoint === kmConfig.apiTemplate) {
                console.error('No se pudo construir el endpoint de kil√≥metros');
                renderKmError('Error en la configuraci√≥n del endpoint de Kil√≥metros.');
                return;
            }
            kmContainer.classList.add('opacity-50');
            fetch(endpoint, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                },
                credentials: 'same-origin'
            }).then(response => {
                if (!response.ok) {
                    // Intentar leer el mensaje de error del JSON si est√° disponible
                    return response.json().then(errData => {
                        throw new Error(errData.message || `Error ${response.status}: ${response.statusText}`);
                    }).catch(() => {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    });
                }
                return response.json();
            }).then(data => {
                if (data && data.success === true && data.data) {
                    renderKilometrosBanner(data.data);
                } else {
                    renderKmError(data?.message || 'No se pudo obtener el saldo de Kil√≥metros.');
                }
            }).catch(error => {
                console.error('Error al obtener kil√≥metros:', error);
                renderKmError(error.message || 'No se pudo obtener el saldo de Kil√≥metros.');
            }).finally(() => {
                kmContainer.classList.remove('opacity-50');
            });
        }

        $('#id_cliente').on('change', function () {
            const clienteId = $(this).val();
            if (!clienteId) {
                renderDefaultKmBanner();
                return;
            }
            fetchKilometrosCliente(clienteId);
        });

        if (kmContainer && !kmContainer.querySelector('.alert-info') && kmConfig && kmConfig.clienteInicial) {
            fetchKilometrosCliente(kmConfig.clienteInicial);
        } else {
            updateSaldoDisponibleText();
        }

        const serviciosCollapse = document.getElementById('serviciosCollapse');
        const serviciosIcon = document.getElementById('serviciosIcon');

        if (serviciosCollapse && serviciosIcon) {
            serviciosCollapse.addEventListener('show.bs.collapse', function () {
                serviciosIcon.classList.remove('fa-chevron-down');
                serviciosIcon.classList.add('fa-chevron-up');
            });

            serviciosCollapse.addEventListener('hide.bs.collapse', function () {
                serviciosIcon.classList.remove('fa-chevron-up');
                serviciosIcon.classList.add('fa-chevron-down');
            });
        }

        function actualizarProveedores() {
            const checkboxes = document.querySelectorAll('input[name="servicios_seleccionados"]:checked');
            const proveedoresSection = document.getElementById('proveedoresSection');
            const proveedorWrappers = document.querySelectorAll('.proveedor-field-wrapper');

            const serviciosSeleccionados = Array.from(checkboxes).map(cb => cb.value);

            console.log('Servicios seleccionados:', serviciosSeleccionados);
            console.log('Campos de proveedor encontrados:', proveedorWrappers.length);

            const servicioToFieldMap = {
                'Vuelo': 'proveedor_vuelo',
                'Hospedaje': 'proveedor_hospedaje',
                'Alojamiento Alterno': 'proveedor_alojamiento_alterno',
                'Traslado': 'proveedor_traslado',
                'Tour y Actividades': 'proveedor_tour_y_actividades',
                'Circuito Internacional': 'proveedor_circuito_internacional',
                'Renta de Auto': 'proveedor_renta_de_auto',
                'Paquete': 'proveedor_paquete',
                'Crucero': 'proveedor_crucero',
                'Seguro de Viaje': 'proveedor_seguro_de_viaje',
                'Tr√°mites de Documentaci√≥n': 'proveedor_tr√°mites_de_documentaci√≥n',
                'Otros Servicios': 'proveedor_otros_servicios'
            };

            // Ocultar todos los wrappers de proveedores
            proveedorWrappers.forEach(wrapper => {
                wrapper.style.display = 'none';
            });

            let hayProveedores = false;
            serviciosSeleccionados.forEach(servicioNombre => {
                let wrapper = document.querySelector(`.proveedor-field-wrapper[data-servicio="${servicioNombre}"]`);

                if (!wrapper) {
                    wrapper = document.querySelector(`.proveedor-field-wrapper[data-servicio=" ${servicioNombre}"]`);
                }

                if (!wrapper) {
                    const allWrappers = document.querySelectorAll('.proveedor-field-wrapper');
                    allWrappers.forEach(w => {
                        const dataServicio = w.getAttribute('data-servicio');
                        if (dataServicio && dataServicio.trim() === servicioNombre) {
                            wrapper = w;
                        }
                    });
                }

                if (!wrapper && servicioToFieldMap[servicioNombre]) {
                    wrapper = document.querySelector(`.proveedor-field-wrapper[data-field-name="${servicioToFieldMap[servicioNombre]}"]`);
                }

                console.log(`Buscando campo para servicio: ${servicioNombre}`, wrapper);
                if (wrapper) {
                    const dataServicio = wrapper.getAttribute('data-servicio');
                    if (dataServicio && dataServicio.trim() !== dataServicio) {
                        wrapper.setAttribute('data-servicio', dataServicio.trim());
                    }

                    wrapper.style.display = 'block';
                    wrapper.style.visibility = 'visible';
                    wrapper.style.opacity = '1';
                    wrapper.style.position = 'relative';
                    wrapper.style.zIndex = '1';
                    wrapper.removeAttribute('hidden');
                    hayProveedores = true;
                    
                    // Actualizar visibilidad del campo de opci√≥n seg√∫n el proveedor seleccionado
                    actualizarCampoOpcionProveedor(wrapper);
                    
                    console.log(`Campo mostrado para: ${servicioNombre}`, wrapper);
                } else {
                    console.warn(`No se encontr√≥ campo para servicio: ${servicioNombre}`);
                }
            });

            if (hayProveedores && proveedoresSection) {
                proveedoresSection.style.display = 'block';
                proveedoresSection.style.visibility = 'visible';
                proveedoresSection.style.opacity = '1';
                proveedoresSection.style.position = 'relative';
                proveedoresSection.removeAttribute('hidden');
                console.log('Secci√≥n de proveedores mostrada', proveedoresSection);
            } else if (proveedoresSection) {
                proveedoresSection.style.display = 'none';
                console.log('Secci√≥n de proveedores oculta');
            }
        }

        // Funci√≥n para mostrar/ocultar el campo de opci√≥n cuando se selecciona un proveedor
        function actualizarCampoOpcionProveedor(wrapper) {
            const proveedorSelect = wrapper.querySelector('.proveedor-select');
            const opcionField = wrapper.querySelector('.proveedor-opcion-field');
            
            if (!proveedorSelect || !opcionField) {
                return;
            }
            
            // Funci√≥n para mostrar/ocultar seg√∫n el valor seleccionado
            function toggleOpcionField() {
                if (proveedorSelect.value && proveedorSelect.value !== '') {
                    opcionField.style.display = 'block';
                    opcionField.style.visibility = 'visible';
                } else {
                    opcionField.style.display = 'none';
                    const opcionInput = opcionField.querySelector('input');
                    if (opcionInput) {
                        opcionInput.value = ''; // Limpiar el valor cuando no hay proveedor seleccionado
                    }
                }
            }
            
            // Actualizar estado inicial
            toggleOpcionField();
            
            // Agregar listener si no existe
            if (!proveedorSelect.hasAttribute('data-opcion-listener')) {
                proveedorSelect.setAttribute('data-opcion-listener', 'true');
                proveedorSelect.addEventListener('change', toggleOpcionField);
            }
        }

        // Inicializar listeners para campos de opci√≥n de proveedor cuando se carga la p√°gina
        function inicializarCamposOpcionProveedor() {
            const proveedorWrappers = document.querySelectorAll('.proveedor-field-wrapper');
            proveedorWrappers.forEach(wrapper => {
                actualizarCampoOpcionProveedor(wrapper);
            });
        }

        // Funci√≥n para mostrar/ocultar el campo de tipo de tr√°mite
        function actualizarTipoTramite() {
            const tipoTramiteContainer = document.getElementById('tipoTramiteContainer');
            const tipoTramiteField = document.getElementById('id_tipo_tramite_documentacion');
            const tramitesCheckbox = document.querySelector('input[name="servicios_seleccionados"][value="Tr√°mites de Documentaci√≥n"]');

            if (tramitesCheckbox && tramitesCheckbox.checked && tipoTramiteContainer) {
                tipoTramiteContainer.style.display = 'block';
                if (tipoTramiteField) {
                    tipoTramiteField.required = true;
                }
            } else {
                tipoTramiteContainer.style.display = 'none';
                if (tipoTramiteField) {
                    tipoTramiteField.required = false;
                    tipoTramiteField.value = ''; // Limpiar el valor cuando se deselecciona
                }
            }
        }

        const servicioCheckboxes = document.querySelectorAll('input[name="servicios_seleccionados"]');
        console.log('Checkboxes de servicios encontrados:', servicioCheckboxes.length);
        servicioCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                console.log('Checkbox cambiado:', this.value, this.checked);
                actualizarProveedores();
                actualizarTipoTramite(); // Actualizar tambi√©n el campo de tipo de tr√°mite
            });
        });

        // Inicializar el estado del campo de tipo de tr√°mite al cargar la p√°gina
        setTimeout(function () {
            actualizarTipoTramite();
        }, 100);

        setTimeout(function () {
            actualizarProveedores();
            inicializarCamposOpcionProveedor();
        }, 100);

        // ===================== DEFINIR TODAS LAS VARIABLES PRIMERO =====================
        // Variables para c√°lculos de descuentos y totales
        const costoNetoInput = document.getElementById('id_costo_neto');
        const costoVentaInput = document.getElementById('id_costo_venta_final');
        const costoModInputEl = document.getElementById('id_costo_modificacion');
        const descuentoCheckbox = document.getElementById('id_aplica_descuento_kilometros');
        const descuentoHidden = document.getElementById('id_descuento_kilometros_mxn');
        const subtotalLabel = document.getElementById('subtotalVenta');
        const descuentoLabel = document.getElementById('descuentoCalculado');
        const totalLabel = document.getElementById('totalConDescuento');
        
        // Variables para promociones (definir aqu√≠ para que est√©n disponibles en todas las funciones)
        const promoContainer = document.getElementById('promoPreviewContainer');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        const clienteSelectEl = document.getElementById('id_cliente');
        const tipoViajeSelectEl = document.getElementById('id_tipo_viaje');
        
        // Variable global para almacenar el descuento de promociones
        if (typeof window.totalDescuentoPromociones === 'undefined') {
            window.totalDescuentoPromociones = 0;
        }

        function recalculateDescuento() {
            // Usar costo_venta_final para calcular el descuento (10% sobre el total de la venta)
            const costoVenta = costoVentaInput ? toNumber(costoVentaInput.value) : 0;
            const aplica = descuentoCheckbox && descuentoCheckbox.checked && costoVenta > 0;
            // Calcular el 10% sobre el costo VENTA FINAL (total)
            const maxPorRegla = Math.round(costoVenta * 10) / 100;
            const maxPorCredito = Math.max(0, kmCreditoDisponible || 0);
            const descuentoAplicable = Math.min(maxPorRegla, maxPorCredito);
            const descuento = aplica ? descuentoAplicable : 0;

            if (descuentoHidden) {
                descuentoHidden.value = descuento.toFixed(2);
            }
            if (subtotalLabel) {
                subtotalLabel.textContent = `${currencyFormatter.format(costoVenta)} MXN`;
            }
            if (descuentoLabel) {
                const formatted = currencyFormatter.format(descuento);
                if (aplica && descuento > 0) {
                    descuentoLabel.textContent = `-${formatted} MXN`;
                } else {
                    descuentoLabel.textContent = `${formatted} MXN`;
                }
            }
            if (totalLabel) {
                const total = Math.max(0, costoVenta - descuento);
                totalLabel.textContent = `${currencyFormatter.format(total)} MXN`;
            }
            
            // Actualizar el resumen total que incluye ambos descuentos
            // Usar setTimeout para asegurar que updateTotalFinal est√© definida
            setTimeout(function() {
                if (typeof updateTotalFinal === 'function') {
                    updateTotalFinal();
                }
            }, 0);
        }
        
        // Funci√≥n para actualizar el total final considerando ambos descuentos
        function updateTotalFinal() {
            // 1. Obtener valores base (usando toNumber para limpiar formato)
            const costoVenta = costoVentaInput ? toNumber(costoVentaInput.value || '0') : 0;
            const costoMod = costoModInputEl ? toNumber(costoModInputEl.value || '0') : 0;
            const baseTotal = costoVenta + costoMod;
            
            // 2. Obtener descuento de kil√≥metros movums
            const aplicaKm = descuentoCheckbox && descuentoCheckbox.checked && costoVenta > 0;
            const maxPorRegla = Math.round(costoVenta * 10) / 100;
            const maxPorCredito = Math.max(0, kmCreditoDisponible || 0);
            const descuentoKm = aplicaKm ? Math.min(maxPorRegla, maxPorCredito) : 0;
            
            // 3. Obtener descuento de promociones (de window.totalDescuentoPromociones)
            // Verificar tambi√©n si hay un radio button seleccionado (por si acaso)
            let descuentoPromos = window.totalDescuentoPromociones || 0;
            
            // Verificar si hay un radio button seleccionado y obtener su monto
            const radioSeleccionado = document.querySelector('.promo-radio:checked');
            if (radioSeleccionado) {
                const montoRadio = parseFloat(radioSeleccionado.getAttribute('data-monto') || '0');
                if (montoRadio > 0) {
                    descuentoPromos = montoRadio;
                    // Sincronizar window.totalDescuentoPromociones
                    window.totalDescuentoPromociones = montoRadio;
                }
            }
            
            console.log('updateTotalFinal - descuentoPromos:', descuentoPromos, 'window.totalDescuentoPromociones:', window.totalDescuentoPromociones);
            
            // 4. Calcular totales
            const totalDescuentos = descuentoKm + descuentoPromos;
            const totalFinal = Math.max(0, baseTotal - totalDescuentos);
            
            // 5. Crear/actualizar resumen unificado al final del formulario
            let resumenContainer = document.getElementById('resumenDescuentosTotal');
            if (!resumenContainer) {
                // Crear el contenedor si no existe
                resumenContainer = document.createElement('div');
                resumenContainer.id = 'resumenDescuentosTotal';
                resumenContainer.className = 'card p-4 shadow-sm border-success mb-4';
                
                // Insertar justo antes de la secci√≥n de botones
                const ventaForm = document.getElementById('ventaForm');
                if (ventaForm) {
                    // Buscar el div que contiene los botones (tiene clase "d-flex justify-content-between mt-4")
                    const buttonSection = ventaForm.querySelector('.d-flex.justify-content-between.mt-4');
                    if (buttonSection && buttonSection.parentElement) {
                        // Insertar antes de la secci√≥n de botones
                        buttonSection.parentElement.insertBefore(resumenContainer, buttonSection);
                    } else {
                        // Fallback: buscar el bot√≥n de submit y su contenedor
                        const submitButton = ventaForm.querySelector('button[type="submit"]');
                        if (submitButton) {
                            let buttonContainer = submitButton.closest('.d-flex');
                            if (!buttonContainer) {
                                buttonContainer = submitButton.parentElement;
                            }
                            if (buttonContainer && buttonContainer.parentElement) {
                                buttonContainer.parentElement.insertBefore(resumenContainer, buttonContainer);
                            } else {
                                ventaForm.insertBefore(resumenContainer, submitButton);
                            }
                        } else {
                            // √öltimo fallback: insertar antes del cierre del form
                            ventaForm.insertBefore(resumenContainer, ventaForm.lastElementChild);
                        }
                    }
                }
            }
            
            // Construir HTML del resumen
            resumenContainer.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-calculator me-2 text-success"></i>Resumen de Descuentos</h5>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6 mb-3 mb-md-0">
                        <p class="text-muted small mb-1">Subtotal venta</p>
                        <h4 class="fw-bold text-secondary mb-0">${currencyFormatter.format(baseTotal)} MXN</h4>
                    </div>
                    <div class="col-md-6">
                        <p class="text-muted small mb-1">Total final</p>
                        <h4 class="fw-bold text-success mb-0">${currencyFormatter.format(totalFinal)} MXN</h4>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">Descuento Promociones:</span>
                            <span class="fw-semibold ${descuentoPromos > 0 ? 'text-danger' : 'text-muted'}">-${currencyFormatter.format(descuentoPromos)} MXN</span>
                        </div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">Descuento Kil√≥metros Movums:</span>
                            <span class="fw-semibold ${descuentoKm > 0 ? 'text-danger' : 'text-muted'}">-${currencyFormatter.format(descuentoKm)} MXN</span>
                        </div>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-top">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold">Total descuentos:</span>
                        <h5 class="fw-bold text-danger mb-0">-${currencyFormatter.format(totalDescuentos)} MXN</h5>
                    </div>
                </div>
            `;
        }

        // Escuchar cambios en costo_neto (para calcular descuento) y costo_venta_final (para mostrar total)
        if (costoNetoInput) {
            costoNetoInput.addEventListener('input', recalculateDescuento);
        }
        if (costoVentaInput) {
            costoVentaInput.addEventListener('input', recalculateDescuento);
        }

        // ========== L√ìGICA PARA VENTAS INTERNACIONALES (USD) ==========
        const tipoViajeSelect = document.getElementById('id_tipo_viaje');
        const seccionVentaInternacional = document.getElementById('seccionVentaInternacional');
        const tarifaBaseUsdInput = document.getElementById('id_tarifa_base_usd');
        const impuestosUsdInput = document.getElementById('id_impuestos_usd');
        const suplementosUsdInput = document.getElementById('id_suplementos_usd');
        const toursUsdInput = document.getElementById('id_tours_usd');
        const tipoCambioInput = document.getElementById('id_tipo_cambio');
        const totalUsdCalculado = document.getElementById('totalUsdCalculado');
        const costoNetoLabel = costoNetoInput ? costoNetoInput.closest('.mb-3').querySelector('label') : null;
        const costoVentaLabel = costoVentaInput ? costoVentaInput.closest('.mb-3').querySelector('label') : null;

        function toggleSeccionInternacional() {
            const esInternacional = tipoViajeSelect && tipoViajeSelect.value === 'INT';
            if (seccionVentaInternacional) {
                seccionVentaInternacional.style.display = esInternacional ? 'block' : 'none';
            }
            // Ocultar/mostrar secci√≥n de Kil√≥metros Movums
            const descuentoKilometrosCard = document.getElementById('descuentoKilometrosCard');
            if (descuentoKilometrosCard) {
                descuentoKilometrosCard.style.display = esInternacional ? 'none' : 'block';
            }
            // Cambiar labels y s√≠mbolos de moneda cuando es internacional
            const cantidadAperturaInput = document.getElementById('id_cantidad_apertura');
            const labelCantidadApertura = document.getElementById('labelCantidadApertura');
            const helpTextApertura = document.getElementById('helpTextApertura');

            const labelCostoNeto = document.getElementById('labelCostoNeto');
            const helpTextCostoNeto = document.getElementById('helpTextCostoNeto');

            if (esInternacional) {
                if (costoVentaLabel) {
                    const originalText = costoVentaLabel.textContent.replace(' *', '').replace(' (MXN - Calculado desde USD)', '');
                    costoVentaLabel.innerHTML = originalText + ' (MXN - Calculado desde USD)<span class="text-danger">*</span>';
                }
                // Costo Neto: se ingresa en USD, se convertir√° a MXN al guardar
                if (labelCostoNeto) {
                    labelCostoNeto.innerHTML = 'Costo Neto (USD)';
                }
                if (helpTextCostoNeto) {
                    helpTextCostoNeto.textContent = 'Ingresa el costo neto en d√≥lares americanos (USD). Se convertir√° autom√°ticamente a MXN al guardar.';
                }
                // Cambiar s√≠mbolo de moneda en costo_neto a USD
                // Nota: Los s√≠mbolos de moneda ahora los maneja el JavaScript de formateo autom√°tico
                if (labelCantidadApertura) {
                    labelCantidadApertura.innerHTML = 'Cantidad de Apertura (USD)';
                }
                if (helpTextApertura) {
                    helpTextApertura.textContent = 'Cantidad de apertura en d√≥lares americanos (se convertir√° a MXN al guardar)';
                }
            } else {
                // Mostrar secci√≥n de Kil√≥metros Movums para ventas nacionales
                if (descuentoKilometrosCard) {
                    descuentoKilometrosCard.style.display = 'block';
                }

                if (costoVentaLabel) {
                    costoVentaLabel.innerHTML = costoVentaLabel.textContent.replace(' (MXN - Calculado desde USD)', '');
                }
                // Restaurar label de costo neto
                if (labelCostoNeto) {
                    labelCostoNeto.innerHTML = 'Costo Neto';
                }
                if (helpTextCostoNeto) {
                    helpTextCostoNeto.textContent = 'Costo real del viaje para la agencia.';
                }
                // Restaurar s√≠mbolo de moneda
                // Nota: Los s√≠mbolos de moneda ahora los maneja el JavaScript de formateo autom√°tico
                if (labelCantidadApertura) {
                    labelCantidadApertura.innerHTML = 'Cantidad de Apertura/Anticipo';
                }
                if (helpTextApertura) {
                    helpTextApertura.textContent = 'Cantidad de apertura o anticipo';
                }
            }
        }

        function calcularTotalUsd() {
            if (!totalUsdCalculado) return;
            const tarifaBase = toNumber(tarifaBaseUsdInput ? tarifaBaseUsdInput.value : 0);
            const impuestos = toNumber(impuestosUsdInput ? impuestosUsdInput.value : 0);
            const suplementos = toNumber(suplementosUsdInput ? suplementosUsdInput.value : 0);
            const tours = toNumber(toursUsdInput ? toursUsdInput.value : 0);
            const totalUsd = tarifaBase + impuestos + suplementos + tours;
            totalUsdCalculado.value = totalUsd.toFixed(2);
        }

        function convertirUsdAMxn() {
            if (!tipoViajeSelect || tipoViajeSelect.value !== 'INT') return;
            const tipoCambio = toNumber(tipoCambioInput ? tipoCambioInput.value : 0);
            if (tipoCambio <= 0) return;

            const tarifaBase = toNumber(tarifaBaseUsdInput ? tarifaBaseUsdInput.value : 0);
            const impuestos = toNumber(impuestosUsdInput ? impuestosUsdInput.value : 0);
            const suplementos = toNumber(suplementosUsdInput ? suplementosUsdInput.value : 0);
            const tours = toNumber(toursUsdInput ? toursUsdInput.value : 0);
            const totalUsd = tarifaBase + impuestos + suplementos + tours;
            const totalMxn = totalUsd * tipoCambio;

            // Actualizar solo costo_venta_final en MXN (costo_neto se llena manualmente)
            if (costoVentaInput && costoVentaInput.value == 0) {
                costoVentaInput.value = totalMxn.toFixed(2);
            }
            // NO actualizar costo_neto autom√°ticamente - el vendedor lo llena manualmente

            // Recalcular descuento si aplica
            recalculateDescuento();
        }

        // Event listeners
        if (tipoViajeSelect) {
            tipoViajeSelect.addEventListener('change', function () {
                toggleSeccionInternacional();
                if (this.value !== 'INT') {
                    // Limpiar campos USD cuando no es internacional
                    if (tarifaBaseUsdInput) tarifaBaseUsdInput.value = '';
                    if (impuestosUsdInput) impuestosUsdInput.value = '';
                    if (suplementosUsdInput) suplementosUsdInput.value = '';
                    if (toursUsdInput) toursUsdInput.value = '';
                    if (tipoCambioInput) tipoCambioInput.value = '';
                    if (totalUsdCalculado) totalUsdCalculado.value = '0.00';
                }
            });
            // Inicializar al cargar
            toggleSeccionInternacional();
        }

        // Calcular total USD cuando cambien los campos
        [tarifaBaseUsdInput, impuestosUsdInput, suplementosUsdInput, toursUsdInput].forEach(input => {
            if (input) {
                input.addEventListener('input', function () {
                    calcularTotalUsd();
                    convertirUsdAMxn();
                });
            }
        });

        // Convertir a MXN cuando cambie el tipo de cambio
        if (tipoCambioInput) {
            tipoCambioInput.addEventListener('input', function () {
                convertirUsdAMxn();
            });
        }
        if (descuentoCheckbox) {
            descuentoCheckbox.addEventListener('change', recalculateDescuento);
        }
        recalculateDescuento();

        // Agregar separador en las opciones originales del select
        // Agregar separador de forma segura
        function agregarSeparadorSelect() {
            const selectCliente = document.getElementById('id_cliente');
            if (!selectCliente) return;
            
            // 1. Limpiar previos
            Array.from(selectCliente.options).forEach(function(option) {
                if (option.textContent && option.textContent.includes('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ EMPRESAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ')) {
                    option.remove();
                }
            });
            
            // 2. Buscar primera empresa
            let primeraEmpresa = null;
            Array.from(selectCliente.options).forEach(function(option) {
                if (!primeraEmpresa && option.textContent && option.textContent.includes('üè¢')) {
                    primeraEmpresa = option;
                }
            });
            
            // 3. Insertar SOLO si la estructura es v√°lida
            if (primeraEmpresa && primeraEmpresa.parentNode === selectCliente) {
                const separador = document.createElement('option');
                separador.disabled = true;
                separador.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ EMPRESAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
                selectCliente.insertBefore(separador, primeraEmpresa);
            }
        }

        // Ejecutar despu√©s de que Select2 se inicialice
        setTimeout(agregarSeparadorSelect, 100);

        // ===================== PREVIEW PROMOS EN TIEMPO REAL =====================
        // Nota: Las variables ya est√°n definidas arriba

        async function fetchPromosPreview() {
            if (!promoContainer) {
                console.warn('promoContainer no encontrado');
                return;
            }
            
            // Obtener valores y limpiarlos
            const clienteId = clienteSelectEl?.value;
            const tipoViaje = tipoViajeSelectEl?.value;
            
            // Limpiar formato de moneda antes de enviar
            const costoRaw = costoVentaInput?.value || '0';
            const costoModRaw = costoModInputEl?.value || '0';
            const costo = toNumber(costoRaw).toFixed(2);
            const costoMod = toNumber(costoModRaw).toFixed(2);
            
            console.log('fetchPromosPreview - clienteId:', clienteId, 'tipoViaje:', tipoViaje, 'costo:', costo, 'costoMod:', costoMod);
            
            if (!clienteId || clienteId === '' || clienteId === '0' || !tipoViaje || tipoViaje === '') {
                console.log('Faltan par√°metros requeridos, limpiando promociones');
                promoContainer.innerHTML = '';
                window.totalDescuentoPromociones = 0;
                if (typeof updateTotalFinal === 'function') {
                    updateTotalFinal();
                }
                return;
            }
            
            const formData = new FormData();
            formData.append('cliente_id', clienteId.toString());
            formData.append('tipo_viaje', tipoViaje.toString());
            formData.append('costo_venta_final', costo);
            formData.append('costo_modificacion', costoMod);
            
            console.log('Enviando petici√≥n a preview_promociones con:', {
                cliente_id: clienteId,
                tipo_viaje: tipoViaje,
                costo_venta_final: costo,
                costo_modificacion: costoMod
            });
            
            try {
                const resp = await fetch("{% url 'preview_promociones' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken || '',
                    },
                    body: formData
                });
                
                console.log('Respuesta recibida, status:', resp.status);
                if (!resp.ok) {
                    const errorText = await resp.text();
                    console.error('Error en respuesta:', resp.status, errorText);
                    promoContainer.innerHTML = `<div class="alert alert-warning">Error al obtener promociones: ${resp.status}</div>`;
                    window.totalDescuentoPromociones = 0;
                    if (typeof updateTotalFinal === 'function') {
                        updateTotalFinal();
                    }
                    return;
                }
                
                const data = await resp.json();
                console.log('Datos recibidos del backend:', data);
                
                if (!data.ok) {
                    console.warn('Backend devolvi√≥ ok: false', data);
                    promoContainer.innerHTML = '';
                    window.totalDescuentoPromociones = 0;
                    if (typeof updateTotalFinal === 'function') {
                        updateTotalFinal();
                    }
                    return;
                }
                
                if (!data.promos || data.promos.length === 0) {
                    console.log('No hay promociones aplicables');
                    promoContainer.innerHTML = '';
                    window.totalDescuentoPromociones = 0;
                    if (typeof updateTotalFinal === 'function') {
                        updateTotalFinal();
                    }
                    return;
                }
                
                console.log('Promociones encontradas:', data.promos.length, data.promos);
                // Validar promociones personales en frontend
                let promosValidas = [];
                data.promos.forEach(p => {
                    promosValidas.push(p);
                });
                
                let html = `
                      <div class="card p-3 shadow-sm border-primary-subtle mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <div>
                            <h6 class="mb-0">Promociones aplicables</h6>
                            <small class="text-muted">Selecciona UNA promoci√≥n para aplicar. Puedes combinarla con el descuento de Kil√≥metros Movums.</small>
                          </div>
                        </div>`;
                
                if (promosValidas.length > 1) {
                    html += `<div class="alert alert-warning mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Hay ${promosValidas.length} promociones aplicables.</strong> Solo puedes seleccionar una. Elige la que ofrezca el mejor descuento.
                    </div>`;
                }
                
                html += `<div class="list-group">`;
                promosValidas.forEach((p, index) => {
                    const isDesc = p.tipo === 'DESCUENTO';
                    const isPersonal = p.alcance === 'CLIENTE_ESPECIFICO';
                    const montoDesc = parseFloat(p.monto_descuento || '0');
                    html += `<div class="list-group-item">
                        <div class="form-check">
                          <input class="form-check-input promo-radio" type="radio" 
                                 name="promocion_seleccionada" 
                                 id="promo_radio_${p.id}" 
                                 value="${p.id}"
                                 data-monto="${montoDesc}"
                                 ${index === 0 ? 'checked' : ''}>
                          <label class="form-check-label w-100" for="promo_radio_${p.id}">
                            <div class="fw-semibold">
                              ${p.nombre}
                              ${isPersonal ? '<span class="badge bg-info text-white ms-2">Personal</span>' : ''}
                            </div>
                            <div class="small text-muted">`;
                    if (isDesc) {
                        html += `${parseFloat(p.porcentaje || '0').toFixed(2)}% de descuento (-$${montoDesc.toFixed(2)})`;
                    } else {
                        html += `+${parseFloat(p.km_bono || '0').toFixed(0)} km Movums`;
                    }
                    html += ` ‚Ä¢ Condici√≥n: ${p.condicion}`;
                    if (p.requiere_confirmacion) {
                        html += ` ‚Ä¢ <span class="text-warning">Requiere confirmaci√≥n</span>`;
                    }
                    html += `</div></label></div></div>`;
                });
                html += `</div></div>`;
                promoContainer.innerHTML = html;
                
                // Inicializar descuento con la primera promoci√≥n (si est√° seleccionada)
                const primeraPromo = promosValidas[0];
                if (primeraPromo && primeraPromo.tipo === 'DESCUENTO') {
                    const montoInicial = parseFloat(primeraPromo.monto_descuento || '0');
                    window.totalDescuentoPromociones = montoInicial;
                    console.log('Promoci√≥n inicial seleccionada:', primeraPromo.nombre, 'Monto:', montoInicial);
                } else {
                    window.totalDescuentoPromociones = 0;
                    console.log('No hay promoci√≥n de descuento inicial');
                }
                
                // Agregar event listeners a los radio buttons (usar setTimeout para asegurar que el DOM est√© listo)
                setTimeout(function() {
                    document.querySelectorAll('.promo-radio').forEach(radio => {
                        // Remover listeners previos para evitar duplicados
                        const newRadio = radio.cloneNode(true);
                        radio.parentNode.replaceChild(newRadio, radio);
                        
                        newRadio.addEventListener('change', function() {
                            if (this.checked) {
                                const monto = parseFloat(this.getAttribute('data-monto') || '0');
                                window.totalDescuentoPromociones = monto;
                                console.log('Promoci√≥n seleccionada, monto:', monto);
                                if (typeof updateTotalFinal === 'function') {
                                    updateTotalFinal();
                                }
                            }
                        });
                        
                        // Si est√° marcado inicialmente, disparar el evento para actualizar
                        if (newRadio.checked) {
                            const monto = parseFloat(newRadio.getAttribute('data-monto') || '0');
                            window.totalDescuentoPromociones = monto;
                            console.log('Promoci√≥n inicial marcada, monto:', monto);
                        }
                    });
                }, 100);
                
                // Llamar a updateTotalFinal despu√©s de actualizar las promociones
                setTimeout(function() {
                    if (typeof updateTotalFinal === 'function') {
                        console.log('Llamando updateTotalFinal, descuento promos:', window.totalDescuentoPromociones);
                        updateTotalFinal();
                    }
                }, 200);
            } catch (e) {
                console.error('Error al obtener promociones:', e);
                promoContainer.innerHTML = `<div class="alert alert-danger">Error al cargar promociones: ${e.message}</div>`;
                window.totalDescuentoPromociones = 0;
                if (typeof updateTotalFinal === 'function') {
                    updateTotalFinal();
                }
            }
        }

        function debounce(fn, delay) {
            let t;
            return function (...args) {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        const debouncedFetch = debounce(fetchPromosPreview, 400);
        if (clienteSelectEl) {
            clienteSelectEl.addEventListener('change', fetchPromosPreview);
        }
        if (tipoViajeSelectEl) {
            tipoViajeSelectEl.addEventListener('change', fetchPromosPreview);
        }
        if (costoVentaInput) {
            costoVentaInput.addEventListener('input', function() {
                debouncedFetch();
                if (typeof updateTotalFinal === 'function') {
                    updateTotalFinal();
                }
            });
        }
        if (costoModInputEl) {
            costoModInputEl.addEventListener('input', function() {
                debouncedFetch();
                if (typeof updateTotalFinal === 'function') {
                    updateTotalFinal();
                }
            });
        }
        
        // Inicializar promociones y resumen al cargar la p√°gina
        function inicializarPromocionesYResumen() {
            // Verificar que todos los elementos necesarios est√©n disponibles
            if (!promoContainer) {
                console.warn('promoPreviewContainer no encontrado, reintentando...');
                setTimeout(inicializarPromocionesYResumen, 200);
                return;
            }
            
            if (clienteSelectEl && clienteSelectEl.value && tipoViajeSelectEl && tipoViajeSelectEl.value) {
                console.log('Inicializando promociones con cliente y tipo de viaje existentes');
                fetchPromosPreview();
            }
            
            // Inicializar resumen
            setTimeout(function() {
                if (typeof updateTotalFinal === 'function') {
                    updateTotalFinal();
                }
            }, 300);
        }
        
        // Esperar a que el DOM est√© completamente listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(inicializarPromocionesYResumen, 500);
            });
        } else {
            setTimeout(inicializarPromocionesYResumen, 500);
        }
        
        // Tambi√©n llamar cuando cambie el cliente (para actualizar el resumen)
        if (clienteSelectEl) {
            // Ya hay un listener para fetchPromosPreview, agregar uno adicional para updateTotalFinal
            clienteSelectEl.addEventListener('change', function() {
                setTimeout(function() {
                    if (typeof updateTotalFinal === 'function') {
                        updateTotalFinal();
                    }
                }, 300);
            });
        }
        
        // Inicializar resumen al cargar completamente la p√°gina
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (typeof updateTotalFinal === 'function') {
                    updateTotalFinal();
                }
            }, 800);
        });

        // --- DEBUG PROBE ANTIGRAVITY ---
        // Este bloque imprime en la consola los datos que llegan desde el servidor (Sesi√≥n)
        console.group("üîç DIAGN√ìSTICO DE SESI√ìN (ANTIGRAVITY)");
        const debugSession = {
            'total_cotizacion': "{{ request.session.cotizacion_convertir.total_cotizacion|default:'NO DATA' }}",
            'opcion_vuelo_index': "{{ request.session.cotizacion_convertir.opcion_vuelo_index|default:'NO DATA' }}",
            'conv_slug': "{{ request.session.cotizacion_convertir.cotizacion_slug|default:'NO DATA' }}",
            'url_param_slug': "{{ request.GET.cotizacion|default:'NO PARAM' }}"
        };
        console.table(debugSession);

        if (debugSession.opcion_vuelo_index !== 'NO DATA' && debugSession.total_cotizacion === 'NO DATA') {
            console.error("‚ö†Ô∏è ALERTA: Tenemos √≠ndice seleccionado pero NO hay total guardado. El fallo est√° en CotizacionConvertirView (Backend).");
        } else if (debugSession.opcion_vuelo_index === '0' || debugSession.opcion_vuelo_index === 0) {
            console.warn("‚ö†Ô∏è AVISO: El √≠ndice en sesi√≥n es 0. ¬øSeleccionaste la opci√≥n 1 o fall√≥ la captura?");
        } else {
            console.log("‚úÖ DATOS DE SESI√ìN PARECEN CORRECTOS. Si el formulario muestra otro precio, es el formulario quien lo ignora.");
        }
        console.groupEnd();
        // -------------------------------
    });

    // Sincronizaci√≥n de fechas: fecha de regreso no puede ser anterior a fecha de ida
    const fechaInicioViaje = document.getElementById('id_fecha_inicio_viaje');
    const fechaFinViaje = document.getElementById('id_fecha_fin_viaje');

    if (fechaInicioViaje && fechaFinViaje) {
        // Guardar los valores iniciales para preservarlos
        const fechaInicioInicial = fechaInicioViaje.value;
        const fechaFinInicial = fechaFinViaje.value;

        // Funci√≥n para actualizar la fecha m√≠nima de regreso y pre-llenar si est√° vac√≠a
        function actualizarFechaMinimaRegreso(esCambioUsuario = false) {
            const fechaIda = fechaInicioViaje.value;
            if (fechaIda) {
                // Establecer la fecha m√≠nima de regreso como la fecha de ida
                fechaFinViaje.min = fechaIda;

                // Solo modificar valores si:
                // 1. El campo de regreso est√° vac√≠o Y es un cambio del usuario (no carga inicial)
                // 2. O si es un cambio del usuario y la fecha de regreso es anterior a la fecha de ida
                if (esCambioUsuario) {
                    if (!fechaFinViaje.value) {
                        // Solo pre-llenar si el usuario est√° cambiando la fecha de ida
                        fechaFinViaje.value = fechaIda;
                    } else if (fechaFinViaje.value < fechaIda) {
                        // Solo actualizar si la fecha de regreso es anterior a la fecha de ida
                        fechaFinViaje.value = fechaIda;
                    }
                }
                // Si no es un cambio del usuario (carga inicial), solo establecer el min sin modificar el valor
            }
        }

        // Restaurar valores iniciales si existen (para preservar fechas al editar)
        if (fechaInicioInicial && !fechaInicioViaje.value) {
            fechaInicioViaje.value = fechaInicioInicial;
        }
        if (fechaFinInicial && !fechaFinViaje.value) {
            fechaFinViaje.value = fechaFinInicial;
        }

        // Pre-llenar fecha de regreso con fecha de ida cuando se hace clic si est√° vac√≠a
        function prellenarFechaRegreso() {
            const fechaIda = fechaInicioViaje.value;
            // Si el campo de regreso est√° vac√≠o y hay una fecha de ida, pre-llenarlo
            if (!fechaFinViaje.value && fechaIda) {
                fechaFinViaje.value = fechaIda;
                actualizarFechaMinimaRegreso(true);
            }
        }

        // Usar tanto 'focus' como 'click' para mayor compatibilidad
        fechaFinViaje.addEventListener('focus', prellenarFechaRegreso);
        fechaFinViaje.addEventListener('click', prellenarFechaRegreso);

        // Ejecutar al cargar la p√°gina solo para establecer el min, sin modificar valores existentes
        if (fechaInicioViaje.value) {
            fechaFinViaje.min = fechaInicioViaje.value;
        }

        // Ejecutar cuando cambie la fecha de ida (solo cuando el usuario hace un cambio)
        fechaInicioViaje.addEventListener('change', function () {
            actualizarFechaMinimaRegreso(true);
        });
    }

    // ========== FORMATO DE MONEDA EN TIEMPO REAL ==========
    // Funciones de formateo (incluidas directamente para evitar problemas de carga)

    // Funci√≥n para limpiar el formato y obtener solo el n√∫mero (sin $ y sin comas)
    function limpiarFormatoMoneda(valor) {
        if (!valor) return '';
        // Remover $, comas y espacios, mantener solo n√∫meros y punto decimal
        return valor.toString().replace(/[^\d.]/g, '');
    }

    // Funci√≥n para formatear en tiempo real manteniendo la posici√≥n del cursor
    function formatearEnTiempoReal(input) {
        // 1. Guardar posici√≥n del cursor y contar d√≠gitos a su izquierda
        const cursorPosition = input.selectionStart;
        const originalValue = input.value;
        let digitsBeforeCursor = 0;
        for (let i = 0; i < cursorPosition; i++) {
            if (/[0-9]/.test(originalValue[i])) digitsBeforeCursor++;
        }
        // 2. Limpiar valor (quitar todo lo que no sea n√∫mero o punto)
        let value = input.value.replace(/[^0-9.]/g, '');

        // Si est√° vac√≠o, borrar y salir
        if (!value) {
            input.value = '';
            return;
        }
        // 3. Separar enteros y decimales para no forzar .00
        const parts = value.split('.');
        let integerPart = parts[0];
        let decimalPart = parts.length > 1 ? '.' + parts[1].substring(0, 2) : ''; // M√°ximo 2 decimales
        // 4. Formatear enteros con comas
        if (integerPart) {
            // Usar toLocaleString para las comas, pero asegurando base 10
            integerPart = parseInt(integerPart, 10).toLocaleString('es-MX');
        } else if (parts.length > 1) {
            // Si escribe ".50", asumimos "0.50"
            integerPart = '0';
        }
        // 5. Construir el nuevo valor final
        const newValue = '$' + integerPart + decimalPart;

        // Evitar re-asignar si no hubo cambios (evita parpadeos)
        if (input.value !== newValue) {
            input.value = newValue;
            // 6. Restaurar posici√≥n del cursor inteligente
            // Recorremos el nuevo valor buscando d√≥nde calzan nuestros "digitsBeforeCursor"
            let newCursorPos = 0;
            let digitsFound = 0;
            for (let i = 0; i < newValue.length; i++) {
                if (/[0-9]/.test(newValue[i])) {
                    digitsFound++;
                }
                if (digitsFound >= digitsBeforeCursor) {
                    // Si encontramos el d√≠gito, el cursor va justo despu√©s
                    // Ajuste especial: si el siguiente char es una coma o punto, avanzamos uno m√°s
                    newCursorPos = i + 1;
                    // Si acabamos de pasar el √∫ltimo d√≠gito deseado, paramos
                    if (digitsFound === digitsBeforeCursor) break;
                }
            }

            // Si el cursor estaba al inicio (antes de cualquier d√≠gito), ponerlo despu√©s del $
            if (digitsBeforeCursor === 0) newCursorPos = 1;

            input.setSelectionRange(newCursorPos, newCursorPos);
        }
    }

    // Funci√≥n para inicializar el formato de moneda en campos espec√≠ficos
    function inicializarFormatoMonedaEnCampos(selectores) {
        selectores.forEach(selector => {
            const campos = document.querySelectorAll(selector);
            campos.forEach(campo => {
                // Verificar si el campo ya tiene event listeners para evitar duplicados
                if (campo.hasAttribute('data-formato-inicializado')) return;

                campo.setAttribute('data-formato-inicializado', 'true');

                // Limpiar valores de 0 antes de formatear
                const valorLimpio = limpiarFormatoMoneda(campo.value);
                if (valorLimpio === '0' || valorLimpio === '0.00' || valorLimpio === '0.0') {
                    campo.value = '';
                } else if (campo.value && campo.value.trim() !== '' && !campo.value.startsWith('$')) {
                    // Formato inicial si ya tiene valor (y no es 0)
                    // Aplicar formato de moneda al valor inicial
                    formatearEnTiempoReal(campo);
                }

                // EVENTO CLAVE: 'input' para formatear mientras escribes
                campo.addEventListener('input', function () {
                    formatearEnTiempoReal(this);
                });

                // Blur limpia entradas inv√°lidas como "$" solo
                campo.addEventListener('blur', function () {
                    if (this.value === '$') this.value = '';
                });
            });
        });
    }

    // Inicializar formato cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', function () {
        // Campos MXN
        const camposMXN = [
            '#id_costo_venta_final',
            '#id_cantidad_apertura',
            '#id_costo_neto',
            '#id_costo_modificacion'
        ];

        // Campos USD (para ventas internacionales)
        const camposUSD = [
            '#id_tarifa_base_usd',
            '#id_impuestos_usd',
            '#id_suplementos_usd',
            '#id_tours_usd'
        ];

        // Inicializar formato en campos MXN
        inicializarFormatoMonedaEnCampos(camposMXN);

        // Inicializar formato en campos USD (con s√≠mbolo USD $)
        camposUSD.forEach(selector => {
            const campos = document.querySelectorAll(selector);
            campos.forEach(campo => {
                if (campo.hasAttribute('data-formato-inicializado')) return;

                campo.setAttribute('data-formato-inicializado', 'true');

                // Formato inicial si ya tiene valor
                if (campo.value && !campo.value.startsWith('USD $') && !campo.value.startsWith('$')) {
                    const valorLimpio = limpiarFormatoMoneda(campo.value);
                    if (valorLimpio) {
                        const parts = valorLimpio.split('.');
                        let integerPart = parts[0];
                        let decimalPart = parts.length > 1 ? '.' + parts[1].substring(0, 2) : '';
                        if (integerPart) {
                            integerPart = parseInt(integerPart, 10).toLocaleString('es-MX');
                        }
                        campo.value = 'USD $' + integerPart + decimalPart;
                    }
                }

                // Formatear mientras escribe (con USD $)
                campo.addEventListener('input', function () {
                    const cursorPosition = this.selectionStart;
                    const originalValue = this.value;
                    let digitsBeforeCursor = 0;
                    for (let i = 0; i < cursorPosition; i++) {
                        if (/[0-9]/.test(originalValue[i])) digitsBeforeCursor++;
                    }

                    let value = this.value.replace(/[^0-9.]/g, '');
                    if (!value) {
                        this.value = '';
                        return;
                    }

                    const parts = value.split('.');
                    let integerPart = parts[0];
                    let decimalPart = parts.length > 1 ? '.' + parts[1].substring(0, 2) : '';
                    if (integerPart) {
                        integerPart = parseInt(integerPart, 10).toLocaleString('es-MX');
                    } else if (parts.length > 1) {
                        integerPart = '0';
                    }

                    const newValue = 'USD $' + integerPart + decimalPart;

                    if (this.value !== newValue) {
                        this.value = newValue;
                        let newCursorPos = 0;
                        let digitsFound = 0;
                        for (let i = 0; i < newValue.length; i++) {
                            if (/[0-9]/.test(newValue[i])) {
                                digitsFound++;
                            }
                            if (digitsFound >= digitsBeforeCursor) {
                                newCursorPos = i + 1;
                                if (digitsFound === digitsBeforeCursor) break;
                            }
                        }
                        if (digitsBeforeCursor === 0) newCursorPos = 6; // Despu√©s de "USD $"
                        this.setSelectionRange(newCursorPos, newCursorPos);
                    }
                });

                campo.addEventListener('blur', function () {
                    if (this.value === 'USD $' || this.value === '$') this.value = '';
                });
            });
        });

        // Limpiar formato antes de enviar el formulario
        const ventaForm = document.getElementById('ventaForm');
        if (ventaForm) {
            ventaForm.addEventListener('submit', function (e) {
                // Lista de todos los IDs de campos que tienen formato moneda
                const camposMonetarios = [
                    'id_costo_venta_final',
                    'id_cantidad_apertura',
                    'id_costo_neto',
                    'id_costo_modificacion',
                    'id_tarifa_base_usd',
                    'id_impuestos_usd',
                    'id_suplementos_usd',
                    'id_tours_usd'
                ];

                camposMonetarios.forEach(id => {
                    const input = document.getElementById(id);
                    if (input && input.value) {
                        // Limpiar formato: remover $, comas, y "USD "
                        let valorLimpio = input.value.replace(/USD \$/g, '').replace(/\$/g, '').replace(/,/g, '').trim();
                        input.value = valorLimpio;
                    }
                });
                // El formulario se enviar√° ahora con n√∫meros limpios
            });
        }
    });
</script>
{% endblock %}