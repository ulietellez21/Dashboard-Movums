{% extends "base.html" %}
{% load widget_tweaks %}
{% load humanize %}
{% load venta_filters %} 

{% block title %}
    {% if object %}Editar Venta #{{ object.pk }}{% else %}Crear Nueva Venta{% endif %}
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-10 offset-md-1">
        
        <h1 class="mb-4 text-primary fw-bold">
            {% if object %}
                <i class="fas fa-edit"></i> Editar Venta de Viaje #{{ object.pk }}
            {% else %}
                <i class="fas fa-plane-departure"></i> Registrar Nueva Venta de Viaje
            {% endif %}
        </h1>
        {% url 'cliente_kilometros_resumen' cliente_id=0 as kilometros_resumen_url %}
        
        {# Mensajes de Django #}
        {% if messages %}
            {# Mostrar mensajes: para mensajes de abono, mostrar solo el último; para otros, mostrar todos #}
            {% regroup messages by message as grouped_messages %}
            {% for group in grouped_messages %}
                {# Verificar si el mensaje contiene "Abono" #}
                {% if "Abono" in group.grouper|stringformat:"s" %}
                    {# Para mensajes de abono, mostrar solo el último grupo (forloop.last) #}
                    {% if forloop.last %}
                    <div class="alert alert-{{ group.grouper.tags }} alert-dismissible fade show" role="alert">
                        {{ group.grouper }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endif %}
                {% else %}
                    {# Para otros mensajes, mostrar todos #}
                    <div class="alert alert-{{ group.grouper.tags }} alert-dismissible fade show" role="alert">
                        {{ group.grouper }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}

        <div id="kilometrosBannerContainer"
             class="mb-4"
             data-api-url="{{ kilometros_resumen_url }}"
             data-valor-km="{{ kilometros_meta.valor_por_km|floatformat:2 }}"
             data-max-redencion="{{ kilometros_meta.max_porcentaje|floatformat:0 }}"
             data-cliente-inicial="{{ cliente_preseleccionado.pk|default_if_none:'' }}"
             data-credito-inicial="{% if kilometros_cliente %}{{ kilometros_cliente.valor_equivalente|default_if_none:'0'|floatformat:2 }}{% else %}0{% endif %}">
            {% if kilometros_cliente %}
            <div class="alert alert-info shadow-sm">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div>
                        <h5 class="mb-1 text-primary">
                            <i class="fas fa-route me-2"></i>Saldo Kilómetros Movums de {{ cliente_preseleccionado }}
                        </h5>
                        <p class="mb-0 text-muted small">
                            1 km = ${{ kilometros_meta.valor_por_km|floatformat:2 }} MXN · Máx redención: {{ kilometros_meta.max_porcentaje|floatformat:0 }}% del valor de la venta
                        </p>
                    </div>
                    <div class="text-end">
                        <p class="mb-0 fw-bold">{{ kilometros_cliente.disponible|floatformat:2|intcomma }} km disponibles</p>
                        <small class="text-muted">≈ ${{ kilometros_cliente.valor_equivalente|floatformat:2|intcomma }} MXN aplicables</small>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-light border shadow-sm text-muted" id="kilometrosEmptyState">
                <i class="fas fa-info-circle me-2"></i> Selecciona un cliente para consultar su saldo de Kilómetros Movums.
            </div>
            {% endif %}
        </div>

        <div class="card p-4 shadow-lg mb-4 border-0 rounded-3">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                {# ------------------- Sección 1: Cliente e Información General ------------------- #}
                <h4 class="mb-3 text-secondary border-bottom pb-2">1. Datos del Cliente y Contrato</h4>

                <div class="row">
                    {# Cliente Asociado #}
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.cliente.id_for_label }}" class="form-label fw-bold text-secondary">
                            {{ form.cliente.label }}<span class="text-danger">*</span>
                        </label>
                        {{ form.cliente|add_class:"form-select select2" }}
                        <div class="form-text text-muted">{{ form.cliente.help_text }}</div>
                        {% for error in form.cliente.errors %}
                            <div class="invalid-feedback d-block"><i class="fas fa-exclamation-circle me-1"></i> {{ error }}</div>
                        {% endfor %}
                    </div>

                    {# Tipo de Viaje (Plantilla de Contrato) #}
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.tipo_viaje.id_for_label }}" class="form-label fw-bold text-secondary">
                            {{ form.tipo_viaje.label }}<span class="text-danger">*</span>
                        </label>
                        {{ form.tipo_viaje|add_class:"form-select" }}
                        {% for error in form.tipo_viaje.errors %}
                            <div class="invalid-feedback d-block"><i class="fas fa-exclamation-circle me-1"></i> {{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
                
                {# Pasajeros (Campo nuevo - Textarea) #}
                <div class="mb-4">
                    <label for="{{ form.pasajeros.id_for_label }}" class="form-label fw-bold text-secondary">
                        {{ form.pasajeros.label }}
                    </label>
                    {{ form.pasajeros|add_class:"form-control" }}
                    {% if form.pasajeros.help_text %}
                        <div class="form-text text-muted">{{ form.pasajeros.help_text }}</div>
                    {% endif %}
                    {% for error in form.pasajeros.errors %}
                        <div class="invalid-feedback d-block"><i class="fas fa-exclamation-circle me-1"></i> {{ error }}</div>
                    {% endfor %}
                </div>

                {# ------------------- Sección 2: Servicios Incluidos ------------------- #}
                <h4 class="mb-3 mt-4 text-secondary border-bottom pb-2">2. Servicios Contratados</h4>
                
                {# Selector de Servicios con Checkboxes Colapsable #}
                <div class="mb-4">
                    <div class="card border-secondary">
                        <div class="card-header bg-light p-2" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#serviciosCollapse" aria-expanded="false" aria-controls="serviciosCollapse">
                            <div class="d-flex align-items-center">
                                <span class="fw-bold text-secondary">
                                    <i class="fas fa-chevron-down me-2" id="serviciosIcon"></i>
                                    {{ form.servicios_seleccionados.label }}
                                </span>
                            </div>
                        </div>
                        <div class="collapse" id="serviciosCollapse">
                            <div class="card-body">
                                <div class="row g-3" id="serviciosCheckboxes">
                                    {% for checkbox in form.servicios_seleccionados %}
                                        <div class="col-md-6 col-lg-4">
                                            <div class="form-check">
                                                {{ checkbox.tag }}
                                                <label class="form-check-label" for="{{ checkbox.id_for_label }}">
                                                    {{ checkbox.choice_label }}
                                                </label>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <div class="form-text text-muted mt-2">{{ form.servicios_seleccionados.help_text }}</div>
                            </div>
                        </div>
                    </div>
                    {% for error in form.servicios_seleccionados.errors %}
                        <div class="invalid-feedback d-block mt-2"><i class="fas fa-exclamation-circle me-1"></i> {{ error }}</div>
                    {% endfor %}
                </div>

                {# ------------------- Sección 2.1: Proveedores por Servicio ------------------- #}
                <div class="mb-4" id="proveedoresSection" style="display: none;">
                    <h5 class="mb-3 text-secondary"><i class="fas fa-handshake me-2"></i>Proveedores por Servicio</h5>
                    <div class="card border-info">
                        <div class="card-body">
                            <div class="row g-3" id="proveedoresContainer">
                                {# Campos de proveedor - Renderizados manualmente según tipo #}
                                {% for field_name, field in form.fields.items %}
                                    {% if "proveedor_" in field_name %}
                                        {# Extraer el nombre del servicio del label (ej: "Proveedor de Vuelo" -> "Vuelo") #}
                                        {% with servicio_nombre=field.label|slice:"12:"|striptags %}
                                        <div class="col-md-6 proveedor-field" 
                                             data-servicio="{{ servicio_nombre|striptags }}"
                                             data-field-name="{{ field_name }}"
                                             style="display: none;">
                                            <label for="id_{{ field_name }}" class="form-label fw-bold text-secondary">
                                                {{ field.label }}
                                            </label>
                                            {# Renderizar según el tipo de campo #}
                                            {% if "proveedor-select" in field.widget.attrs.class %}
                                                {# Campo de selección (dropdown) para Vuelo, Hospedaje, Tour #}
                                                {# Obtener el valor inicial del proveedor - usar field.initial o form.initial #}
                                                {% with selected_proveedor=form.initial|get_item:field_name|default:field.initial %}
                                                <select name="{{ field_name }}" id="id_{{ field_name }}" class="form-select proveedor-select">
                                                    <option value="">Selecciona un proveedor</option>
                                                    {% for proveedor in field.queryset %}
                                                        {% if selected_proveedor %}
                                                            {% if selected_proveedor.pk == proveedor.pk %}
                                                                <option value="{{ proveedor.pk }}" selected>{{ proveedor.nombre }}</option>
                                                            {% else %}
                                                                <option value="{{ proveedor.pk }}">{{ proveedor.nombre }}</option>
                                                            {% endif %}
                                                        {% else %}
                                                            <option value="{{ proveedor.pk }}">{{ proveedor.nombre }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                                {% endwith %}
                                            {% else %}
                                                {# Campo de texto para otros servicios #}
                                                {% with text_value=form.initial|get_item:field_name %}
                                                <input type="text" 
                                                       name="{{ field_name }}" 
                                                       id="id_{{ field_name }}" 
                                                       class="form-control" 
                                                       {% if text_value %}value="{{ text_value }}"{% endif %}
                                                       placeholder="{{ field.widget.attrs.placeholder|default:'' }}">
                                                {% endwith %}
                                            {% endif %}
                                            {# Mostrar errores si existen #}
                                            {% if form.errors %}
                                                {% for error_key, error_list in form.errors.items %}
                                                    {% if error_key == field_name %}
                                                        {% for error in error_list %}
                                                            <div class="invalid-feedback d-block"><i class="fas fa-exclamation-circle me-1"></i> {{ error }}</div>
                                                        {% endfor %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                        {% endwith %}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                {# ------------------- Sección 3: Fechas y Finanzas ------------------- #}
                <h4 class="mb-3 mt-4 text-secondary border-bottom pb-2">3. Fechas y Financiero</h4>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        {# Fecha Inicio Viaje - Renderizado manual con formato ISO #}
                        <label for="id_fecha_inicio_viaje" class="form-label fw-bold text-secondary">{{ form.fecha_inicio_viaje.label }}<span class="text-danger">*</span></label>
                        <input type="date" 
                               name="fecha_inicio_viaje" 
                               id="id_fecha_inicio_viaje" 
                               class="form-control" 
                               {% if form.fecha_inicio_viaje.value %}value="{{ form.fecha_inicio_viaje.value|date:'Y-m-d' }}"{% endif %}
                               required>
                        {% if form.fecha_inicio_viaje.errors %}
                            <div class="text-danger small">{{ form.fecha_inicio_viaje.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4 mb-3">
                        {# Fecha Fin Viaje - Renderizado manual con formato ISO #}
                        <label for="id_fecha_fin_viaje" class="form-label fw-bold text-secondary">{{ form.fecha_fin_viaje.label }}</label>
                        <input type="date" 
                               name="fecha_fin_viaje" 
                               id="id_fecha_fin_viaje" 
                               class="form-control" 
                               {% if form.fecha_fin_viaje.value %}value="{{ form.fecha_fin_viaje.value|date:'Y-m-d' }}"{% endif %}>
                        {% if form.fecha_fin_viaje.errors %}
                            <div class="text-danger small">{{ form.fecha_fin_viaje.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4 mb-3">
                        {# Fecha Vencimiento Pago - Renderizado manual con formato ISO #}
                        <label for="id_fecha_vencimiento_pago" class="form-label fw-bold text-secondary">{{ form.fecha_vencimiento_pago.label }}</label>
                        <input type="date" 
                               name="fecha_vencimiento_pago" 
                               id="id_fecha_vencimiento_pago" 
                               class="form-control" 
                               {% if form.fecha_vencimiento_pago.value %}value="{{ form.fecha_vencimiento_pago.value|date:'Y-m-d' }}"{% endif %}>
                        {% if form.fecha_vencimiento_pago.errors %}
                            <div class="text-danger small">{{ form.fecha_vencimiento_pago.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        {# Costo Venta Final (Precio Cliente) #}
                        <label for="{{ form.costo_venta_final.id_for_label }}" class="form-label fw-bold text-secondary">{{ form.costo_venta_final.label }}<span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            {{ form.costo_venta_final|add_class:"form-control" }}
                        </div>
                        <div class="form-text text-muted">{{ form.costo_venta_final.help_text }}</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        {# Cantidad de Apertura/Anticipo #}
                        <label for="{{ form.cantidad_apertura.id_for_label }}" class="form-label fw-bold text-secondary">{{ form.cantidad_apertura.label }}</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            {{ form.cantidad_apertura|add_class:"form-control" }}
                        </div>
                        {% for error in form.cantidad_apertura.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-md-4 mb-3">
                        {# Modo de Pago de Apertura #}
                        <label for="{{ form.modo_pago_apertura.id_for_label }}" class="form-label fw-bold text-secondary">{{ form.modo_pago_apertura.label }}</label>
                        {{ form.modo_pago_apertura|add_class:"form-select" }}
                        {% if form.modo_pago_apertura.help_text %}
                            <div class="form-text">{{ form.modo_pago_apertura.help_text }}</div>
                        {% endif %}
                        {% for error in form.modo_pago_apertura.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-md-4 mb-3">
                        {# Costo Neto (Costo Agencia) #}
                        <label for="{{ form.costo_neto.id_for_label }}" class="form-label fw-bold text-secondary">{{ form.costo_neto.label }}<span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            {{ form.costo_neto|add_class:"form-control" }}
                        </div>
                        <div class="form-text text-muted">{{ form.costo_neto.help_text }}</div>
                    </div>
                </div>

                <div class="card p-3 shadow-sm border-success-subtle mb-4" id="descuentoKilometrosCard">
                    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between">
                        <div class="form-check form-switch mb-2 mb-md-0">
                            {{ form.aplica_descuento_kilometros|add_class:"form-check-input" }}
                            <label for="{{ form.aplica_descuento_kilometros.id_for_label }}" class="form-check-label fw-bold text-success ms-2">
                                Aplicar descuento Kilómetros Movums (10%)
                            </label>
                        </div>
                        <p class="text-muted small mb-0">
                            Disponible como beneficio de fidelidad. El descuento se calcula sobre el total de la venta.
                        </p>
                    </div>
                    {% for error in form.aplica_descuento_kilometros.errors %}
                        <div class="text-danger small mt-2"><i class="fas fa-exclamation-circle me-1"></i> {{ error }}</div>
                    {% endfor %}
                    {{ form.descuento_kilometros_mxn }}
                    <div class="text-muted small mt-2">
                        Saldo disponible Kilómetros: <strong id="saldoKilometrosDisponible">$0.00 MXN</strong>
                    </div>
                    <div class="row text-center mt-3">
                        <div class="col-md-4 mb-3 mb-md-0">
                            <p class="text-muted mb-1">Subtotal venta</p>
                            <h5 id="subtotalVenta" class="fw-bold text-secondary">$0.00 MXN</h5>
                        </div>
                        <div class="col-md-4 mb-3 mb-md-0">
                            <p class="text-muted mb-1">Descuento (10%)</p>
                            <h5 id="descuentoCalculado" class="fw-bold text-success">-$0.00 MXN</h5>
                        </div>
                        <div class="col-md-4">
                            <p class="text-muted mb-1">Total con descuento</p>
                            <h5 id="totalConDescuento" class="fw-bold text-primary">$0.00 MXN</h5>
                        </div>
                    </div>
                </div>
                
                {# Campo de Costo de Modificación - Solo visible al editar #}
                {% if form.costo_modificacion %}
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="alert alert-warning mb-0">
                            <label for="{{ form.costo_modificacion.id_for_label }}" class="form-label fw-bold text-secondary">
                                <i class="fas fa-edit me-1"></i>{{ form.costo_modificacion.label }}
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                {{ form.costo_modificacion|add_class:"form-control" }}
                            </div>
                            {% if form.costo_modificacion.help_text %}
                                <div class="form-text text-muted mt-2">{{ form.costo_modificacion.help_text }}</div>
                            {% endif %}
                            {% for error in form.costo_modificacion.errors %}
                                <div class="text-danger small mt-1">{{ error }}</div>
                            {% endfor %}
                            {% if form.instance.costo_modificacion and form.instance.costo_modificacion > 0 %}
                                <div class="alert alert-info mt-2 mb-0">
                                    <small><i class="fas fa-info-circle"></i> Costo de modificación actual: ${{ form.instance.costo_modificacion|floatformat:2|intcomma }}</small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {# ------------------- Sección 4: Documentos (Campo File) ------------------- #}
                <h4 class="mb-3 mt-4 text-secondary border-bottom pb-2">4. Archivos Adjuntos</h4>

                <div class="mb-3">
                    <label for="{{ form.documentos_cliente.id_for_label }}" class="form-label fw-bold text-secondary">
                        {{ form.documentos_cliente.label }}
                    </label>
                    {# El widget ya es ClearableFileInput y tiene la clase form-control desde forms.py #}
                    {{ form.documentos_cliente }} 
                    <div class="form-text text-muted">{{ form.documentos_cliente.help_text }}</div>
                    {% for error in form.documentos_cliente.errors %}
                        <div class="invalid-feedback d-block"><i class="fas fa-exclamation-circle me-1"></i> {{ error }}</div>
                    {% endfor %}
                </div>
                

                <hr class="my-4">

                <div class="d-flex justify-content-between mt-4">
                    <a href="{% url 'lista_ventas' %}" class="btn btn-outline-secondary px-4">
                        <i class="fas fa-arrow-left me-2"></i> Volver
                    </a>
                    <div class="d-flex gap-2">
                        {% if object %}
                            {# Botón de Cancelar Venta - Solo visible al editar #}
                            <button type="button" class="btn btn-danger px-4 shadow-sm" data-bs-toggle="modal" data-bs-target="#cancelarVentaModal">
                                <i class="fas fa-times-circle me-2"></i> Cancelar Venta
                            </button>
                        {% endif %}
                        <button type="submit" class="btn btn-success px-4 shadow-sm">
                            <i class="fas fa-save me-2"></i> 
                            {% if object %}Actualizar Venta{% else %}Guardar Venta{% endif %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

{# Modal de Confirmación para Cancelar Venta - Solo visible al editar #}
{% if object %}
<div class="modal fade" id="cancelarVentaModal" tabindex="-1" aria-labelledby="cancelarVentaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="cancelarVentaModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Cancelación de Venta
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas cancelar la <strong>Venta #{{ object.pk }}</strong>?</p>
                <p class="text-muted small mb-0">
                    <i class="fas fa-info-circle me-1"></i>
                    Al cancelar, el estado de la venta cambiará a "Cancelada". Esta acción puede revertirse editando la venta nuevamente.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> No Cancelar
                </button>
                <form method="post" action="{% url 'cancelar_venta' pk=object.pk %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-check me-1"></i> Sí, Cancelar Venta
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" 
          xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMD/cd2jBDEXk4B7Hw22Z5+gD5b7t9R1B1xR1wM8t7j07JtMv0jXw4W5r3v5sXw==" 
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    {# Carga de Select2 para mejorar la interfaz de selección de cliente y servicios #}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block extra_js %}
    {# Cargar jQuery antes de Select2 #}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#id_cliente').select2({
                placeholder: "Selecciona un cliente",
                allowClear: true
            });

                    const currencyFormatter = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', minimumFractionDigits: 2 });
                    const numberFormatter = new Intl.NumberFormat('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    const toNumber = (value) => {
                        if (value === null || value === undefined) return 0;
                        const normalized = typeof value === 'string' ? value.replace(/[^0-9.\-]/g, '') : value;
                        const parsed = Number.parseFloat(normalized);
                        return Number.isFinite(parsed) ? parsed : 0;
                    };

            const kmContainer = document.getElementById('kilometrosBannerContainer');
            const kmConfig = kmContainer ? {
                apiTemplate: kmContainer.dataset.apiUrl || '',
                        valorKm: toNumber(kmContainer.dataset.valorKm || '0.05'),
                        maxRedencion: toNumber(kmContainer.dataset.maxRedencion || '10'),
                clienteInicial: kmContainer.dataset.clienteInicial,
                        creditoInicial: toNumber(kmContainer.dataset.creditoInicial || '0')
            } : null;
            let kmCreditoDisponible = kmConfig ? kmConfig.creditoInicial : 0;
            const saldoDisponibleLabel = document.getElementById('saldoKilometrosDisponible');

            function updateSaldoDisponibleText() {
                if (!saldoDisponibleLabel) return;
                const value = Math.max(0, kmCreditoDisponible || 0);
                saldoDisponibleLabel.textContent = `${currencyFormatter.format(value)} MXN`;
            }
            updateSaldoDisponibleText();

            function renderDefaultKmBanner() {
                if (!kmContainer) return;
                kmCreditoDisponible = 0;
                kmContainer.innerHTML = `
                    <div class="alert alert-light border shadow-sm text-muted">
                        <i class="fas fa-info-circle me-2"></i> Selecciona un cliente para consultar su saldo de Kilómetros Movums.
                    </div>
                `;
                updateSaldoDisponibleText();
                recalculateDescuento();
            }

            function renderKmError(message) {
                if (!kmContainer) return;
                kmCreditoDisponible = 0;
                kmContainer.innerHTML = `
                    <div class="alert alert-warning shadow-sm">
                        <i class="fas fa-exclamation-triangle me-2"></i> ${message}
                    </div>
                `;
                updateSaldoDisponibleText();
                recalculateDescuento();
            }

            function renderKilometrosBanner(payload) {
                if (!kmContainer) { return; }
                if (!payload) {
                    renderDefaultKmBanner();
                    return;
                }
                if (payload.participa === false) {
                    kmCreditoDisponible = 0;
                    kmContainer.innerHTML = `
                        <div class="alert alert-secondary shadow-sm">
                            <i class="fas fa-ban me-2"></i> ${payload.cliente} no participa en el programa Kilómetros Movums.
                        </div>
                    `;
                    updateSaldoDisponibleText();
                    recalculateDescuento();
                    return;
                }

                        const kmDisponibles = toNumber(payload.disponible);
                        const valorEquivalente = toNumber(payload.valor_equivalente);

                if (kmDisponibles <= 0 || valorEquivalente <= 0) {
                    kmCreditoDisponible = 0;
                    kmContainer.innerHTML = `
                        <div class="alert alert-primary shadow-sm">
                            <div class="d-flex justify-content-between align-items-center flex-wrap">
                                <div>
                                    <h5 class="mb-1 text-primary">
                                        <i class="fas fa-star me-2"></i> ${payload.cliente}
                                    </h5>
                                    <p class="mb-0 text-muted small">Cliente nuevo en Kilómetros Movums.</p>
                                </div>
                                <div class="text-end">
                                    <p class="mb-0 fw-bold text-success">¡Bienvenido!</p>
                                    <small class="text-muted">Aún no tiene saldo disponible.</small>
                                </div>
                            </div>
                        </div>
                    `;
                    updateSaldoDisponibleText();
                    recalculateDescuento();
                    return;
                }

                const valorKm = kmConfig ? kmConfig.valorKm.toFixed(2) : '0.05';
                const maxRedencion = kmConfig ? kmConfig.maxRedencion.toFixed(0) : '10';
                kmCreditoDisponible = Math.max(0, valorEquivalente);

                kmContainer.innerHTML = `
                    <div class="alert alert-info shadow-sm">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <div>
                                <h5 class="mb-1 text-primary">
                                    <i class="fas fa-route me-2"></i>Saldo Kilómetros Movums de ${payload.cliente}
                                </h5>
                                <p class="mb-0 text-muted small">
                                    1 km = $${valorKm} MXN · Máx redención: ${maxRedencion}% del valor de la venta
                                </p>
                            </div>
                            <div class="text-end">
                                <p class="mb-0 fw-bold">${numberFormatter.format(kmDisponibles)} km disponibles</p>
                                <small class="text-muted">≈ ${currencyFormatter.format(valorEquivalente)} MXN aplicables</small>
                            </div>
                        </div>
                    </div>
                `;
                updateSaldoDisponibleText();
                recalculateDescuento();
            }

            function fetchKilometrosCliente(clienteId) {
                if (!kmContainer || !kmConfig || !kmConfig.apiTemplate) {
                    return;
                }
                const endpoint = kmConfig.apiTemplate.replace('/0/', `/${clienteId}/`);
                kmContainer.classList.add('opacity-50');
                fetch(endpoint, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                }).then(response => {
                    if (!response.ok) {
                        throw new Error('Error al solicitar el saldo');
                    }
                    return response.json();
                }).then(data => {
                    if (data.success) {
                        renderKilometrosBanner(data.data);
                    } else {
                        renderKmError(data.message || 'No se pudo obtener el saldo de Kilómetros.');
                    }
                }).catch(() => {
                    renderKmError('No se pudo obtener el saldo de Kilómetros.');
                }).finally(() => {
                    kmContainer.classList.remove('opacity-50');
                });
            }

            $('#id_cliente').on('change', function() {
                const clienteId = $(this).val();
                if (!clienteId) {
                    renderDefaultKmBanner();
                    return;
                }
                fetchKilometrosCliente(clienteId);
            });

            if (kmContainer && !kmContainer.querySelector('.alert-info') && kmConfig && kmConfig.clienteInicial) {
                fetchKilometrosCliente(kmConfig.clienteInicial);
            } else {
                updateSaldoDisponibleText();
            }

            const serviciosCollapse = document.getElementById('serviciosCollapse');
            const serviciosIcon = document.getElementById('serviciosIcon');
            
            if (serviciosCollapse && serviciosIcon) {
                serviciosCollapse.addEventListener('show.bs.collapse', function() {
                    serviciosIcon.classList.remove('fa-chevron-down');
                    serviciosIcon.classList.add('fa-chevron-up');
                });
                
                serviciosCollapse.addEventListener('hide.bs.collapse', function() {
                    serviciosIcon.classList.remove('fa-chevron-up');
                    serviciosIcon.classList.add('fa-chevron-down');
                });
            }

            function actualizarProveedores() {
                const checkboxes = document.querySelectorAll('input[name="servicios_seleccionados"]:checked');
                const proveedoresSection = document.getElementById('proveedoresSection');
                const proveedorFields = document.querySelectorAll('.proveedor-field');
                
                const serviciosSeleccionados = Array.from(checkboxes).map(cb => cb.value);
                
                console.log('Servicios seleccionados:', serviciosSeleccionados);
                console.log('Campos de proveedor encontrados:', proveedorFields.length);
                
                const servicioToFieldMap = {
                    'Vuelo': 'proveedor_vuelo',
                    'Hospedaje': 'proveedor_hospedaje',
                    'Tour': 'proveedor_tour',
                    'Traslado': 'proveedor_traslado',
                    'Circuito Int': 'proveedor_circuito_int',
                    'Renta Auto': 'proveedor_renta_auto',
                    'Paquete Todo Incluido': 'proveedor_paquete_todo_incluido',
                    'Crucero': 'proveedor_crucero',
                    'Seguro de Viaje': 'proveedor_seguro_de_viaje',
                    'Trámite de Visa': 'proveedor_trámite_de_visa',
                    'Trámite de Pasaporte': 'proveedor_trámite_de_pasaporte'
                };
                
                proveedorFields.forEach(field => {
                    field.style.display = 'none';
                });
                
                let hayProveedores = false;
                serviciosSeleccionados.forEach(servicioNombre => {
                    let field = document.querySelector(`.proveedor-field[data-servicio="${servicioNombre}"]`);
                    
                    if (!field) {
                        field = document.querySelector(`.proveedor-field[data-servicio=" ${servicioNombre}"]`);
                    }
                    
                    if (!field) {
                        const allFields = document.querySelectorAll('.proveedor-field');
                        allFields.forEach(f => {
                            const dataServicio = f.getAttribute('data-servicio');
                            if (dataServicio && dataServicio.trim() === servicioNombre) {
                                field = f;
                            }
                        });
                    }
                    
                    if (!field && servicioToFieldMap[servicioNombre]) {
                        field = document.querySelector(`.proveedor-field[data-field-name="${servicioToFieldMap[servicioNombre]}"]`);
                    }
                    
                    console.log(`Buscando campo para servicio: ${servicioNombre}`, field);
                    if (field) {
                        const dataServicio = field.getAttribute('data-servicio');
                        if (dataServicio && dataServicio.trim() !== dataServicio) {
                            field.setAttribute('data-servicio', dataServicio.trim());
                        }
                        
                        field.style.display = 'block';
                        field.style.visibility = 'visible';
                        field.style.opacity = '1';
                        field.style.position = 'relative';
                        field.style.zIndex = '1';
                        field.removeAttribute('hidden');
                        hayProveedores = true;
                        console.log(`Campo mostrado para: ${servicioNombre}`, field);
                        console.log(`Estilo del campo:`, field.style.cssText);
                        console.log(`Data-servicio:`, field.getAttribute('data-servicio'));
                    } else {
                        console.warn(`No se encontró campo para servicio: ${servicioNombre}`);
                        const allFields = document.querySelectorAll('.proveedor-field');
                        console.log('Todos los campos de proveedor:', allFields);
                        allFields.forEach(f => {
                            console.log(`Campo: ${f.getAttribute('data-field-name')}, servicio: ${f.getAttribute('data-servicio')}`);
                        });
                    }
                });
                
                if (hayProveedores && proveedoresSection) {
                    proveedoresSection.style.display = 'block';
                    proveedoresSection.style.visibility = 'visible';
                    proveedoresSection.style.opacity = '1';
                    proveedoresSection.style.position = 'relative';
                    proveedoresSection.removeAttribute('hidden');
                    console.log('Sección de proveedores mostrada', proveedoresSection);
                    console.log('Estilo de la sección:', proveedoresSection.style.cssText);
                    console.log('Altura de la sección:', proveedoresSection.offsetHeight);
                    console.log('Ancho de la sección:', proveedoresSection.offsetWidth);
                } else if (proveedoresSection) {
                    proveedoresSection.style.display = 'none';
                    console.log('Sección de proveedores oculta');
                }
            }
            
            const servicioCheckboxes = document.querySelectorAll('input[name="servicios_seleccionados"]');
            console.log('Checkboxes de servicios encontrados:', servicioCheckboxes.length);
            servicioCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    console.log('Checkbox cambiado:', this.value, this.checked);
                    actualizarProveedores();
                });
            });
            
            setTimeout(function() {
                actualizarProveedores();
            }, 100);

            const costoVentaInput = document.getElementById('id_costo_venta_final');
            const descuentoCheckbox = document.getElementById('id_aplica_descuento_kilometros');
            const descuentoHidden = document.getElementById('id_descuento_kilometros_mxn');
            const subtotalLabel = document.getElementById('subtotalVenta');
            const descuentoLabel = document.getElementById('descuentoCalculado');
            const totalLabel = document.getElementById('totalConDescuento');

            function recalculateDescuento() {
                if (!costoVentaInput) { return; }
                const costo = toNumber(costoVentaInput.value);
                const aplica = descuentoCheckbox && descuentoCheckbox.checked && costo > 0;
                const maxPorRegla = Math.round(costo * 10) / 100;
                const maxPorCredito = Math.max(0, kmCreditoDisponible || 0);
                const descuentoAplicable = Math.min(maxPorRegla, maxPorCredito);
                const descuento = aplica ? descuentoAplicable : 0;

                if (descuentoHidden) {
                    descuentoHidden.value = descuento.toFixed(2);
                }
                if (subtotalLabel) {
                    subtotalLabel.textContent = `${currencyFormatter.format(costo)} MXN`;
                }
                if (descuentoLabel) {
                    const formatted = currencyFormatter.format(descuento);
                    if (aplica && descuento > 0) {
                        descuentoLabel.textContent = `-${formatted} MXN`;
                    } else {
                        descuentoLabel.textContent = `${formatted} MXN`;
                    }
                }
                if (totalLabel) {
                    const total = Math.max(0, costo - descuento);
                    totalLabel.textContent = `${currencyFormatter.format(total)} MXN`;
                }
            }

            if (costoVentaInput) {
                costoVentaInput.addEventListener('input', recalculateDescuento);
            }
            if (descuentoCheckbox) {
                descuentoCheckbox.addEventListener('change', recalculateDescuento);
            }
            recalculateDescuento();
        });
    </script>
{% endblock %}