{% extends "base.html" %}
{% load humanize %}
{% load venta_filters %}

{% block title %}Alerta Log√≠stica{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-shipping-fast text-warning"></i> Log√≠stica Pendiente
        </h1>
        <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Volver al Dashboard
        </a>
    </div>

    {# CORRECCI√ìN 1: La variable user_rol debe evaluarse por separado #}
    {% if user_rol != 'JEFE' and user_rol != 'CONTADOR' %}
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-lock"></i> Acceso denegado. Esta vista es solo para el personal de Log√≠stica/Jefatura.
        </div>
    
    {% else %} 
        
        {# Usamos object_list, que es el nombre de contexto can√≥nico de la ListView #}
        {% with lista_ventas=object_list %}
            
            {% if lista_ventas %}
                <p class="lead">Mostrando **{{ lista_ventas|length }}** viajes con servicios pendientes de confirmaci√≥n. Las filas est√°n ordenadas por la proximidad de la fecha de viaje.</p>
                
                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle shadow-sm">
                        <thead class="table-primary">
                            <tr>
                                <th>Prioridad</th> {# üö® Columna A√±adida #}
                                <th>ID Venta</th>
                                <th>Cliente</th>
                                <th>Fecha Viaje</th>
                                
                                <th>Vuelo</th>
                                <th>Hospedaje</th>
                                <th>Traslado</th>
                                <th>Tickets</th>
                                
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for venta in lista_ventas %}
                            {# üö® IMPLEMENTACI√ìN DE ALERTA VISUAL: Cambia el color de la fila seg√∫n la proximidad üö® #}
                            <tr class="
                                {% if venta.alerta_proximidad == 'CRITICA' %}table-danger
                                {% elif venta.alerta_proximidad == 'URGENTE' %}table-warning
                                {% endif %}
                            ">
                                
                                {# üö® Columna de Prioridad #}
                                <td>
                                    {% if venta.alerta_proximidad == 'CRITICA' %}
                                        <span class="badge bg-danger fw-bold">CR√çTICA ({{ venta.dias_restantes.days }} D√≠as)</span>
                                    {% elif venta.alerta_proximidad == 'URGENTE' %}
                                        <span class="badge bg-warning text-dark fw-bold">URGENTE ({{ venta.dias_restantes.days }} D√≠as)</span>
                                    {% else %}
                                        <span class="badge bg-secondary fw-bold">NORMAL</span>
                                    {% endif %}
                                </td>
                                
                                <td><a href="{% url 'detalle_venta' slug=venta.slug_safe pk=venta.pk %}">#{{ venta.id }}</a></td>
                                <td><i class="fas fa-user"></i> {{ venta.cliente.nombre_completo_display }}</td>
                                
                                {# üö® Columna Fecha Viaje con √©nfasis en el n√∫mero de d√≠as üö® #}
                                <td>
                                    <span class="fw-bold">{{ venta.fecha_inicio_viaje|date:"d M Y" }}</span>
                                </td>
                                
                                {% with servicios_str=venta.servicios_seleccionados|default:"" %}
                                    {# Vuelo #}
                                    {% if servicios_str|servicio_esta_contratado:"VUE" %}
                                        {% if venta.logistica %}
                                            {% include 'ventas/includes/logistica_badge.html' with valor=venta.logistica.vuelo_confirmado|default:False %}
                                        {% else %}
                                            {% include 'ventas/includes/logistica_badge.html' with valor=False %}
                                        {% endif %}
                                    {% else %}
                                        <td><span class="badge bg-secondary">No contratado</span></td>
                                    {% endif %}
                                    
                                    {# Hospedaje #}
                                    {% if servicios_str|servicio_esta_contratado:"HOS" %}
                                        {% if venta.logistica %}
                                            {% include 'ventas/includes/logistica_badge.html' with valor=venta.logistica.hospedaje_reservado|default:False %}
                                        {% else %}
                                            {% include 'ventas/includes/logistica_badge.html' with valor=False %}
                                        {% endif %}
                                    {% else %}
                                        <td><span class="badge bg-secondary">No contratado</span></td>
                                    {% endif %}
                                    
                                    {# Traslado #}
                                    {% if servicios_str|servicio_esta_contratado:"TRA" %}
                                        {% if venta.logistica %}
                                            {% include 'ventas/includes/logistica_badge.html' with valor=venta.logistica.traslado_confirmado|default:False %}
                                        {% else %}
                                            {% include 'ventas/includes/logistica_badge.html' with valor=False %}
                                        {% endif %}
                                    {% else %}
                                        <td><span class="badge bg-secondary">No contratado</span></td>
                                    {% endif %}
                                    
                                    {# Tickets #}
                                    {% if servicios_str|servicio_esta_contratado:"TOU" %}
                                        {% if venta.logistica %}
                                            {% include 'ventas/includes/logistica_badge.html' with valor=venta.logistica.tickets_confirmado|default:False %}
                                        {% else %}
                                            {% include 'ventas/includes/logistica_badge.html' with valor=False %}
                                        {% endif %}
                                    {% else %}
                                        <td><span class="badge bg-secondary">No contratado</span></td>
                                    {% endif %}
                                {% endwith %}

                                <td>
                                    <a href="{% url 'detalle_venta' slug=venta.slug_safe pk=venta.pk %}?tab=logistica" class="btn btn-sm btn-info text-white">
                                        <i class="fas fa-cogs"></i> Gestionar
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

            {% else %}
                <div class="alert alert-success text-center shadow-sm p-4" role="alert">
                    <h2><i class="fas fa-check-circle"></i> ¬°Felicidades!</h2>
                    <p class="lead">Todos los servicios de log√≠stica para los viajes activos han sido confirmados.</p>
                    <a href="{% url 'lista_ventas' %}" class="btn btn-primary mt-3">Ver Listado General de Ventas</a>
                </div>
            {% endif %}
        {% endwith %}

    {% endif %}
{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" 
          crossorigin="anonymous" referrerpolicy="no-referrer" />
{% endblock %}