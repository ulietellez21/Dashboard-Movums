{% extends "base.html" %}
{% load humanize %}

{% block title %}Gestión de Roles{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="text-primary">
            <i class="fas fa-users-cog"></i> Gestión de Roles
        </h1>
        <p class="text-muted mb-0">Administra los usuarios y roles del sistema</p>
    </div>
    <span class="badge bg-warning text-dark p-2 shadow">Exclusivo para JEFE</span>
</div>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
{% endif %}

<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <div>
            <h2 class="h5 mb-0">Equipo de Ejecutivos</h2>
            <small class="text-muted">Administra los ejecutivos autorizados para vender.</small>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#ejecutivoModal" data-mode="create">
            <i class="fas fa-user-plus me-2"></i>Agregar Nuevo Ejecutivo
        </button>
    </div>
    <div class="card-body">
        {% if ejecutivos %}
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Nombre</th>
                            <th>Teléfono</th>
                            <th>Tipo de Usuario</th>
                            <th>Oficina</th>
                            <th>Correo</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ejecutivo in ejecutivos %}
                        <tr {% if ejecutivo.usuario and not ejecutivo.usuario.is_active %}class="table-warning opacity-75" style="background-color: #fff3cd !important;"{% endif %}>
                            <td>
                                <strong>{{ ejecutivo.nombre_completo }}</strong>
                                {% if ejecutivo.usuario and not ejecutivo.usuario.is_active %}
                                    <span class="badge bg-warning text-dark ms-2">
                                        <i class="fas fa-user-slash"></i> Deshabilitado
                                    </span>
                                {% endif %}
                                <br>
                                <small class="text-muted">{{ ejecutivo.direccion|linebreaksbr }}</small>
                            </td>
                            <td>{{ ejecutivo.telefono }}</td>
                            <td>
                                {% with ejecutivo.usuario.perfil.rol|default:""|upper as rol_ej %}
                                    {% if rol_ej == 'JEFE' %}
                                        <span class="badge bg-danger text-white">Jefe</span>
                                    {% elif rol_ej == 'DIRECTOR_GENERAL' %}
                                        <span class="badge bg-primary text-white">Director General</span>
                                    {% elif rol_ej == 'DIRECTOR_VENTAS' %}
                                        <span class="badge bg-primary text-white">Director de Ventas</span>
                                    {% elif rol_ej == 'DIRECTOR_ADMINISTRATIVO' %}
                                        <span class="badge bg-primary text-white">Director Administrativo</span>
                                    {% elif rol_ej == 'GERENTE' %}
                                        <span class="badge bg-info text-white">Gerente</span>
                                    {% elif rol_ej == 'CONTADOR' %}
                                        <span class="badge bg-secondary text-white">Contador</span>
                                    {% elif rol_ej == 'VENDEDOR' %}
                                        {% if ejecutivo.tipo_vendedor == 'MOSTRADOR' %}
                                            <span class="badge bg-info text-white">Asesor de Mostrador</span>
                                        {% elif ejecutivo.tipo_vendedor == 'CAMPO' %}
                                            <span class="badge bg-warning text-dark">Asesor de Campo</span>
                                        {% elif ejecutivo.tipo_vendedor == 'ISLA' %}
                                            <span class="badge bg-success text-white">Asesor de Isla</span>
                                        {% else %}
                                            <span class="badge bg-success text-white">Asesor</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary">{{ ejecutivo.usuario.perfil.get_rol_display|default:"N/A" }}</span>
                                    {% endif %}
                                {% endwith %}
                            </td>
                            <td>
                                {% if ejecutivo.oficina %}
                                    {{ ejecutivo.oficina.nombre }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if ejecutivo.email %}
                                    <a href="mailto:{{ ejecutivo.email }}">{{ ejecutivo.email }}</a>
                                {% else %}
                                    <span class="text-muted">No registrado</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <button
                                    type="button"
                                    class="btn btn-outline-secondary btn-sm me-2"
                                    data-bs-toggle="modal"
                                    data-bs-target="#ejecutivoModal"
                                    data-mode="edit"
                                    data-id="{{ ejecutivo.id }}"
                                    data-nombre="{{ ejecutivo.nombre_completo|escape }}"
                                    data-direccion="{{ ejecutivo.direccion|escape }}"
                                    data-telefono="{{ ejecutivo.telefono|escape }}"
                                    data-email="{{ ejecutivo.email|default_if_none:''|escape }}"
                                    data-sueldo="{{ ejecutivo.sueldo_base }}"
                                    data-tipo-vendedor="{{ ejecutivo.tipo_vendedor }}"
                                    data-oficina="{% if ejecutivo.oficina %}{{ ejecutivo.oficina.id }}{% endif %}"
                                    data-fecha-ingreso="{{ ejecutivo.fecha_ingreso|date:'Y-m-d' }}"
                                    data-fecha-nacimiento="{{ ejecutivo.fecha_nacimiento|date:'Y-m-d' }}"
                                    data-tipo-usuario="{% if ejecutivo.usuario.perfil %}{{ ejecutivo.usuario.perfil.rol }}{% else %}VENDEDOR{% endif %}"
                                    data-usuario="{% if ejecutivo.usuario %}{{ ejecutivo.usuario.username }}{% endif %}"
                                >
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <a href="{% url 'ejecutivo_detail' ejecutivo.pk %}" class="btn btn-outline-info btn-sm">
                                    <i class="fas fa-eye"></i> Ver Detalles
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-light border">
                <i class="fas fa-users-slash"></i> Aún no hay ejecutivos registrados.
            </div>
        {% endif %}
    </div>
</div>

<!-- Tabla de Oficinas -->
<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <div>
            <h2 class="h5 mb-0">Oficinas</h2>
            <small class="text-muted">Administra las oficinas de la agencia.</small>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#oficinaModal" data-mode="create">
            <i class="fas fa-building me-2"></i>Agregar Nueva Oficina
        </button>
    </div>
    <div class="card-body">
        {% if oficinas %}
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Nombre</th>
                            <th>Dirección</th>
                            <th>Ubicación</th>
                            <th>Responsable</th>
                            <th>Encargado</th>
                            <th>Tipo</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for oficina in oficinas %}
                        <tr>
                            <td>
                                <strong>{{ oficina.nombre }}</strong>
                            </td>
                            <td>
                                <small>{{ oficina.direccion|truncatewords:10 }}</small>
                            </td>
                            <td>{{ oficina.ubicacion }}</td>
                            <td>{{ oficina.responsable }}</td>
                            <td>{{ oficina.encargado }}</td>
                            <td>
                                {% if oficina.tipo == 'PROPIA' %}
                                    <span class="badge bg-primary">Propia</span>
                                {% else %}
                                    <span class="badge bg-info text-dark">Franquicia</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <button
                                    type="button"
                                    class="btn btn-outline-secondary btn-sm me-2"
                                    data-bs-toggle="modal"
                                    data-bs-target="#oficinaModal"
                                    data-mode="edit"
                                    data-id="{{ oficina.id }}"
                                    data-nombre="{{ oficina.nombre|escape }}"
                                    data-direccion="{{ oficina.direccion|escape }}"
                                    data-ubicacion="{{ oficina.ubicacion|escape }}"
                                    data-responsable="{{ oficina.responsable|escape }}"
                                    data-encargado="{{ oficina.encargado|escape }}"
                                    data-tipo="{{ oficina.tipo }}"
                                >
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <form method="post" action="{% url 'gestion_roles' %}" class="d-inline" onsubmit="return confirm('¿Estás seguro de que deseas eliminar la oficina {{ oficina.nombre }}? Los ejecutivos asociados mantendrán su información.');">
                                    {% csrf_token %}
                                    <input type="hidden" name="oficina_action" value="eliminar">
                                    <input type="hidden" name="oficina_id" value="{{ oficina.id }}">
                                    <button type="submit" class="btn btn-outline-danger btn-sm">
                                        <i class="fas fa-trash"></i> Eliminar
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-light border">
                <i class="fas fa-building"></i> Aún no hay oficinas registradas.
            </div>
        {% endif %}
    </div>
</div>

<!-- Variable para controlar si se debe mostrar el modal automáticamente -->
<div id="modal-config" data-mostrar-modal="{% if mostrar_modal_ejecutivo %}true{% else %}false{% endif %}" data-mostrar-modal-oficina="{% if mostrar_modal_oficina %}true{% else %}false{% endif %}" style="display: none;"></div>

{% endblock %}

{% block modals %}
<!-- Modal para crear/editar ejecutivos -->
<div class="modal fade" id="ejecutivoModal" tabindex="-1" aria-labelledby="ejecutivoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ejecutivoModalLabel">Agregar Nuevo Ejecutivo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form method="post" action="{% url 'gestion_roles' %}" enctype="multipart/form-data">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" name="ejecutivo_action" id="ejecutivoAction" value="crear">
                    <input type="hidden" name="ejecutivo_id" id="ejecutivoId">
                    {% if ejecutivo_form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ ejecutivo_form.non_field_errors }}
                        </div>
                    {% endif %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Nombre Completo</label>
                            {{ ejecutivo_form.nombre_completo }}
                            {{ ejecutivo_form.nombre_completo.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Teléfono</label>
                            {{ ejecutivo_form.telefono }}
                            {{ ejecutivo_form.telefono.errors }}
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-semibold">Dirección</label>
                            {{ ejecutivo_form.direccion }}
                            {{ ejecutivo_form.direccion.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Correo Electrónico</label>
                            {{ ejecutivo_form.email }}
                            {{ ejecutivo_form.email.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Tipo de Usuario</label>
                            {{ ejecutivo_form.tipo_usuario }}
                            <div class="form-text">{{ ejecutivo_form.tipo_usuario.help_text }}</div>
                            {{ ejecutivo_form.tipo_usuario.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Oficina</label>
                            {{ ejecutivo_form.oficina }}
                            {{ ejecutivo_form.oficina.errors }}
                        </div>
                        <div class="col-md-6" id="tipoVendedorContainer" style="display: none;">
                            <label class="form-label fw-semibold" id="tipoVendedorLabel">Tipo de Asesor</label>
                            {{ ejecutivo_form.tipo_vendedor }}
                            <div class="form-text">Determina el sistema de comisiones aplicable</div>
                            {{ ejecutivo_form.tipo_vendedor.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Sueldo Base</label>
                            {{ ejecutivo_form.sueldo_base }}
                            {{ ejecutivo_form.sueldo_base.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Fecha de Ingreso</label>
                            {{ ejecutivo_form.fecha_ingreso }}
                            {{ ejecutivo_form.fecha_ingreso.errors }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Fecha de Nacimiento</label>
                            {{ ejecutivo_form.fecha_nacimiento }}
                            {{ ejecutivo_form.fecha_nacimiento.errors }}
                        </div>
                    </div>
                    
                    {# Sección de Documentos Digitales #}
                    <div class="row g-3 mt-2">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-file-alt me-2"></i>Documentos digitales
                            </h6>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Acta de Nacimiento</label>
                            {{ ejecutivo_form.acta_nacimiento }}
                            <div class="form-text">{{ ejecutivo_form.acta_nacimiento.help_text }}</div>
                            {{ ejecutivo_form.acta_nacimiento.errors }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">INE</label>
                            {{ ejecutivo_form.ine_imagen }}
                            <div class="form-text">{{ ejecutivo_form.ine_imagen.help_text }}</div>
                            {{ ejecutivo_form.ine_imagen.errors }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Comprobante de Domicilio</label>
                            {{ ejecutivo_form.comprobante_domicilio }}
                            <div class="form-text">{{ ejecutivo_form.comprobante_domicilio.help_text }}</div>
                            {{ ejecutivo_form.comprobante_domicilio.errors }}
                        </div>
                    </div>
                    
                    {# Sección de Información de Usuario (solo para edición) #}
                    <div class="row g-3 mt-3" id="infoUsuarioContainer" style="display: none;">
                        <div class="col-12">
                            <hr class="my-3">
                            <h6 class="text-muted mb-3">
                                <i class="fas fa-user-cog me-2"></i>Información de Usuario
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Usuario</label>
                            <input type="text" class="form-control" id="usuarioDisplay" readonly>
                            <div class="form-text">El usuario no puede ser modificado</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Nueva Contraseña</label>
                            <input type="text" class="form-control" name="nueva_contrasena" id="nuevaContrasena" placeholder="Dejar vacío para mantener la actual">
                            <div class="form-text">Dejar vacío si no deseas cambiar la contraseña</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="submitEjecutivoBtn">
                        Guardar Ejecutivo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para crear/editar oficinas -->
<div class="modal fade" id="oficinaModal" tabindex="-1" aria-labelledby="oficinaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="oficinaModalLabel">Agregar Nueva Oficina</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form method="post" action="{% url 'gestion_roles' %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" name="oficina_action" id="oficinaAction" value="crear">
                    <input type="hidden" name="oficina_id" id="oficinaId">
                    {% if oficina_form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ oficina_form.non_field_errors }}
                        </div>
                    {% endif %}
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="{{ oficina_form.nombre.id_for_label }}" class="form-label fw-semibold">Nombre de la Oficina <span class="text-danger">*</span></label>
                            <input type="text" 
                                   name="nombre" 
                                   id="{{ oficina_form.nombre.id_for_label }}"
                                   class="form-control" 
                                   placeholder="Ej. Oficina Central, Sucursal Norte"
                                   maxlength="255"
                                   required
                                   value="{{ oficina_form.nombre.value|default:'' }}">
                            {% for error in oficina_form.nombre.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-12">
                            <label for="{{ oficina_form.direccion.id_for_label }}" class="form-label fw-semibold">Dirección <span class="text-danger">*</span></label>
                            <textarea name="direccion" 
                                      id="{{ oficina_form.direccion.id_for_label }}"
                                      class="form-control" 
                                      rows="3"
                                      placeholder="Calle, número, ciudad, estado, código postal"
                                      required>{{ oficina_form.direccion.value|default:'' }}</textarea>
                            <div class="form-text">{{ oficina_form.direccion.help_text }}</div>
                            {% for error in oficina_form.direccion.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-12">
                            <label for="{{ oficina_form.ubicacion.id_for_label }}" class="form-label fw-semibold">Ubicación <span class="text-danger">*</span></label>
                            <input type="text" 
                                   name="ubicacion" 
                                   id="{{ oficina_form.ubicacion.id_for_label }}"
                                   class="form-control" 
                                   placeholder="Ej. Local 15, Piso 2, Oficina 201"
                                   maxlength="255"
                                   required
                                   value="{{ oficina_form.ubicacion.value|default:'' }}">
                            <div class="form-text">{{ oficina_form.ubicacion.help_text }}</div>
                            {% for error in oficina_form.ubicacion.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ oficina_form.responsable.id_for_label }}" class="form-label fw-semibold">Responsable <span class="text-danger">*</span></label>
                            <input type="text" 
                                   name="responsable" 
                                   id="{{ oficina_form.responsable.id_for_label }}"
                                   class="form-control" 
                                   placeholder="Nombre del responsable"
                                   maxlength="255"
                                   required
                                   value="{{ oficina_form.responsable.value|default:'' }}">
                            {% for error in oficina_form.responsable.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ oficina_form.encargado.id_for_label }}" class="form-label fw-semibold">Encargado <span class="text-danger">*</span></label>
                            <input type="text" 
                                   name="encargado" 
                                   id="{{ oficina_form.encargado.id_for_label }}"
                                   class="form-control" 
                                   placeholder="Nombre del encargado"
                                   maxlength="255"
                                   required
                                   value="{{ oficina_form.encargado.value|default:'' }}">
                            {% for error in oficina_form.encargado.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-12">
                            <label for="{{ oficina_form.tipo.id_for_label }}" class="form-label fw-semibold">Tipo de Oficina <span class="text-danger">*</span></label>
                            <select name="tipo" 
                                    id="{{ oficina_form.tipo.id_for_label }}"
                                    class="form-select" 
                                    required>
                                <option value="">---------</option>
                                <option value="PROPIA" {% if oficina_form.tipo.value == 'PROPIA' %}selected{% endif %}>Propia</option>
                                <option value="FRANQUICIA" {% if oficina_form.tipo.value == 'FRANQUICIA' %}selected{% endif %}>Franquicia</option>
                            </select>
                            {% for error in oficina_form.tipo.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="submitOficinaBtn">
                        Guardar Oficina
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" 
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* FORZAR que el modal sea visible cuando tiene la clase show */
        #ejecutivoModal.show,
        #ejecutivoModal.show.show {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 1060 !important;
            pointer-events: auto !important;
        }
        
        /* Asegurar que el modal-dialog y modal-content sean interactivos */
        #ejecutivoModal.show .modal-dialog,
        #ejecutivoModal.show .modal-content {
            pointer-events: auto !important;
        }
        
        /* Asegurar que el overlay nunca bloquee los modales */
        body.modal-open #pageTransitionOverlay,
        #ejecutivoModal.show ~ #pageTransitionOverlay,
        #ejecutivoModal.show + #pageTransitionOverlay,
        #oficinaModal.show ~ #pageTransitionOverlay,
        #oficinaModal.show + #pageTransitionOverlay {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
            z-index: -1 !important;
        }
        
        /* Estilos para el modal de oficinas */
        #oficinaModal.show,
        #oficinaModal.show.show {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 1060 !important;
            pointer-events: auto !important;
        }
        
        #oficinaModal.show .modal-dialog,
        #oficinaModal.show .modal-content {
            pointer-events: auto !important;
        }
    </style>
{% endblock %}

{% block extra_js %}
<script>
// Función global para forzar el ocultamiento del overlay (debe estar fuera de funciones anónimas)
function forceHideOverlayGestionRoles() {
    var overlay = document.getElementById('pageTransitionOverlay');
    if (overlay) {
        overlay.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; z-index: -9999 !important;';
        overlay.classList.remove('active');
        overlay.removeAttribute('class');
        try {
            overlay.remove();
        } catch(e) {
            // Si no se puede remover, al menos está oculto
        }
    }
    window._modalIsOpening = true;
    // También llamar a la función global de base.html si existe
    if (typeof forceHideOverlay === 'function') {
        forceHideOverlay();
    }
}

// Ocultar overlay inmediatamente al cargar la página
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        forceHideOverlayGestionRoles();
    });
} else {
    forceHideOverlayGestionRoles();
}

(function() {
    'use strict';
    
    // Función global para manejar la visibilidad del campo "Tipo de Asesor" según "Tipo de Usuario"
    function toggleTipoVendedorVisibility() {
        var tipoUsuarioInput = document.querySelector('#ejecutivoModal [name="tipo_usuario"]');
        var tipoVendedorInput = document.querySelector('#ejecutivoModal [name="tipo_vendedor"]');
        var tipoVendedorContainer = document.querySelector('#ejecutivoModal #tipoVendedorContainer');
        var tipoVendedorLabel = document.querySelector('#ejecutivoModal #tipoVendedorLabel');
        
        if (!tipoUsuarioInput || !tipoVendedorInput || !tipoVendedorContainer) {
            return;
        }
        
        var tipoUsuario = tipoUsuarioInput.value;
        
        // Solo mostrar "Tipo de Asesor" cuando el tipo de usuario es "VENDEDOR" (Asesor)
        if (tipoUsuario === 'VENDEDOR') {
            tipoVendedorContainer.style.display = 'block';
            tipoVendedorContainer.style.opacity = '1';
            tipoVendedorContainer.style.pointerEvents = 'auto';
            tipoVendedorInput.disabled = false;
            tipoVendedorInput.required = true;
            if (tipoVendedorLabel) {
                tipoVendedorLabel.style.opacity = '1';
            }
        } else {
            // Ocultar y deshabilitar para todos los demás tipos de usuario
            tipoVendedorContainer.style.display = 'none';
            tipoVendedorContainer.style.opacity = '0.5';
            tipoVendedorContainer.style.pointerEvents = 'none';
            tipoVendedorInput.disabled = true;
            tipoVendedorInput.required = false;
            tipoVendedorInput.value = '';
            if (tipoVendedorLabel) {
                tipoVendedorLabel.style.opacity = '0.5';
            }
        }
    }
    
    function initModalEjecutivo() {
        var modalEl = document.getElementById('ejecutivoModal');
        if (!modalEl) {
            return;
        }
        
        // Mover el modal fuera del #main-content al body si es necesario
        if (modalEl.parentElement && modalEl.parentElement.id === 'main-content') {
            document.body.appendChild(modalEl);
        }
        
        if (typeof bootstrap === 'undefined') {
            alert('Error: Bootstrap no está disponible. Recarga la página.');
            return;
        }
        
        var actionInput = document.getElementById('ejecutivoAction');
        var idInput = document.getElementById('ejecutivoId');
        var titleEl = document.getElementById('ejecutivoModalLabel');
        var submitBtn = document.getElementById('submitEjecutivoBtn');
        var documentoInfo = document.getElementById('documentoActualContainer');
        var documentoLink = document.getElementById('documentoActualLink');
        
        // Listener para cambios en "Tipo de Usuario"
        modalEl.addEventListener('change', function(e) {
            if (e.target && e.target.name === 'tipo_usuario') {
                toggleTipoVendedorVisibility();
            }
        });
        
        // Aplicar estado inicial cuando el modal se muestra
        modalEl.addEventListener('shown.bs.modal', function() {
            setTimeout(toggleTipoVendedorVisibility, 150);
        });
        
        // Ocultar overlay completamente al inicializar
        forceHideOverlay();
        
        // Ocultar overlay en mousedown/click de botones ANTES de que se abra el modal
        var modalButtons = document.querySelectorAll('[data-bs-toggle="modal"][data-bs-target="#ejecutivoModal"]');
        modalButtons.forEach(function(button) {
            // Usar capture phase para ejecutar ANTES que otros handlers
            button.addEventListener('mousedown', function(e) {
                forceHideOverlay();
            }, true);
            
            // También en click como respaldo
            button.addEventListener('click', function(e) {
                forceHideOverlay();
            }, true);
        });
        
        // Llenar formulario cuando se abre el modal
        modalEl.addEventListener('show.bs.modal', function(event) {
            // Forzar ocultamiento del overlay
            forceHideOverlay();
            
            var nombreInput = modalEl.querySelector('[name="nombre_completo"]');
            var direccionInput = modalEl.querySelector('[name="direccion"]');
            var telefonoInput = modalEl.querySelector('[name="telefono"]');
            var emailInput = modalEl.querySelector('[name="email"]');
            var oficinaInput = modalEl.querySelector('[name="oficina"]');
            var tipoVendedorInput = modalEl.querySelector('[name="tipo_vendedor"]');
            var sueldoInput = modalEl.querySelector('[name="sueldo_base"]');
            var fechaIngresoInput = modalEl.querySelector('[name="fecha_ingreso"]');
            var fechaNacimientoInput = modalEl.querySelector('[name="fecha_nacimiento"]');
            var tipoUsuarioInput = modalEl.querySelector('[name="tipo_usuario"]');
            
            var button = event.relatedTarget;
            
            if (!button || button.getAttribute('data-mode') === 'create') {
                // Modo crear
                if (actionInput) actionInput.value = 'crear';
                if (idInput) idInput.value = '';
                if (titleEl) titleEl.textContent = 'Agregar Nuevo Ejecutivo';
                if (submitBtn) submitBtn.textContent = 'Guardar Ejecutivo';
                
                if (nombreInput) nombreInput.value = '';
                if (direccionInput) direccionInput.value = '';
                if (telefonoInput) telefonoInput.value = '';
                if (emailInput) emailInput.value = '';
                if (oficinaInput) oficinaInput.value = '';
                if (tipoUsuarioInput) tipoUsuarioInput.value = 'VENDEDOR';
                if (tipoVendedorInput) tipoVendedorInput.value = 'MOSTRADOR';
                if (sueldoInput) sueldoInput.value = '';
                if (fechaIngresoInput) fechaIngresoInput.value = '';
                if (fechaNacimientoInput) fechaNacimientoInput.value = '';
                
                // Aplicar visibilidad después de limpiar
                setTimeout(toggleTipoVendedorVisibility, 50);
                return;
            }
            
            // Modo editar
            if (actionInput) actionInput.value = 'editar';
            if (idInput) idInput.value = button.getAttribute('data-id') || '';
            if (titleEl) titleEl.textContent = 'Editar Ejecutivo';
            if (submitBtn) submitBtn.textContent = 'Actualizar Ejecutivo';
            
            if (nombreInput) nombreInput.value = button.getAttribute('data-nombre') || '';
            if (direccionInput) direccionInput.value = button.getAttribute('data-direccion') || '';
            if (telefonoInput) telefonoInput.value = button.getAttribute('data-telefono') || '';
            if (emailInput) emailInput.value = button.getAttribute('data-email') || '';
            if (oficinaInput) oficinaInput.value = button.getAttribute('data-oficina') || '';
            if (tipoVendedorInput) tipoVendedorInput.value = button.getAttribute('data-tipo-vendedor') || 'MOSTRADOR';
            if (sueldoInput) sueldoInput.value = button.getAttribute('data-sueldo') || '';
            if (fechaIngresoInput) fechaIngresoInput.value = button.getAttribute('data-fecha-ingreso') || '';
            if (fechaNacimientoInput) fechaNacimientoInput.value = button.getAttribute('data-fecha-nacimiento') || '';
            if (tipoUsuarioInput) tipoUsuarioInput.value = button.getAttribute('data-tipo-usuario') || 'VENDEDOR';
            if (usuarioDisplay) usuarioDisplay.value = button.getAttribute('data-usuario') || '';
            if (nuevaContrasenaInput) nuevaContrasenaInput.value = '';
            if (infoUsuarioContainer) infoUsuarioContainer.style.display = 'block';
            
            // Aplicar visibilidad después de cargar los valores
            setTimeout(toggleTipoVendedorVisibility, 50);
        });
        
        // Limpiar formulario al cerrar
        modalEl.addEventListener('hidden.bs.modal', function() {
            var form = modalEl.querySelector('form');
            if (form) {
                form.reset();
            }
        });
        
        // Mostrar modal automáticamente si hay errores de validación o si hay parámetro ?editar=id
        var modalConfigEl = document.getElementById('modal-config');
        var mostrarModalEjecutivo = modalConfigEl && modalConfigEl.getAttribute('data-mostrar-modal') === 'true';
        
        // Verificar si hay parámetro ?editar=id en la URL
        var urlParams = new URLSearchParams(window.location.search);
        var ejecutivoIdEditar = urlParams.get('editar');
        
        if (mostrarModalEjecutivo || ejecutivoIdEditar) {
            setTimeout(function() {
                try {
                    // Si hay un ID para editar, buscar el botón correspondiente y hacer click
                    if (ejecutivoIdEditar) {
                        var botonEditar = document.querySelector('button[data-id="' + ejecutivoIdEditar + '"]');
                        if (botonEditar) {
                            // Hacer click en el botón para que se dispare el evento show.bs.modal
                            botonEditar.click();
                        } else {
                            // Si no se encuentra el botón, abrir el modal de todas formas
                            var bootstrapModal = bootstrap.Modal.getOrCreateInstance(modalEl);
                            bootstrapModal.show();
                        }
                    } else {
                        var bootstrapModal = bootstrap.Modal.getOrCreateInstance(modalEl);
                        bootstrapModal.show();
                    }
                } catch (err) {
                    console.error('Error al abrir modal:', err);
                    var bootstrapModal = new bootstrap.Modal(modalEl);
                    bootstrapModal.show();
                }
            }, 300);
        }
    }
    
    // Ejecutar cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initModalEjecutivo);
    } else {
        initModalEjecutivo();
    }
})();

// Inicialización del modal de oficinas
(function() {
    'use strict';
    
    function initModalOficina() {
        var modalEl = document.getElementById('oficinaModal');
        if (!modalEl) {
            return;
        }
        
        // Mover el modal fuera del #main-content al body si es necesario
        if (modalEl.parentElement && modalEl.parentElement.id === 'main-content') {
            document.body.appendChild(modalEl);
        }
        
        if (typeof bootstrap === 'undefined') {
            alert('Error: Bootstrap no está disponible. Recarga la página.');
            return;
        }
        
        var actionInput = document.getElementById('oficinaAction');
        var idInput = document.getElementById('oficinaId');
        var titleEl = document.getElementById('oficinaModalLabel');
        var submitBtn = document.getElementById('submitOficinaBtn');
        
        // Ocultar overlay completamente al inicializar
        forceHideOverlayGestionRoles();
        
        // Ocultar overlay en mousedown/click de botones ANTES de que se abra el modal
        var modalButtons = document.querySelectorAll('[data-bs-toggle="modal"][data-bs-target="#oficinaModal"]');
        modalButtons.forEach(function(button) {
            // Usar capture phase para ejecutar ANTES que otros handlers
            button.addEventListener('mousedown', function(e) {
                forceHideOverlayGestionRoles();
            }, true);
            
            // También en click como respaldo
            button.addEventListener('click', function(e) {
                forceHideOverlayGestionRoles();
            }, true);
        });
        
        modalEl.addEventListener('show.bs.modal', function(event) {
            // Forzar ocultamiento del overlay cuando se abre el modal
            forceHideOverlayGestionRoles();
            
            var button = event.relatedTarget;
            
            if (!button || button.getAttribute('data-mode') === 'create') {
                // Modo crear
                if (actionInput) actionInput.value = 'crear';
                if (idInput) idInput.value = '';
                if (titleEl) titleEl.textContent = 'Agregar Nueva Oficina';
                if (submitBtn) submitBtn.textContent = 'Guardar Oficina';
                
                // Limpiar formulario
                var form = modalEl.querySelector('form');
                if (form) form.reset();
                return;
            }
            
            // Modo editar
            if (actionInput) actionInput.value = 'editar';
            if (idInput) idInput.value = button.getAttribute('data-id') || '';
            if (titleEl) titleEl.textContent = 'Editar Oficina';
            if (submitBtn) submitBtn.textContent = 'Actualizar Oficina';
            
            // Llenar campos del formulario
            var nombreInput = modalEl.querySelector('input[name="nombre"]');
            var direccionInput = modalEl.querySelector('textarea[name="direccion"]');
            var ubicacionInput = modalEl.querySelector('input[name="ubicacion"]');
            var responsableInput = modalEl.querySelector('input[name="responsable"]');
            var encargadoInput = modalEl.querySelector('input[name="encargado"]');
            var tipoInput = modalEl.querySelector('select[name="tipo"]');
            
            if (nombreInput) nombreInput.value = button.getAttribute('data-nombre') || '';
            if (direccionInput) direccionInput.value = button.getAttribute('data-direccion') || '';
            if (ubicacionInput) ubicacionInput.value = button.getAttribute('data-ubicacion') || '';
            if (responsableInput) responsableInput.value = button.getAttribute('data-responsable') || '';
            if (encargadoInput) encargadoInput.value = button.getAttribute('data-encargado') || '';
            if (tipoInput) tipoInput.value = button.getAttribute('data-tipo') || 'PROPIA';
        });
        
        // Limpiar formulario al cerrar
        modalEl.addEventListener('hidden.bs.modal', function() {
            var form = modalEl.querySelector('form');
            if (form) form.reset();
        });
        
        // Mostrar modal automáticamente si hay errores
        var modalConfigEl = document.getElementById('modal-config');
        var mostrarModalOficina = modalConfigEl && modalConfigEl.getAttribute('data-mostrar-modal-oficina') === 'true';
        
        if (mostrarModalOficina) {
            setTimeout(function() {
                try {
                    var bootstrapModal = bootstrap.Modal.getOrCreateInstance(modalEl);
                    bootstrapModal.show();
                } catch (err) {
                    console.error('Error al abrir modal de oficina:', err);
                }
            }, 300);
        }
    }
    
    // Ejecutar cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initModalOficina);
    } else {
        initModalOficina();
    }
})();
</script>
{% endblock %}

