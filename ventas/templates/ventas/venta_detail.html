{% extends "base.html" %}
{% load humanize %}
{% load widget_tweaks %} 
{% load venta_filters %}
{% load static %}
{% block title %}Venta {{ venta.folio|default:venta.id }} | {{ venta.cliente.nombre_completo_display }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        
        <!-- 1. Encabezado y Botones de Edición: Usamos flex-column en móviles (d-sm-flex) -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
            <h1 class="mb-2 mb-md-0">
                <i class="fas fa-receipt"></i> Detalle de Venta <span class="badge bg-primary fs-5">{{ venta.folio|default:venta.id }}</span>
            </h1>
            <!-- Botones de Edición y Cliente: Usamos d-grid/gap-2 en móviles para apilar los botones si es necesario -->
            <div class="d-grid d-md-block gap-2">
                {% if puede_editar_datos_viaje %}
                    <a href="{% url 'editar_venta' pk=venta.pk %}" 
                        class="btn btn-warning shadow-sm">
                        <i class="fas fa-edit"></i> Editar Datos del Viaje
                    </a>
                {% endif %}
                
                <a href="{% url 'detalle_cliente' pk=venta.cliente.pk %}" class="btn btn-outline-primary shadow-sm">
                    {% if venta.cliente.tipo_cliente == 'EMPRESA' %}
                        <i class="fas fa-building"></i>
                    {% else %}
                        <i class="fas fa-user"></i>
                    {% endif %}
                    Ver Cliente
                </a>
            </div>
        </div>

        <!-- 2. Botones de Documentos: Usamos flex-wrap en móviles para envolver los botones -->
        <div class="d-flex flex-wrap justify-content-start gap-2 mb-4">
            <!-- Botón de Contrato PDF -->
            {% comment %} Ocultar el botón si la venta es solo de vuelo (VUE) ya que el pago es al momento {% endcomment %}
            {% if venta.servicios_seleccionados == 'VUE' %}
                {# No mostrar botón de contrato para ventas de solo vuelo #}
            {% elif not puede_generar_documentos %}
                <button type="button" 
                    class="btn btn-danger shadow-sm" 
                    disabled
                    title="El contrato se habilita cuando el anticipo está confirmado.">
                    <i class="fas fa-file-contract me-1"></i> Contrato Venta
                    <i class="fas fa-lock ms-1"></i>
                </button>
                <span class="badge bg-warning text-dark align-self-center" data-bs-toggle="tooltip" data-bs-placement="top" title="Sube y confirma el anticipo para habilitar el contrato">
                    <i class="fas fa-clock me-1"></i> Pendiente de anticipo confirmado
                </span>
            {% else %}
                {# Lógica condicional para dirigir al contrato correcto según el tipo de servicio #}
                {# Paquete Nacional: detectar si es 'PAQ' o si tiene 'VUE' y 'HOS' juntos (paquete desglosado) #}
                {# Paquete Internacional: detectar si es 'PAQ' con tipo_viaje 'INT' #}
                {# Nota: Django templates no soporta paréntesis, así que usamos múltiples condiciones #}
                {% if venta.tipo_viaje == 'NAC' %}
                    {% if 'PAQ' in venta.servicios_seleccionados %}
                        {# Paquete Nacional explícito: usar contrato específico de paquete nacional #}
                        <a href="{% url 'generar_contrato_paquete_nacional_pdf' slug=venta.slug pk=venta.pk %}" 
                            class="btn btn-danger shadow-sm" target="_blank"
                            title="Genera el contrato de paquete nacional como DOCX">
                            <i class="fas fa-file-contract me-1"></i> Contrato Venta
                        </a>
                    {% elif 'VUE' in venta.servicios_seleccionados and 'HOS' in venta.servicios_seleccionados %}
                        {# Paquete Nacional desglosado (VUE + HOS): usar contrato específico de paquete nacional #}
                        <a href="{% url 'generar_contrato_paquete_nacional_pdf' slug=venta.slug pk=venta.pk %}" 
                            class="btn btn-danger shadow-sm" target="_blank"
                            title="Genera el contrato de paquete nacional como DOCX">
                            <i class="fas fa-file-contract me-1"></i> Contrato Venta
                        </a>
                    {% elif 'HOS' in venta.servicios_seleccionados %}
                        {# Solo Hospedaje (sin vuelo): usar contrato específico de hospedaje #}
                        <a href="{% url 'generar_contrato_hospedaje_pdf' slug=venta.slug pk=venta.pk %}" 
                            class="btn btn-danger shadow-sm" target="_blank"
                            title="Genera el contrato de hospedaje como DOCX">
                            <i class="fas fa-file-contract me-1"></i> Contrato Venta
                        </a>
                    {% else %}
                        {# Otros casos nacionales: usar contrato genérico #}
                        <a href="{% url 'generar_contrato_pdf' slug=venta.slug pk=venta.pk %}" 
                            class="btn btn-danger shadow-sm" target="_blank"
                            title="Genera el contrato de venta como PDF">
                            <i class="fas fa-file-contract me-1"></i> Contrato Venta
                        </a>
                    {% endif %}
                {% elif venta.tipo_viaje == 'INT' %}
                    <a href="{% url 'generar_contrato_paquete_internacional_pdf' slug=venta.slug pk=venta.pk %}" 
                        class="btn btn-danger shadow-sm" target="_blank"
                        title="Genera el contrato internacional como DOCX">
                        <i class="fas fa-file-contract me-1"></i> Contrato Venta
                    </a>
                {% elif 'HOS' in venta.servicios_seleccionados and 'PAQ' not in venta.servicios_seleccionados %}
                    {# Solo Hospedaje (sin tipo específico): usar contrato específico de hospedaje #}
                    <a href="{% url 'generar_contrato_hospedaje_pdf' slug=venta.slug pk=venta.pk %}" 
                        class="btn btn-danger shadow-sm" target="_blank"
                        title="Genera el contrato de hospedaje como DOCX">
                        <i class="fas fa-file-contract me-1"></i> Contrato Venta
                    </a>
                {% else %}
                    {# Otros casos (Vuelo, Generic, etc.): usar contrato genérico #}
                    <a href="{% url 'generar_contrato_pdf' slug=venta.slug pk=venta.pk %}" 
                        class="btn btn-danger shadow-sm" target="_blank"
                        title="Genera el contrato de venta como PDF">
                        <i class="fas fa-file-contract me-1"></i> Contrato Venta
                    </a>
                {% endif %}
            {% endif %}
            
            <!-- Botón de Comprobante de Abonos PDF -->
            {% comment %} Ocultar el botón si la venta es solo de vuelo (VUE) ya que el pago es al momento y no habrá abonos {% endcomment %}
            {% if venta.servicios_seleccionados != 'VUE' %}
                {% if not puede_generar_documentos %}
                    <button type="button" class="btn btn-success shadow-sm" disabled
                        title="El comprobante de abonos se habilita cuando el anticipo está confirmado.">
                        <i class="fas fa-receipt me-1"></i> Comprobante Abonos
                        <i class="fas fa-lock ms-1"></i>
                    </button>
                    <span class="badge bg-warning text-dark align-self-center" data-bs-toggle="tooltip" data-bs-placement="top" title="Sube y confirma el anticipo para habilitar el comprobante de abonos">
                        <i class="fas fa-clock me-1"></i> Pendiente de anticipo confirmado
                    </span>
                {% else %}
                    <a href="{% url 'comprobante_abonos_pdf' slug=venta.slug pk=venta.pk %}" 
                        class="btn btn-success shadow-sm" target="_blank"
                        title="Genera el comprobante de todos los abonos realizados">
                        <i class="fas fa-receipt me-1"></i> Comprobante Abonos
                    </a>
                {% endif %}
            {% endif %}
            
            <!-- Botón de Plantillas de Confirmación -->
            <a href="{% url 'listar_confirmaciones' slug=venta.slug pk=venta.pk %}" 
                class="btn btn-info shadow-sm text-white"
                title="Generar plantillas de confirmación (Vuelo, Hospedaje, Traslado, etc.)">
                <i class="fas fa-file-alt me-1"></i> Generar Confirmaciones
            </a>

        </div>
        <!-- Fin de la Fila de Botones de Documentos -->

        {% if messages %}
            {# Mostrar mensajes: para mensajes de abono, mostrar solo el último; para otros, mostrar todos #}
            {# Excluir mensajes de plantillas (se muestran en listar_confirmaciones) #}
            {# Excluir mensajes de comisiones (se muestran en reporte de comisiones) #}
            {# Primero mostrar todos los mensajes que NO son de abono NI de plantillas NI de comisiones #}
            {% for message in messages %}
                {% if "Abono" not in message|stringformat:"s" and "Plantilla" not in message|stringformat:"s" and "comisión" not in message|stringformat:"s"|lower and "ajustado" not in message|stringformat:"s"|lower %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}
            {% endfor %}
            
            {# Luego, mostrar todos los mensajes de abono (JavaScript eliminará los duplicados) #}
            {# Agregar un atributo data para identificar mensajes de abono y usar JavaScript para eliminar duplicados #}
            {% for message in messages %}
                {% if "Abono" in message|stringformat:"s" %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mensaje-abono" role="alert" data-abono-message="true">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
        
        {# JavaScript para eliminar mensajes de abono duplicados, dejando solo el último #}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var mensajesAbono = document.querySelectorAll('.mensaje-abono');
                if (mensajesAbono.length > 1) {
                    // Eliminar todos excepto el último
                    for (var i = 0; i < mensajesAbono.length - 1; i++) {
                        mensajesAbono[i].remove();
                    }
                }
            });
        </script>
        
        <!-- 3. Contenedor de Métricas: Aseguramos que los bordes verticales se quiten en móviles -->
        <div class="card bg-light mb-4 shadow-sm border-primary">
            <div class="card-body">
                <div class="row text-center">
                    <!-- En móviles (col-12), el borde vertical (border-end) se quita usando border-md-end -->
                    <div class="col-12 col-md-4 border-bottom border-md-end pb-3 pb-md-0"> 
                        <h6 class="text-muted">Total Final</h6>
                        <h2 class="text-success">{% if venta.tipo_viaje == 'INT' %}USD {% endif %}${{ total_final|floatformat:2|intcomma }}</h2>
                        {% if venta.tipo_viaje == 'INT' and venta.costo_modificacion_usd and venta.costo_modificacion_usd > 0 %}
                            <p class="text-muted small mb-0">Modificaciones: +USD ${{ venta.costo_modificacion_usd|floatformat:2|intcomma }}</p>
                        {% elif venta.tipo_viaje != 'INT' and venta.costo_modificacion and venta.costo_modificacion > 0 %}
                            <p class="text-muted small mb-0">Modificaciones: +${{ venta.costo_modificacion|floatformat:2|intcomma }}</p>
                        {% endif %}
                        {% if venta.aplica_descuento_kilometros %}
                            <p class="text-muted small mb-0">Descuento Kilómetros Movums: -${{ venta.descuento_kilometros_mxn|floatformat:2|intcomma }}</p>
                        {% endif %}
                        {% if venta.descuento_promociones_mxn and venta.descuento_promociones_mxn > 0 %}
                            <p class="text-muted small mb-0">Descuento Promociones: -${{ venta.descuento_promociones_mxn|floatformat:2|intcomma }}</p>
                        {% endif %}
                    </div>
                    <!-- Aplicamos border-bottom solo en móviles para separar las tarjetas -->
                    <div class="col-12 col-md-4 border-bottom border-md-end py-3 py-md-0">
                        <h6 class="text-muted">Total Pagado</h6>
                        <h2 class="text-info">{% if venta.tipo_viaje == 'INT' %}USD {% endif %}${{ venta.total_pagado|floatformat:2|intcomma }}</h2>
                        {% if venta.descuento_promociones_mxn and venta.descuento_promociones_mxn > 0 %}
                            <p class="text-muted small mb-0">Incluye descuento promo como pago: ${{ venta.descuento_promociones_mxn|floatformat:2|intcomma }}</p>
                        {% endif %}
                    </div>
                    <div class="col-12 col-md-4 pt-3 pt-md-0">
                        <h6 class="text-muted">Saldo Pendiente</h6>
                        {% if venta.saldo_restante > 0 %}
                            <h2 class="text-danger">{% if venta.tipo_viaje == 'INT' %}USD {% endif %}${{ venta.saldo_restante|floatformat:2|intcomma }}</h2>
                        {% else %}
                            <h2 class="text-success"><i class="fas fa-check-circle"></i> Pagado</h2>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <ul class="nav nav-tabs mb-3" id="ventaTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab" aria-controls="info" aria-selected="true">
                    <i class="fas fa-info-circle"></i> Información General
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="abonos-tab" data-bs-toggle="tab" data-bs-target="#abonos" type="button" role="tab" aria-controls="abonos" aria-selected="false">
                    <i class="fas fa-dollar-sign"></i> Abonos y Pagos
                </button>
            </li>
            {% if mostrar_tab_logistica %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="logistica-tab" data-bs-toggle="tab" data-bs-target="#logistica" type="button" role="tab" aria-controls="logistica" aria-selected="false">
                        <i class="fas fa-shipping-fast"></i> Logística
                    </button>
                </li>
            {% endif %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="confirmaciones-tab" data-bs-toggle="tab" data-bs-target="#confirmaciones" type="button" role="tab" aria-controls="confirmaciones" aria-selected="false">
                    <i class="fas fa-file-upload"></i> Confirmaciones en la Venta
                </button>
            </li>
        </ul>

        <div class="tab-content" id="ventaTabsContent">
            
            <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
                <div class="d-flex justify-content-end mb-3 d-print-none">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.print();" title="Abre el cuadro de impresión para imprimir o guardar como PDF">
                        <i class="fas fa-print me-1"></i> Imprimir / Guardar como PDF
                    </button>
                </div>
                <div id="venta-print-area">
                    <h1 class="h2 mb-4 text-primary d-none d-print-block">
                        <i class="fas fa-receipt me-2"></i> Información General — Venta {{ venta.folio|default:venta.id }}
                    </h1>
                    {% include "ventas/_venta_detail_info_content.html" %}
                </div>
            </div>

            <div class="tab-pane fade" id="abonos" role="tabpanel" aria-labelledby="abonos-tab">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card mb-4 shadow-sm border-success">
                            <div class="card-header bg-success text-white">
                                Registrar Nuevo Abono
                            </div>
                            <div class="card-body">
                                {% if venta.saldo_restante > 0 and venta.modo_pago_apertura != 'PRO' %}
                                    <form method="post">
                                        {% csrf_token %}
                                        
                                        {% if venta.tipo_viaje == 'INT' %}
                                            <div class="mb-3">
                                                <label class="form-label">Monto (USD)</label>
                                                <input type="text" inputmode="decimal" step="0.01" min="0.01" class="form-control" id="montoUsd" name="monto_usd" placeholder="Ej: 100.00">
                                                <div class="text-danger small d-none" id="montoUsdError">Ingresa un monto válido en USD.</div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Tipo de cambio del día</label>
                                                <input type="number" step="0.0001" min="0.0001" class="form-control" id="tipoCambioAbono" name="tipo_cambio_abono" value="{{ venta.tipo_cambio|floatformat:2 }}">
                                                <div class="form-text text-muted">Ej: 19.80</div>
                                                <div class="text-danger small d-none" id="tipoCambioError">Ingresa un tipo de cambio válido.</div>
                                            </div>
                                            {# Campo real (monto en MXN) como hidden para evitar validación HTML5 que bloquea el submit #}
                                            <input type="hidden" id="{{ abono_form.monto.auto_id }}" name="{{ abono_form.monto.html_name }}" value="{{ abono_form.monto.value|default_if_none:'' }}">
                                            {% for error in abono_form.monto.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                                        {% else %}
                                            <div class="mb-3">
                                                <label for="{{ abono_form.monto.id_for_label }}" class="form-label">Monto (Máximo: ${{ venta.saldo_restante|floatformat:2|intcomma }})</label>
                                                {{ abono_form.monto|add_class:"form-control"|attr:"type:text"|attr:"inputmode:decimal"|attr:"min:0.01"|attr:"max:"|add_max_attr:venta.saldo_restante }}
                                                {% for error in abono_form.monto.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                                            </div>
                                        {% endif %}
                                        
                                        <div class="mb-3">
                                            <label for="{{ abono_form.forma_pago.id_for_label }}" class="form-label">Forma de Pago</label>
                                            {{ abono_form.forma_pago|add_class:"form-select" }}
                                            {% for error in abono_form.forma_pago.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                                        </div>

                                        <div class="mb-3">
                                            <div class="form-check">
                                                {{ abono_form.requiere_factura }}
                                                <label class="form-check-label" for="{{ abono_form.requiere_factura.id_for_label }}">
                                                    Requiere factura por este abono
                                                </label>
                                            </div>
                                            {% for error in abono_form.requiere_factura.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                                        </div>

                                        <button type="submit" name="registrar_abono" class="btn btn-success w-100 mt-3">
                                            <i class="fas fa-plus-circle"></i> Registrar Pago
                                        </button>
                                    </form>
                                {% else %}
                                    <div class="alert alert-success text-center">
                                        <i class="fas fa-check-double"></i> 
                                        {% if venta.modo_pago_apertura == 'PRO' %}
                                            Esta venta fue pagada directamente al proveedor. No se requieren abonos adicionales.
                                        {% else %}
                                            ¡Esta venta está completamente pagada!
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header">
                                Historial de Pagos ({% if venta.cantidad_apertura > 0 or venta.tipo_viaje == 'INT' and venta.cantidad_apertura_usd %}{{ abonos|length|add:1 }}{% else %}{{ abonos|length }}{% endif %})
                            </div>
                            <div class="card-body">
                                {% if abonos or venta.cantidad_apertura > 0 or venta.tipo_viaje == 'INT' and venta.cantidad_apertura_usd or venta.descuento_promociones_mxn or venta.descuento_kilometros_mxn %}
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped">
                                            <thead class="table-light">
                                                <tr>
                                                <th>Fecha</th>
                                                <th>Monto</th>
                                                <th>Forma</th>
                                                <th>Estado</th>
                                                <th>Comprobante</th>
                                                <th>Registrado por</th>
                                                {% if user_rol == 'CONTADOR' %}
                                                <th>Acciones</th>
                                                {% endif %}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% if venta.cantidad_apertura > 0 or venta.tipo_viaje == 'INT' and venta.cantidad_apertura_usd %}
                                                <tr class="{% if venta.estado_confirmacion == 'EN_CONFIRMACION' %}table-warning{% else %}table-info{% endif %}">
                                                    <td>{{ venta.fecha_creacion|date:"d/M/y H:i" }}</td>
                                                {% if venta.tipo_viaje == 'INT' %}
                                                    <td>
                                                        <strong>USD ${{ venta.cantidad_apertura_usd|default:0|floatformat:2|intcomma }}</strong>
                                                        {% if venta.tipo_cambio %}<br><small class="text-muted">TC: ${{ venta.tipo_cambio|floatformat:4 }} MXN/USD</small>{% endif %}
                                                    </td>
                                                {% else %}
                                                    <td><strong>${{ venta.cantidad_apertura|floatformat:2|intcomma }}</strong></td>
                                                {% endif %}
                                                    <td><span class="badge bg-info">{{ venta.get_modo_pago_apertura_display }}</span></td>
                                                    <td>
                                                        {# Apertura confirmada solo cuando el contador la aprobó (y comprobante). TRN/TAR/DEP usan apertura_confirmada; EFE/LIG/PRO no requieren contador. #}
                                                        {% if venta.modo_pago_apertura in 'EFE,LIG,PRO' %}
                                                            <span class="badge bg-success"><i class="fas fa-check"></i> Confirmado</span>
                                                        {% elif venta.modo_pago_apertura in 'TRN,TAR,DEP' %}
                                                            {% if venta.apertura_confirmada %}
                                                                <span class="badge bg-success"><i class="fas fa-check"></i> Confirmado</span>
                                                            {% else %}
                                                                <span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Pendiente</span>
                                                            {% endif %}
                                                        {% elif venta.modo_pago_apertura == 'CRE' %}
                                                            {% if venta.estado_confirmacion == 'EN_CONFIRMACION' %}
                                                                <span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Pendiente</span>
                                                            {% else %}
                                                                <span class="badge bg-success"><i class="fas fa-check"></i> Confirmado</span>
                                                            {% endif %}
                                                        {% else %}
                                                            <span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Pendiente</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if venta.modo_pago_apertura == 'CRE' %}
                                                            <span class="badge bg-info">Crédito - Pendiente de validación</span>
                                                        {% elif venta.modo_pago_apertura in 'TRN,TAR,DEP' %}
                                                            {% if venta.comprobante_apertura_subido and venta.comprobante_apertura %}
                                                                {% if not venta.apertura_confirmada %}
                                                                    <button type="button" class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#modalEditarComprobanteApertura" title="Editar comprobante">
                                                                        <i class="fas fa-edit"></i> Editar
                                                                    </button>
                                                                {% else %}
                                                                <span class="text-muted">-</span>
                                                                {% endif %}
                                                            {% else %}
                                                                <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#modalComprobanteApertura" title="Subir comprobante">
                                                                    <i class="fas fa-upload"></i> Subir
                                                                </button>
                                                            {% endif %}
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td><em>Apertura/Anticipo</em> - {{ venta.vendedor.username|default:"Sistema" }}</td>
                                                    {% if user_rol == 'CONTADOR' %}
                                                    <td>
                                                        {% if venta.modo_pago_apertura in 'TRN,TAR,DEP' and not venta.apertura_confirmada and venta.comprobante_apertura_subido %}
                                                            <form method="post" action="{% url 'confirmar_pago_desde_lista' tipo='apertura' pk=venta.pk %}" style="display: inline;">
                                                                {% csrf_token %}
                                                                <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('¿Confirmar este pago de apertura?')" title="Aprobar apertura">
                                                                    <i class="fas fa-check"></i> Aprobar
                                                                </button>
                                                            </form>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    {% endif %}
                                                </tr>
                                                {% endif %}
                                                {% for abono in abonos %}
                                                <tr class="{% if not abono.confirmado and abono.forma_pago in 'TRN,TAR,DEP' %}table-warning{% endif %}">
                                                    <td>{{ abono.fecha_pago|date:"d/M/y H:i" }}</td>
                                                    {% if venta.tipo_viaje == 'INT' and venta.tipo_cambio %}
                                                        {% with tc_abono=abono.tipo_cambio_para_display|default:venta.tipo_cambio %}
                                                        <td>
                                                            {% if abono.monto_usd_para_display %}
                                                                <strong>USD ${{ abono.monto_usd_para_display|floatformat:2|intcomma }}</strong>
                                                                <br><small class="text-muted">TC: ${{ tc_abono|floatformat:4 }} MXN/USD</small>
                                                            {% else %}
                                                                <strong>${{ abono.monto|floatformat:2|intcomma }} MXN</strong>
                                                                {% if tc_abono %}<br><small class="text-muted">TC: ${{ tc_abono|floatformat:4 }} MXN/USD</small>{% endif %}
                                                            {% endif %}
                                                        </td>
                                                        {% endwith %}
                                                    {% else %}
                                                        <td><strong>${{ abono.monto|floatformat:2|intcomma }}</strong></td>
                                                    {% endif %}
                                                    <td><span class="badge {% if abono.forma_pago == 'EFE' %}bg-success{% elif abono.forma_pago == 'TRN' %}bg-primary{% elif abono.forma_pago == 'TAR' %}bg-info{% elif abono.forma_pago == 'DEP' %}bg-secondary{% elif abono.forma_pago == 'LIG' %}bg-warning text-dark{% elif abono.forma_pago == 'PRO' %}bg-dark{% elif abono.forma_pago == 'PPL' %}bg-secondary{% else %}bg-secondary{% endif %}">{{ abono.get_forma_pago_display }}</span></td>
                                                    <td>
                                                        {% if abono.confirmado or abono.forma_pago in 'EFE,LIG,PRO' %}
                                                            <span class="badge bg-success"><i class="fas fa-check"></i> Confirmado</span>
                                                        {% else %}
                                                            <span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Pendiente</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if abono.forma_pago in 'TRN,TAR,DEP' %}
                                                            {% if abono.comprobante_subido and abono.comprobante_imagen %}
                                                                {% if not abono.confirmado %}
                                                                <button type="button" class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#modalEditarComprobanteAbono{{ abono.pk }}" title="Editar comprobante">
                                                                    <i class="fas fa-edit"></i> Editar
                                                                </button>
                                                                {% else %}
                                                                <span class="text-muted">-</span>
                                                                {% endif %}
                                                            {% elif not abono.confirmado %}
                                                                <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#modalComprobanteAbono{{ abono.pk }}" title="Subir comprobante">
                                                                    <i class="fas fa-upload"></i> Subir
                                                                </button>
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {{ abono.registrado_por.username|default:"-" }}
                                                        {% if abono.requiere_factura %}
                                                            <br><small class="text-muted"><i class="fas fa-file-invoice text-info"></i> Requiere factura</small>
                                                        {% endif %}
                                                    </td>
                                                    {% if user_rol == 'CONTADOR' %}
                                                    <td>
                                                        {% if abono.forma_pago in 'TRN,TAR,DEP' and not abono.confirmado and abono.comprobante_subido %}
                                                            <form method="post" action="{% url 'confirmar_abono' abono_id=abono.pk %}" style="display: inline;">
                                                                {% csrf_token %}
                                                                <button type="submit" class="btn btn-sm btn-success" title="Confirmar abono">
                                                                    <i class="fas fa-check"></i> Confirmar
                                                                </button>
                                                            </form>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    {% endif %}
                                                </tr>
                                                {% endfor %}
                                                {% if venta.descuento_kilometros_mxn and venta.descuento_kilometros_mxn > 0 %}
                                                <tr class="table-info">
                                                    <td>{{ venta.fecha_actualizacion|default:venta.fecha_creacion|date:"d/M/y H:i" }}</td>
                                                    <td><strong>${{ venta.descuento_kilometros_mxn|floatformat:2|intcomma }}</strong></td>
                                                    <td><span class="badge bg-primary">Descuento Kilómetros Movums</span></td>
                                                    <td><span class="badge bg-success"><i class="fas fa-check"></i> Confirmado</span></td>
                                                    <td><span class="text-muted">-</span></td>
                                                    <td>{{ venta.vendedor.username|default:"Sistema" }}</td>
                                                    {% if user_rol == 'CONTADOR' %}
                                                    <td><span class="text-muted">-</span></td>
                                                    {% endif %}
                                                </tr>
                                                {% endif %}
                                                {% if venta.descuento_promociones_mxn and venta.descuento_promociones_mxn > 0 %}
                                                <tr class="table-info">
                                                    <td>{{ venta.fecha_actualizacion|default:venta.fecha_creacion|date:"d/M/y H:i" }}</td>
                                                    <td><strong>${{ venta.descuento_promociones_mxn|floatformat:2|intcomma }}</strong></td>
                                                    <td><span class="badge bg-primary">Descuento Promociones</span></td>
                                                    <td><span class="badge bg-success"><i class="fas fa-check"></i> Confirmado</span></td>
                                                    <td><span class="text-muted">-</span></td>
                                                    <td>{{ venta.vendedor.username|default:"Sistema" }}</td>
                                                    {% if user_rol == 'CONTADOR' %}
                                                    <td><span class="text-muted">-</span></td>
                                                    {% endif %}
                                                </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <p class="text-muted text-center">No se han registrado abonos para esta venta.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if mostrar_tab_logistica %}
                <div class="tab-pane fade" id="logistica" role="tabpanel" aria-labelledby="logistica-tab">
                    <div class="card mb-4 shadow border-info" id="logisticaFinanzasCard">
                        <div class="card-header bg-info text-white">
                            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                                <span><i class="fas fa-layer-group me-2"></i>Control financiero por servicio</span>
                                <small class="text-white-50">Los importes se actualizan con abonos y apertura confirmados</small>
                            </div>
                        </div>
                        <div class="card-body">
                            {% if servicios_logisticos_rows %}
                            <div class="row text-center g-3 mb-4">
                                <div class="col-12 col-md-4">
                                    <p class="text-muted mb-1">Total Venta (con descuentos)</p>
                                    <h4 class="text-primary mb-0">{% if venta.tipo_viaje == 'INT' %}USD {% endif %}${{ logistica_finanzas.total_venta|floatformat:2|intcomma }}</h4>
                                    {% if descuento_km > 0 or descuento_promo > 0 %}
                                        <small class="text-muted">Base: {% if venta.tipo_viaje == 'INT' %}USD {% endif %}${{ costo_base|floatformat:2|intcomma }}</small>
                                    {% endif %}
                                </div>
                                <div class="col-12 col-md-4">
                                    <p class="text-muted mb-1">Apertura + Abonos</p>
                                    <h4 class="text-success mb-0">{% if venta.tipo_viaje == 'INT' %}USD {% endif %}${{ logistica_finanzas.total_pagado|floatformat:2|intcomma }}</h4>
                                </div>
                                <div class="col-12 col-md-4">
                                    <p class="text-muted mb-1">Saldo disponible para servicios</p>
                                    <h4 class="text-warning mb-0">{% if venta.tipo_viaje == 'INT' %}USD {% endif %}${{ logistica_finanzas.saldo_disponible_servicios|floatformat:2|intcomma }}</h4>
                                </div>
                            </div>
                            <div class="row text-center g-3 mb-4">
                                <div class="col-12 col-md-4">
                                    <p class="text-muted mb-1">Servicios planificados</p>
                                    <h5 class="mb-0">{% if venta.tipo_viaje == 'INT' %}USD {% endif %}${{ logistica_finanzas.total_servicios_planeados|floatformat:2|intcomma }}</h5>
                                    <small class="text-muted">Monto objetivo a cubrir</small>
                                </div>
                                <div class="col-12 col-md-4">
                                    <p class="text-muted mb-1">Servicios pagados</p>
                                    <h5 class="text-success mb-0">{% if venta.tipo_viaje == 'INT' %}USD {% endif %}${{ logistica_finanzas.monto_pagado_servicios|floatformat:2|intcomma }}</h5>
                                    <small class="text-muted">Monto ya aplicado</small>
                                </div>
                                <div class="col-12 col-md-4">
                                    <p class="text-muted mb-1">Ganancia estimada</p>
                                    <h5 class="mb-0">{% if venta.tipo_viaje == 'INT' %}USD {% endif %}${{ logistica_finanzas.ganancia_estimada|floatformat:2|intcomma }}</h5>
                                    <small class="text-muted">Pendiente: {% if venta.tipo_viaje == 'INT' %}USD {% endif %}${{ logistica_finanzas.ganancia_pendiente|floatformat:2|intcomma }}</small>
                                </div>
                            </div>
                        {% if logistica_finanzas.modificaciones and logistica_finanzas.modificaciones > 0 %}
                        <div class="alert alert-light border-start border-info mt-3 py-2">
                            <small>
                                <i class="fas fa-info-circle me-1 text-info"></i>
                                Modificaciones acumuladas: <strong>{% if venta.tipo_viaje == 'INT' %}USD {% endif %}${{ logistica_finanzas.modificaciones|floatformat:2|intcomma }}</strong>
                            </small>
                        </div>
                        {% endif %}
                            {% if not logistica_finanzas.montos_cuadran %}
                                <div class="alert alert-danger mb-3" role="alert">
                                    <strong><i class="fas fa-exclamation-triangle me-1"></i>Verifique las cantidades asignadas.</strong>
                                    La suma de los montos planificados ({% if venta.tipo_viaje == 'INT' %}USD {% endif %}${{ logistica_finanzas.suma_montos_planeados|floatformat:2|intcomma }}) debe ser igual a Servicios planificados ({% if venta.tipo_viaje == 'INT' %}USD {% endif %}${{ logistica_finanzas.total_servicios_planeados|floatformat:2|intcomma }}).
                                </div>
                            {% endif %}
                            {% if servicios_financieros_formset.non_form_errors %}
                                <div class="alert alert-danger">
                                    {% for error in servicios_financieros_formset.non_form_errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <form method="post" class="table-responsive">
                                {% csrf_token %}
                                <input type="hidden" name="actualizar_servicios_logistica" value="1">
                                {{ servicios_financieros_formset.management_form }}
                                <table class="table align-middle table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Servicio</th>
                                            <th width="180">Monto Planificado{% if venta.tipo_viaje == 'INT' %} (USD){% endif %}</th>
                                            <th width="200">Estado</th>
                                            <th width="140">Pagado</th>
                                            <th>Nombre del Proveedor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in servicios_logisticos_rows %}
                                        <tr class="logistica-servicio-row status-{{ row.status }}">
                                            <td>
                                                {% for hidden in row.form.hidden_fields %}{{ hidden }}{% endfor %}
                                                {% if row.servicio %}
                                                <strong>{{ row.servicio.nombre_servicio }}</strong>
                                                {% if row.servicio.fecha_pagado %}
                                                    <div class="text-muted small">Actualizado: {{ row.servicio.fecha_pagado|date:"d/m/Y H:i" }}</div>
                                                {% endif %}
                                                {% else %}
                                                <strong class="text-muted">Servicio (nuevo)</strong>
                                                <small class="d-block text-muted">Complete y guarde para agregar otro proveedor</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="input-group">
                                                    <span class="input-group-text">{% if venta.tipo_viaje == 'INT' %}USD {% endif %}$</span>
                                                    {% if row.servicio %}
                                                    {% comment %} Usar hidden+display cuando bloqueado (monto>0 y no puede editar). Evita que disabled excluya el valor del POST. Quien puede desbloquear ve el form. {% endcomment %}
                                                    {% if puede_desbloquear_todos_los_campos %}
                                                        {{ row.form.monto_planeado }}
                                                    {% elif row.servicio.monto_planeado and row.servicio.monto_planeado > 0 and not puede_editar_logistica_restringidos %}
                                                        <input type="hidden" name="{{ row.form.monto_planeado.name }}" value="{{ row.servicio.monto_planeado|stringformat:'.2f' }}">
                                                        <input type="text" class="form-control logistica-monto-display" value="{{ row.servicio.monto_planeado|floatformat:2 }}" disabled readonly style="background-color: #e9ecef; cursor: not-allowed;" title="Los montos planificados están bloqueados y no se pueden editar">
                                                    {% else %}
                                                        {{ row.form.monto_planeado }}
                                                    {% endif %}
                                                    {% else %}
                                                    {{ row.form.monto_planeado }}
                                                    {% endif %}
                                                </div>
                                                {% for error in row.form.monto_planeado.errors %}
                                                    <div class="text-danger small">{{ error }}</div>
                                                {% endfor %}
                                            </td>
                                            <td>
                                                <span class="badge bg-{{ row.badge_class }} px-3 py-2">{{ row.status_label }}</span>
                                                <small class="d-block text-muted mt-1">{{ row.status_hint }}</small>
                                            </td>
                                            <td>
                                                <div class="form-check">
                                                    {% if row.servicio %}
                                                    {% if puede_desbloquear_todos_los_campos %}
                                                        {{ row.form.pagado }}
                                                        <label class="form-check-label">Pagado</label>
                                                    {% elif row.servicio.pagado and not puede_editar_logistica_restringidos %}
                                                        <input type="hidden" name="{{ row.form.pagado.name }}" value="on">
                                                        <input type="checkbox" class="form-check-input" checked disabled style="cursor: not-allowed;" title="El estado de pago está bloqueado y no se puede desmarcar">
                                                        <label class="form-check-label" style="opacity: 0.7;">Pagado</label>
                                                    {% elif row.status == 'pending' %}
                                                        <input type="checkbox" class="form-check-input" disabled style="cursor: not-allowed;" title="Fondos insuficientes para marcar como pagado">
                                                        <label class="form-check-label text-muted">Pagado</label>
                                                    {% else %}
                                                        {{ row.form.pagado }}
                                                        <label class="form-check-label">Pagado</label>
                                                    {% endif %}
                                                    {% else %}
                                                    {{ row.form.pagado }}
                                                    <label class="form-check-label">Pagado</label>
                                                    {% endif %}
                                                </div>
                                                {% for error in row.form.pagado.errors %}
                                                    <div class="text-danger small">{{ error }}</div>
                                                {% endfor %}
                                            </td>
                                            <td>
                                                {% if row.servicio %}
                                                {% comment %} Usar hidden+display cuando opcion_proveedor bloqueado. Preserva el valor en POST. {% endcomment %}
                                                {% if puede_desbloquear_todos_los_campos %}
                                                    {{ row.form.opcion_proveedor }}
                                                {% elif row.servicio.opcion_proveedor and row.servicio.opcion_proveedor.strip and not puede_editar_logistica_restringidos %}
                                                    <input type="hidden" name="{{ row.form.opcion_proveedor.name }}" value="{{ row.servicio.opcion_proveedor }}">
                                                    <input type="text" class="form-control form-control-sm logistica-proveedor-display" value="{{ row.servicio.opcion_proveedor }}" disabled readonly style="background-color: #e9ecef; cursor: not-allowed;" title="El nombre del proveedor está bloqueado">
                                                {% else %}
                                                    {{ row.form.opcion_proveedor }}
                                                {% endif %}
                                                {% else %}
                                                {{ row.form.opcion_proveedor }}
                                                {% endif %}
                                                {% for error in row.form.opcion_proveedor.errors %}
                                                    <div class="text-danger small">{{ error }}</div>
                                                {% endfor %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                {% if puede_editar_servicios_financieros %}
                                <div class="text-end mt-3">
                                    <button type="submit" class="btn btn-info">
                                        <i class="fas fa-save me-1"></i> Guardar ajustes
                                    </button>
                                </div>
                                {% endif %}
                            </form>
                            {% if puede_editar_servicios_financieros %}
                            <div class="d-flex flex-wrap align-items-center gap-2 mt-2">
                                {% if tiene_tou_para_otro_proveedor %}
                                <form method="post" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="añadir_servicio_logistica" value="1">
                                    <input type="hidden" name="tipo" value="TOU">
                                    <button type="submit" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-plus me-1"></i> Añadir otro Tour
                                    </button>
                                </form>
                                {% endif %}
                                {% if tiene_vue_para_otro_proveedor %}
                                <form method="post" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="añadir_servicio_logistica" value="1">
                                    <input type="hidden" name="tipo" value="VUE">
                                    <button type="submit" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-plus me-1"></i> Añadir otro Vuelo
                                    </button>
                                </form>
                                {% endif %}
                                {% if tiene_hos_para_otro_proveedor %}
                                <form method="post" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="añadir_servicio_logistica" value="1">
                                    <input type="hidden" name="tipo" value="HOS">
                                    <button type="submit" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-plus me-1"></i> Añadir otro Hospedaje
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% else %}
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle me-2"></i> Esta venta todavía no tiene servicios contratados para desglosar.
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    {# Sección de Abonos a Proveedor #}
                    {# Usar variable de la vista: incluye venta.proveedor Y proveedores en logística (Traslado, Tour, etc.) #}
                    {% if debe_mostrar_abonos %}
                    <div class="card mb-4 shadow border-warning" id="abonosProveedorCard">
                        <div class="card-header bg-warning text-dark">
                            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                                <span><i class="fas fa-hand-holding-usd me-2"></i>Abonos a Proveedor</span>
                                <small class="text-dark-50">Gestión de abonos a proveedores externos</small>
                            </div>
                        </div>
                        <div class="card-body">
                            {# Resumen de abonos #}
                            <div class="row text-center g-3 mb-4">
                                <div class="col-12 col-md-4">
                                    <p class="text-muted mb-1">Servicios planificados ({{ moneda_abonos }})</p>
                                    <h4 class="text-primary mb-0">${{ servicios_planificados_abonos|floatformat:2|intcomma }} {{ moneda_abonos }}</h4>
                                </div>
                                <div class="col-12 col-md-4">
                                    <p class="text-muted mb-1">Total Abonado al Proveedor</p>
                                    <h4 class="text-success mb-0">${{ total_abonado_proveedor|floatformat:2|intcomma }} {{ moneda_abonos }}</h4>
                                </div>
                                <div class="col-12 col-md-4">
                                    <p class="text-muted mb-1">Saldo Pendiente</p>
                                    <h4 class="text-warning mb-0">${{ saldo_pendiente_proveedor|floatformat:2|intcomma }} {{ moneda_abonos }}</h4>
                                </div>
                            </div>

                            {# Botón para solicitar abono #}
                            {% if puede_solicitar_abono_proveedor %}
                            <div class="mb-4">
                                <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalSolicitarAbonoProveedor">
                                    <i class="fas fa-plus-circle me-2"></i>Solicitar Abono al Proveedor
                                </button>
                            </div>
                            {% endif %}

                            {# Tabla de historial de abonos #}
                            {% if abonos_proveedor %}
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Proveedor</th>
                                            <th>Fecha Solicitud</th>
                                            <th>Monto ({{ moneda_abonos }})</th>
                                            <th>Estado</th>
                                            <th>Solicitado Por</th>
                                            <th>Notas</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for abono in abonos_proveedor %}
                                        <tr>
                                            <td><strong>{{ abono.proveedor }}</strong></td>
                                            <td>{{ abono.fecha_solicitud|date:"d/m/Y H:i" }}</td>
                                            {% if venta.tipo_viaje == 'INT' %}
                                                {% with tc_abono=abono.tipo_cambio_para_display|default:venta.tipo_cambio %}
                                                <td>
                                                    {% if abono.monto_usd_para_display %}
                                                        <strong>USD ${{ abono.monto_usd_para_display|floatformat:2|intcomma }}</strong>
                                                        {% if tc_abono %}<br><small class="text-muted">TC: ${{ tc_abono|floatformat:4 }} MXN/USD</small>{% endif %}
                                                    {% else %}
                                                        <strong>${{ abono.monto|floatformat:2|intcomma }} MXN</strong>
                                                        {% if tc_abono %}<br><small class="text-muted">TC: ${{ tc_abono|floatformat:4 }} MXN/USD</small>{% endif %}
                                                    {% endif %}
                                                </td>
                                                {% endwith %}
                                            {% else %}
                                                <td><strong>${{ abono.monto|floatformat:2|intcomma }}</strong></td>
                                            {% endif %}
                                            <td>
                                                {% if abono.estado == 'PENDIENTE' %}
                                                    <span class="badge bg-warning text-dark">Pendiente</span>
                                                {% elif abono.estado == 'APROBADO' %}
                                                    <span class="badge bg-info">Aprobado</span>
                                                {% elif abono.estado == 'COMPLETADO' %}
                                                    <span class="badge bg-success">Completado</span>
                                                {% elif abono.estado == 'CANCELADO' %}
                                                    <span class="badge bg-secondary">Cancelado</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ abono.solicitud_por.get_full_name|default:abono.solicitud_por.username }}</td>
                                            <td>
                                                {% if abono.nota_solicitud %}
                                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalNotasAbono{{ abono.id }}" title="Ver notas">
                                                        <i class="fas fa-sticky-note"></i>
                                                    </button>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    {% if abono.estado == 'PENDIENTE' and puede_aprobar_abono_proveedor %}
                                                        <form method="post" action="{% url 'aprobar_abono_proveedor' abono.id %}" style="display: inline;">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-info btn-sm" title="Aprobar">
                                                                <i class="fas fa-check"></i>
                                                            </button>
                                                        </form>
                                                    {% endif %}
                                                    {% if abono.estado == 'APROBADO' and puede_confirmar_abono_proveedor %}
                                                        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalConfirmarAbonoProveedor{{ abono.id }}" title="Confirmar con comprobante">
                                                            <i class="fas fa-upload"></i>
                                                        </button>
                                                    {% endif %}
                                                    {% if abono.estado == 'COMPLETADO' and puede_confirmar_abono_proveedor and not abono.comprobante %}
                                                        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalConfirmarAbonoProveedor{{ abono.id }}" title="Subir comprobante">
                                                            <i class="fas fa-upload"></i>
                                                        </button>
                                                    {% endif %}
                                                    {% if abono.estado == 'COMPLETADO' and puede_confirmar_abono_proveedor and abono.comprobante %}
                                                        <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#modalConfirmarAbonoProveedor{{ abono.id }}" title="Reemplazar comprobante">
                                                            <i class="fas fa-exchange-alt"></i>
                                                        </button>
                                                        <form method="post" action="{% url 'eliminar_comprobante_abono_proveedor' abono_id=abono.id %}" style="display: inline;" onsubmit="return confirm('¿Eliminar el comprobante actual? Podrás subir el correcto después.');">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-outline-danger btn-sm" title="Eliminar comprobante">
                                                                <i class="fas fa-trash-alt"></i>
                                                            </button>
                                                        </form>
                                                    {% endif %}
                                                    {% if abono.comprobante %}
                                                        <a href="{{ abono.comprobante.url }}" target="_blank" class="btn btn-outline-primary btn-sm" title="Ver comprobante subido por el contador">
                                                            <i class="fas fa-file-invoice"></i>
                                                        </a>
                                                    {% endif %}
                                                    {% if abono.estado == 'PENDIENTE' and puede_cancelar_abono_proveedor %}
                                                        <form method="post" action="{% url 'cancelar_abono_proveedor' abono.id %}" style="display: inline;" onsubmit="return confirm('¿Estás seguro de cancelar este abono?');">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-danger btn-sm" title="Cancelar">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                        </form>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle me-2"></i> No se han solicitado abonos a este proveedor aún.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                </div>
            {% endif %}

            <div class="tab-pane fade" id="confirmaciones" role="tabpanel" aria-labelledby="confirmaciones-tab">
                <div class="row">
                    <div class="col-lg-4">
                        <div class="card shadow-sm mb-4 border-secondary">
                            <div class="card-header bg-secondary text-white">
                                Subir confirmaciones
                            </div>
                            <div class="card-body">
                                {% if confirmacion_form %}
                                    {% if puede_subir_confirmaciones %}
                                        <form method="post" enctype="multipart/form-data">
                                            {% csrf_token %}
                                            <div class="mb-3">
                                                <label for="{{ confirmacion_form.archivos.id_for_label }}" class="form-label fw-semibold">
                                                    {{ confirmacion_form.archivos.label }}
                                                </label>
                                                {{ confirmacion_form.archivos }}
                                                <div class="form-text text-muted">{{ confirmacion_form.archivos.help_text }}</div>
                                                {% for error in confirmacion_form.archivos.errors %}
                                                    <div class="text-danger small mt-1">{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                            <div class="mb-3">
                                                <label for="{{ confirmacion_form.nota.id_for_label }}" class="form-label fw-semibold">
                                                    {{ confirmacion_form.nota.label }}
                                                </label>
                                                {{ confirmacion_form.nota }}
                                                {% for error in confirmacion_form.nota.errors %}
                                                    <div class="text-danger small mt-1">{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                            <button type="submit" name="registrar_confirmacion" class="btn btn-secondary w-100">
                                                <i class="fas fa-upload me-1"></i> Guardar confirmaciones
                                            </button>
                                        </form>
                                    {% else %}
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            No tienes permisos para subir confirmaciones en esta venta.
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="alert alert-danger">
                                        <i class="fas fa-exclamation-circle me-2"></i>
                                        Error: El formulario de confirmaciones no está disponible.
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="card shadow-sm">
                            <div class="card-header bg-light">
                                Archivos cargados
                            </div>
                            <div class="card-body">
                                {% if confirmaciones %}
                                    <div class="row g-3">
                                        {% for confirmacion in confirmaciones %}
                                            <div class="col-md-6">
                                                <div class="card h-100 border-0 shadow-sm">
                                                    <div class="card-body">
                                                        <h6 class="fw-bold mb-2">
                                                            <i class="fas fa-file-alt me-1 text-secondary"></i>
                                                            {{ confirmacion.nombre_archivo }}
                                                        </h6>
                                                        <p class="small text-muted mb-2">
                                                            Subido el {{ confirmacion.fecha_subida|date:"d/m/Y H:i" }}
                                                            {% if confirmacion.subido_por %}
                                                                por {{ confirmacion.subido_por.get_full_name|default:confirmacion.subido_por.username }}
                                                            {% endif %}
                                                        </p>
                                                        <p class="mb-3">{{ confirmacion.nota|default:"Sin descripción" }}</p>
                                                        <a href="{{ confirmacion.archivo.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                            <i class="fas fa-download"></i> Descargar
                                                        </a>
                                                    </div>
                                                    {% if confirmacion.es_imagen %}
                                                        <img src="{{ confirmacion.archivo.url }}" alt="{{ confirmacion.nombre_archivo }}" class="img-fluid rounded-bottom">
                                                    {% elif confirmacion.es_pdf %}
                                                        <div class="ratio ratio-4x3">
                                                            <iframe src="{{ confirmacion.archivo.url }}" title="{{ confirmacion.nombre_archivo }}" class="rounded-bottom" loading="lazy"></iframe>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="alert alert-light border text-center">
                                        <i class="fas fa-info-circle me-2"></i> Aún no se han cargado confirmaciones para esta venta.
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div> 
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Modal para subir comprobante de apertura -->
<div class="modal fade" id="modalComprobanteApertura" tabindex="-1" aria-labelledby="modalComprobanteAperturaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalComprobanteAperturaLabel">
                    <i class="fas fa-upload"></i> Subir Comprobante de Apertura
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'subir_comprobante_apertura' pk=venta.pk %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <p class="text-muted">Por favor, sube una imagen del comprobante de pago (recibo, screenshot, ticket, etc.).</p>
                    <div class="mb-3">
                        <label for="comprobante_apertura" class="form-label">Imagen del Comprobante <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="comprobante_apertura" name="comprobante_apertura" accept="image/*,.pdf" required>
                        <div class="form-text">Formatos aceptados: JPG, PNG, PDF. La imagen se comprimirá automáticamente.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-upload"></i> Subir Comprobante
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para editar comprobante de apertura (cuando ya está subido pero no confirmado por el contador) -->
{% if venta.modo_pago_apertura in 'TRN,TAR,DEP' and venta.comprobante_apertura_subido and venta.comprobante_apertura and not venta.apertura_confirmada %}
<div class="modal fade" id="modalEditarComprobanteApertura" tabindex="-1" aria-labelledby="modalEditarComprobanteAperturaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalEditarComprobanteAperturaLabel">
                    <i class="fas fa-edit"></i> Editar Comprobante de Apertura
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'subir_comprobante_apertura' pk=venta.pk %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <p class="text-muted">Apertura: <strong>${{ venta.cantidad_apertura|floatformat:2|intcomma }}</strong> - {{ venta.get_modo_pago_apertura_display }}</p>
                    {% if venta.comprobante_apertura %}
                    <div class="mb-3">
                        <label class="form-label">Comprobante actual:</label>
                        <div>
                            <a href="{{ venta.comprobante_apertura.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-image"></i> Ver actual
                            </a>
                        </div>
                    </div>
                    {% endif %}
                    <p class="text-muted">Sube una nueva imagen del comprobante para reemplazar la actual.</p>
                    <div class="mb-3">
                        <label for="comprobante_apertura_editar" class="form-label">Nueva Imagen del Comprobante <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="comprobante_apertura_editar" name="comprobante_apertura" accept="image/*,.pdf" required>
                        <div class="form-text">Formatos aceptados: JPG, PNG, PDF. La imagen se comprimirá automáticamente.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save"></i> Actualizar Comprobante
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Modales para subir comprobante de abonos (uno por cada abono pendiente) -->
{% for abono in abonos %}
    {% if abono.forma_pago in 'TRN,TAR,DEP' and not abono.confirmado and not abono.comprobante_subido %}
    <div class="modal fade" id="modalComprobanteAbono{{ abono.pk }}" tabindex="-1" aria-labelledby="modalComprobanteAbonoLabel{{ abono.pk }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="modalComprobanteAbonoLabel{{ abono.pk }}">
                        <i class="fas fa-upload"></i> Subir Comprobante de Abono
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'subir_comprobante_abono' pk=abono.pk %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-body">
                        <p class="text-muted mb-0">Abono: {% if venta.tipo_viaje == 'INT' and abono.monto_usd_para_display %}<strong>USD ${{ abono.monto_usd_para_display|floatformat:2|intcomma }}</strong>{% if abono.tipo_cambio_para_display or venta.tipo_cambio %} <small class="text-muted">(TC: ${{ abono.tipo_cambio_para_display|default:venta.tipo_cambio|floatformat:4 }} MXN/USD)</small>{% endif %}{% else %}<strong>${{ abono.monto|floatformat:2|intcomma }}</strong>{% endif %} - {{ abono.get_forma_pago_display }}</p>
                        <p class="text-muted">Por favor, sube una imagen del comprobante de pago (recibo, screenshot, ticket, etc.).</p>
                        <div class="mb-3">
                            <label for="comprobante_imagen{{ abono.pk }}" class="form-label">Imagen del Comprobante <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" id="comprobante_imagen{{ abono.pk }}" name="comprobante_imagen" accept="image/*,.pdf" required>
                            <div class="form-text">Formatos aceptados: JPG, PNG, PDF. La imagen se comprimirá automáticamente.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-upload"></i> Subir Comprobante
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Modal para editar comprobante (cuando ya está subido pero no confirmado) -->
    {% if abono.forma_pago in 'TRN,TAR,DEP' and not abono.confirmado and abono.comprobante_subido %}
    <div class="modal fade" id="modalEditarComprobanteAbono{{ abono.pk }}" tabindex="-1" aria-labelledby="modalEditarComprobanteAbonoLabel{{ abono.pk }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="modalEditarComprobanteAbonoLabel{{ abono.pk }}">
                        <i class="fas fa-edit"></i> Editar Comprobante de Abono
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'subir_comprobante_abono' pk=abono.pk %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-body">
                        <p class="text-muted mb-0">Abono: {% if venta.tipo_viaje == 'INT' and abono.monto_usd_para_display %}<strong>USD ${{ abono.monto_usd_para_display|floatformat:2|intcomma }}</strong>{% if abono.tipo_cambio_para_display or venta.tipo_cambio %} <small class="text-muted">(TC: ${{ abono.tipo_cambio_para_display|default:venta.tipo_cambio|floatformat:4 }} MXN/USD)</small>{% endif %}{% else %}<strong>${{ abono.monto|floatformat:2|intcomma }}</strong>{% endif %} - {{ abono.get_forma_pago_display }}</p>
                        {% if abono.comprobante_imagen %}
                        <div class="mb-3">
                            <label class="form-label">Comprobante actual:</label>
                            <div>
                                <a href="{{ abono.comprobante_imagen.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-image"></i> Ver actual
                                </a>
                            </div>
                        </div>
                        {% endif %}
                        <p class="text-muted">Sube una nueva imagen del comprobante para reemplazar la actual.</p>
                        <div class="mb-3">
                            <label for="comprobante_imagen_editar{{ abono.pk }}" class="form-label">Nueva Imagen del Comprobante <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" id="comprobante_imagen_editar{{ abono.pk }}" name="comprobante_imagen" accept="image/*,.pdf" required>
                            <div class="form-text">Formatos aceptados: JPG, PNG, PDF. La imagen se comprimirá automáticamente.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-save"></i> Actualizar Comprobante
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
{% endfor %}

{# Modal para Revisar Solicitud de Cancelación (solo para director) #}
{% if solicitud_cancelacion and solicitud_cancelacion.estado == 'PENDIENTE' and puede_aprobar_rechazar_cancelacion %}
<div class="modal fade" id="revisarSolicitudCancelacionModal" tabindex="-1" aria-labelledby="revisarSolicitudCancelacionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="revisarSolicitudCancelacionModalLabel">
                    <i class="fas fa-clipboard-list me-2"></i>Revisar Solicitud de Cancelación
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong class="text-muted d-block mb-1">Venta:</strong>
                        <span class="badge bg-primary fs-6">#{{ venta.folio|default:venta.pk }}</span>
                    </div>
                    <div class="col-md-6">
                        <strong class="text-muted d-block mb-1">Cliente:</strong>
                        <span>{{ venta.cliente.nombre_completo_display }}</span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong class="text-muted d-block mb-1">Vendedor:</strong>
                        <span>
                            {% if venta.vendedor.get_full_name %}
                                {{ venta.vendedor.get_full_name }} ({{ venta.vendedor.username }})
                            {% else %}
                                {{ venta.vendedor.username }}
                            {% endif %}
                        </span>
                    </div>
                    <div class="col-md-6">
                        <strong class="text-muted d-block mb-1">Fecha de Solicitud:</strong>
                        <span>{{ solicitud_cancelacion.fecha_solicitud|date:"d/m/Y H:i" }}</span>
                    </div>
                </div>
                <hr>
                <div class="mb-3">
                    <strong class="text-muted d-block mb-2">
                        <i class="fas fa-comment-alt me-2"></i>Motivo de la Cancelación:
                    </strong>
                    <div class="alert alert-light border" style="min-height: 100px; white-space: pre-wrap; word-wrap: break-word;">
                        {{ solicitud_cancelacion.motivo }}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cerrar
                </button>
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalRechazarCancelacion" data-bs-dismiss="modal">
                    <i class="fas fa-times-circle me-1"></i> Rechazar
                </button>
                <form method="post" action="{% url 'aprobar_cancelacion' pk=solicitud_cancelacion.pk %}" style="display: inline;" onsubmit="return confirm('¿Estás seguro de que deseas aprobar esta solicitud de cancelación?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check-circle me-1"></i> Aprobar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{# Modal para Rechazar Cancelación (con motivo) #}
<div class="modal fade" id="modalRechazarCancelacion" tabindex="-1" aria-labelledby="modalRechazarCancelacionLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalRechazarCancelacionLabel">
                    <i class="fas fa-times-circle me-2"></i>Rechazar Solicitud de Cancelación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'rechazar_cancelacion' pk=solicitud_cancelacion.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <p>¿Estás seguro de que deseas rechazar esta solicitud de cancelación?</p>
                    <div class="mb-3">
                        <label for="motivo_rechazo" class="form-label fw-bold">
                            <i class="fas fa-comment-alt me-2"></i>Motivo del Rechazo <span class="text-danger">*</span>
                        </label>
                        <textarea 
                            class="form-control" 
                            id="motivo_rechazo" 
                            name="motivo_rechazo" 
                            rows="4" 
                            placeholder="Proporciona el motivo del rechazo (mínimo 10 caracteres)..." 
                            required
                            minlength="10"
                            style="resize: vertical;"></textarea>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            El vendedor recibirá una notificación con este motivo.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times-circle me-1"></i> Rechazar Solicitud
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% endblock modals %}

{% block extra_js %}
<script>
    var activar_tab_logistica = {{ activar_tab_logistica|default:False|yesno:"true,false" }};
    // Código JS para la funcionalidad de pestañas y URL
    document.addEventListener('DOMContentLoaded', function() {
        // Al hacer clic en un tab, actualizar la URL para que se mantenga
        const tabButtons = document.querySelectorAll('button[data-bs-toggle="tab"]');
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tabId = this.id.replace('-tab', '');
                history.replaceState(null, null, `?tab=${tabId}`);
            });
        });

        // Revisar URL para activar la pestaña correcta al cargar
        const urlParams = new URLSearchParams(window.location.search);
        let activeTabId = urlParams.get('tab');
        // Tras guardar logística (re-render sin redirect), mantener pestaña Logística activa
        if (typeof activar_tab_logistica !== 'undefined' && activar_tab_logistica) {
            activeTabId = 'logistica';
        }
        if (activeTabId) {
            // Aseguramos que el tab exista (ej: si el usuario no es JEFE/CONTADOR, el tab de logística no existe)
            const activeTab = document.querySelector(`#${activeTabId}-tab`);
            if (activeTab) {
                // Usamos el constructor de Bootstrap para mostrar la pestaña
                // Se asume que el objeto 'bootstrap' está disponible globalmente.
                if (typeof bootstrap !== 'undefined' && bootstrap.Tab) {
                    new bootstrap.Tab(activeTab).show();
                }
            }
        }

        // Conversión de abono USD->MXN con tipo de cambio por abono (solo INT)
        const abonoForm = document.querySelector('form button[name="registrar_abono"]')?.closest('form');
        if (abonoForm && "{{ venta.tipo_viaje }}" === "INT") {
            const montoInput = document.getElementById('{{ abono_form.monto.auto_id }}');
            const montoUsdInput = document.getElementById('montoUsd');
            const tipoCambioInput = document.getElementById('tipoCambioAbono');
            const montoUsdError = document.getElementById('montoUsdError');
            const tipoCambioError = document.getElementById('tipoCambioError');
            abonoForm.addEventListener('submit', function(e) {
                if (!montoUsdInput || !montoInput || !tipoCambioInput) return;
                // Usamos limpiarFormatoMoneda() para quitar '$', 'USD' y comas antes de convertir
                const usd = parseFloat(limpiarFormatoMoneda(montoUsdInput.value));
                const tc = parseFloat(limpiarFormatoMoneda(tipoCambioInput.value));
                let hasError = false;
                if (isNaN(usd) || usd <= 0) {
                    hasError = true;
                    if (montoUsdError) montoUsdError.classList.remove('d-none');
                } else if (montoUsdError) {
                    montoUsdError.classList.add('d-none');
                }
                if (isNaN(tc) || tc <= 0) {
                    hasError = true;
                    if (tipoCambioError) tipoCambioError.classList.remove('d-none');
                } else if (tipoCambioError) {
                    tipoCambioError.classList.add('d-none');
                }
                if (hasError) {
                    e.preventDefault();
                    return;
                }
                const mxn = usd * tc;
                montoInput.value = mxn.toFixed(2);
            });
        }
    });
</script>

{# Modales para Abonos a Proveedor #}
{% if debe_mostrar_abonos %}
<!-- Modal para solicitar abono a proveedor -->
<div class="modal fade" id="modalSolicitarAbonoProveedor" tabindex="-1" aria-labelledby="modalSolicitarAbonoProveedorLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalSolicitarAbonoProveedorLabel">
                    <i class="fas fa-hand-holding-usd"></i> Solicitar Abono a Proveedor
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'solicitar_abono_proveedor' pk=venta.pk %}" id="formSolicitarAbonoProveedor">
                {% csrf_token %}
                <div class="modal-body">
                    <p class="text-muted">Servicios planificados: <strong>${{ servicios_planificados_abonos|floatformat:2|intcomma }} {{ moneda_abonos }}</strong></p>
                    <p class="text-muted">Saldo pendiente: <strong>${{ saldo_pendiente_proveedor|floatformat:2|intcomma }} {{ moneda_abonos }}</strong></p>
                    <hr>
                    {% if form_abono_proveedor %}
                        <div class="mb-3">
                            <label for="{{ form_abono_proveedor.proveedor.id_for_label }}" class="form-label">
                                {{ form_abono_proveedor.proveedor.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form_abono_proveedor.proveedor }}
                            <div class="form-text">{{ form_abono_proveedor.proveedor.help_text }}</div>
                            {% for error in form_abono_proveedor.proveedor.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form_abono_proveedor.monto.id_for_label }}" class="form-label">
                                {{ form_abono_proveedor.monto.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form_abono_proveedor.monto }}
                            <div class="form-text">{{ form_abono_proveedor.monto.help_text }}</div>
                            {% for error in form_abono_proveedor.monto.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form_abono_proveedor.tipo_cambio_aplicado.id_for_label }}" class="form-label">
                                {{ form_abono_proveedor.tipo_cambio_aplicado.label }}
                                {% if venta.tipo_viaje == 'INT' %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            {{ form_abono_proveedor.tipo_cambio_aplicado }}
                            <div class="form-text">{{ form_abono_proveedor.tipo_cambio_aplicado.help_text }}</div>
                            {% for error in form_abono_proveedor.tipo_cambio_aplicado.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form_abono_proveedor.nota_solicitud.id_for_label }}" class="form-label">
                                {{ form_abono_proveedor.nota_solicitud.label }}
                            </label>
                            {{ form_abono_proveedor.nota_solicitud }}
                            <div class="form-text">{{ form_abono_proveedor.nota_solicitud.help_text }}</div>
                            {% for error in form_abono_proveedor.nota_solicitud.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-paper-plane"></i> Enviar Solicitud
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    // Inicializar formato de moneda cuando se abre el modal de abono a proveedor
    const modalSolicitarAbonoProveedor = document.getElementById('modalSolicitarAbonoProveedor');
    if (modalSolicitarAbonoProveedor) {
        modalSolicitarAbonoProveedor.addEventListener('shown.bs.modal', function() {
            const formAbonoProveedor = document.getElementById('formSolicitarAbonoProveedor');
            if (formAbonoProveedor) {
                const montoProveedorInput = formAbonoProveedor.querySelector('input[name="monto"]');
                const tipoCambioProveedorInput = formAbonoProveedor.querySelector('input[name="tipo_cambio_aplicado"]');
                
                // Inicializar formato de moneda para el campo monto
                if (montoProveedorInput && typeof inicializarFormatoMonedaEnCampos === 'function') {
                    if (!montoProveedorInput.hasAttribute('data-formato-inicializado')) {
                        inicializarFormatoMonedaEnCampos(['input[name="monto"]']);
                    }
                }
            }
        });
    }
</script>

<!-- Modales para confirmar/reemplazar comprobante de abonos a proveedor (contador: APROBADO = confirmar, COMPLETADO = reemplazar) -->
{% for abono in abonos_proveedor %}
    {% if puede_confirmar_abono_proveedor and abono.estado == 'APROBADO' or puede_confirmar_abono_proveedor and abono.estado == 'COMPLETADO' %}
    <div class="modal fade" id="modalConfirmarAbonoProveedor{{ abono.id }}" tabindex="-1" aria-labelledby="modalConfirmarAbonoProveedor{{ abono.id }}Label" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header {% if abono.estado == 'COMPLETADO' %}bg-warning text-dark{% else %}bg-success text-white{% endif %}">
                    <h5 class="modal-title" id="modalConfirmarAbonoProveedor{{ abono.id }}Label">
                        {% if abono.estado == 'COMPLETADO' %}
                            <i class="fas fa-exchange-alt"></i> Reemplazar Comprobante
                        {% else %}
                            <i class="fas fa-check-circle"></i> Confirmar Abono a Proveedor
                        {% endif %}
                    </h5>
                    <button type="button" class="btn-close {% if abono.estado == 'COMPLETADO' %}btn-close-dark{% else %}btn-close-white{% endif %}" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'confirmar_abono_proveedor' abono_id=abono.id %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-body">
                        <p class="text-muted">Proveedor: <strong>{{ abono.proveedor }}</strong></p>
                        {% if venta.tipo_viaje == 'INT' %}
                            {% with tc_abono=abono.tipo_cambio_para_display|default:venta.tipo_cambio %}
                            {% if abono.monto_usd_para_display %}
                                <p class="text-muted mb-0">Monto: <strong>USD ${{ abono.monto_usd_para_display|floatformat:2|intcomma }}</strong></p>
                                {% if tc_abono %}<p class="text-muted small mb-0">TC: ${{ tc_abono|floatformat:4 }} MXN/USD</p>{% endif %}
                            {% else %}
                                <p class="text-muted mb-0">Monto: <strong>${{ abono.monto|floatformat:2|intcomma }} MXN</strong></p>
                                {% if tc_abono %}<p class="text-muted small mb-0">TC: ${{ tc_abono|floatformat:4 }} MXN/USD</p>{% endif %}
                            {% endif %}
                            {% endwith %}
                        {% else %}
                            <p class="text-muted">Monto: <strong>${{ abono.monto|floatformat:2|intcomma }} MXN</strong></p>
                        {% endif %}
                        <hr>
                        <div class="mb-3">
                            <label for="comprobante_abono_{{ abono.id }}" class="form-label">
                                {% if abono.estado == 'COMPLETADO' %}Nuevo comprobante{% else %}Comprobante de Abono{% endif %} <span class="text-danger">*</span>
                            </label>
                            <input type="file" class="form-control" id="comprobante_abono_{{ abono.id }}" name="comprobante" accept="image/*,.pdf" required>
                            <div class="form-text">Sube el comprobante de pago al proveedor (imagen o PDF)</div>
                        </div>
                        <div class="mb-3">
                            <label for="nota_confirmacion_{{ abono.id }}" class="form-label">
                                Nota de Confirmación
                            </label>
                            <textarea class="form-control" id="nota_confirmacion_{{ abono.id }}" name="nota_confirmacion" rows="3" placeholder="Notas adicionales...">{{ abono.nota_confirmacion|default:'' }}</textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn {% if abono.estado == 'COMPLETADO' %}btn-warning{% else %}btn-success{% endif %}">
                            {% if abono.estado == 'COMPLETADO' %}
                                <i class="fas fa-upload"></i> Actualizar Comprobante
                            {% else %}
                                <i class="fas fa-check"></i> Confirmar con Comprobante
                            {% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
{% endfor %}

<!-- Modales para ver notas de abonos a proveedor -->
{% for abono in abonos_proveedor %}
    {% if abono.nota_solicitud %}
    <div class="modal fade" id="modalNotasAbono{{ abono.id }}" tabindex="-1" aria-labelledby="modalNotasAbono{{ abono.id }}Label" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h6 class="modal-title" id="modalNotasAbono{{ abono.id }}Label">
                        <i class="fas fa-sticky-note me-2"></i>Notas
                    </h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0 text-muted small">{{ abono.nota_solicitud|linebreaks }}</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
{% endfor %}
{% endif %}

{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" 
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        .logistica-servicio-row.status-pending {
            border-left: 4px solid #dc3545;
            background-color: rgba(220,53,69,0.05);
        }
        .logistica-servicio-row.status-ready {
            border-left: 4px solid #ffc107;
            background-color: rgba(255,193,7,0.08);
        }
        .logistica-servicio-row.status-paid {
            border-left: 4px solid #198754;
            background-color: rgba(25,135,84,0.08);
        }
        /* Impresión: solo zona de Información general, centrada. Evitar position:fixed para que todo el contenido fluya y se imprima en varias páginas. */
        @media print {
            /* En impresión la página es toda el ancho; quitar margen del sidebar para centrar bien */
            html, body { margin: 0 !important; padding: 0 !important; width: 100% !important; }
            #page-content-wrapper { margin-left: 0 !important; width: 100% !important; max-width: none !important; }
            #main-content { margin: 0 !important; padding: 0 !important; max-width: none !important; }
            .container-fluid { margin-left: 0 !important; margin-right: 0 !important; max-width: 100% !important; padding-left: 0 !important; padding-right: 0 !important; }
            /* Ocultar todo excepto la zona de impresión */
            body *:not(#venta-print-area):not(#venta-print-area *) { visibility: hidden !important; }
            #venta-print-area, #venta-print-area * { visibility: visible !important; }
            .d-print-none, .d-print-none * { display: none !important; visibility: hidden !important; }
            /* Centrado: márgenes laterales iguales (2.5% cada lado) para que quede centrado en la hoja */
            #venta-print-area {
                position: absolute !important;
                left: 2.5% !important;
                right: 2.5% !important;
                width: auto !important;
                max-width: none !important;
                top: 0 !important;
                margin: 0 !important;
                height: auto !important;
                min-height: auto !important;
                overflow: visible !important;
                padding: 0 1rem !important;
                box-sizing: border-box;
                background: white !important;
                z-index: 99999;
            }
            .navbar, .sidebar, nav, header, .breadcrumb, footer, #sidebar-wrapper { display: none !important; }
            .card { break-inside: avoid; }
            .card-header { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            /* En impresión mostrar todo el texto de detalles de servicios (sin recortar a 200px) */
            .detalle-servicios-texto { max-height: none !important; overflow: visible !important; }
        }
    </style>
    {# Script común para formateo de moneda #}
    <script src="{% static 'js/currency-formatter.js' %}"></script>
    <script>
        // ========== FORMATO DE MONEDA EN TIEMPO REAL ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Campo de monto en MXN (formulario de abonos)
            const campoMontoMXN = document.getElementById('{{ abono_form.monto.id_for_label }}');
            if (campoMontoMXN) {
                inicializarFormatoMonedaEnCampos(['#{{ abono_form.monto.id_for_label }}']);
            }
            
            // Campo de monto en USD (formulario de abonos para ventas internacionales)
            const campoMontoUSD = document.getElementById('montoUsd');
            if (campoMontoUSD) {
                campoMontoUSD.setAttribute('data-formato-inicializado', 'true');
                
                // Formato inicial si ya tiene valor
                if (campoMontoUSD.value && !campoMontoUSD.value.startsWith('USD $') && !campoMontoUSD.value.startsWith('$')) {
                    const valorLimpio = limpiarFormatoMoneda(campoMontoUSD.value);
                    if (valorLimpio) {
                        const parts = valorLimpio.split('.');
                        let integerPart = parts[0];
                        let decimalPart = parts.length > 1 ? '.' + parts[1].substring(0, 2) : '';
                        if (integerPart) {
                            integerPart = parseInt(integerPart, 10).toLocaleString('es-MX');
                        }
                        campoMontoUSD.value = 'USD $' + integerPart + decimalPart;
                    }
                }
                
                // Formatear mientras escribe (con USD $)
                campoMontoUSD.addEventListener('input', function() {
                    const cursorPosition = this.selectionStart;
                    const originalValue = this.value;
                    let digitsBeforeCursor = 0;
                    for (let i = 0; i < cursorPosition; i++) {
                        if (/[0-9]/.test(originalValue[i])) digitsBeforeCursor++;
                    }
                    
                    let value = this.value.replace(/[^0-9.]/g, '');
                    if (!value) {
                        this.value = '';
                        return;
                    }
                    
                    const parts = value.split('.');
                    let integerPart = parts[0];
                    let decimalPart = parts.length > 1 ? '.' + parts[1].substring(0, 2) : '';
                    if (integerPart) {
                        integerPart = parseInt(integerPart, 10).toLocaleString('es-MX');
                    } else if (parts.length > 1) {
                        integerPart = '0';
                    }
                    
                    const newValue = 'USD $' + integerPart + decimalPart;
                    
                    if (this.value !== newValue) {
                        this.value = newValue;
                        let newCursorPos = 0;
                        let digitsFound = 0;
                        for (let i = 0; i < newValue.length; i++) {
                            if (/[0-9]/.test(newValue[i])) {
                                digitsFound++;
                            }
                            if (digitsFound >= digitsBeforeCursor) {
                                newCursorPos = i + 1;
                                if (digitsFound === digitsBeforeCursor) break;
                            }
                        }
                        if (digitsBeforeCursor === 0) newCursorPos = 6; // Después de "USD $"
                        this.setSelectionRange(newCursorPos, newCursorPos);
                    }
                });
                
                campoMontoUSD.addEventListener('blur', function() {
                    if (this.value === 'USD $' || this.value === '$') this.value = '';
                });
            }
            
            // Campos monto_planeado en la tabla de servicios (logística)
            // Estos campos se generan dinámicamente, así que usamos delegación de eventos
            document.addEventListener('input', function(e) {
                if (e.target && e.target.id && e.target.id.includes('monto_planeado')) {
                    const campo = e.target;
                    if (!campo.hasAttribute('data-formato-inicializado')) {
                        campo.setAttribute('data-formato-inicializado', 'true');
                    }
                    // Solo formatear si hay valor y no es 0 o 0.00
                    if (campo.value && campo.value.trim() !== '' && campo.value !== '0' && campo.value !== '0.00') {
                        formatearEnTiempoReal(campo);
                    } else if (campo.value === '0' || campo.value === '0.00') {
                        campo.value = '';
                    }
                }
            });
            
            // Inicializar formato solo en campos monto_planeado EDITABLES (excluir .logistica-monto-display que son solo visualización)
            const camposMontoPlaneado = document.querySelectorAll('[id*="monto_planeado"]:not(.logistica-monto-display)');
            camposMontoPlaneado.forEach(campo => {
                if (!campo.hasAttribute('data-formato-inicializado')) {
                    campo.setAttribute('data-formato-inicializado', 'true');
                    // Solo formatear si tiene valor y no es 0.00 o vacío
                    if (campo.value && campo.value.trim() !== '' && campo.value !== '0.00' && campo.value !== '0' && !campo.value.startsWith('$')) {
                        // Limpiar el valor primero para verificar si es realmente 0
                        const valorLimpio = campo.value.replace('$', '').replace(',', '').trim();
                        if (valorLimpio && valorLimpio !== '0' && valorLimpio !== '0.00') {
                            formatearEnTiempoReal(campo);
                        } else {
                            // Si es 0.00, dejar vacío
                            campo.value = '';
                        }
                    } else if (campo.value === '0.00' || campo.value === '0') {
                        // Si el valor es 0.00, dejarlo vacío
                        campo.value = '';
                    }
                    campo.addEventListener('input', function() {
                        // Solo formatear si hay valor y no es solo 0
                        if (this.value && this.value.trim() !== '' && this.value !== '0' && this.value !== '0.00') {
                            formatearEnTiempoReal(this);
                        }
                    });
                    campo.addEventListener('blur', function() {
                        if (this.value === '$' || this.value === '0.00' || this.value === '0') {
                            this.value = '';
                        }
                    });
                }
            });
            
            // Limpiar formato antes de enviar formularios - SOLO los campos del formulario que se está enviando
            const forms = document.querySelectorAll('form[method="post"]');
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    // Limpiar formato de campo monto MXN solo si está en este formulario
                    if (campoMontoMXN && form.contains(campoMontoMXN) && campoMontoMXN.value) {
                        campoMontoMXN.value = limpiarFormatoMoneda(campoMontoMXN.value);
                    }
                    
                    // Limpiar formato de campo monto USD solo si está en este formulario
                    if (campoMontoUSD && form.contains(campoMontoUSD) && campoMontoUSD.value) {
                        let valorLimpio = campoMontoUSD.value.replace(/USD \$/g, '').replace(/\$/g, '').replace(/,/g, '');
                        campoMontoUSD.value = valorLimpio;
                    }
                    
                    // Limpiar formato de campos monto_planeado SOLO si pertenecen al formulario que se envía (evita tocar logística al enviar confirmaciones/abonos)
                    camposMontoPlaneado.forEach(campo => {
                        if (form.contains(campo) && campo.value) {
                            campo.value = limpiarFormatoMoneda(campo.value);
                        }
                    });
                    
                    // Limpiar formato de campos en el formulario de abono a proveedor
                    if (form.id === 'formSolicitarAbonoProveedor') {
                        const montoProveedor = form.querySelector('input[name="monto"]');
                        if (montoProveedor && montoProveedor.value) {
                            montoProveedor.value = limpiarFormatoMoneda(montoProveedor.value);
                        }
                        const tipoCambioProveedor = form.querySelector('input[name="tipo_cambio_aplicado"]');
                        if (tipoCambioProveedor && tipoCambioProveedor.value) {
                            tipoCambioProveedor.value = tipoCambioProveedor.value.replace(/[^0-9.]/g, '');
                        }
                    }
                });
            });
        });
    </script>
{% endblock %}