{% extends "base.html" %}
{% load humanize %}
{% load widget_tweaks %} 
{% load venta_filters %}
{% load static %}
{% block title %}Venta {{ venta.folio|default:venta.id }} | {{ venta.cliente.nombre_completo_display }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        
        <!-- 1. Encabezado y Botones de Edición: Usamos flex-column en móviles (d-sm-flex) -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
            <h1 class="mb-2 mb-md-0">
                <i class="fas fa-receipt"></i> Detalle de Venta <span class="badge bg-primary fs-5">{{ venta.folio|default:venta.id }}</span>
            </h1>
            <!-- Botones de Edición y Cliente: Usamos d-grid/gap-2 en móviles para apilar los botones si es necesario -->
            <div class="d-grid d-md-block gap-2">
                {% if user.perfil.rol in 'JEFE,CONTADOR' or user.id == venta.vendedor.id %}
                    <a href="{% url 'editar_venta' pk=venta.pk %}" 
                        class="btn btn-warning shadow-sm">
                        <i class="fas fa-edit"></i> Editar Datos del Viaje
                    </a>
                {% endif %}
                
                <a href="{% url 'detalle_cliente' pk=venta.cliente.pk %}" class="btn btn-outline-primary shadow-sm">
                    {% if venta.cliente.tipo_cliente == 'EMPRESA' %}
                        <i class="fas fa-building"></i>
                    {% else %}
                        <i class="fas fa-user"></i>
                    {% endif %}
                    Ver Cliente
                </a>
            </div>
        </div>

        <!-- 2. Botones de Documentos: Usamos flex-wrap en móviles para envolver los botones -->
        <div class="d-flex flex-wrap justify-content-start gap-2 mb-4">
            <!-- Botón de Contrato PDF -->
            {% comment %} Ocultar el botón si la venta es solo de vuelo (VUE) ya que el pago es al momento {% endcomment %}
            {% if venta.servicios_seleccionados == 'VUE' %}
                {# No mostrar botón de contrato para ventas de solo vuelo #}
            {% elif not puede_generar_documentos %}
                <button type="button" 
                    class="btn btn-danger shadow-sm" 
                    disabled
                    title="El contrato se habilita cuando el anticipo está confirmado.">
                    <i class="fas fa-file-contract me-1"></i> Contrato Venta
                    <i class="fas fa-lock ms-1"></i>
                </button>
                <span class="badge bg-warning text-dark align-self-center" data-bs-toggle="tooltip" data-bs-placement="top" title="Sube y confirma el anticipo para habilitar el contrato">
                    <i class="fas fa-clock me-1"></i> Pendiente de anticipo confirmado
                </span>
            {% else %}
                <a href="{% url 'generar_contrato_pdf' slug=venta.slug pk=venta.pk %}" 
                    class="btn btn-danger shadow-sm" target="_blank"
                    title="Genera el contrato de venta como PDF">
                    <i class="fas fa-file-contract me-1"></i> Contrato Venta
                </a>
            {% endif %}
            
            <!-- Botón de Comprobante de Abonos PDF -->
            {% comment %} Ocultar el botón si la venta es solo de vuelo (VUE) ya que el pago es al momento y no habrá abonos {% endcomment %}
            {% if venta.servicios_seleccionados != 'VUE' %}
                {% if not puede_generar_documentos %}
                    <button type="button" class="btn btn-success shadow-sm" disabled
                        title="El comprobante de abonos se habilita cuando el anticipo está confirmado.">
                        <i class="fas fa-receipt me-1"></i> Comprobante Abonos
                        <i class="fas fa-lock ms-1"></i>
                    </button>
                    <span class="badge bg-warning text-dark align-self-center" data-bs-toggle="tooltip" data-bs-placement="top" title="Sube y confirma el anticipo para habilitar el comprobante de abonos">
                        <i class="fas fa-clock me-1"></i> Pendiente de anticipo confirmado
                    </span>
                {% else %}
                    <a href="{% url 'comprobante_abonos_pdf' slug=venta.slug pk=venta.pk %}" 
                        class="btn btn-success shadow-sm" target="_blank"
                        title="Genera el comprobante de todos los abonos realizados">
                        <i class="fas fa-receipt me-1"></i> Comprobante Abonos
                    </a>
                {% endif %}
            {% endif %}
            
            <!-- Botón de Plantillas de Confirmación -->
            <a href="{% url 'listar_confirmaciones' slug=venta.slug pk=venta.pk %}" 
                class="btn btn-info shadow-sm text-white"
                title="Generar plantillas de confirmación (Vuelo, Hospedaje, Traslado, etc.)">
                <i class="fas fa-file-alt me-1"></i> Generar Confirmaciones
            </a>

        </div>
        <!-- Fin de la Fila de Botones de Documentos -->

        {% if messages %}
            {# Mostrar mensajes: para mensajes de abono, mostrar solo el último; para otros, mostrar todos #}
            {# Excluir mensajes de plantillas (se muestran en listar_confirmaciones) #}
            {# Primero mostrar todos los mensajes que NO son de abono NI de plantillas #}
            {% for message in messages %}
                {% if "Abono" not in message|stringformat:"s" and "Plantilla" not in message|stringformat:"s" %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}
            {% endfor %}
            
            {# Luego, mostrar todos los mensajes de abono (JavaScript eliminará los duplicados) #}
            {# Agregar un atributo data para identificar mensajes de abono y usar JavaScript para eliminar duplicados #}
            {% for message in messages %}
                {% if "Abono" in message|stringformat:"s" %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mensaje-abono" role="alert" data-abono-message="true">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
        
        {# JavaScript para eliminar mensajes de abono duplicados, dejando solo el último #}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var mensajesAbono = document.querySelectorAll('.mensaje-abono');
                if (mensajesAbono.length > 1) {
                    // Eliminar todos excepto el último
                    for (var i = 0; i < mensajesAbono.length - 1; i++) {
                        mensajesAbono[i].remove();
                    }
                }
            });
        </script>
        
        <!-- 3. Contenedor de Métricas: Aseguramos que los bordes verticales se quiten en móviles -->
        <div class="card bg-light mb-4 shadow-sm border-primary">
            <div class="card-body">
                <div class="row text-center">
                    <!-- En móviles (col-12), el borde vertical (border-end) se quita usando border-md-end -->
                    <div class="col-12 col-md-4 border-bottom border-md-end pb-3 pb-md-0"> 
                        <h6 class="text-muted">Total Final</h6>
                        <h2 class="text-success">${{ total_final|floatformat:2|intcomma }}</h2>
                        {% if venta.costo_modificacion and venta.costo_modificacion > 0 %}
                            <p class="text-muted small mb-0">Modificaciones: +${{ venta.costo_modificacion|floatformat:2|intcomma }}</p>
                        {% endif %}
                        {% if venta.aplica_descuento_kilometros %}
                            <p class="text-muted small mb-0">Descuento Kilómetros Movums: -${{ venta.descuento_kilometros_mxn|floatformat:2|intcomma }}</p>
                        {% endif %}
                        {% if venta.descuento_promociones_mxn and venta.descuento_promociones_mxn > 0 %}
                            <p class="text-muted small mb-0">Descuento Promociones: -${{ venta.descuento_promociones_mxn|floatformat:2|intcomma }}</p>
                        {% endif %}
                    </div>
                    <!-- Aplicamos border-bottom solo en móviles para separar las tarjetas -->
                    <div class="col-12 col-md-4 border-bottom border-md-end py-3 py-md-0">
                        <h6 class="text-muted">Total Pagado</h6>
                        <h2 class="text-info">${{ venta.total_pagado|floatformat:2|intcomma }}</h2>
                        {% if venta.descuento_promociones_mxn and venta.descuento_promociones_mxn > 0 %}
                            <p class="text-muted small mb-0">Incluye descuento promo como pago: ${{ venta.descuento_promociones_mxn|floatformat:2|intcomma }}</p>
                        {% endif %}
                    </div>
                    <div class="col-12 col-md-4 pt-3 pt-md-0">
                        <h6 class="text-muted">Saldo Pendiente</h6>
                        {% if venta.saldo_restante > 0 %}
                            <h2 class="text-danger">${{ venta.saldo_restante|floatformat:2|intcomma }}</h2>
                        {% else %}
                            <h2 class="text-success"><i class="fas fa-check-circle"></i> Pagado</h2>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <ul class="nav nav-tabs mb-3" id="ventaTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab" aria-controls="info" aria-selected="true">
                    <i class="fas fa-info-circle"></i> Información General
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="abonos-tab" data-bs-toggle="tab" data-bs-target="#abonos" type="button" role="tab" aria-controls="abonos" aria-selected="false">
                    <i class="fas fa-dollar-sign"></i> Abonos y Pagos
                </button>
            </li>
            {% if mostrar_tab_logistica %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="logistica-tab" data-bs-toggle="tab" data-bs-target="#logistica" type="button" role="tab" aria-controls="logistica" aria-selected="false">
                        <i class="fas fa-shipping-fast"></i> Logística
                    </button>
                </li>
            {% endif %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="confirmaciones-tab" data-bs-toggle="tab" data-bs-target="#confirmaciones" type="button" role="tab" aria-controls="confirmaciones" aria-selected="false">
                    <i class="fas fa-file-upload"></i> Confirmaciones en la Venta
                </button>
            </li>
        </ul>

        <div class="tab-content" id="ventaTabsContent">
            
            <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
                <!-- Información General de la Venta -->
                <div class="row g-3 mb-4">
                    <div class="col-md-12">
                        <div class="card shadow-sm border-primary">
                            <div class="card-header bg-primary text-white">
                                <i class="fas fa-info-circle me-2"></i>Información General de la Venta
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <strong class="text-muted d-block mb-1">Folio:</strong>
                                        <span class="badge bg-primary fs-6">{{ venta.folio|default:"Sin folio" }}</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong class="text-muted d-block mb-1">Estado:</strong>
                                        {% if venta.estado == 'ACTIVA' %}
                                            <span class="badge bg-success fs-6">Activa</span>
                                        {% else %}
                                            <span class="badge bg-danger fs-6">Cancelada</span>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3">
                                        <strong class="text-muted d-block mb-1">Tipo de Viaje:</strong>
                                        {% if venta.tipo_viaje == 'INT' %}
                                            <span class="badge bg-info fs-6"><i class="fas fa-globe me-1"></i>Internacional</span>
                                        {% else %}
                                            <span class="badge bg-secondary fs-6"><i class="fas fa-map-marker-alt me-1"></i>Nacional</span>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3">
                                        <strong class="text-muted d-block mb-1">Fecha de Creación:</strong>
                                        <span>{{ venta.fecha_creacion|date:"d/m/Y H:i" }}</span>
                                    </div>
                                    {% if venta.cotizacion_origen %}
                                    <div class="col-md-12">
                                        <strong class="text-muted d-block mb-1">Cotización Origen:</strong>
                                        <a href="{% url 'cotizacion_detalle' slug=venta.cotizacion_origen.slug %}" class="text-decoration-none">
                                            <i class="fas fa-file-invoice me-1"></i>{{ venta.cotizacion_origen.folio|default:"Ver cotización" }}
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Información del Cliente -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-info text-white">
                                <i class="fas fa-user me-2"></i>Información del Cliente
                            </div>
                            <div class="card-body">
                                <p class="mb-2">
                                    <strong class="text-muted d-block mb-1">Nombre:</strong>
                                    <a href="{% url 'detalle_cliente' pk=venta.cliente.pk %}" class="text-decoration-none">
                                        {% if venta.cliente.tipo_cliente == 'EMPRESA' %}
                                            <i class="fas fa-building text-info me-1"></i>
                                            <span class="badge bg-info text-white me-2">Empresa</span>
                                        {% else %}
                                            <i class="fas fa-user text-success me-1"></i>
                                            <span class="badge bg-success text-white me-2">Particular</span>
                                        {% endif %}
                                        {{ venta.cliente.nombre_completo_display }}
                                    </a>
                                </p>
                                {% if venta.cliente.tipo_cliente == 'EMPRESA' and venta.cliente.rfc %}
                                <p class="mb-2">
                                    <strong class="text-muted d-block mb-1">RFC:</strong>
                                    <code>{{ venta.cliente.rfc }}</code>
                                </p>
                                {% endif %}
                                {% if venta.cliente.telefono %}
                                <p class="mb-2">
                                    <strong class="text-muted d-block mb-1">Teléfono:</strong>
                                    <a href="tel:{{ venta.cliente.telefono }}">{{ venta.cliente.telefono }}</a>
                                </p>
                                {% endif %}
                                {% if venta.cliente.email %}
                                <p class="mb-2">
                                    <strong class="text-muted d-block mb-1">Email:</strong>
                                    <a href="mailto:{{ venta.cliente.email }}">{{ venta.cliente.email }}</a>
                                </p>
                                {% endif %}
                                <p class="mb-0">
                                    <strong class="text-muted d-block mb-1">Asesor/Vendedor:</strong>
                                    {% if venta.vendedor.get_full_name %}
                                        {{ venta.vendedor.get_full_name }} <small class="text-muted">({{ venta.vendedor.username }})</small>
                                    {% else %}
                                        {{ venta.vendedor.username }}
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-success text-white">
                                <i class="fas fa-suitcase me-2"></i>Información del Viaje
                            </div>
                            <div class="card-body">
                                <p class="mb-2">
                                    <strong class="text-muted d-block mb-1">Servicios Incluidos:</strong>
                                    {% if venta.servicios_seleccionados_display %}
                                        <span class="text-primary fw-semibold">{{ venta.servicios_seleccionados_display }}</span>
                                    {% else %}
                                        <span class="text-muted">No especificado</span>
                                    {% endif %}
                                </p>
                                <p class="mb-2">
                                    <strong class="text-muted d-block mb-1">Fecha de Inicio:</strong>
                                    <i class="fas fa-calendar-alt me-1 text-primary"></i>{{ venta.fecha_inicio_viaje|date:"l, d F Y" }}
                                </p>
                                {% if venta.fecha_fin_viaje %}
                                <p class="mb-2">
                                    <strong class="text-muted d-block mb-1">Fecha de Regreso:</strong>
                                    <i class="fas fa-calendar-check me-1 text-primary"></i>{{ venta.fecha_fin_viaje|date:"l, d F Y" }}
                                </p>
                                {% endif %}
                                {% if venta.fecha_vencimiento_pago %}
                                <p class="mb-2">
                                    <strong class="text-muted d-block mb-1">Fecha Límite de Pago:</strong>
                                    <i class="fas fa-clock me-1 text-warning"></i>{{ venta.fecha_vencimiento_pago|date:"d/m/Y" }}
                                </p>
                                {% endif %}
                                {% if venta.proveedor %}
                                <p class="mb-0">
                                    <strong class="text-muted d-block mb-1">Proveedor Asignado:</strong>
                                    <span><i class="fas fa-building me-1"></i>{{ venta.proveedor.nombre }}</span>
                                    {% if venta.proveedor.ejecutivo %}
                                        <br><small class="text-muted">Ejecutivo: {{ venta.proveedor.ejecutivo }}</small>
                                    {% endif %}
                                    {% if venta.proveedor.telefono_ejecutivo %}
                                        <br><small class="text-muted">Tel: {{ venta.proveedor.telefono_ejecutivo }}</small>
                                    {% endif %}
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Información Financiera -->
                <div class="row g-3 mb-4">
                    <div class="col-md-12">
                        <div class="card shadow-sm">
                            <div class="card-header bg-warning text-dark">
                                <i class="fas fa-dollar-sign me-2"></i>Información Financiera
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    {% if venta.tipo_viaje == 'INT' %}
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-3"><i class="fas fa-coins me-1"></i>Montos en USD</h6>
                                        {% if venta.tarifa_base_usd %}
                                        <p class="mb-2">
                                            <strong class="text-muted d-block mb-1">Tarifa Base:</strong>
                                            USD ${{ venta.tarifa_base_usd|floatformat:2|intcomma }}
                                        </p>
                                        {% endif %}
                                        {% if venta.impuestos_usd %}
                                        <p class="mb-2">
                                            <strong class="text-muted d-block mb-1">Impuestos:</strong>
                                            USD ${{ venta.impuestos_usd|floatformat:2|intcomma }}
                                        </p>
                                        {% endif %}
                                        {% if venta.suplementos_usd %}
                                        <p class="mb-2">
                                            <strong class="text-muted d-block mb-1">Suplementos:</strong>
                                            USD ${{ venta.suplementos_usd|floatformat:2|intcomma }}
                                        </p>
                                        {% endif %}
                                        {% if venta.tours_usd %}
                                        <p class="mb-2">
                                            <strong class="text-muted d-block mb-1">Tours:</strong>
                                            USD ${{ venta.tours_usd|floatformat:2|intcomma }}
                                        </p>
                                        {% endif %}
                                        {% if venta.tipo_cambio %}
                                        <p class="mb-2">
                                            <strong class="text-muted d-block mb-1">Tipo de Cambio:</strong>
                                            ${{ venta.tipo_cambio|floatformat:4 }} MXN/USD
                                        </p>
                                        {% endif %}
                                        {% if venta.total_usd %}
                                        <p class="mb-0">
                                            <strong class="text-muted d-block mb-1">Total USD:</strong>
                                            <span class="badge bg-info fs-6">USD ${{ venta.total_usd|floatformat:2|intcomma }}</span>
                                        </p>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-3"><i class="fas fa-peso-sign me-1"></i>Montos en MXN</h6>
                                    {% else %}
                                    <div class="col-md-12">
                                    {% endif %}
                                        <!-- 1. Costo Neto (Agencia) -->
                                        <p class="mb-2">
                                            <strong class="text-muted d-block mb-1">Costo Neto (Agencia):</strong>
                                            ${{ venta.costo_neto|floatformat:2|intcomma }} MXN
                                        </p>
                                        
                                        <!-- 2. Costo de Venta Final (sin descuentos) -->
                                        <p class="mb-2">
                                            <strong class="text-muted d-block mb-1">Costo de Venta Final (sin descuentos):</strong>
                                            <span class="text-muted">${{ costo_base|floatformat:2|intcomma }} MXN</span>
                                            {% if venta.costo_modificacion and venta.costo_modificacion > 0 %}
                                                <small class="text-muted d-block mt-1">
                                                    <i class="fas fa-info-circle"></i> Incluye modificaciones: +${{ venta.costo_modificacion|floatformat:2|intcomma }}
                                                </small>
                                            {% endif %}
                                        </p>
                                        
                                        <!-- 3. Descuento Kilómetros Movums -->
                                        {% if venta.aplica_descuento_kilometros %}
                                        <p class="mb-2">
                                            <strong class="text-muted d-block mb-1">Descuento Kilómetros Movums:</strong>
                                            <span class="text-success">-${{ venta.descuento_kilometros_mxn|floatformat:2|intcomma }} MXN</span>
                                        </p>
                                        {% endif %}
                                        
                                        <!-- 4. Descuento por Promociones -->
                                        {% if venta.descuento_promociones_mxn and venta.descuento_promociones_mxn > 0 %}
                                        <p class="mb-2">
                                            <strong class="text-muted d-block mb-1">Descuento por Promociones:</strong>
                                            <span class="text-success">-${{ venta.descuento_promociones_mxn|floatformat:2|intcomma }} MXN</span>
                                        </p>
                                        {% endif %}
                                        
                                        <!-- 5. Total Descuentos -->
                                        {% if total_descuentos > 0 %}
                                        <p class="mb-2">
                                            <strong class="text-muted d-block mb-1">Total Descuentos:</strong>
                                            <span class="text-danger fw-bold">-${{ total_descuentos|floatformat:2|intcomma }} MXN</span>
                                        </p>
                                        {% endif %}
                                        
                                        <!-- 6. Total Final (con descuentos) -->
                                        <p class="mb-2">
                                            <strong class="text-muted d-block mb-1">Total Final (con descuentos):</strong>
                                            <span class="badge bg-primary fs-6">${{ total_final|floatformat:2|intcomma }} MXN</span>
                                        </p>
                                        
                                        <!-- 7. Apertura/Anticipo -->
                                        {% if venta.cantidad_apertura and venta.cantidad_apertura > 0 %}
                                        <p class="mb-2">
                                            <strong class="text-muted d-block mb-1">Apertura/Anticipo:</strong>
                                            ${{ venta.cantidad_apertura|floatformat:2|intcomma }} MXN
                                            <span class="badge bg-secondary ms-2">{{ venta.get_modo_pago_apertura_display }}</span>
                                        </p>
                                        {% endif %}
                                        
                                        <!-- 8. Estado de Confirmación -->
                                        <p class="mb-0">
                                            <strong class="text-muted d-block mb-1">Estado de Confirmación:</strong>
                                            {% if venta.estado_confirmacion == 'COMPLETADO' %}
                                                <span class="badge bg-success fs-6">Completado</span>
                                            {% elif venta.estado_confirmacion == 'EN_CONFIRMACION' %}
                                                <span class="badge bg-warning text-dark fs-6">En Confirmación</span>
                                            {% else %}
                                                <span class="badge bg-secondary fs-6">Pendiente</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pasajeros y Detalles Adicionales -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-secondary text-white">
                                <i class="fas fa-users me-2"></i>Pasajeros
                            </div>
                            <div class="card-body">
                                {% if venta.pasajeros %}
                                <p class="mb-3">
                                    <strong class="text-muted d-block mb-2">Listado de Pasajeros:</strong>
                                    <div class="bg-light p-3 rounded">{{ venta.pasajeros|linebreaksbr }}</div>
                                </p>
                                {% endif %}
                                {% if venta.edades_menores %}
                                <p class="mb-0">
                                    <strong class="text-muted d-block mb-2">Menores (nombre y edad):</strong>
                                    <div class="bg-light p-3 rounded">{{ venta.edades_menores|linebreaksbr }}</div>
                                </p>
                                {% endif %}
                                {% if not venta.pasajeros and not venta.edades_menores %}
                                <p class="text-muted mb-0">No se ha registrado información de pasajeros.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-dark text-white">
                                <i class="fas fa-info-circle me-2"></i>Detalles Adicionales
                            </div>
                            <div class="card-body">
                                {% if venta.servicios_detalle %}
                                <p class="mb-3">
                                    <strong class="text-muted d-block mb-2">Descripción Detallada de Servicios:</strong>
                                    <div class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;">{{ venta.servicios_detalle|linebreaksbr }}</div>
                                </p>
                                {% endif %}
                                {% if venta.comprobante_apertura_subido_por %}
                                <p class="mb-2">
                                    <strong class="text-muted d-block mb-1">Comprobante de Apertura:</strong>
                                    <span class="badge bg-success me-1">Subido</span>
                                    {% if venta.comprobante_apertura_subido_en %}
                                        <small class="text-muted">el {{ venta.comprobante_apertura_subido_en|date:"d/m/Y H:i" }}</small>
                                    {% endif %}
                                    <br><small class="text-muted">Por: {{ venta.comprobante_apertura_subido_por.get_full_name|default:venta.comprobante_apertura_subido_por.username }}</small>
                                </p>
                                {% endif %}
                                {% if not venta.servicios_detalle and not venta.comprobante_apertura_subido_por %}
                                <p class="text-muted mb-0">No hay información adicional disponible.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                {# Sección de Archivos Adjuntos #}
                {% if archivos_adjuntos %}
                <div class="card mb-4 shadow-sm mt-4">
                    <div class="card-header bg-secondary text-white">
                        <i class="fas fa-paperclip me-2"></i> Archivos Adjuntos ({{ archivos_adjuntos|length }})
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            {% for archivo in archivos_adjuntos %}
                            <div class="col-md-6 col-lg-4">
                                <div class="card border h-100">
                                    <div class="card-body">
                                        <h6 class="card-title mb-2">
                                            <i class="fas fa-file me-2 text-primary"></i>
                                            {{ archivo.nombre }}
                                        </h6>
                                        {% if archivo.tipo == 'principal' %}
                                            <span class="badge bg-primary mb-2">Principal</span>
                                        {% else %}
                                            <span class="badge bg-info mb-2">Adicional</span>
                                        {% endif %}
                                        <div class="mt-2">
                                            <a href="{{ archivo.url }}" target="_blank" class="btn btn-sm btn-outline-primary w-100">
                                                <i class="fas fa-download me-1"></i> Descargar
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="tab-pane fade" id="abonos" role="tabpanel" aria-labelledby="abonos-tab">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card mb-4 shadow-sm border-success">
                            <div class="card-header bg-success text-white">
                                Registrar Nuevo Abono
                            </div>
                            <div class="card-body">
                                {% if venta.saldo_restante > 0 %}
                                    <form method="post">
                                        {% csrf_token %}
                                        
                                        {% if venta.tipo_viaje == 'INT' %}
                                            <div class="mb-3">
                                                <label class="form-label">Monto (USD)</label>
                                                <input type="text" inputmode="decimal" step="0.01" min="0.01" class="form-control" id="montoUsd" name="monto_usd" placeholder="Ej: 100.00">
                                                <div class="text-danger small d-none" id="montoUsdError">Ingresa un monto válido en USD.</div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Tipo de cambio del día</label>
                                                <input type="number" step="0.0001" min="0.0001" class="form-control" id="tipoCambioAbono" name="tipo_cambio_abono" value="{{ venta.tipo_cambio|floatformat:2 }}">
                                                <div class="form-text text-muted">Ej: 19.80</div>
                                                <div class="text-danger small d-none" id="tipoCambioError">Ingresa un tipo de cambio válido.</div>
                                            </div>
                                            {# Campo real (monto en MXN) como hidden para evitar validación HTML5 que bloquea el submit #}
                                            <input type="hidden" id="{{ abono_form.monto.auto_id }}" name="{{ abono_form.monto.html_name }}" value="{{ abono_form.monto.value|default_if_none:'' }}">
                                            {% for error in abono_form.monto.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                                        {% else %}
                                            <div class="mb-3">
                                                <label for="{{ abono_form.monto.id_for_label }}" class="form-label">Monto (Máximo: ${{ venta.saldo_restante|floatformat:2|intcomma }})</label>
                                                {{ abono_form.monto|add_class:"form-control"|attr:"type:text"|attr:"inputmode:decimal"|attr:"min:0.01"|attr:"max:"|add_max_attr:venta.saldo_restante }}
                                                {% for error in abono_form.monto.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                                            </div>
                                        {% endif %}
                                        
                                        <div class="mb-3">
                                            <label for="{{ abono_form.forma_pago.id_for_label }}" class="form-label">Forma de Pago</label>
                                            {{ abono_form.forma_pago|add_class:"form-select" }}
                                            {% for error in abono_form.forma_pago.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                                        </div>

                                        <div class="mb-3">
                                            <div class="form-check">
                                                {{ abono_form.requiere_factura }}
                                                <label class="form-check-label" for="{{ abono_form.requiere_factura.id_for_label }}">
                                                    Requiere factura por este abono
                                                </label>
                                            </div>
                                            {% for error in abono_form.requiere_factura.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
                                        </div>

                                        <button type="submit" name="registrar_abono" class="btn btn-success w-100 mt-3">
                                            <i class="fas fa-plus-circle"></i> Registrar Pago
                                        </button>
                                    </form>
                                {% else %}
                                    <div class="alert alert-success text-center">
                                        <i class="fas fa-check-double"></i> ¡Esta venta está completamente pagada!
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header">
                                Historial de Pagos ({{ abonos|length }})
                            </div>
                            <div class="card-body">
                                {% if abonos or venta.cantidad_apertura > 0 or venta.descuento_promociones_mxn or venta.descuento_kilometros_mxn %}
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped">
                                            <thead class="table-light">
                                                <tr>
                                                <th>Fecha</th>
                                                <th>Monto</th>
                                                <th>Forma</th>
                                                <th>Estado</th>
                                                <th>Comprobante</th>
                                                <th>Registrado por</th>
                                                {% if user_rol == 'CONTADOR' %}
                                                <th>Acciones</th>
                                                {% endif %}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% if venta.cantidad_apertura > 0 %}
                                                <tr class="{% if venta.estado_confirmacion == 'EN_CONFIRMACION' %}table-warning{% else %}table-info{% endif %}">
                                                    <td>{{ venta.fecha_creacion|date:"d/M/y H:i" }}</td>
                                                {% if venta.tipo_viaje == 'INT' and venta.tipo_cambio %}
                                                    {% widthratio venta.cantidad_apertura venta.tipo_cambio 1 as apertura_usd %}
                                                    <td><strong>USD ${{ apertura_usd|floatformat:2|intcomma }}</strong></td>
                                                {% else %}
                                                    <td><strong>${{ venta.cantidad_apertura|floatformat:2|intcomma }}</strong></td>
                                                {% endif %}
                                                    <td><span class="badge bg-info">{{ venta.get_modo_pago_apertura_display }}</span></td>
                                                    <td>
                                                        {# Solo está pendiente si la venta está en confirmación Y NO hay otros abonos pendientes #}
                                                        {% if venta.estado_confirmacion == 'EN_CONFIRMACION' and venta.modo_pago_apertura in 'TRN,TAR,DEP,CRE' and not tiene_abonos_pendientes %}
                                                            <span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Pendiente</span>
                                                        {% elif venta.modo_pago_apertura in 'EFE,LIG,PRO' %}
                                                            <span class="badge bg-success"><i class="fas fa-check"></i> Confirmado</span>
                                                        {% else %}
                                                            <span class="badge bg-success"><i class="fas fa-check"></i> Confirmado</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if venta.modo_pago_apertura == 'CRE' %}
                                                            <span class="badge bg-info">Crédito - Pendiente de validación</span>
                                                        {% elif venta.modo_pago_apertura in 'TRN,TAR,DEP' %}
                                                            {% if venta.comprobante_apertura_subido and venta.comprobante_apertura %}
                                                                {% if venta.estado_confirmacion == 'EN_CONFIRMACION' %}
                                                                <button type="button" class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#modalEditarComprobanteApertura" title="Editar comprobante">
                                                                    <i class="fas fa-edit"></i> Editar
                                                                </button>
                                                                {% else %}
                                                                <span class="text-muted">-</span>
                                                                {% endif %}
                                                            {% elif venta.estado_confirmacion == 'EN_CONFIRMACION' %}
                                                                <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#modalComprobanteApertura" title="Subir comprobante">
                                                                    <i class="fas fa-upload"></i> Subir
                                                                </button>
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td><em>Apertura/Anticipo</em> - {{ venta.vendedor.username|default:"Sistema" }}</td>
                                                </tr>
                                                {% endif %}
                                                {% for abono in abonos %}
                                                <tr class="{% if not abono.confirmado and abono.forma_pago in 'TRN,TAR,DEP' %}table-warning{% endif %}">
                                                    <td>{{ abono.fecha_pago|date:"d/M/y H:i" }}</td>
                                                    {% if venta.tipo_viaje == 'INT' and venta.tipo_cambio %}
                                                        {% if abono.monto_usd %}
                                                            <td><strong>USD ${{ abono.monto_usd|floatformat:2|intcomma }}</strong></td>
                                                        {% else %}
                                                            {% widthratio abono.monto venta.tipo_cambio 1 as abono_usd %}
                                                            <td><strong>USD ${{ abono_usd|floatformat:2|intcomma }}</strong></td>
                                                        {% endif %}
                                                    {% else %}
                                                        <td><strong>${{ abono.monto|floatformat:2|intcomma }}</strong></td>
                                                    {% endif %}
                                                    <td><span class="badge {% if abono.forma_pago == 'EFE' %}bg-success{% elif abono.forma_pago == 'TRN' %}bg-primary{% elif abono.forma_pago == 'TAR' %}bg-info{% elif abono.forma_pago == 'DEP' %}bg-secondary{% elif abono.forma_pago == 'LIG' %}bg-warning text-dark{% elif abono.forma_pago == 'PRO' %}bg-dark{% elif abono.forma_pago == 'PPL' %}bg-secondary{% else %}bg-secondary{% endif %}">{{ abono.get_forma_pago_display }}</span></td>
                                                    <td>
                                                        {% if abono.confirmado or abono.forma_pago in 'EFE,LIG,PRO' %}
                                                            <span class="badge bg-success"><i class="fas fa-check"></i> Confirmado</span>
                                                        {% else %}
                                                            <span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Pendiente</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if abono.forma_pago in 'TRN,TAR,DEP' %}
                                                            {% if abono.comprobante_subido and abono.comprobante_imagen %}
                                                                {% if not abono.confirmado %}
                                                                <button type="button" class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#modalEditarComprobanteAbono{{ abono.pk }}" title="Editar comprobante">
                                                                    <i class="fas fa-edit"></i> Editar
                                                                </button>
                                                                {% else %}
                                                                <span class="text-muted">-</span>
                                                                {% endif %}
                                                            {% elif not abono.confirmado %}
                                                                <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#modalComprobanteAbono{{ abono.pk }}" title="Subir comprobante">
                                                                    <i class="fas fa-upload"></i> Subir
                                                                </button>
                                                            {% else %}
                                                                <span class="text-muted">-</span>
                                                            {% endif %}
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {{ abono.registrado_por.username|default:"-" }}
                                                        {% if abono.requiere_factura %}
                                                            <br><small class="text-muted"><i class="fas fa-file-invoice text-info"></i> Requiere factura</small>
                                                        {% endif %}
                                                    </td>
                                                    {% if user_rol == 'CONTADOR' %}
                                                    <td>
                                                        {% if abono.forma_pago in 'TRN,TAR,DEP' and not abono.confirmado and abono.comprobante_subido %}
                                                            <form method="post" action="{% url 'confirmar_abono' abono_id=abono.pk %}" style="display: inline;">
                                                                {% csrf_token %}
                                                                <button type="submit" class="btn btn-sm btn-success" title="Confirmar abono">
                                                                    <i class="fas fa-check"></i> Confirmar
                                                                </button>
                                                            </form>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    {% endif %}
                                                </tr>
                                                {% endfor %}
                                                {% if venta.descuento_kilometros_mxn and venta.descuento_kilometros_mxn > 0 %}
                                                <tr class="table-info">
                                                    <td>{{ venta.fecha_actualizacion|default:venta.fecha_creacion|date:"d/M/y H:i" }}</td>
                                                    <td><strong>${{ venta.descuento_kilometros_mxn|floatformat:2|intcomma }}</strong></td>
                                                    <td><span class="badge bg-primary">Descuento Kilómetros Movums</span></td>
                                                    <td><span class="badge bg-success"><i class="fas fa-check"></i> Confirmado</span></td>
                                                    <td><span class="text-muted">-</span></td>
                                                    <td>{{ venta.vendedor.username|default:"Sistema" }}</td>
                                                    {% if user_rol == 'CONTADOR' %}
                                                    <td><span class="text-muted">-</span></td>
                                                    {% endif %}
                                                </tr>
                                                {% endif %}
                                                {% if venta.descuento_promociones_mxn and venta.descuento_promociones_mxn > 0 %}
                                                <tr class="table-info">
                                                    <td>{{ venta.fecha_actualizacion|default:venta.fecha_creacion|date:"d/M/y H:i" }}</td>
                                                    <td><strong>${{ venta.descuento_promociones_mxn|floatformat:2|intcomma }}</strong></td>
                                                    <td><span class="badge bg-primary">Descuento Promociones</span></td>
                                                    <td><span class="badge bg-success"><i class="fas fa-check"></i> Confirmado</span></td>
                                                    <td><span class="text-muted">-</span></td>
                                                    <td>{{ venta.vendedor.username|default:"Sistema" }}</td>
                                                    {% if user_rol == 'CONTADOR' %}
                                                    <td><span class="text-muted">-</span></td>
                                                    {% endif %}
                                                </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <p class="text-muted text-center">No se han registrado abonos para esta venta.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if mostrar_tab_logistica %}
                <div class="tab-pane fade" id="logistica" role="tabpanel" aria-labelledby="logistica-tab">
                    <div class="card mb-4 shadow border-info" id="logisticaFinanzasCard">
                        <div class="card-header bg-info text-white">
                            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                                <span><i class="fas fa-layer-group me-2"></i>Control financiero por servicio</span>
                                <small class="text-white-50">Los importes se actualizan con abonos y apertura confirmados</small>
                            </div>
                        </div>
                        <div class="card-body">
                            {% if servicios_logisticos_rows %}
                            <div class="row text-center g-3 mb-4">
                                <div class="col-12 col-md-3">
                                    <p class="text-muted mb-1">Total Venta (con descuentos)</p>
                                    <h4 class="text-primary mb-0">${{ logistica_finanzas.total_venta|floatformat:2|intcomma }}</h4>
                                    {% if descuento_km > 0 or descuento_promo > 0 %}
                                        <small class="text-muted">Base: ${{ costo_base|floatformat:2|intcomma }}</small>
                                    {% endif %}
                                </div>
                                <div class="col-12 col-md-3">
                                    <p class="text-muted mb-1">Total Neto</p>
                                    <h4 class="text-secondary mb-0">${{ logistica_finanzas.total_neto|floatformat:2|intcomma }}</h4>
                                </div>
                                <div class="col-12 col-md-3">
                                    <p class="text-muted mb-1">Apertura + Abonos</p>
                                    <h4 class="text-success mb-0">${{ logistica_finanzas.total_pagado|floatformat:2|intcomma }}</h4>
                                </div>
                                <div class="col-12 col-md-3">
                                    <p class="text-muted mb-1">Saldo disponible para servicios</p>
                                    <h4 class="text-warning mb-0">${{ logistica_finanzas.saldo_disponible_servicios|floatformat:2|intcomma }}</h4>
                                </div>
                            </div>
                            <div class="row text-center g-3 mb-4">
                                <div class="col-12 col-md-4">
                                    <p class="text-muted mb-1">Servicios planificados</p>
                                    <h5 class="mb-0">${{ logistica_finanzas.total_servicios_planeados|floatformat:2|intcomma }}</h5>
                                    <small class="text-muted">Monto objetivo a cubrir</small>
                                </div>
                                <div class="col-12 col-md-4">
                                    <p class="text-muted mb-1">Servicios pagados</p>
                                    <h5 class="text-success mb-0">${{ logistica_finanzas.monto_pagado_servicios|floatformat:2|intcomma }}</h5>
                                    <small class="text-muted">Monto ya aplicado</small>
                                </div>
                                <div class="col-12 col-md-4">
                                    <p class="text-muted mb-1">Ganancia estimada</p>
                                    <h5 class="mb-0">${{ logistica_finanzas.ganancia_estimada|floatformat:2|intcomma }}</h5>
                                    <small class="text-muted">Pendiente: ${{ logistica_finanzas.ganancia_pendiente|floatformat:2|intcomma }}</small>
                                </div>
                            </div>
                        {% if logistica_finanzas.modificaciones and logistica_finanzas.modificaciones > 0 %}
                        <div class="alert alert-light border-start border-info mt-3 py-2">
                            <small>
                                <i class="fas fa-info-circle me-1 text-info"></i>
                                Modificaciones acumuladas: <strong>${{ logistica_finanzas.modificaciones|floatformat:2|intcomma }}</strong>
                            </small>
                        </div>
                        {% endif %}
                            {% if servicios_financieros_formset.non_form_errors %}
                                <div class="alert alert-danger">
                                    {% for error in servicios_financieros_formset.non_form_errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <form method="post" class="table-responsive">
                                {% csrf_token %}
                                <input type="hidden" name="actualizar_servicios_logistica" value="1">
                                {{ servicios_financieros_formset.management_form }}
                                <table class="table align-middle table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Servicio</th>
                                            <th width="180">Monto Planificado</th>
                                            <th width="200">Estado</th>
                                            <th width="140">Pagado</th>
                                            <th>Nombre del Proveedor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in servicios_logisticos_rows %}
                                        <tr class="logistica-servicio-row status-{{ row.status }}">
                                            <td>
                                                <strong>{{ row.servicio.nombre_servicio }}</strong>
                                                {% if row.servicio.fecha_pagado %}
                                                    <div class="text-muted small">Actualizado: {{ row.servicio.fecha_pagado|date:"d/m/Y H:i" }}</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ row.form.id }}
                                                <div class="input-group">
                                                    <span class="input-group-text">$</span>
                                                    {% if row.servicio.monto_planeado and row.servicio.monto_planeado > 0 %}
                                                        {# Campo oculto para preservar el valor cuando está deshabilitado #}
                                                        <input type="hidden" 
                                                               name="{{ row.form.monto_planeado.name }}" 
                                                               value="{{ row.servicio.monto_planeado|stringformat:'.2f' }}">
                                                        <input type="text" 
                                                               id="{{ row.form.monto_planeado.id_for_label }}_display"
                                                               value="{{ row.servicio.monto_planeado|floatformat:2 }}" 
                                                               class="form-control" 
                                                               disabled 
                                                               readonly
                                                               style="background-color: #e9ecef; cursor: not-allowed;"
                                                               title="Los montos planificados están bloqueados para pruebas">
                                                    {% else %}
                                                        {{ row.form.monto_planeado }}
                                                    {% endif %}
                                                </div>
                                                {% for error in row.form.monto_planeado.errors %}
                                                    <div class="text-danger small">{{ error }}</div>
                                                {% endfor %}
                                            </td>
                                            <td>
                                                <span class="badge bg-{{ row.badge_class }} px-3 py-2">{{ row.status_label }}</span>
                                                <small class="d-block text-muted mt-1">{{ row.status_hint }}</small>
                                            </td>
                                            <td>
                                                <div class="form-check">
                                                    {% if row.servicio.pagado %}
                                                        {# Campo oculto para preservar el valor cuando está deshabilitado #}
                                                        {# Para checkboxes, Django envía el nombre del campo si está marcado #}
                                                        <input type="hidden" 
                                                               name="{{ row.form.pagado.name }}" 
                                                               value="on">
                                                        <input type="checkbox" 
                                                               id="{{ row.form.pagado.id_for_label }}_display"
                                                               class="form-check-input" 
                                                               checked 
                                                               disabled
                                                               style="cursor: not-allowed;"
                                                               title="El estado de pago está bloqueado para pruebas">
                                                        <label class="form-check-label" style="opacity: 0.7;">Pagado</label>
                                                    {% else %}
                                                        {{ row.form.pagado }}
                                                        <label class="form-check-label">Pagado</label>
                                                    {% endif %}
                                                </div>
                                                {% for error in row.form.pagado.errors %}
                                                    <div class="text-danger small">{{ error }}</div>
                                                {% endfor %}
                                            </td>
                                            <td>
                                                {{ row.form.opcion_proveedor }}
                                                {% for error in row.form.opcion_proveedor.errors %}
                                                    <div class="text-danger small">{{ error }}</div>
                                                {% endfor %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                {% if puede_editar_servicios_financieros %}
                                <div class="text-end">
                                    <button type="submit" class="btn btn-info">
                                        <i class="fas fa-save me-1"></i> Guardar ajustes
                                    </button>
                                </div>
                                {% endif %}
                            </form>
                            {% else %}
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle me-2"></i> Esta venta todavía no tiene servicios contratados para desglosar.
                                </div>
                            {% endif %}
                        </div>
                    </div>

                </div>
            {% endif %}

            <div class="tab-pane fade" id="confirmaciones" role="tabpanel" aria-labelledby="confirmaciones-tab">
                <div class="row">
                    <div class="col-lg-4">
                        <div class="card shadow-sm mb-4 border-secondary">
                            <div class="card-header bg-secondary text-white">
                                Subir confirmaciones
                            </div>
                            <div class="card-body">
                                {% if confirmacion_form %}
                                    {% if puede_subir_confirmaciones %}
                                        <form method="post" enctype="multipart/form-data">
                                            {% csrf_token %}
                                            <div class="mb-3">
                                                <label for="{{ confirmacion_form.archivos.id_for_label }}" class="form-label fw-semibold">
                                                    {{ confirmacion_form.archivos.label }}
                                                </label>
                                                {{ confirmacion_form.archivos }}
                                                <div class="form-text text-muted">{{ confirmacion_form.archivos.help_text }}</div>
                                                {% for error in confirmacion_form.archivos.errors %}
                                                    <div class="text-danger small mt-1">{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                            <div class="mb-3">
                                                <label for="{{ confirmacion_form.nota.id_for_label }}" class="form-label fw-semibold">
                                                    {{ confirmacion_form.nota.label }}
                                                </label>
                                                {{ confirmacion_form.nota }}
                                                {% for error in confirmacion_form.nota.errors %}
                                                    <div class="text-danger small mt-1">{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                            <button type="submit" name="registrar_confirmacion" class="btn btn-secondary w-100">
                                                <i class="fas fa-upload me-1"></i> Guardar confirmaciones
                                            </button>
                                        </form>
                                    {% else %}
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            No tienes permisos para subir confirmaciones en esta venta.
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="alert alert-danger">
                                        <i class="fas fa-exclamation-circle me-2"></i>
                                        Error: El formulario de confirmaciones no está disponible.
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="card shadow-sm">
                            <div class="card-header bg-light">
                                Archivos cargados
                            </div>
                            <div class="card-body">
                                {% if confirmaciones %}
                                    <div class="row g-3">
                                        {% for confirmacion in confirmaciones %}
                                            <div class="col-md-6">
                                                <div class="card h-100 border-0 shadow-sm">
                                                    <div class="card-body">
                                                        <h6 class="fw-bold mb-2">
                                                            <i class="fas fa-file-alt me-1 text-secondary"></i>
                                                            {{ confirmacion.nombre_archivo }}
                                                        </h6>
                                                        <p class="small text-muted mb-2">
                                                            Subido el {{ confirmacion.fecha_subida|date:"d/m/Y H:i" }}
                                                            {% if confirmacion.subido_por %}
                                                                por {{ confirmacion.subido_por.get_full_name|default:confirmacion.subido_por.username }}
                                                            {% endif %}
                                                        </p>
                                                        <p class="mb-3">{{ confirmacion.nota|default:"Sin descripción" }}</p>
                                                        <a href="{{ confirmacion.archivo.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                            <i class="fas fa-download"></i> Descargar
                                                        </a>
                                                    </div>
                                                    {% if confirmacion.es_imagen %}
                                                        <img src="{{ confirmacion.archivo.url }}" alt="{{ confirmacion.nombre_archivo }}" class="img-fluid rounded-bottom">
                                                    {% elif confirmacion.es_pdf %}
                                                        <div class="ratio ratio-4x3">
                                                            <iframe src="{{ confirmacion.archivo.url }}" title="{{ confirmacion.nombre_archivo }}" class="rounded-bottom" loading="lazy"></iframe>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="alert alert-light border text-center">
                                        <i class="fas fa-info-circle me-2"></i> Aún no se han cargado confirmaciones para esta venta.
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div> 
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Modal para subir comprobante de apertura -->
<div class="modal fade" id="modalComprobanteApertura" tabindex="-1" aria-labelledby="modalComprobanteAperturaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalComprobanteAperturaLabel">
                    <i class="fas fa-upload"></i> Subir Comprobante de Apertura
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'subir_comprobante_apertura' pk=venta.pk %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <p class="text-muted">Por favor, sube una imagen del comprobante de pago (recibo, screenshot, ticket, etc.).</p>
                    <div class="mb-3">
                        <label for="comprobante_apertura" class="form-label">Imagen del Comprobante <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="comprobante_apertura" name="comprobante_apertura" accept="image/*,.pdf" required>
                        <div class="form-text">Formatos aceptados: JPG, PNG, PDF. La imagen se comprimirá automáticamente.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-upload"></i> Subir Comprobante
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para editar comprobante de apertura (cuando ya está subido pero no confirmado) -->
{% if venta.modo_pago_apertura in 'TRN,TAR,DEP' and venta.estado_confirmacion == 'EN_CONFIRMACION' and venta.comprobante_apertura_subido and venta.comprobante_apertura %}
<div class="modal fade" id="modalEditarComprobanteApertura" tabindex="-1" aria-labelledby="modalEditarComprobanteAperturaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalEditarComprobanteAperturaLabel">
                    <i class="fas fa-edit"></i> Editar Comprobante de Apertura
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'subir_comprobante_apertura' pk=venta.pk %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <p class="text-muted">Apertura: <strong>${{ venta.cantidad_apertura|floatformat:2|intcomma }}</strong> - {{ venta.get_modo_pago_apertura_display }}</p>
                    {% if venta.comprobante_apertura %}
                    <div class="mb-3">
                        <label class="form-label">Comprobante actual:</label>
                        <div>
                            <a href="{{ venta.comprobante_apertura.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-image"></i> Ver actual
                            </a>
                        </div>
                    </div>
                    {% endif %}
                    <p class="text-muted">Sube una nueva imagen del comprobante para reemplazar la actual.</p>
                    <div class="mb-3">
                        <label for="comprobante_apertura_editar" class="form-label">Nueva Imagen del Comprobante <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="comprobante_apertura_editar" name="comprobante_apertura" accept="image/*,.pdf" required>
                        <div class="form-text">Formatos aceptados: JPG, PNG, PDF. La imagen se comprimirá automáticamente.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save"></i> Actualizar Comprobante
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Modales para subir comprobante de abonos (uno por cada abono pendiente) -->
{% for abono in abonos %}
    {% if abono.forma_pago in 'TRN,TAR,DEP' and not abono.confirmado and not abono.comprobante_subido %}
    <div class="modal fade" id="modalComprobanteAbono{{ abono.pk }}" tabindex="-1" aria-labelledby="modalComprobanteAbonoLabel{{ abono.pk }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="modalComprobanteAbonoLabel{{ abono.pk }}">
                        <i class="fas fa-upload"></i> Subir Comprobante de Abono
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'subir_comprobante_abono' pk=abono.pk %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-body">
                        <p class="text-muted">Abono: <strong>${{ abono.monto|floatformat:2|intcomma }}</strong> - {{ abono.get_forma_pago_display }}</p>
                        <p class="text-muted">Por favor, sube una imagen del comprobante de pago (recibo, screenshot, ticket, etc.).</p>
                        <div class="mb-3">
                            <label for="comprobante_imagen{{ abono.pk }}" class="form-label">Imagen del Comprobante <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" id="comprobante_imagen{{ abono.pk }}" name="comprobante_imagen" accept="image/*,.pdf" required>
                            <div class="form-text">Formatos aceptados: JPG, PNG, PDF. La imagen se comprimirá automáticamente.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-upload"></i> Subir Comprobante
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Modal para editar comprobante (cuando ya está subido pero no confirmado) -->
    {% if abono.forma_pago in 'TRN,TAR,DEP' and not abono.confirmado and abono.comprobante_subido %}
    <div class="modal fade" id="modalEditarComprobanteAbono{{ abono.pk }}" tabindex="-1" aria-labelledby="modalEditarComprobanteAbonoLabel{{ abono.pk }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="modalEditarComprobanteAbonoLabel{{ abono.pk }}">
                        <i class="fas fa-edit"></i> Editar Comprobante de Abono
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'subir_comprobante_abono' pk=abono.pk %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-body">
                        <p class="text-muted">Abono: <strong>${{ abono.monto|floatformat:2|intcomma }}</strong> - {{ abono.get_forma_pago_display }}</p>
                        {% if abono.comprobante_imagen %}
                        <div class="mb-3">
                            <label class="form-label">Comprobante actual:</label>
                            <div>
                                <a href="{{ abono.comprobante_imagen.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-image"></i> Ver actual
                                </a>
                            </div>
                        </div>
                        {% endif %}
                        <p class="text-muted">Sube una nueva imagen del comprobante para reemplazar la actual.</p>
                        <div class="mb-3">
                            <label for="comprobante_imagen_editar{{ abono.pk }}" class="form-label">Nueva Imagen del Comprobante <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" id="comprobante_imagen_editar{{ abono.pk }}" name="comprobante_imagen" accept="image/*,.pdf" required>
                            <div class="form-text">Formatos aceptados: JPG, PNG, PDF. La imagen se comprimirá automáticamente.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-save"></i> Actualizar Comprobante
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
{% endfor %}
{% endblock modals %}

{% block extra_js %}
<script>
    // Código JS para la funcionalidad de pestañas y URL
    document.addEventListener('DOMContentLoaded', function() {
        // Al hacer clic en un tab, actualizar la URL para que se mantenga
        const tabButtons = document.querySelectorAll('button[data-bs-toggle="tab"]');
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tabId = this.id.replace('-tab', '');
                history.replaceState(null, null, `?tab=${tabId}`);
            });
        });

        // Revisar URL para activar la pestaña correcta al cargar
        const urlParams = new URLSearchParams(window.location.search);
        const activeTabId = urlParams.get('tab');
        if (activeTabId) {
            // Aseguramos que el tab exista (ej: si el usuario no es JEFE/CONTADOR, el tab de logística no existe)
            const activeTab = document.querySelector(`#${activeTabId}-tab`);
            if (activeTab) {
                // Usamos el constructor de Bootstrap para mostrar la pestaña
                // Se asume que el objeto 'bootstrap' está disponible globalmente.
                if (typeof bootstrap !== 'undefined' && bootstrap.Tab) {
                    new bootstrap.Tab(activeTab).show();
                }
            }
        }

        // Conversión de abono USD->MXN con tipo de cambio por abono (solo INT)
        const abonoForm = document.querySelector('form button[name="registrar_abono"]')?.closest('form');
        if (abonoForm && "{{ venta.tipo_viaje }}" === "INT") {
            const montoInput = document.getElementById('{{ abono_form.monto.auto_id }}');
            const montoUsdInput = document.getElementById('montoUsd');
            const tipoCambioInput = document.getElementById('tipoCambioAbono');
            const montoUsdError = document.getElementById('montoUsdError');
            const tipoCambioError = document.getElementById('tipoCambioError');
            abonoForm.addEventListener('submit', function(e) {
                if (!montoUsdInput || !montoInput || !tipoCambioInput) return;
                // Usamos limpiarFormatoMoneda() para quitar '$', 'USD' y comas antes de convertir
                const usd = parseFloat(limpiarFormatoMoneda(montoUsdInput.value));
                const tc = parseFloat(limpiarFormatoMoneda(tipoCambioInput.value));
                let hasError = false;
                if (isNaN(usd) || usd <= 0) {
                    hasError = true;
                    if (montoUsdError) montoUsdError.classList.remove('d-none');
                } else if (montoUsdError) {
                    montoUsdError.classList.add('d-none');
                }
                if (isNaN(tc) || tc <= 0) {
                    hasError = true;
                    if (tipoCambioError) tipoCambioError.classList.remove('d-none');
                } else if (tipoCambioError) {
                    tipoCambioError.classList.add('d-none');
                }
                if (hasError) {
                    e.preventDefault();
                    return;
                }
                const mxn = usd * tc;
                montoInput.value = mxn.toFixed(2);
            });
        }
    });
</script>
{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" 
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        .logistica-servicio-row.status-pending {
            border-left: 4px solid #dc3545;
            background-color: rgba(220,53,69,0.05);
        }
        .logistica-servicio-row.status-ready {
            border-left: 4px solid #ffc107;
            background-color: rgba(255,193,7,0.08);
        }
        .logistica-servicio-row.status-paid {
            border-left: 4px solid #198754;
            background-color: rgba(25,135,84,0.08);
        }
    </style>
    {# Script común para formateo de moneda #}
    <script src="{% static 'js/currency-formatter.js' %}"></script>
    <script>
        // ========== FORMATO DE MONEDA EN TIEMPO REAL ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Campo de monto en MXN (formulario de abonos)
            const campoMontoMXN = document.getElementById('{{ abono_form.monto.id_for_label }}');
            if (campoMontoMXN) {
                inicializarFormatoMonedaEnCampos(['#{{ abono_form.monto.id_for_label }}']);
            }
            
            // Campo de monto en USD (formulario de abonos para ventas internacionales)
            const campoMontoUSD = document.getElementById('montoUsd');
            if (campoMontoUSD) {
                campoMontoUSD.setAttribute('data-formato-inicializado', 'true');
                
                // Formato inicial si ya tiene valor
                if (campoMontoUSD.value && !campoMontoUSD.value.startsWith('USD $') && !campoMontoUSD.value.startsWith('$')) {
                    const valorLimpio = limpiarFormatoMoneda(campoMontoUSD.value);
                    if (valorLimpio) {
                        const parts = valorLimpio.split('.');
                        let integerPart = parts[0];
                        let decimalPart = parts.length > 1 ? '.' + parts[1].substring(0, 2) : '';
                        if (integerPart) {
                            integerPart = parseInt(integerPart, 10).toLocaleString('es-MX');
                        }
                        campoMontoUSD.value = 'USD $' + integerPart + decimalPart;
                    }
                }
                
                // Formatear mientras escribe (con USD $)
                campoMontoUSD.addEventListener('input', function() {
                    const cursorPosition = this.selectionStart;
                    const originalValue = this.value;
                    let digitsBeforeCursor = 0;
                    for (let i = 0; i < cursorPosition; i++) {
                        if (/[0-9]/.test(originalValue[i])) digitsBeforeCursor++;
                    }
                    
                    let value = this.value.replace(/[^0-9.]/g, '');
                    if (!value) {
                        this.value = '';
                        return;
                    }
                    
                    const parts = value.split('.');
                    let integerPart = parts[0];
                    let decimalPart = parts.length > 1 ? '.' + parts[1].substring(0, 2) : '';
                    if (integerPart) {
                        integerPart = parseInt(integerPart, 10).toLocaleString('es-MX');
                    } else if (parts.length > 1) {
                        integerPart = '0';
                    }
                    
                    const newValue = 'USD $' + integerPart + decimalPart;
                    
                    if (this.value !== newValue) {
                        this.value = newValue;
                        let newCursorPos = 0;
                        let digitsFound = 0;
                        for (let i = 0; i < newValue.length; i++) {
                            if (/[0-9]/.test(newValue[i])) {
                                digitsFound++;
                            }
                            if (digitsFound >= digitsBeforeCursor) {
                                newCursorPos = i + 1;
                                if (digitsFound === digitsBeforeCursor) break;
                            }
                        }
                        if (digitsBeforeCursor === 0) newCursorPos = 6; // Después de "USD $"
                        this.setSelectionRange(newCursorPos, newCursorPos);
                    }
                });
                
                campoMontoUSD.addEventListener('blur', function() {
                    if (this.value === 'USD $' || this.value === '$') this.value = '';
                });
            }
            
            // Campos monto_planeado en la tabla de servicios (logística)
            // Estos campos se generan dinámicamente, así que usamos delegación de eventos
            document.addEventListener('input', function(e) {
                if (e.target && e.target.id && e.target.id.includes('monto_planeado')) {
                    const campo = e.target;
                    if (!campo.hasAttribute('data-formato-inicializado')) {
                        campo.setAttribute('data-formato-inicializado', 'true');
                    }
                    // Solo formatear si hay valor y no es 0 o 0.00
                    if (campo.value && campo.value.trim() !== '' && campo.value !== '0' && campo.value !== '0.00') {
                        formatearEnTiempoReal(campo);
                    } else if (campo.value === '0' || campo.value === '0.00') {
                        campo.value = '';
                    }
                }
            });
            
            // Inicializar formato en campos monto_planeado existentes
            const camposMontoPlaneado = document.querySelectorAll('[id*="monto_planeado"]');
            camposMontoPlaneado.forEach(campo => {
                if (!campo.hasAttribute('data-formato-inicializado')) {
                    campo.setAttribute('data-formato-inicializado', 'true');
                    // Solo formatear si tiene valor y no es 0.00 o vacío
                    if (campo.value && campo.value.trim() !== '' && campo.value !== '0.00' && campo.value !== '0' && !campo.value.startsWith('$')) {
                        // Limpiar el valor primero para verificar si es realmente 0
                        const valorLimpio = campo.value.replace('$', '').replace(',', '').trim();
                        if (valorLimpio && valorLimpio !== '0' && valorLimpio !== '0.00') {
                            formatearEnTiempoReal(campo);
                        } else {
                            // Si es 0.00, dejar vacío
                            campo.value = '';
                        }
                    } else if (campo.value === '0.00' || campo.value === '0') {
                        // Si el valor es 0.00, dejarlo vacío
                        campo.value = '';
                    }
                    campo.addEventListener('input', function() {
                        // Solo formatear si hay valor y no es solo 0
                        if (this.value && this.value.trim() !== '' && this.value !== '0' && this.value !== '0.00') {
                            formatearEnTiempoReal(this);
                        }
                    });
                    campo.addEventListener('blur', function() {
                        if (this.value === '$' || this.value === '0.00' || this.value === '0') {
                            this.value = '';
                        }
                    });
                }
            });
            
            // Limpiar formato antes de enviar formularios
            const forms = document.querySelectorAll('form[method="post"]');
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    // Limpiar formato de campo monto MXN
                    if (campoMontoMXN && campoMontoMXN.value) {
                        campoMontoMXN.value = limpiarFormatoMoneda(campoMontoMXN.value);
                    }
                    
                    // Limpiar formato de campo monto USD
                    if (campoMontoUSD && campoMontoUSD.value) {
                        let valorLimpio = campoMontoUSD.value.replace(/USD \$/g, '').replace(/\$/g, '').replace(/,/g, '');
                        campoMontoUSD.value = valorLimpio;
                    }
                    
                    // Limpiar formato de campos monto_planeado
                    camposMontoPlaneado.forEach(campo => {
                        if (campo.value) {
                            campo.value = limpiarFormatoMoneda(campo.value);
                        }
                    });
                });
            });
        });
    </script>
{% endblock %}