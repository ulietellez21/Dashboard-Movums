{% extends "base.html" %}
{% load humanize %}
{% load static %}

{# Aseg√∫rate de que tienes una URL configurada como 'eliminar_venta' que acepte el PK #}

{% block title %}Listado de Ventas{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
<h1>
<i class="fas fa-handshake"></i>
{% if user.perfil.rol == 'JEFE' or user.perfil.rol == 'CONTADOR' %}
Gesti√≥n de Contratos (Total) üìä
{% else %}
Mis Ventas üíº
{% endif %}
</h1>
{% with user.perfil.rol|default:""|upper as user_rol %}
    {% if "CONTADOR" not in user_rol %}
        <div class="d-flex flex-wrap gap-2">
            <a href="{% url 'crear_venta' %}" class="btn btn-success">
                <i class="fas fa-plus-circle"></i> Registrar Nueva Venta
            </a>
            <a href="{% url 'cotizaciones_lista' %}" class="btn btn-primary">
                <i class="fas fa-file-invoice-dollar"></i> Ir a Cotizaciones
            </a>
        </div>
    {% endif %}
{% endwith %}
</div>

<!-- Formulario de B√∫squeda Avanzada -->
<div class="card shadow-sm border-0 mb-3">
    <div class="card-header bg-light py-2">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-bold">
                <i class="fas fa-search me-2"></i> B√∫squeda Avanzada
            </h6>
            {% if fecha_filtro or busqueda_folio or busqueda_cliente or busqueda_servicio %}
            <a href="{% url 'lista_ventas' %}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-times"></i> Limpiar Filtros
            </a>
            {% endif %}
        </div>
    </div>
    <div class="card-body py-3">
        <form method="get" action="{% url 'lista_ventas' %}" class="row g-2 mb-2">
            <!-- B√∫squeda por Folio/ID -->
            <div class="col-md-2">
                <label for="busqueda_folio" class="form-label small mb-1">
                    <strong><i class="fas fa-hashtag me-1"></i> Folio / ID</strong>
                </label>
                <input type="text" class="form-control form-control-sm" id="busqueda_folio" name="busqueda_folio" 
                       value="{{ busqueda_folio|default:'' }}" 
                       placeholder="Ej: VUE-20251217-01">
            </div>
            <!-- B√∫squeda por Nombre de Cliente -->
            <div class="col-md-3">
                <label for="busqueda_cliente" class="form-label small mb-1">
                    <strong><i class="fas fa-user me-1"></i> Nombre de Cliente</strong>
                </label>
                <input type="text" class="form-control form-control-sm" id="busqueda_cliente" name="busqueda_cliente" 
                       value="{{ busqueda_cliente|default:'' }}" 
                       placeholder="Nombre, apellido o empresa">
            </div>
            <!-- Filtro por Servicio -->
            <div class="col-md-2">
                <label for="busqueda_servicio" class="form-label small mb-1">
                    <strong><i class="fas fa-concierge-bell me-1"></i> Servicio</strong>
                </label>
                <select class="form-select form-select-sm" id="busqueda_servicio" name="busqueda_servicio">
                    <option value="">Todos</option>
                    <option value="VUE" {% if busqueda_servicio == 'VUE' %}selected{% endif %}>Vuelo</option>
                    <option value="HOS" {% if busqueda_servicio == 'HOS' %}selected{% endif %}>Hospedaje</option>
                    <option value="ALO" {% if busqueda_servicio == 'ALO' %}selected{% endif %}>Alojamiento Alterno</option>
                    <option value="TRA" {% if busqueda_servicio == 'TRA' %}selected{% endif %}>Traslado</option>
                    <option value="TOU" {% if busqueda_servicio == 'TOU' %}selected{% endif %}>Tour y Actividades</option>
                    <option value="CIR" {% if busqueda_servicio == 'CIR' %}selected{% endif %}>Circuito Internacional</option>
                    <option value="REN" {% if busqueda_servicio == 'REN' %}selected{% endif %}>Renta de Auto</option>
                    <option value="PAQ" {% if busqueda_servicio == 'PAQ' %}selected{% endif %}>Paquete</option>
                    <option value="CRU" {% if busqueda_servicio == 'CRU' %}selected{% endif %}>Crucero</option>
                    <option value="SEG" {% if busqueda_servicio == 'SEG' %}selected{% endif %}>Seguro de Viaje</option>
                    <option value="DOC" {% if busqueda_servicio == 'DOC' %}selected{% endif %}>Tr√°mites de Documentaci√≥n</option>
                    <option value="VAR" {% if busqueda_servicio == 'VAR' %}selected{% endif %}>Varios (m√∫ltiples)</option>
                </select>
            </div>
            <!-- Filtro por Fecha -->
            <div class="col-md-3">
                <label for="fecha_filtro" class="form-label small mb-1">
                    <strong><i class="fas fa-calendar me-1"></i> Fecha de Viaje</strong>
                    <small class="text-muted">(Shift para rango)</small>
                </label>
                <input type="text" class="form-control form-control-sm" id="fecha_filtro" name="fecha_filtro" 
                       value="{% if fecha_filtro %}{{ fecha_filtro }}{% elif fecha_desde and fecha_hasta %}{{ fecha_desde }} a {{ fecha_hasta }}{% endif %}" 
                       placeholder="Selecciona fecha o rango" readonly>
                <input type="hidden" id="fecha_desde" name="fecha_desde" value="{{ fecha_desde }}">
                <input type="hidden" id="fecha_hasta" name="fecha_hasta" value="{{ fecha_hasta }}">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary btn-sm w-100">
                    <i class="fas fa-search me-1"></i> Buscar
                </button>
            </div>
        </form>
        {% if fecha_desde and fecha_hasta %}
        <div class="alert alert-info py-2 mb-0 mt-2">
            <small><i class="fas fa-info-circle me-1"></i> Mostrando ventas desde <strong>{{ fecha_desde }}</strong> hasta <strong>{{ fecha_hasta }}</strong></small>
        </div>
        {% elif fecha_filtro %}
        <div class="alert alert-info py-2 mb-0 mt-2">
            <small><i class="fas fa-info-circle me-1"></i> Mostrando ventas del <strong>{{ fecha_filtro }}</strong></small>
        </div>
        {% endif %}
        {% if busqueda_folio %}
        <div class="alert alert-info py-2 mb-0 mt-2">
            <small><i class="fas fa-info-circle me-1"></i> Buscando folio/ID: <strong>{{ busqueda_folio }}</strong></small>
        </div>
        {% endif %}
        {% if busqueda_cliente %}
        <div class="alert alert-info py-2 mb-0 mt-2">
            <small><i class="fas fa-info-circle me-1"></i> Buscando cliente: <strong>{{ busqueda_cliente }}</strong></small>
        </div>
        {% endif %}
        {% if busqueda_servicio %}
        <div class="alert alert-info py-2 mb-0 mt-2">
            <small><i class="fas fa-info-circle me-1"></i> Filtrando por servicio: <strong>{{ busqueda_servicio }}</strong></small>
        </div>
        {% endif %}
    </div>
</div>

{# ================================================================= #}
{#          TABLA DE VENTAS ACTIVAS / ABIERTAS                       #}
{# ================================================================= #}

{% if fecha_filtro %}
<h2 class="mb-3 mt-3 text-info">
<i class="fas fa-filter"></i> Resultados de la B√∫squeda: {{ fecha_filtro }}
</h2>
{% else %}
<h2 class="mb-3 mt-3 text-warning">
<i class="fas fa-folder-open"></i> Contratos Activos (Pendientes de Cerrar)
</h2>
{% endif %}
{% if ventas_activas %}
<div class="table-responsive">
<table class="table table-striped table-hover align-middle shadow-sm">
<thead class="table-dark bg-warning">
<tr>
<th>Folio</th>
<th>Cliente</th>
{% if user.perfil.rol == 'JEFE' or user.perfil.rol == 'CONTADOR' %}
<th>Asesor</th>
{% endif %}
<th>Fecha Viaje</th>
<th class="text-end">Costo Final</th>
<th class="text-end">Pagado</th>
<th class="text-end">Saldo Pendiente</th>
<th>Estado</th>
<th>Acciones</th>
</tr>
</thead>
<tbody>
{% for venta in ventas_activas %}
{% with user.perfil.rol|default:""|upper as user_rol %}
<tr {% if venta.estado_confirmacion == 'EN_CONFIRMACION' %}class="table-warning"{% endif %}>
<td><span class="badge bg-secondary">{{ venta.folio|default:venta.id }}</span></td>
<td>
<a href="{% url 'detalle_cliente' pk=venta.cliente.pk %}">
    {% if venta.cliente.tipo_cliente == 'EMPRESA' %}
        <i class="fas fa-building text-info"></i>
        <span class="badge bg-info text-white me-1">Empresa</span>
    {% else %}
        <i class="fas fa-user text-success"></i>
        <span class="badge bg-success text-white me-1">Particular</span>
    {% endif %}
    {{ venta.cliente.nombre_completo_display }}
</a>
</td>
{% if user_rol == 'JEFE' or user_rol == 'CONTADOR' %}
<td>{{ venta.vendedor.username }}</td>
{% endif %}

                <td>{{ venta.fecha_inicio_viaje|date:"d M Y" }}</td>
                {# Aseg√∫rate de que esta celda sea simple para evitar roturas #}
                <td class="text-end text-primary">
                    ${{ venta.costo_total_con_modificacion|floatformat:2|intcomma }}
                    {% if venta.costo_modificacion and venta.costo_modificacion > 0 %}
                        <br><small class="text-muted">(Incl. modif.)</small>
                    {% endif %}
                </td>
                
                <td class="text-end">
                    <span class="badge bg-success">${{ venta.total_pagado|floatformat:2|intcomma }}</span>
                </td>
                
                <td class="text-end">
                    {% if venta.saldo_restante > 0 %}
                        <span class="badge bg-danger">${{ venta.saldo_restante|floatformat:2|intcomma }}</span>
                    {% else %}
                        <span class="badge bg-primary">Pagado</span>
                    {% endif %}
                </td>
                
                <td>
                    {% if venta.estado_confirmacion == 'EN_CONFIRMACION' %}
                        <span class="badge bg-warning text-dark">
                            <i class="fas fa-clock"></i> En Confirmaci√≥n
                        </span>
                        {% if user_rol == 'CONTADOR' %}
                            <br><small class="text-warning"><i class="fas fa-exclamation-triangle"></i> Requiere acci√≥n</small>
                        {% endif %}
                    {% elif venta.saldo_restante > 0 %}
                        <span class="badge bg-info">Pendiente</span>
                    {% else %}
                        <span class="badge bg-success">Completado</span>
                    {% endif %}
                </td>
                <td>
                    {# RUTA DE DETALLE CORREGIDA: Requiere slug y pk #}
                    <a href="{% url 'detalle_venta' slug=venta.slug_safe pk=venta.pk %}{% if user_rol == 'CONTADOR' %}?tab=abonos{% endif %}" 
                       class="btn btn-sm btn-info text-white">
                        <i class="fas fa-eye"></i> Detalle
                    </a>
                </td>
            </tr>
            {% endwith %}
            {% endfor %}
        </tbody>
    </table>
</div>
{% if page_obj_activas and page_obj_activas.paginator.num_pages > 1 %}
<nav aria-label="Paginaci√≥n Contratos Activos" class="mt-2">
    <ul class="pagination pagination-sm justify-content-center flex-wrap">
        {% if page_obj_activas.has_previous %}
        <li class="page-item"><a class="page-link" href="?page_activas=1&page_cerradas={{ current_page_cerradas }}{% if busqueda_folio %}&busqueda_folio={{ busqueda_folio }}{% endif %}{% if busqueda_cliente %}&busqueda_cliente={{ busqueda_cliente }}{% endif %}{% if busqueda_servicio %}&busqueda_servicio={{ busqueda_servicio }}{% endif %}{% if fecha_filtro %}&fecha_filtro={{ fecha_filtro }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}">&laquo;&laquo;</a></li>
        <li class="page-item"><a class="page-link" href="?page_activas={{ page_obj_activas.previous_page_number }}&page_cerradas={{ current_page_cerradas }}{% if busqueda_folio %}&busqueda_folio={{ busqueda_folio }}{% endif %}{% if busqueda_cliente %}&busqueda_cliente={{ busqueda_cliente }}{% endif %}{% if busqueda_servicio %}&busqueda_servicio={{ busqueda_servicio }}{% endif %}{% if fecha_filtro %}&fecha_filtro={{ fecha_filtro }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}">&laquo;</a></li>
        {% endif %}
        {% for num in page_obj_activas.paginator.page_range %}
        {% if num == page_obj_activas.number %}
        <li class="page-item active" aria-current="page"><span class="page-link">{{ num }}</span></li>
        {% else %}
        <li class="page-item"><a class="page-link" href="?page_activas={{ num }}&page_cerradas={{ current_page_cerradas }}{% if busqueda_folio %}&busqueda_folio={{ busqueda_folio }}{% endif %}{% if busqueda_cliente %}&busqueda_cliente={{ busqueda_cliente }}{% endif %}{% if busqueda_servicio %}&busqueda_servicio={{ busqueda_servicio }}{% endif %}{% if fecha_filtro %}&fecha_filtro={{ fecha_filtro }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}">{{ num }}</a></li>
        {% endif %}
        {% endfor %}
        {% if page_obj_activas.has_next %}
        <li class="page-item"><a class="page-link" href="?page_activas={{ page_obj_activas.next_page_number }}&page_cerradas={{ current_page_cerradas }}{% if busqueda_folio %}&busqueda_folio={{ busqueda_folio }}{% endif %}{% if busqueda_cliente %}&busqueda_cliente={{ busqueda_cliente }}{% endif %}{% if busqueda_servicio %}&busqueda_servicio={{ busqueda_servicio }}{% endif %}{% if fecha_filtro %}&fecha_filtro={{ fecha_filtro }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}">&raquo;</a></li>
        <li class="page-item"><a class="page-link" href="?page_activas={{ page_obj_activas.paginator.num_pages }}&page_cerradas={{ current_page_cerradas }}{% if busqueda_folio %}&busqueda_folio={{ busqueda_folio }}{% endif %}{% if busqueda_cliente %}&busqueda_cliente={{ busqueda_cliente }}{% endif %}{% if busqueda_servicio %}&busqueda_servicio={{ busqueda_servicio }}{% endif %}{% if fecha_filtro %}&fecha_filtro={{ fecha_filtro }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}">&raquo;&raquo;</a></li>
        {% endif %}
    </ul>
    <p class="text-center small text-muted mb-0 mt-1">P√°g. {{ page_obj_activas.number }} de {{ page_obj_activas.paginator.num_pages }} ({{ page_obj_activas.paginator.count }} contratos activos)</p>
</nav>
{% endif %}
{% else %}
<div class="alert alert-info">No hay ventas activas registradas que coincidan con tu rol.</div>
{% endif %}

{# ================================================================= #}
{#          TABLA DE VENTAS CERRADAS / LIQUIDADAS                    #}
{# ================================================================= #}

<h2 class="mb-3 mt-5 text-success">
<i class="fas fa-check-circle"></i> Contratos Cerrados y Liquidados
</h2>
{% if ventas_cerradas %}
<div class="table-responsive">
<table class="table table-striped table-hover align-middle shadow-sm">
<thead class="table-dark bg-success">
<tr>
<th>Folio</th>
<th>Cliente</th>
{% if user.perfil.rol == 'JEFE' or user.perfil.rol == 'CONTADOR' %}
<th>Asesor</th>
{% endif %}
<th>Fecha Viaje</th>
<th class="text-end">Costo Final</th>
<th class="text-end">Pagado</th>
<th class="text-end">Estatus</th>
<th>Acciones</th>
</tr>
</thead>
<tbody>
{% for venta in ventas_cerradas %}
<tr>
<td><span class="badge bg-secondary">{{ venta.folio|default:venta.id }}</span></td>
<td>
<a href="{% url 'detalle_cliente' pk=venta.cliente.pk %}">
    {% if venta.cliente.tipo_cliente == 'EMPRESA' %}
        <i class="fas fa-building text-info"></i>
        <span class="badge bg-info text-white me-1">Empresa</span>
    {% else %}
        <i class="fas fa-user text-success"></i>
        <span class="badge bg-success text-white me-1">Particular</span>
    {% endif %}
    {{ venta.cliente.nombre_completo_display }}
</a>
</td>
{% if user.perfil.rol == 'JEFE' or user.perfil.rol == 'CONTADOR' %}
<td>{{ venta.vendedor.username }}</td>
{% endif %}

                <td>{{ venta.fecha_inicio_viaje|date:"d M Y" }}</td>
                <td class="text-end text-primary">
                    ${{ venta.costo_total_con_modificacion|floatformat:2|intcomma }}
                    {% if venta.costo_modificacion and venta.costo_modificacion > 0 %}
                        <br><small class="text-muted">(Incl. modif.)</small>
                    {% endif %}
                </td>
                <td class="text-end">
                    <span class="badge bg-success">${{ venta.total_pagado|floatformat:2|intcomma }}</span>
                </td>
                <td>
                    {% if venta.estado == 'CANCELADA' %}
                        <span class="badge bg-danger"><i class="fas fa-times-circle"></i> CANCELADA</span>
                    {% else %}
                        <span class="badge bg-success"><i class="fas fa-check-circle"></i> CERRADA</span>
                    {% endif %}
                </td>
                <td>
                    {# RUTA DE DETALLE CORREGIDA: Requiere slug y pk #}
                    <a href="{% url 'detalle_venta' slug=venta.slug_safe pk=venta.pk %}" class="btn btn-sm btn-info text-white">
                        <i class="fas fa-eye"></i> Detalle
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% if page_obj_cerradas and page_obj_cerradas.paginator.num_pages > 1 %}
<nav aria-label="Paginaci√≥n Contratos Cerrados" class="mt-2">
    <ul class="pagination pagination-sm justify-content-center flex-wrap">
        {% if page_obj_cerradas.has_previous %}
        <li class="page-item"><a class="page-link" href="?page_activas={{ current_page_activas }}&page_cerradas=1{% if busqueda_folio %}&busqueda_folio={{ busqueda_folio }}{% endif %}{% if busqueda_cliente %}&busqueda_cliente={{ busqueda_cliente }}{% endif %}{% if busqueda_servicio %}&busqueda_servicio={{ busqueda_servicio }}{% endif %}{% if fecha_filtro %}&fecha_filtro={{ fecha_filtro }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}">&laquo;&laquo;</a></li>
        <li class="page-item"><a class="page-link" href="?page_activas={{ current_page_activas }}&page_cerradas={{ page_obj_cerradas.previous_page_number }}{% if busqueda_folio %}&busqueda_folio={{ busqueda_folio }}{% endif %}{% if busqueda_cliente %}&busqueda_cliente={{ busqueda_cliente }}{% endif %}{% if busqueda_servicio %}&busqueda_servicio={{ busqueda_servicio }}{% endif %}{% if fecha_filtro %}&fecha_filtro={{ fecha_filtro }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}">&laquo;</a></li>
        {% endif %}
        {% for num in page_obj_cerradas.paginator.page_range %}
        {% if num == page_obj_cerradas.number %}
        <li class="page-item active" aria-current="page"><span class="page-link">{{ num }}</span></li>
        {% else %}
        <li class="page-item"><a class="page-link" href="?page_activas={{ current_page_activas }}&page_cerradas={{ num }}{% if busqueda_folio %}&busqueda_folio={{ busqueda_folio }}{% endif %}{% if busqueda_cliente %}&busqueda_cliente={{ busqueda_cliente }}{% endif %}{% if busqueda_servicio %}&busqueda_servicio={{ busqueda_servicio }}{% endif %}{% if fecha_filtro %}&fecha_filtro={{ fecha_filtro }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}">{{ num }}</a></li>
        {% endif %}
        {% endfor %}
        {% if page_obj_cerradas.has_next %}
        <li class="page-item"><a class="page-link" href="?page_activas={{ current_page_activas }}&page_cerradas={{ page_obj_cerradas.next_page_number }}{% if busqueda_folio %}&busqueda_folio={{ busqueda_folio }}{% endif %}{% if busqueda_cliente %}&busqueda_cliente={{ busqueda_cliente }}{% endif %}{% if busqueda_servicio %}&busqueda_servicio={{ busqueda_servicio }}{% endif %}{% if fecha_filtro %}&fecha_filtro={{ fecha_filtro }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}">&raquo;</a></li>
        <li class="page-item"><a class="page-link" href="?page_activas={{ current_page_activas }}&page_cerradas={{ page_obj_cerradas.paginator.num_pages }}{% if busqueda_folio %}&busqueda_folio={{ busqueda_folio }}{% endif %}{% if busqueda_cliente %}&busqueda_cliente={{ busqueda_cliente }}{% endif %}{% if busqueda_servicio %}&busqueda_servicio={{ busqueda_servicio }}{% endif %}{% if fecha_filtro %}&fecha_filtro={{ fecha_filtro }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}">&raquo;&raquo;</a></li>
        {% endif %}
    </ul>
    <p class="text-center small text-muted mb-0 mt-1">P√°g. {{ page_obj_cerradas.number }} de {{ page_obj_cerradas.paginator.num_pages }} ({{ page_obj_cerradas.paginator.count }} contratos cerrados)</p>
</nav>
{% endif %}

{% else %}
<div class="alert alert-warning">No hay ventas cerradas registradas que coincidan con tu rol.</div>
{% endif %}

{% endblock %}

{% block modals %}
<div class="modal fade" id="cotizacionModal" tabindex="-1" aria-labelledby="cotizacionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="cotizacionModalLabel">
                    <i class="fas fa-file-invoice-dollar me-2"></i> Generar Cotizaci√≥n
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <form id="cotizacionForm">
                    <div class="alert alert-info mb-4">
                        Completa la informaci√≥n para generar tu cotizaci√≥n con el formato Movums.
                    </div>

                    <hr class="my-4">

                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label fw-bold">Tipo de cotizaci√≥n</label>
                            <select class="form-select form-select-lg" name="tipo_cotizacion" id="tipoCotizacionSelect">
                                <option value="vuelos" selected>‚úàÔ∏è Vuelos</option>
                                <option value="hospedaje">üè® Hospedaje</option>
                                <option value="paquete">üß≥ Paquete</option>
                                <option value="tours">üó∫Ô∏è Tours</option>
                                <option value="generica">üìÑ Plantilla Gen√©rica</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row g-3 mt-2">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Origen</label>
                            <input type="text" class="form-control" name="origen" placeholder="Ej: Guadalajara">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Destino</label>
                            <input type="text" class="form-control" name="destino" placeholder="Ej: Canc√∫n">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Duraci√≥n del viaje</label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="dias" placeholder="D√≠as" min="1">
                                <span class="input-group-text">d√≠as</span>
                                <input type="number" class="form-control" name="noches" placeholder="Noches" min="0">
                                <span class="input-group-text">noches</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Fecha inicio</label>
                            <input type="date" class="form-control" name="fecha_inicio">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Fecha fin</label>
                            <input type="date" class="form-control" name="fecha_fin">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Pasajeros</label>
                            <input type="number" class="form-control" name="pasajeros" min="1" value="1">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Adultos</label>
                            <input type="number" class="form-control" name="adultos" min="0" value="2">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Menores</label>
                            <input type="number" class="form-control" name="menores" min="0" value="0">
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="cotizacion-section" data-section="vuelos">
                        <h5 class="text-primary fw-bold mb-3"><i class="fas fa-plane"></i> Propuestas de Vuelo</h5>
                        <div class="row g-3">
                            {% for idx in "123" %}
                            <div class="col-md-4">
                                <div class="border rounded p-3 h-100">
                                    <h6 class="fw-bold text-uppercase text-secondary">Opci√≥n {{ forloop.counter }}</h6>
                                    <div class="mb-2">
                                        <label class="form-label small fw-semibold">Aerol√≠nea</label>
                                        <input type="text" class="form-control form-control-sm" name="vuelo_aerolinea_{{ forloop.counter }}" placeholder="Ej: Volaris">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small fw-semibold">Salida</label>
                                        <input type="text" class="form-control form-control-sm" name="vuelo_salida_{{ forloop.counter }}" placeholder="Ej: 07:50 CDMX">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small fw-semibold">Regreso</label>
                                        <input type="text" class="form-control form-control-sm" name="vuelo_regreso_{{ forloop.counter }}" placeholder="Ej: 22:20 Canc√∫n">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small fw-semibold">Incluye</label>
                                        <textarea class="form-control form-control-sm" rows="2" name="vuelo_incluye_{{ forloop.counter }}" placeholder="Equipaje, tiempos, etc."></textarea>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small fw-semibold">Total MXN</label>
                                        <input type="text" class="form-control form-control-sm" name="vuelo_total_{{ forloop.counter }}" placeholder="24,909.00">
                                    </div>
                                    <div>
                                        <label class="form-label small fw-semibold">Forma de pago <span class="text-muted">(Opcional)</span></label>
                                        <input type="text" class="form-control form-control-sm" name="vuelo_forma_pago_{{ forloop.counter }}" placeholder="Ej: 50% anticipo, 50% al confirmar">
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="cotizacion-section d-none" data-section="hospedaje">
                        <h5 class="text-primary fw-bold mb-3"><i class="fas fa-hotel"></i> Propuestas de Hospedaje</h5>
                        <div class="row g-3">
                            {% for idx in "123" %}
                            <div class="col-md-4">
                                <div class="border rounded p-3 h-100">
                                    <h6 class="fw-bold text-uppercase text-secondary">Opci√≥n {{ forloop.counter }}</h6>
                                    <div class="mb-2">
                                        <label class="form-label small fw-semibold">Hotel</label>
                                        <input type="text" class="form-control form-control-sm" name="hotel_nombre_{{ forloop.counter }}" placeholder="Ej: Sotavento Hotel">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small fw-semibold">Habitaci√≥n</label>
                                        <input type="text" class="form-control form-control-sm" name="hotel_habitacion_{{ forloop.counter }}" placeholder="2 x Est√°ndar">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small fw-semibold">Direcci√≥n</label>
                                        <textarea class="form-control form-control-sm" rows="2" name="hotel_direccion_{{ forloop.counter }}" placeholder="Blvr Kukulk√°n km 4..."></textarea>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small fw-semibold">Plan de alimentos</label>
                                        <input type="text" class="form-control form-control-sm" name="hotel_plan_{{ forloop.counter }}" placeholder="Desayuno buffet">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small fw-semibold">Total MXN</label>
                                        <input type="text" class="form-control form-control-sm" name="hotel_total_{{ forloop.counter }}" placeholder="28,349.00">
                                    </div>
                                    <div>
                                        <label class="form-label small fw-semibold">Forma de pago <span class="text-muted">(Opcional)</span></label>
                                        <input type="text" class="form-control form-control-sm" name="hotel_forma_pago_{{ forloop.counter }}" placeholder="Ej: 50% anticipo, 50% al confirmar">
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="cotizacion-section d-none" data-section="paquete">
                        <h5 class="text-primary fw-bold mb-3"><i class="fas fa-layer-group"></i> Detalles del Paquete (Vuelo + Hospedaje)</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="border rounded p-3">
                                    <h6 class="fw-bold text-uppercase text-secondary">Vuelo</h6>
                                    <div class="mb-2">
                                        <label class="form-label small fw-semibold">Aerol√≠nea</label>
                                        <input type="text" class="form-control form-control-sm" name="paquete_vuelo_aerolinea" placeholder="Volaris">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small fw-semibold">Salida</label>
                                        <input type="text" class="form-control form-control-sm" name="paquete_vuelo_salida" placeholder="07:50 CDMX">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small fw-semibold">Regreso</label>
                                        <input type="text" class="form-control form-control-sm" name="paquete_vuelo_regreso" placeholder="22:20 CDMX">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small fw-semibold">Incluye</label>
                                        <textarea class="form-control form-control-sm" rows="3" name="paquete_vuelo_incluye" placeholder="Equipaje, traslados, etc."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="border rounded p-3">
                                    <h6 class="fw-bold text-uppercase text-secondary">Hospedaje</h6>
                                    <div class="mb-2">
                                        <label class="form-label small fw-semibold">Hotel</label>
                                        <input type="text" class="form-control form-control-sm" name="paquete_hotel_nombre" placeholder="Grand Oasis Canc√∫n">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small fw-semibold">Habitaci√≥n / Plan</label>
                                        <input type="text" class="form-control form-control-sm" name="paquete_hotel_habitacion" placeholder="Gran Std | Todo Incluido">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small fw-semibold">Notas</label>
                                        <textarea class="form-control form-control-sm" rows="2" name="paquete_hotel_notas" placeholder="Incluye traslado redondo"></textarea>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small fw-semibold">Total MXN</label>
                                        <input type="text" class="form-control form-control-sm" name="paquete_total" placeholder="37,199.00">
                                    </div>
                                    <div>
                                        <label class="form-label small fw-semibold">Forma de pago <span class="text-muted">(Opcional)</span></label>
                                        <input type="text" class="form-control form-control-sm" name="paquete_forma_pago" placeholder="Ej: 50% anticipo, 50% al confirmar">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="cotizacion-section d-none" data-section="tours">
                        <h5 class="text-primary fw-bold mb-3"><i class="fas fa-map-marked-alt"></i> Informaci√≥n de Tours</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">N√∫mero de Reserva</label>
                                <input type="text" class="form-control" name="tour_numero_reserva" placeholder="Ej: TOUR-2025-001">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Nombre del Tour</label>
                                <input type="text" class="form-control" name="tour_nombre" placeholder="Ej: Tour Chichen Itz√° + Cenote">
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-semibold">Especificaciones</label>
                                <textarea class="form-control" rows="6" name="tour_especificaciones" placeholder="Detalles del tour, itinerario, horarios, incluye, no incluye, etc."></textarea>
                                <small class="text-muted">Incluye toda la informaci√≥n relevante del tour: itinerario, horarios, qu√© incluye, qu√© no incluye, recomendaciones, etc.</small>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-semibold">Forma de pago <span class="text-muted">(Opcional)</span></label>
                                <input type="text" class="form-control" name="tour_forma_pago" placeholder="Ej: 50% anticipo, 50% al confirmar">
                            </div>
                        </div>
                    </div>

                    <div class="cotizacion-section d-none" data-section="generica">
                        <h5 class="text-primary fw-bold mb-3"><i class="fas fa-file-alt"></i> Plantilla Gen√©rica</h5>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Utiliza esta plantilla para incluir cualquier informaci√≥n personalizada en tu cotizaci√≥n.
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Contenido de la Cotizaci√≥n</label>
                            <textarea class="form-control" name="generica_contenido" rows="15" placeholder="Ingresa aqu√≠ toda la informaci√≥n que deseas incluir en la cotizaci√≥n. Puedes incluir texto, detalles de servicios, precios, condiciones, etc."></textarea>
                            <small class="form-text text-muted">Este contenido se incluir√° tal cual en la cotizaci√≥n generada.</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-secondary" id="limpiarCotizacionBtn">
                    <i class="fas fa-eraser"></i> Limpiar
                </button>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="generarCotizacionBtn">
                        <i class="fas fa-print"></i> Generar cotizaci√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<script id="cotizacionVentasJSON" type="application/json">{{ cotizacion_ventas_json|default:"[]"|safe }}</script>

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
crossorigin="anonymous" referrerpolicy="no-referrer" />
<!-- Flatpickr para selecci√≥n de rango de fechas -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}

{% block extra_js %}
<!-- Flatpickr para selecci√≥n de rango de fechas -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
<script>
    // Configurar Flatpickr para selecci√≥n de rango con Shift
    document.addEventListener('DOMContentLoaded', function() {
        const fechaInput = document.getElementById('fecha_filtro');
        const fechaDesdeInput = document.getElementById('fecha_desde');
        const fechaHastaInput = document.getElementById('fecha_hasta');
        const fechaDesdeDefault = "{{ fecha_desde|default:'' }}";
        const fechaHastaDefault = "{{ fecha_hasta|default:'' }}";
        const fechaFiltroDefault = "{{ fecha_filtro|default:'' }}";
        
        if (fechaInput) {
            // Configurar Flatpickr en modo rango
            let flatpickrInstance = flatpickr(fechaInput, {
                mode: "range",
                dateFormat: "Y-m-d",
                locale: "es",
                altInput: true,
                altFormat: "d/m/Y",
                allowInput: false,
                clickOpens: true,
                enableTime: false,
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length === 1) {
                        // Solo una fecha seleccionada
                        fechaDesdeInput.value = selectedDates[0].toISOString().split('T')[0];
                        fechaHastaInput.value = '';
                        fechaInput.value = dateStr;
                    } else if (selectedDates.length === 2) {
                        // Rango completo seleccionado
                        fechaDesdeInput.value = selectedDates[0].toISOString().split('T')[0];
                        fechaHastaInput.value = selectedDates[1].toISOString().split('T')[0];
                        fechaInput.value = dateStr;
                    } else {
                        // Sin selecci√≥n
                        fechaDesdeInput.value = '';
                        fechaHastaInput.value = '';
                        fechaInput.value = '';
                    }
                }
            });
            
            // Restaurar valores si existen
            if (fechaDesdeDefault && fechaHastaDefault) {
                fechaDesdeInput.value = fechaDesdeDefault;
                fechaHastaInput.value = fechaHastaDefault;
                flatpickrInstance.setDate([fechaDesdeDefault, fechaHastaDefault]);
            } else if (fechaFiltroDefault) {
                fechaInput.value = fechaFiltroDefault;
                flatpickrInstance.setDate(fechaFiltroDefault);
            }
        }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cotizacionForm = document.getElementById('cotizacionForm');
        if (!cotizacionForm) {
            return;
        }

        const tipoSelect = document.getElementById('tipoCotizacionSelect');
        const sections = cotizacionForm.querySelectorAll('.cotizacion-section');
        const limpiarBtn = document.getElementById('limpiarCotizacionBtn');
        const generarBtn = document.getElementById('generarCotizacionBtn');
        const datosEl = document.getElementById('cotizacionVentasJSON');
        const docxUrl = "{% url 'generar_cotizacion_docx' %}";

        const origenInput = cotizacionForm.querySelector('input[name="origen"]');
        const destinoInput = cotizacionForm.querySelector('input[name="destino"]');
        const diasInput = cotizacionForm.querySelector('input[name="dias"]');
        const nochesInput = cotizacionForm.querySelector('input[name="noches"]');
        const fechaInicioInput = cotizacionForm.querySelector('input[name="fecha_inicio"]');
        const fechaFinInput = cotizacionForm.querySelector('input[name="fecha_fin"]');

        let ventasMap = new Map();
        try {
            const parsed = JSON.parse(datosEl?.textContent || '[]');
            parsed.forEach(item => ventasMap.set(String(item.id), item));
        } catch (error) {
            console.warn('No se pudo parsear el JSON de cotizaciones', error);
        }

        let selectedVenta = ventasMap.values().next().value || null;

        function toggleSection(tipo) {
            sections.forEach(section => {
                if (section.dataset.section === tipo) {
                    section.classList.remove('d-none');
                } else {
                    section.classList.add('d-none');
                }
            });
        }

        function fillForm(venta) {
            if (!venta) {
                diasInput.value = '';
                nochesInput.value = '';
                fechaInicioInput.value = '';
                fechaFinInput.value = '';
                return;
            }
            fechaInicioInput.value = venta.fecha_inicio || '';
            fechaFinInput.value = venta.fecha_fin || '';
            diasInput.value = venta.dias ?? '';
            nochesInput.value = venta.noches ?? '';
        }

        const cotizacionModalEl = document.getElementById('cotizacionModal');
        cotizacionModalEl?.addEventListener('shown.bs.modal', function() {
            if (!selectedVenta) {
                selectedVenta = ventasMap.values().next().value || null;
            }
            fillForm(selectedVenta);
        });

        tipoSelect?.addEventListener('change', function() {
            toggleSection(this.value);
        });

        // Establecer fecha de cotizaci√≥n autom√°ticamente (fecha actual)
        const hoy = new Date();
        const fecha_cotizacion = hoy.toISOString().split('T')[0]; // Formato YYYY-MM-DD
        
        const defaults = {
            pasajeros: cotizacionForm.querySelector('input[name="pasajeros"]')?.value || '',
            adultos: cotizacionForm.querySelector('input[name="adultos"]')?.value || '',
            menores: cotizacionForm.querySelector('input[name="menores"]')?.value || ''
        };

        limpiarBtn?.addEventListener('click', function() {
            cotizacionForm.reset();
            Object.entries(defaults).forEach(([key, value]) => {
                const input = cotizacionForm.querySelector(`[name="${key}"]`);
                if (input && value !== undefined) {
                    input.value = value;
                }
            });
            fillForm(selectedVenta);
            const tipoSeleccionado = tipoSelect?.value || 'vuelos';
            toggleSection(tipoSeleccionado);
        });

        generarBtn?.addEventListener('click', function() {
            if (!selectedVenta) {
                selectedVenta = {
                    cliente: '',
                    id: null
                };
            }

            const formData = new FormData(cotizacionForm);
            const data = Object.fromEntries(formData.entries());
            const tipo = data.tipo_cotizacion || 'vuelos';

            const requiredFields = ['origen', 'destino', 'fecha_inicio', 'fecha_fin'];
            const missing = requiredFields.filter(field => !(data[field] || '').trim());
            if (missing.length) {
                alert('Por favor completa los campos obligatorios: Origen, Destino y Fechas.');
                return;
            }

            const propuestasVuelo = [1, 2, 3].map(idx => ({
                aerolinea: (data[`vuelo_aerolinea_${idx}`] || '').trim(),
                salida: (data[`vuelo_salida_${idx}`] || '').trim(),
                regreso: (data[`vuelo_regreso_${idx}`] || '').trim(),
                incluye: (data[`vuelo_incluye_${idx}`] || '').trim(),
                total: (data[`vuelo_total_${idx}`] || '').trim(),
                forma_pago: (data[`vuelo_forma_pago_${idx}`] || '').trim()
            })).filter(item => Object.values(item).some(value => value));

            const propuestasHotel = [1, 2, 3].map(idx => ({
                nombre: (data[`hotel_nombre_${idx}`] || '').trim(),
                habitacion: (data[`hotel_habitacion_${idx}`] || '').trim(),
                direccion: (data[`hotel_direccion_${idx}`] || '').trim(),
                plan: (data[`hotel_plan_${idx}`] || '').trim(),
                total: (data[`hotel_total_${idx}`] || '').trim(),
                forma_pago: (data[`hotel_forma_pago_${idx}`] || '').trim()
            })).filter(item => Object.values(item).some(value => value));

            if (tipo === 'vuelos' && propuestasVuelo.length === 0) {
                alert('Agrega al menos una propuesta de vuelo.');
                return;
            }
            if (tipo === 'hospedaje' && propuestasHotel.length === 0) {
                alert('Agrega al menos una propuesta de hospedaje.');
                return;
            }
            if (tipo === 'paquete' && !(data.paquete_total || '').trim()) {
                alert('Agrega la informaci√≥n del paquete (total, vuelo u hotel).');
                return;
            }
            if (tipo === 'generica' && !(data.generica_contenido || '').trim()) {
                alert('Agrega el contenido para la cotizaci√≥n gen√©rica.');
                return;
            }
            if (tipo === 'tours' && !(data.tour_nombre || '').trim()) {
                alert('Agrega el nombre del tour.');
                return;
            }

            const cotizacionData = {
                tipo,
                general: {
                    cliente: selectedVenta?.cliente || '',
                    fechaCotizacion: fecha_cotizacion, // Usar fecha autom√°tica establecida arriba
                    origen: data.origen,
                    destino: data.destino,
                    dias: data.dias,
                    noches: data.noches,
                    fechaInicio: data.fecha_inicio,
                    fechaFin: data.fecha_fin,
                    pasajeros: data.pasajeros,
                    adultos: data.adultos,
                    menores: data.menores
                },
                vuelos: propuestasVuelo,
                hoteles: propuestasHotel,
                paquete: {
                    vuelo: {
                        aerolinea: (data.paquete_vuelo_aerolinea || '').trim(),
                        salida: (data.paquete_vuelo_salida || '').trim(),
                        regreso: (data.paquete_vuelo_regreso || '').trim(),
                        incluye: (data.paquete_vuelo_incluye || '').trim(),
                    },
                    hotel: {
                        nombre: (data.paquete_hotel_nombre || '').trim(),
                        habitacion: (data.paquete_hotel_habitacion || '').trim(),
                        notas: (data.paquete_hotel_notas || '').trim(),
                    },
                    total: (data.paquete_total || '').trim(),
                    forma_pago: (data.paquete_forma_pago || '').trim()
                },
                tours: {
                    numero_reserva: (data.tour_numero_reserva || '').trim(),
                    nombre: (data.tour_nombre || '').trim(),
                    especificaciones: (data.tour_especificaciones || '').trim(),
                    forma_pago: (data.tour_forma_pago || '').trim()
                },
                generica: {
                    contenido: (data.generica_contenido || '').trim()
                }
            };

            fetch(docxUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    cotizacion: cotizacionData,
                    venta_id: selectedVenta.id || null
                })
            })
            .then(async response => {
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || 'No se pudo generar la cotizaci√≥n.');
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                const nombreCliente = (selectedVenta.cliente || 'cotizacion').replace(/\s+/g, '_');
                link.href = url;
                link.download = `cotizacion_${nombreCliente}.docx`;
                document.body.appendChild(link);
                link.click();
                link.remove();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                alert(error.message || 'No se pudo generar la cotizaci√≥n.');
            });
        });

        // Inicializar con la secci√≥n de vuelos
        if (tipoSelect) {
            toggleSection(tipoSelect.value);
        } else {
            toggleSection('vuelos');
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>

{% endblock %}