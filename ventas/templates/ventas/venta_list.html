{% extends "base.html" %}
{% load humanize %}

{# Aseg칰rate de que tienes una URL configurada como 'eliminar_venta' que acepte el PK #}

{% block title %}Listado de Ventas{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
<h1>
<i class="fas fa-handshake"></i>
{% if user.perfil.rol == 'JEFE' or user.perfil.rol == 'CONTADOR' %}
Gesti칩n de Contratos (Total) 游늵
{% else %}
Mis Ventas 游눺
{% endif %}
</h1>
{% with user.perfil.rol|default:""|upper as user_rol %}
    {% if "CONTADOR" not in user_rol %}
        <a href="{% url 'crear_venta' %}" class="btn btn-success">
            <i class="fas fa-plus-circle"></i> Registrar Nueva Venta
        </a>
    {% endif %}
{% endwith %}
</div>

{# ================================================================= #}
{#     TABLA DE VENTAS ACTIVAS / ABIERTAS            #}
{# ================================================================= #}

<h2 class="mb-3 mt-5 text-warning">
<i class="fas fa-folder-open"></i> Contratos Activos (Pendientes de Cerrar)
</h2>
{% if ventas_activas %}
<div class="table-responsive">
<table class="table table-striped table-hover align-middle shadow-sm">
<thead class="table-dark bg-warning">
<tr>
<th>ID</th>
<th>Cliente</th>
{% if user.perfil.rol == 'JEFE' or user.perfil.rol == 'CONTADOR' %}
<th>Vendedor</th>
{% endif %}
<th>Fecha Viaje</th>
<th class="text-end">Costo Final</th>
<th class="text-end">Pagado</th>
<th class="text-end">Saldo Pendiente</th>
<th>Estado</th>
<th>Acciones</th>
</tr>
</thead>
<tbody>
{% for venta in ventas_activas %}
<tr>
<td>{{ venta.id }}</td>
<td>
<a href="{% url 'detalle_cliente' pk=venta.cliente.pk %}">
<i class="fas fa-user-circle"></i> {{ venta.cliente.nombre_completo_display }}
</a>
</td>
{% if user.perfil.rol == 'JEFE' or user.perfil.rol == 'CONTADOR' %}
<td>{{ venta.vendedor.username }}</td>
{% endif %}

                <td>{{ venta.fecha_inicio_viaje|date:"d M Y" }}</td>
                {# Aseg칰rate de que esta celda sea simple para evitar roturas #}
                <td class="text-end text-primary">${{ venta.costo_venta_final|floatformat:2|intcomma }}</td>
                
                <td class="text-end">
                    <span class="badge bg-success">${{ venta.total_pagado|floatformat:2|intcomma }}</span>
                </td>
                
                <td class="text-end">
                    {% if venta.saldo_restante > 0 %}
                        <span class="badge bg-danger">${{ venta.saldo_restante|floatformat:2|intcomma }}</span>
                    {% else %}
                        <span class="badge bg-primary">Pagado</span>
                    {% endif %}
                </td>
                
                <td>
                    <span class="badge bg-warning text-dark">Pendiente</span>
                </td>
                <td>
                    {# RUTA DE DETALLE CORREGIDA: Requiere slug y pk #}
                    <a href="{% url 'detalle_venta' slug=venta.slug_safe pk=venta.pk %}" class="btn btn-sm btn-info text-white">
                        <i class="fas fa-eye"></i> Detalle
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


{% else %}
<div class="alert alert-info">No hay ventas activas registradas que coincidan con tu rol.</div>
{% endif %}

{# ================================================================= #}
{#     TABLA DE VENTAS CERRADAS / LIQUIDADAS          #}
{# ================================================================= #}

<h2 class="mb-3 mt-5 text-success">
<i class="fas fa-check-circle"></i> Contratos Cerrados y Liquidados
</h2>
{% if ventas_cerradas %}
<div class="table-responsive">
<table class="table table-striped table-hover align-middle shadow-sm">
<thead class="table-dark bg-success">
<tr>
<th>ID</th>
<th>Cliente</th>
{% if user.perfil.rol == 'JEFE' or user.perfil.rol == 'CONTADOR' %}
<th>Vendedor</th>
{% endif %}
<th>Fecha Viaje</th>
<th class="text-end">Costo Final</th>
<th class="text-end">Pagado</th>
<th class="text-end">Estatus</th>
<th>Acciones</th>
</tr>
</thead>
<tbody>
{% for venta in ventas_cerradas %}
<tr>
<td>{{ venta.id }}</td>
<td>
<a href="{% url 'detalle_cliente' pk=venta.cliente.pk %}">
<i class="fas fa-user-circle"></i> {{ venta.cliente.nombre_completo_display }}
</a>
</td>
{% if user.perfil.rol == 'JEFE' or user.perfil.rol == 'CONTADOR' %}
<td>{{ venta.vendedor.username }}</td>
{% endif %}

                <td>{{ venta.fecha_inicio_viaje|date:"d M Y" }}</td>
                <td class="text-end text-primary">${{ venta.costo_venta_final|floatformat:2|intcomma }}</td>
                <td class="text-end">
                    <span class="badge bg-success">${{ venta.total_pagado|floatformat:2|intcomma }}</span>
                </td>
                <td>
                    <span class="badge bg-success">CERRADA</span>
                </td>
                <td>
                    {# RUTA DE DETALLE CORREGIDA: Requiere slug y pk #}
                    <a href="{% url 'detalle_venta' slug=venta.slug pk=venta.pk %}" class="btn btn-sm btn-info text-white me-2">
                        <i class="fas fa-eye"></i> Detalle
                    </a>
                    {# BOT칍N DE ELIMINAR A칌ADIDO #}
                    <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal{{ venta.pk }}">
                        <i class="fas fa-trash-alt"></i> Eliminar
                    </button>
                </td>
            </tr>

            {# MODAL DE CONFIRMACI칍N DE ELIMINACI칍N #}
            <div class="modal fade" id="confirmDeleteModal{{ venta.pk }}" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Eliminaci칩n</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            쮼st치s seguro de que deseas eliminar la venta **#{{ venta.id }}** del cliente **{{ venta.cliente.nombre_completo_display }}**? Esta acci칩n es irreversible.
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <form action="{% url 'eliminar_venta' pk=venta.pk %}" method="post" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger">S칤, Eliminar Permanentemente</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </tbody>
    </table>
</div>


{% else %}
<div class="alert alert-warning">No hay ventas cerradas registradas que coincidan con tu rol.</div>
{% endif %}

{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
crossorigin="anonymous" referrerpolicy="no-referrer" />
{% endblock %}