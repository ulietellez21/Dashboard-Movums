{% extends "base.html" %}
{% load humanize %}
{% block title %}Pagos por Confirmar{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-clock text-warning"></i> Pagos por Confirmar
            </h1>
            
            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}
            
            <!-- Pestañas para Pendientes y Historial -->
            <ul class="nav nav-tabs mb-4" id="pagosTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if not request.GET.tab or request.GET.tab != 'historial' %}active{% endif %}" id="pendientes-tab" data-bs-toggle="tab" data-bs-target="#pendientes" type="button" role="tab">
                        <i class="fas fa-exclamation-circle"></i> Pendientes 
                        <span class="badge bg-warning text-dark ms-1">
                            {{ object.abonos|length|add:object.aperturas|length|add:object.abonos_proveedor|length }}
                        </span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if request.GET.tab == 'historial' %}active{% endif %}" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial" type="button" role="tab">
                        <i class="fas fa-history"></i> Historial
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="pagosTabsContent">
                <!-- Tab Pendientes -->
                <div class="tab-pane fade {% if not request.GET.tab or request.GET.tab != 'historial' %}show active{% endif %}" id="pendientes" role="tabpanel">
                    <!-- Abonos Pendientes -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-money-bill-wave"></i> Abonos Pendientes 
                                <span class="badge bg-light text-dark ms-2">{{ object.abonos|length }}</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if object.abonos %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Venta</th>
                                                <th>Cliente</th>
                                                <th>Monto</th>
                                                <th>Forma de Pago</th>
                                                <th>Comprobante</th>
                                                <th>Registrado por</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for abono in object.abonos %}
                                            <tr class="{% if abono.venta.tipo_viaje == 'INT' %}table-danger{% elif not abono.confirmado %}table-warning{% endif %}">
                                                <td>
                                                    {{ abono.fecha_pago|date:"d/M/y H:i" }}
                                                    {% if abono.venta.tipo_viaje == 'INT' %}
                                                        <br><span class="badge bg-danger"><i class="fas fa-dollar-sign me-1"></i>USD</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <a href="{% url 'detalle_venta' pk=abono.venta.pk slug=abono.venta.slug_safe %}" class="text-decoration-none">
                                                        {{ abono.venta.folio|default:abono.venta.id }}
                                                    </a>
                                                </td>
                                                <td>{{ abono.venta.cliente.nombre_completo_display }}</td>
                                                <td>
                                                    {% if abono.venta.tipo_viaje == 'INT' %}
                                                        {% with tc_abono=abono.tipo_cambio_para_display|default:abono.venta.tipo_cambio %}
                                                        {% if abono.monto_usd_para_display %}
                                                            <strong>USD ${{ abono.monto_usd_para_display|floatformat:2|intcomma }}</strong>
                                                            {% if tc_abono %}<br><small class="text-muted">TC: ${{ tc_abono|floatformat:4 }} MXN/USD</small>{% endif %}
                                                        {% else %}
                                                            <strong>${{ abono.monto|floatformat:2|intcomma }} MXN</strong>
                                                            {% if tc_abono %}<br><small class="text-muted">TC: ${{ tc_abono|floatformat:4 }} MXN/USD</small>{% endif %}
                                                        {% endif %}
                                                        {% endwith %}
                                                    {% else %}
                                                        <strong>${{ abono.monto|floatformat:2|intcomma }}</strong>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge {% if abono.forma_pago == 'TRN' %}bg-primary{% elif abono.forma_pago == 'TAR' %}bg-info{% elif abono.forma_pago == 'DEP' %}bg-secondary{% elif abono.forma_pago == 'EFE' %}bg-success{% else %}bg-secondary{% endif %}">
                                                        {{ abono.get_forma_pago_display }}
                                                    </span>
                                                    {% if abono.requiere_factura %}
                                                        <span class="badge bg-info text-white ms-1" title="Requiere factura">
                                                            <i class="fas fa-file-invoice"></i> Factura
                                                        </span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if abono.comprobante_imagen %}
                                                        <a href="{{ abono.comprobante_imagen.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                            <i class="fas fa-image"></i> Ver
                                                        </a>
                                                    {% else %}
                                                        <span class="text-muted">Sin comprobante</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {{ abono.registrado_por.username|default:"-" }}
                                                    {% if abono.requiere_factura %}
                                                        <br><small class="text-info"><i class="fas fa-file-invoice"></i> Requiere factura</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if abono.comprobante_subido %}
                                                        {% if abono.venta.tipo_viaje == 'INT' %}
                                                            <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#modalConfirmarUSD_abono{{ abono.pk }}">
                                                                <i class="fas fa-exclamation-triangle me-1"></i> Confirmar (USD)
                                                            </button>
                                                        {% else %}
                                                            <form method="post" action="{% url 'confirmar_pago_desde_lista' tipo='abono' pk=abono.pk %}" class="d-inline">
                                                                {% csrf_token %}
                                                                <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('¿Confirmar este pago?')">
                                                                    <i class="fas fa-check"></i> Confirmar
                                                                </button>
                                                            </form>
                                                        {% endif %}
                                                        <a href="{% url 'detalle_venta' pk=abono.venta.pk slug=abono.venta.slug_safe %}?tab=abonos" class="btn btn-sm btn-outline-info">
                                                            <i class="fas fa-eye"></i> Ver Venta
                                                        </a>
                                                    {% else %}
                                                        <span class="text-muted small">Esperando comprobante</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> No hay abonos pendientes de confirmar.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Aperturas Pendientes -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-hand-holding-usd"></i> Pagos de Apertura Pendientes 
                                <span class="badge bg-light text-dark ms-2">{{ object.aperturas|length }}</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if object.aperturas %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Venta</th>
                                                <th>Cliente</th>
                                                <th>Monto</th>
                                                <th>Forma de Pago</th>
                                                <th>Comprobante</th>
                                                <th>Asesor</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for venta in object.aperturas %}
                                            <tr class="table-warning">
                                                <td>{{ venta.fecha_creacion|date:"d/M/y H:i" }}</td>
                                                <td>
                                                    <a href="{% url 'detalle_venta' pk=venta.pk slug=venta.slug_safe %}" class="text-decoration-none">
                                                        {{ venta.folio|default:venta.id }}
                                                    </a>
                                                </td>
                                                <td>{{ venta.cliente.nombre_completo_display }}</td>
                                                <td>
                                                    {% if venta.tipo_viaje == 'INT' and venta.cantidad_apertura_usd %}
                                                        <strong>USD ${{ venta.cantidad_apertura_usd|floatformat:2|intcomma }}</strong>
                                                        {% if venta.tipo_cambio %}<br><small class="text-muted">TC: ${{ venta.tipo_cambio|floatformat:4 }} MXN/USD</small>{% endif %}
                                                    {% else %}
                                                        <strong>${{ venta.cantidad_apertura|floatformat:2|intcomma }}</strong>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge {% if venta.modo_pago_apertura == 'TRN' %}bg-primary{% elif venta.modo_pago_apertura == 'TAR' %}bg-info{% elif venta.modo_pago_apertura == 'DEP' %}bg-secondary{% elif venta.modo_pago_apertura == 'CRE' %}bg-warning{% elif venta.modo_pago_apertura == 'EFE' %}bg-success{% else %}bg-secondary{% endif %}">
                                                        {{ venta.get_modo_pago_apertura_display }}
                                                    </span>
                                                    {% if venta.requiere_factura_apertura %}
                                                        <span class="badge bg-info text-white ms-1" title="Requiere factura">
                                                            <i class="fas fa-file-invoice"></i> Factura
                                                        </span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if venta.comprobante_apertura %}
                                                        <a href="{{ venta.comprobante_apertura.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                            <i class="fas fa-image"></i> Ver
                                                        </a>
                                                    {% else %}
                                                        <span class="text-muted">Sin comprobante</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {{ venta.vendedor.username|default:"-" }}
                                                    {% if venta.requiere_factura_apertura %}
                                                        <br><small class="text-info"><i class="fas fa-file-invoice"></i> Requiere factura</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if venta.comprobante_apertura_subido %}
                                                        <form method="post" action="{% url 'confirmar_pago_desde_lista' tipo='apertura' pk=venta.pk %}" class="d-inline">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('¿Confirmar este pago de apertura?')">
                                                                <i class="fas fa-check"></i> Confirmar
                                                            </button>
                                                        </form>
                                                        <a href="{% url 'detalle_venta' pk=venta.pk slug=venta.slug_safe %}?tab=abonos" class="btn btn-sm btn-outline-info">
                                                            <i class="fas fa-eye"></i> Ver Venta
                                                        </a>
                                                    {% else %}
                                                        <span class="text-muted small">Esperando comprobante</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> No hay pagos de apertura pendientes de confirmar.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Abonos a Proveedor Pendientes -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">
                                <i class="fas fa-hand-holding-usd"></i> Abonos a Proveedor Pendientes 
                                <span class="badge bg-light text-dark ms-2">{{ object.abonos_proveedor|length }}</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if object.abonos_proveedor %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Venta</th>
                                                <th>Cliente</th>
                                                <th>Proveedor</th>
                                                <th>Monto</th>
                                                <th>Estado</th>
                                                <th>Solicitado Por</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for abono in object.abonos_proveedor %}
                                            <tr class="{% if abono.venta.tipo_viaje == 'INT' %}table-danger{% elif abono.estado == 'PENDIENTE' %}table-warning{% elif abono.estado == 'APROBADO' %}table-info{% endif %}">
                                                <td>
                                                    {% if abono.estado == 'APROBADO' and abono.fecha_aprobacion %}
                                                        {{ abono.fecha_aprobacion|date:"d/M/y H:i" }}
                                                    {% else %}
                                                        {{ abono.fecha_solicitud|date:"d/M/y H:i" }}
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <a href="{% url 'detalle_venta' pk=abono.venta.pk slug=abono.venta.slug_safe %}?tab=logistica" class="text-decoration-none">
                                                        {{ abono.venta.folio|default:abono.venta.id }}
                                                    </a>
                                                </td>
                                                <td>{{ abono.venta.cliente.nombre_completo_display }}</td>
                                                <td><strong>{{ abono.proveedor }}</strong></td>
                                                <td>
                                                    {% if abono.venta.tipo_viaje == 'INT' %}
                                                        <span class="badge bg-danger mb-1"><i class="fas fa-dollar-sign me-1"></i>USD</span><br>
                                                        {% with tc_abono=abono.tipo_cambio_para_display|default:abono.venta.tipo_cambio %}
                                                        {% if abono.monto_usd_para_display %}
                                                            <strong class="text-danger">USD ${{ abono.monto_usd_para_display|floatformat:2|intcomma }}</strong>
                                                            {% if tc_abono %}<br><small class="text-muted">TC: ${{ tc_abono|floatformat:4 }} MXN/USD</small>{% endif %}
                                                        {% else %}
                                                            <strong class="text-danger">${{ abono.monto|floatformat:2|intcomma }}</strong>
                                                            {% if tc_abono %}<br><small class="text-muted">TC: ${{ tc_abono|floatformat:4 }} MXN/USD</small>{% endif %}
                                                        {% endif %}
                                                        {% endwith %}
                                                    {% else %}
                                                        <strong>${{ abono.monto|floatformat:2|intcomma }} MXN</strong>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if abono.estado == 'PENDIENTE' %}
                                                        <span class="badge bg-warning text-dark">Pendiente</span>
                                                    {% elif abono.estado == 'APROBADO' %}
                                                        <span class="badge bg-info">Aprobado</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ abono.solicitud_por.get_full_name|default:abono.solicitud_por.username }}</td>
                                                <td>
                                                    <a href="{% url 'detalle_venta' pk=abono.venta.pk slug=abono.venta.slug_safe %}?tab=logistica" class="btn btn-sm btn-outline-info">
                                                        <i class="fas fa-eye"></i> Ver Venta
                                                    </a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> No hay abonos a proveedor pendientes de confirmar.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Tab Historial -->
                <div class="tab-pane fade {% if request.GET.tab == 'historial' %}show active{% endif %}" id="historial" role="tabpanel">
                    <!-- Filtros de fecha -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0"><i class="fas fa-filter"></i> Filtros</h5>
                        </div>
                        <div class="card-body">
                            <form method="get" class="row g-3" id="filtroHistorialForm">
                                <!-- Campo oculto para mantener la pestaña activa -->
                                <input type="hidden" name="tab" value="historial">
                                <div class="col-md-3">
                                    <label class="form-label">Período</label>
                                    <select name="fecha_filtro" id="fecha_filtro_select" class="form-select">
                                        <option value="dia" {% if fecha_filtro == 'dia' %}selected{% endif %}>Hoy</option>
                                        <option value="semana" {% if fecha_filtro == 'semana' %}selected{% endif %}>Última semana</option>
                                        <option value="mes" {% if fecha_filtro == 'mes' %}selected{% endif %}>Último mes</option>
                                        <option value="personalizado" {% if fecha_filtro == 'personalizado' %}selected{% endif %}>Personalizado</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Desde</label>
                                    <input type="date" name="fecha_desde" id="fecha_desde_input" class="form-control" value="{% if fecha_filtro == 'personalizado' %}{{ fecha_desde }}{% endif %}">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Hasta</label>
                                    <input type="date" name="fecha_hasta" id="fecha_hasta_input" class="form-control" value="{% if fecha_filtro == 'personalizado' %}{{ fecha_hasta }}{% endif %}">
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-search"></i> Filtrar
                                    </button>
                                </div>
                            </form>
                            <script>
                                // Solución mejorada: usar disabled en lugar de removeAttribute
                                const fechaFiltroSelect = document.getElementById('fecha_filtro_select');
                                const fechaDesdeInput = document.getElementById('fecha_desde_input');
                                const fechaHastaInput = document.getElementById('fecha_hasta_input');
                                
                                function toggleInputs() {
                                    const isPersonalizado = fechaFiltroSelect.value === 'personalizado';
                                    fechaDesdeInput.disabled = !isPersonalizado;
                                    fechaHastaInput.disabled = !isPersonalizado;
                                    if (!isPersonalizado) {
                                        fechaDesdeInput.value = '';
                                        fechaHastaInput.value = '';
                                    }
                                }
                                
                                fechaFiltroSelect.addEventListener('change', toggleInputs);
                                toggleInputs(); // Ejecutar al inicio para establecer el estado correcto
                            </script>
                        </div>
                    </div>
                    
                    <!-- Abonos Confirmados -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-check-circle"></i> Abonos Confirmados 
                                <span class="badge bg-light text-dark ms-2">{{ abonos_confirmados|length }}</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if abonos_confirmados %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Fecha Confirmación</th>
                                                <th>Venta</th>
                                                <th>Cliente</th>
                                                <th>Monto</th>
                                                <th>Forma de Pago</th>
                                                <th>Confirmado por</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for abono in abonos_confirmados %}
                                            <tr class="{% if abono.venta.tipo_viaje == 'INT' %}table-danger{% endif %}">
                                                <td>{{ abono.confirmado_en|date:"d/M/y H:i" }}</td>
                                                <td>
                                                    <a href="{% url 'detalle_venta' pk=abono.venta.pk slug=abono.venta.slug_safe %}" class="text-decoration-none">
                                                        {{ abono.venta.folio|default:abono.venta.id }}
                                                    </a>
                                                </td>
                                                <td>{{ abono.venta.cliente.nombre_completo_display }}</td>
                                                <td>
                                                    {% if abono.venta.tipo_viaje == 'INT' and abono.monto_usd %}
                                                        <span class="badge bg-danger mb-1">USD</span><br>
                                                        <strong class="text-danger">USD ${{ abono.monto_usd|floatformat:2|intcomma }}</strong>
                                                    {% else %}
                                                        <strong>${{ abono.monto|floatformat:2|intcomma }}</strong>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge {% if abono.forma_pago == 'TRN' %}bg-primary{% elif abono.forma_pago == 'TAR' %}bg-info{% elif abono.forma_pago == 'DEP' %}bg-secondary{% elif abono.forma_pago == 'EFE' %}bg-success{% else %}bg-secondary{% endif %}">
                                                        {{ abono.get_forma_pago_display }}
                                                    </span>
                                                </td>
                                                <td>{{ abono.confirmado_por.username|default:"-" }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> No hay abonos confirmados en el período seleccionado.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Aperturas Confirmadas -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-check-circle"></i> Aperturas Confirmadas 
                                <span class="badge bg-light text-dark ms-2">{{ ventas_apertura_confirmada|length }}</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if ventas_apertura_confirmada %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Fecha Venta</th>
                                                <th>Venta</th>
                                                <th>Cliente</th>
                                                <th>Monto</th>
                                                <th>Forma de Pago</th>
                                                <th>Asesor</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for venta in ventas_apertura_confirmada %}
                                            <tr>
                                                <td>{{ venta.fecha_creacion|date:"d/M/y H:i" }}</td>
                                                <td>
                                                    <a href="{% url 'detalle_venta' pk=venta.pk slug=venta.slug_safe %}" class="text-decoration-none">
                                                        {{ venta.folio|default:venta.id }}
                                                    </a>
                                                </td>
                                                <td>{{ venta.cliente.nombre_completo_display }}</td>
                                                <td><strong>${{ venta.cantidad_apertura|floatformat:2|intcomma }}</strong></td>
                                                <td>
                                                    <span class="badge {% if venta.modo_pago_apertura == 'TRN' %}bg-primary{% elif venta.modo_pago_apertura == 'TAR' %}bg-info{% elif venta.modo_pago_apertura == 'DEP' %}bg-secondary{% elif venta.modo_pago_apertura == 'CRE' %}bg-warning{% elif venta.modo_pago_apertura == 'EFE' %}bg-success{% else %}bg-secondary{% endif %}">
                                                        {{ venta.get_modo_pago_apertura_display }}
                                                    </span>
                                                </td>
                                                <td>{{ venta.vendedor.username|default:"-" }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> No hay aperturas confirmadas en el período seleccionado.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Abonos a Proveedor Confirmados -->
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-check-circle"></i> Abonos a Proveedor Confirmados 
                                <span class="badge bg-light text-dark ms-2">{{ abonos_proveedor_confirmados|length }}</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if abonos_proveedor_confirmados %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Fecha Confirmación</th>
                                                <th>Venta</th>
                                                <th>Cliente</th>
                                                <th>Proveedor</th>
                                                <th>Monto</th>
                                                <th>Confirmado por</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for abono in abonos_proveedor_confirmados %}
                                            <tr>
                                                <td>{{ abono.fecha_confirmacion|date:"d/M/y H:i" }}</td>
                                                <td>
                                                    <a href="{% url 'detalle_venta' pk=abono.venta.pk slug=abono.venta.slug_safe %}" class="text-decoration-none">
                                                        {{ abono.venta.folio|default:abono.venta.id }}
                                                    </a>
                                                </td>
                                                <td>{{ abono.venta.cliente.nombre_completo_display }}</td>
                                                <td><strong>{{ abono.proveedor }}</strong></td>
                                                <td>
                                                    {% if abono.venta.tipo_viaje == 'INT' %}
                                                        {% with tc_abono=abono.tipo_cambio_para_display|default:abono.venta.tipo_cambio %}
                                                        {% if abono.monto_usd_para_display %}
                                                            <strong>USD ${{ abono.monto_usd_para_display|floatformat:2|intcomma }}</strong>
                                                            {% if tc_abono %}<br><small class="text-muted">TC: ${{ tc_abono|floatformat:4 }} MXN/USD</small>{% endif %}
                                                        {% else %}
                                                            <strong>${{ abono.monto|floatformat:2|intcomma }} MXN</strong>
                                                            {% if tc_abono %}<br><small class="text-muted">TC: ${{ tc_abono|floatformat:4 }} MXN/USD</small>{% endif %}
                                                        {% endif %}
                                                        {% endwith %}
                                                    {% else %}
                                                        <strong>${{ abono.monto|floatformat:2|intcomma }} MXN</strong>
                                                    {% endif %}
                                                </td>
                                                <td>{{ abono.confirmado_por.username|default:"-" }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> No hay abonos a proveedor confirmados en el período seleccionado.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
{% for abono in object.abonos %}
{% if abono.venta.tipo_viaje == 'INT' and abono.comprobante_subido %}
<div class="modal fade" id="modalConfirmarUSD_abono{{ abono.pk }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>ATENCIÓN: Abono en DÓLARES (USD)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <strong><i class="fas fa-dollar-sign me-1"></i>Este abono es en DÓLARES AMERICANOS (USD), NO en pesos mexicanos.</strong>
                </div>
                <p><strong>Monto:</strong> {% if abono.monto_usd_para_display %}USD ${{ abono.monto_usd_para_display|floatformat:2|intcomma }}{% else %}${{ abono.monto|floatformat:2|intcomma }}{% endif %}</p>
                {% with tc_abono=abono.tipo_cambio_para_display|default:abono.venta.tipo_cambio %}
                {% if tc_abono %}<p class="text-muted mb-0"><strong>Tipo de cambio del abono:</strong> ${{ tc_abono|floatformat:4 }} MXN/USD</p>{% endif %}
                {% endwith %}
                <p><strong>Venta:</strong> #{{ abono.venta.folio|default:abono.venta.pk }} - {{ abono.venta.cliente.nombre_completo_display }}</p>
                <hr>
                <p class="fw-bold">Para confirmar, rectifique el tipo de cambio ingresándolo una vez:</p>
                <div class="mb-3">
                    <label class="form-label">Tipo de cambio (MXN/USD)</label>
                    <input type="number" step="0.0001" min="0" class="form-control usd-tc" data-modal="abono{{ abono.pk }}" data-expected-tc="{% if abono.tipo_cambio_para_display %}{{ abono.tipo_cambio_para_display|floatformat:4 }}{% elif abono.venta.tipo_cambio %}{{ abono.venta.tipo_cambio|floatformat:4 }}{% endif %}" placeholder="Ej: 17.5000">
                    <div class="invalid-feedback">El tipo de cambio no coincide con el registrado.</div>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input usd-check" type="checkbox" data-modal="abono{{ abono.pk }}" id="checkUSD_abono{{ abono.pk }}">
                    <label class="form-check-label fw-bold text-danger" for="checkUSD_abono{{ abono.pk }}">
                        Confirmo que este abono es en DÓLARES (USD) y he verificado el tipo de cambio
                    </label>
                </div>
                <form method="post" action="{% url 'confirmar_pago_desde_lista' tipo='abono' pk=abono.pk %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger w-100 usd-submit" data-modal="abono{{ abono.pk }}" disabled>
                        <i class="fas fa-check-circle me-1"></i> Confirmar Abono en USD
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}
{% endblock modals %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Validación de modales USD (un solo campo TC que debe coincidir con el esperado)
        document.querySelectorAll('.usd-tc, .usd-check').forEach(function(el) {
            el.addEventListener('input', function() { validarModalUSD(el.dataset.modal); });
            el.addEventListener('change', function() { validarModalUSD(el.dataset.modal); });
        });
        function validarModalUSD(modalId) {
            var tcInput = document.querySelector('.usd-tc[data-modal="' + modalId + '"]');
            var chk = document.querySelector('.usd-check[data-modal="' + modalId + '"]');
            var btn = document.querySelector('.usd-submit[data-modal="' + modalId + '"]');
            if (!tcInput || !chk || !btn) return;
            var v = parseFloat(tcInput.value);
            var expected = parseFloat(tcInput.getAttribute('data-expected-tc') || '0');
            var coincide = v > 0 && expected > 0 && Math.abs(v - expected) < 0.0001;
            tcInput.classList.toggle('is-invalid', tcInput.value && !coincide);
            tcInput.classList.toggle('is-valid', coincide);
            btn.disabled = !(coincide && chk.checked);
        }

        // Activar la pestaña correcta según el parámetro de URL
        const urlParams = new URLSearchParams(window.location.search);
        const activeTab = urlParams.get('tab');
        
        if (activeTab === 'historial') {
            // Activar la pestaña de historial
            const historialTab = document.getElementById('historial-tab');
            const historialPane = document.getElementById('historial');
            
            if (historialTab && historialPane) {
                // Remover active de pendientes
                const pendientesTab = document.getElementById('pendientes-tab');
                const pendientesPane = document.getElementById('pendientes');
                if (pendientesTab) pendientesTab.classList.remove('active');
                if (pendientesPane) pendientesPane.classList.remove('show', 'active');
                
                // Agregar active a historial
                historialTab.classList.add('active');
                historialPane.classList.add('show', 'active');
            }
        }
    });
</script>
{% endblock %}

