{% extends "base.html" %}

{% load static %}

{% block title %}Crear Nuevo Cliente{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-9">
            <div class="card shadow-lg rounded-4 border-0">
                <div class="card-header bg-primary text-white rounded-top-4 p-4">
                    <h2 class="h3 mb-0">
                        <i class="fas fa-user-plus me-2"></i> Nuevo Cliente
                    </h2>
                </div>
                <div class="card-body p-4 p-md-5">
                    <!-- Mensajes de Django -->
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show rounded-3" role="alert">
                                <strong>{{ message.tags|title }}:</strong> {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <form method="post" id="clienteForm" enctype="multipart/form-data" class="needs-validation" novalidate>
                        {% csrf_token %}

                        <!-- Mensajes de error globales del formulario -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger rounded-3" role="alert">
                                <strong>Errores Generales:</strong>
                                <ul>
                                    {% for error in form.non_field_errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}

                        <!-- SECCIÓN 1: TIPO DE CLIENTE -->
                        <h4 class="mb-3 text-primary border-bottom pb-2"><i class="fas fa-user-tag me-2"></i>Tipo de Cliente</h4>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="{{ form.tipo_cliente.id_for_label }}" class="form-label">Tipo de Cliente <span class="text-danger">*</span></label>
                                {{ form.tipo_cliente }}
                                {% for error in form.tipo_cliente.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.fuente_contacto.id_for_label }}" class="form-label">Fuente de Contacto</label>
                                {{ form.fuente_contacto }}
                            </div>
                        </div>

                        <!-- ================================================== -->
                        <!-- CAMPOS DE EMPRESA -->
                        <!-- ================================================== -->
                        <div id="empresa_fields" style="display: none;">
                            <h4 class="mb-3 text-primary border-bottom pb-2"><i class="fas fa-building me-2"></i>Datos de la Empresa</h4>
                            <div class="row g-3 mb-4">
                                <div class="col-md-7">
                                    <label for="{{ form.nombre_empresa.id_for_label }}" class="form-label">Razón Social / Nombre <span class="text-danger">*</span></label>
                                    {{ form.nombre_empresa }}
                                    {% for error in form.nombre_empresa.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-5">
                                    <label for="{{ form.rfc.id_for_label }}" class="form-label">RFC / ID Fiscal <span class="text-danger">*</span></label>
                                    {{ form.rfc }}
                                    {% for error in form.rfc.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-12">
                                    <label for="{{ form.direccion_fiscal.id_for_label }}" class="form-label">Dirección Fiscal <span class="text-danger">*</span></label>
                                    {{ form.direccion_fiscal }}
                                    {% for error in form.direccion_fiscal.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.industria.id_for_label }}" class="form-label">Industria</label>
                                    {{ form.industria }}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.responsable_administrativo.id_for_label }}" class="form-label">Responsable Administrativo</label>
                                    {{ form.responsable_administrativo }}
                                </div>
                                <div class="col-12">
                                    <label for="{{ form.politicas_viaje_internas.id_for_label }}" class="form-label">Políticas de Viaje Internas</label>
                                    {{ form.politicas_viaje_internas }}
                                    <small class="form-text text-muted">Políticas y restricciones de viaje de la empresa</small>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mt-4">
                                        {{ form.credito }}
                                        <label class="form-check-label" for="{{ form.credito.id_for_label }}">
                                            Crédito (si aplica)
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6" id="monto_credito_field" style="display: none;">
                                    <label for="{{ form.monto_credito.id_for_label }}" class="form-label">Monto de Crédito Asignado</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        {{ form.monto_credito }}
                                    </div>
                                    <small class="form-text text-muted">Monto de crédito asignado a la empresa</small>
                                </div>
                            </div>
                        </div>

                        <!-- ================================================== -->
                        <!-- CAMPOS DE PARTICULAR -->
                        <!-- ================================================== -->
                        <div id="particular_fields" style="display: none;">
                            <!-- Información Personal -->
                            <h4 class="mb-3 text-primary border-bottom pb-2"><i class="fas fa-id-card me-2"></i>Información Personal</h4>
                            <div class="row g-3 mb-4">
                                <div class="col-md-4">
                                    <label for="{{ form.nombre.id_for_label }}" class="form-label">Nombre <span class="text-danger">*</span></label>
                                    {{ form.nombre }}
                                    {% for error in form.nombre.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.apellido.id_for_label }}" class="form-label">Apellido <span class="text-danger">*</span></label>
                                    {{ form.apellido }}
                                    {% for error in form.apellido.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.genero.id_for_label }}" class="form-label">Género</label>
                                    {{ form.genero }}
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.nacionalidad.id_for_label }}" class="form-label">Nacionalidad</label>
                                    {{ form.nacionalidad }}
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.fecha_nacimiento.id_for_label }}" class="form-label">Fecha de Nacimiento</label>
                                    {{ form.fecha_nacimiento }}
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.empresa_asociada.id_for_label }}" class="form-label">Empresa Asociada <span class="badge bg-secondary">Opcional</span></label>
                                    {{ form.empresa_asociada }}
                                    <small class="form-text text-muted">Si pertenece a una empresa registrada</small>
                                </div>
                            </div>

                            <!-- Documentos de Identificación -->
                            <h4 class="mb-3 text-primary border-bottom pb-2"><i class="fas fa-passport me-2"></i>Documentos de Identificación</h4>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label for="{{ form.ine_imagen.id_for_label }}" class="form-label">INE (Imagen) <span class="badge bg-secondary">Opcional</span></label>
                                    {{ form.ine_imagen }}
                                    <small class="form-text text-muted">Sube una imagen de la credencial INE</small>
                                </div>
                            </div>
                            
                            <div class="row g-3 mb-4">
                                <div class="col-12">
                                    <h6 class="text-muted"><i class="fas fa-id-badge me-1"></i> Visa <span class="badge bg-secondary">Opcional</span></h6>
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.visa_numero.id_for_label }}" class="form-label">Número de Visa</label>
                                    {{ form.visa_numero }}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.visa_vigencia.id_for_label }}" class="form-label">Vigencia de Visa</label>
                                    {{ form.visa_vigencia }}
                                </div>
                            </div>

                            <div class="row g-3 mb-4">
                                <div class="col-12">
                                    <h6 class="text-muted"><i class="fas fa-passport me-1"></i> Pasaporte <span class="badge bg-secondary">Opcional</span></h6>
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.pasaporte_numero.id_for_label }}" class="form-label">Número de Pasaporte</label>
                                    {{ form.pasaporte_numero }}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.pasaporte_vigencia.id_for_label }}" class="form-label">Vigencia de Pasaporte</label>
                                    {{ form.pasaporte_vigencia }}
                                </div>
                            </div>
                        </div>

                        <!-- ================================================== -->
                        <!-- CAMPOS COMUNES - CONTACTO -->
                        <!-- ================================================== -->
                        <h4 class="mb-3 text-primary border-bottom pb-2"><i class="fas fa-phone me-2"></i>Información de Contacto</h4>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label for="{{ form.telefono.id_for_label }}" class="form-label">Teléfono Móvil <span class="text-danger">*</span></label>
                                {{ form.telefono }}
                                {% for error in form.telefono.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                                <small class="form-text text-muted">Para envío de WhatsApp</small>
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.telefono_adicional.id_for_label }}" class="form-label">Teléfono Adicional <span class="badge bg-secondary">Opcional</span></label>
                                {{ form.telefono_adicional }}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.email.id_for_label }}" class="form-label">Correo Electrónico</label>
                                {{ form.email }}
                                {% for error in form.email.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- ================================================== -->
                        <!-- PREFERENCIAS DE VIAJE -->
                        <!-- ================================================== -->
                        <h4 class="mb-3 text-primary border-bottom pb-2"><i class="fas fa-plane me-2"></i>Preferencias de Viaje</h4>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <label for="{{ form.preferencias_viaje.id_for_label }}" class="form-label">Preferencias de Viaje</label>
                                {{ form.preferencias_viaje }}
                                <small class="form-text text-muted">Notas sobre gustos de viaje (Playa, Aventura, etc.)</small>
                            </div>
                        </div>

                        <!-- ================================================== -->
                        <!-- PROGRAMA KILÓMETROS -->
                        <!-- ================================================== -->
                        <h4 class="mb-3 text-primary border-bottom pb-2"><i class="fas fa-award me-2"></i>Programa Kilómetros Movums</h4>
                        
                        <div class="row g-3 mb-4 align-items-start">
                            <div class="col-md-6">
                                <div class="form-check mt-4">
                                    {{ form.participa_kilometros }}
                                    <label class="form-check-label" for="{{ form.participa_kilometros.id_for_label }}">
                                        Participa en Kilómetros Movums
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 mt-4">
                                <div class="d-flex flex-column" style="gap: 0.25rem;">
                                    <label for="{{ form.referido_por.id_for_label }}" class="form-label d-flex align-items-center flex-wrap gap-1 mb-0">Referido Por <span class="badge bg-secondary">Opcional</span></label>
                                    <div>{{ form.referido_por }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="d-flex justify-content-between mt-4">
                            <div>
                                <a href="{% url 'lista_clientes' %}" class="btn btn-outline-secondary rounded-pill px-4">
                                    <i class="fas fa-arrow-left me-2"></i> Cancelar
                                </a>
                                {% if object and object.pk %}
                                    {% with user.perfil.rol|default:""|upper as user_rol %}
                                        {% if user_rol == "JEFE" %}
                                            <button type="button" class="btn btn-danger rounded-pill px-4 ms-2" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">
                                                <i class="fas fa-trash-alt me-2"></i> Eliminar Cliente
                                            </button>
                                        {% endif %}
                                    {% endwith %}
                                {% endif %}
                            </div>
                            <button type="submit" class="btn btn-success rounded-pill px-4 shadow-sm">
                                <i class="fas fa-save me-2"></i> {% if object and object.pk %}Actualizar{% else %}Guardar{% endif %} Cliente
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tipoClienteSelect = document.getElementById('id_tipo_cliente');
        const particularFields = document.getElementById('particular_fields');
        const empresaFields = document.getElementById('empresa_fields');
        const creditoCheckbox = document.getElementById('id_credito');
        const montoCreditoField = document.getElementById('monto_credito_field');

        function toggleFields() {
            const selectedValue = tipoClienteSelect.value;
            
            particularFields.style.display = 'none';
            empresaFields.style.display = 'none';

            if (selectedValue === 'PARTICULAR') {
                particularFields.style.display = 'block';
            } else if (selectedValue === 'EMPRESA') {
                empresaFields.style.display = 'block';
            }
            
            // Actualizar visibilidad del monto de crédito
            toggleMontoCredito();
        }
        
        function toggleMontoCredito() {
            if (creditoCheckbox && montoCreditoField) {
                if (creditoCheckbox.checked && tipoClienteSelect.value === 'EMPRESA') {
                    montoCreditoField.style.display = 'block';
                } else {
                    montoCreditoField.style.display = 'none';
                }
            }
        }

        toggleFields(); 
        tipoClienteSelect.addEventListener('change', toggleFields);
        
        if (creditoCheckbox) {
            creditoCheckbox.addEventListener('change', toggleMontoCredito);
        }
    });
    
    // Script mejorado para eliminar overlay - Versión FUERTE
    (function() {
        'use strict';
        
        // Función FUERTE para matar el overlay
        function killOverlay() {
            // Seleccionar por ID y por clase para no fallar
            const overlays = document.querySelectorAll('#pageTransitionOverlay, .page-transition-overlay');
            overlays.forEach(function(el) {
                // Forzar ocultamiento con estilos inline de máxima prioridad
                el.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important; z-index: -9999 !important; pointer-events: none !important;';
                el.classList.remove('active');
            });
            document.body.classList.remove('no-animations');
        }
        
        // 1. Ejecutar inmediatamente al detectar el click en el botón de eliminar
        document.addEventListener('mousedown', function(e) {
            // Buscar si el clic fue en un botón de modal de eliminar
            const btn = e.target.closest('[data-bs-target="#confirmDeleteModal"]');
            if (btn) {
                killOverlay();
                // Reintentar varias veces por si el sistema intenta reactivarlo
                setTimeout(killOverlay, 10);
                setTimeout(killOverlay, 50);
                setTimeout(killOverlay, 200);
            }
        }, true); // Fase de captura para ganar prioridad
        
        // 2. Ejecutar cuando el modal intenta abrirse
        document.addEventListener('show.bs.modal', function(e) {
            if (e.target.id === 'confirmDeleteModal') {
                killOverlay();
            }
        }, true);
        
        // 3. Limpieza inicial por si acaso
        killOverlay();
    })();
</script>

{% endblock content %}

{% block modals %}
{% if object and object.pk %}
    <!-- Modal de Confirmación de Eliminación -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="confirmDeleteModalLabel"><i class="fas fa-exclamation-triangle"></i> Confirmar Eliminación</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body text-black">
                    <p><strong>¿Estás absolutamente seguro de que deseas eliminar al cliente "{{ object }}"?</strong></p>
                    <p class="text-danger">
                        Esta acción es <strong>irreversible</strong>. Se eliminará toda la información de este cliente, incluyendo sus datos de contacto y su historial de ventas asociado.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    
                    <!-- Formulario de Eliminación (solo se activa con POST) -->
                    <form method="POST" action="{% url 'eliminar_cliente' pk=object.pk %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger"><i class="fas fa-trash-alt"></i> Eliminar Definitivamente</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}
