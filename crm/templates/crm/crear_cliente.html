{% extends "base.html" %}

{% load static %}

{% block title %}Crear Nuevo Cliente{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <div class="card shadow-lg rounded-4 border-0">
                <div class="card-header bg-primary text-white rounded-top-4 p-4">
                    <h2 class="h3 mb-0">
                        <i class="fas fa-user-plus me-2"></i> Nuevo Cliente
                    </h2>
                </div>
                <div class="card-body p-4 p-md-5">
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}

                        <!-- Mensajes de error globales del formulario -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger rounded-3" role="alert">
                                <strong>Errores Generales:</strong>
                                <ul>
                                    {% for error in form.non_field_errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}

                        <!-- SECCIÓN 1: TIPO DE CLIENTE (CONTROL DINÁMICO) -->
                        <h4 class="mb-3 text-primary border-bottom pb-2">Tipo y Contacto</h4>
                        
                        <div class="row g-3 mb-4">
                            <!-- Campo tipo_cliente: CLAVE PARA EL JS -->
                            <div class="col-md-6">
                                <label for="{{ form.tipo_cliente.id_for_label }}" class="form-label">Tipo de Cliente</label>
                                {{ form.tipo_cliente }}
                                {% for error in form.tipo_cliente.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>

                            <!-- Teléfono (Campo Común y Obligatorio) -->
                            <div class="col-md-6">
                                <label for="{{ form.telefono.id_for_label }}" class="form-label">Teléfono <span class="text-danger">*</span></label>
                                {{ form.telefono }}
                                {% for error in form.telefono.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                                <small class="form-text text-muted">{{ form.telefono.help_text }}</small>
                            </div>

                            <!-- Email (Campo Común) -->
                            <div class="col-12">
                                <label for="{{ form.email.id_for_label }}" class="form-label">Email</label>
                                {{ form.email }}
                                {% for error in form.email.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- SECCIÓN 2: CAMPOS ESPECÍFICOS -->

                        <!-- ---------------------------------------------------- -->
                        <!-- CONTENEDOR DE CAMPOS DE EMPRESA -->
                        <!-- ---------------------------------------------------- -->
                        <div id="empresa_fields" style="display: none;">
                            <h4 class="mb-3 text-primary border-bottom pb-2">Datos de la Empresa</h4>
                            <div class="row g-3 mb-4">
                                <!-- Nombre Empresa (Razón Social) -->
                                <div class="col-md-7">
                                    <label for="{{ form.nombre_empresa.id_for_label }}" class="form-label">{{ form.nombre_empresa.label }} <span class="text-danger">*</span></label>
                                    {{ form.nombre_empresa }}
                                    {% for error in form.nombre_empresa.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <!-- RFC -->
                                <div class="col-md-5">
                                    <label for="{{ form.rfc.id_for_label }}" class="form-label">{{ form.rfc.label }} <span class="text-danger">*</span></label>
                                    {{ form.rfc }}
                                    {% for error in form.rfc.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <!-- Dirección Fiscal -->
                                <div class="col-12">
                                    <label for="{{ form.direccion_fiscal.id_for_label }}" class="form-label">{{ form.direccion_fiscal.label }} <span class="text-danger">*</span></label>
                                    {{ form.direccion_fiscal }}
                                    {% for error in form.direccion_fiscal.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>


                        <!-- ---------------------------------------------------- -->
                        <!-- CONTENEDOR DE CAMPOS DE PARTICULAR -->
                        <!-- ---------------------------------------------------- -->
                        <div id="particular_fields" style="display: none;">
                            <h4 class="mb-3 text-primary border-bottom pb-2">Datos Personales</h4>
                            <div class="row g-3 mb-4">
                                <!-- Nombre -->
                                <div class="col-md-6">
                                    <label for="{{ form.nombre.id_for_label }}" class="form-label">{{ form.nombre.label }} <span class="text-danger">*</span></label>
                                    {{ form.nombre }}
                                    {% for error in form.nombre.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <!-- Apellido -->
                                <div class="col-md-6">
                                    <label for="{{ form.apellido.id_for_label }}" class="form-label">{{ form.apellido.label }} <span class="text-danger">*</span></label>
                                    {{ form.apellido }}
                                    {% for error in form.apellido.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <!-- Fecha Nacimiento -->
                                <div class="col-md-6">
                                    <label for="{{ form.fecha_nacimiento.id_for_label }}" class="form-label">{{ form.fecha_nacimiento.label }}</label>
                                    {{ form.fecha_nacimiento }}
                                    {% for error in form.fecha_nacimiento.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <!-- Documento Identificación -->
                                <div class="col-md-6">
                                    <label for="{{ form.documento_identificacion.id_for_label }}" class="form-label">{{ form.documento_identificacion.label }}</label>
                                    {{ form.documento_identificacion }}
                                    {% for error in form.documento_identificacion.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                    <small class="form-text text-muted">{{ form.documento_identificacion.help_text }}</small>
                                </div>
                            </div>
                        </div>

                        <!-- SECCIÓN 3: CAMPOS ADICIONALES COMUNES -->
                        <h4 class="mb-3 text-primary border-bottom pb-2">Preferencias y Origen</h4>
                        
                        <div class="row g-3 mb-4">
                            <!-- Fuente de Contacto -->
                            <div class="col-md-6">
                                <label for="{{ form.fuente_contacto.id_for_label }}" class="form-label">{{ form.fuente_contacto.label }}</label>
                                {{ form.fuente_contacto }}
                                {% for error in form.fuente_contacto.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>

                            <!-- Notas -->
                            <div class="col-12">
                                <label for="{{ form.notas.id_for_label }}" class="form-label">{{ form.notas.label }}</label>
                                {{ form.notas }}
                                {% for error in form.notas.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>

                            <!-- Preferencias de Viaje -->
                            <div class="col-12">
                                <label for="{{ form.preferencias_viaje.id_for_label }}" class="form-label">{{ form.preferencias_viaje.label }}</label>
                                {{ form.preferencias_viaje }}
                                {% for error in form.preferencias_viaje.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                                <small class="form-text text-muted">{{ form.preferencias_viaje.help_text }}</small>
                            </div>
                        </div>


                        <!-- Botones -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'lista_clientes' %}" class="btn btn-outline-secondary rounded-pill px-4">
                                <i class="fas fa-arrow-left me-2"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-success rounded-pill px-4 shadow-sm">
                                <i class="fas fa-save me-2"></i> Guardar Cliente
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tipoClienteSelect = document.getElementById('id_tipo_cliente');
        const particularFields = document.getElementById('particular_fields');
        const empresaFields = document.getElementById('empresa_fields');

        function toggleFields() {
            const selectedValue = tipoClienteSelect.value;
            
            // Ocultar todos los campos específicos primero
            particularFields.style.display = 'none';
            empresaFields.style.display = 'none';

            // Mostrar el conjunto de campos correspondiente al tipo seleccionado
            if (selectedValue === 'PARTICULAR') {
                particularFields.style.display = 'block';
            } else if (selectedValue === 'EMPRESA') {
                empresaFields.style.display = 'block';
            }
        }

        // 1. Ejecutar al cargar la página (útil para edición o si hay errores de validación)
        toggleFields(); 
        
        // 2. Escuchar el cambio en el selector
        tipoClienteSelect.addEventListener('change', toggleFields);
    });
</script>

{% endblock content %}
