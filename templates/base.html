{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{% block title %}Movums The Travel Store{% endblock %}</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<link rel="stylesheet" href="{% static 'css/main.css' %}">

{# ----------------------------------------------------------- #}
{# CSS CRÍTICO: SOLO LAYOUTS. TODOS LOS COLORES FUERON MOVIDOS A main.css #}
{# ----------------------------------------------------------- #}
<style>
    /* Layout del Sidebar - fijo, visible siempre */
    #sidebar-wrapper {
        height: 100vh;
        width: 15rem;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 10;
        overflow-y: auto;
        background-color: #0d6efd;
    }
    
    #page-content-wrapper {
        margin-left: 15rem;
        width: calc(100% - 15rem);
        min-width: 0;
    }

    /* CORRECCIÓN DE LOGO: Centrado y escalado correcto (sin aplastar) */
    .sidebar-heading {
        border-color: rgba(255, 255, 255, 0.1) !important;
        padding: 1.5rem; 
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .logo-area {
        max-width: 100%; 
        padding: 0;
        margin: 0;
    }
    
    .logo-img {
        max-width: 100%;
        height: auto; 
        display: block;
    }
    
    /* Estilos de los ítems del menú */
    .list-group-item {
        color: rgba(255, 255, 255, .8) !important;
        background-color: transparent !important;
        border: none !important;
        padding: 1rem 1.5rem !important; 
        font-weight: 500;
    }

    /* Media query para desktop: Sidebar visible por defecto */
    @media (min-width: 768px) {
        #sidebar-wrapper {
            margin-left: 0;
        }
    }
    
    /* ============================================
       ANIMACIONES DE TRANSICIÓN ENTRE PÁGINAS
       ============================================ */
    
    /* Overlay de carga durante transiciones - oculto por defecto */
    .page-transition-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        z-index: -9999 !important; /* MUY bajo para que nunca bloquee modales */
        opacity: 0 !important;
        pointer-events: none !important;
        display: none !important;
        align-items: center;
        justify-content: center;
        transition: opacity 0.3s ease-in-out;
        visibility: hidden !important;
    }
    
    .page-transition-overlay.active {
        opacity: 1;
        pointer-events: all;
        visibility: visible;
        display: flex !important;
        z-index: 1030 !important; /* Más bajo que modal backdrop (1050) */
    }
    
    /* CRÍTICO: El overlay NUNCA debe estar activo cuando hay un modal - MÁXIMA PRIORIDAD */
    body.modal-open .page-transition-overlay.active,
    body.modal-open .page-transition-overlay,
    body.modal-open #pageTransitionOverlay,
    .modal.show ~ .page-transition-overlay,
    .modal.show ~ #pageTransitionOverlay,
    .modal.show .page-transition-overlay,
    .modal.show #pageTransitionOverlay,
    .modal.show + .page-transition-overlay,
    .modal.show + #pageTransitionOverlay,
    .modal.in ~ .page-transition-overlay,
    .modal.in ~ #pageTransitionOverlay,
    .modal.in .page-transition-overlay,
    .modal.in #pageTransitionOverlay,
    .modal[class*="show"] ~ .page-transition-overlay,
    .modal[class*="show"] ~ #pageTransitionOverlay {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
        pointer-events: none !important;
        z-index: -9999 !important;
        position: fixed !important;
    }
    
    /* REGLAS CONSOLIDADAS: El overlay NUNCA debe estar activo cuando hay un modal */
    
    /* Asegurar que los modales y su backdrop estén SIEMPRE por encima del overlay y navbar */
    .modal {
        z-index: 1060 !important;
    }
    
    .modal.show {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        pointer-events: auto !important;
        z-index: 1060 !important;
    }
    
    /* Asegurar que el contenido del modal sea interactivo */
    .modal.show .modal-dialog {
        pointer-events: auto !important;
        z-index: 1061 !important;
    }
    
    .modal.show .modal-content {
        pointer-events: auto !important;
        z-index: 1062 !important;
    }
    
    .modal-backdrop {
        z-index: 1055 !important;
        pointer-events: auto !important; /* Permitir clicks en backdrop para cerrar */
    }
    
    .modal-backdrop.show {
        z-index: 1055 !important;
    }
    
    /* FORZAR que el overlay se oculte cuando hay un modal abierto */
    body.modal-open .page-transition-overlay,
    body.modal-open #pageTransitionOverlay {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
        pointer-events: none !important;
        z-index: -9999 !important;
    }
    
    /* Asegurar que los inputs dentro del modal sean interactivos */
    .modal input,
    .modal select,
    .modal textarea,
    .modal button,
    .modal label,
    .modal .form-control,
    .modal .form-select {
        pointer-events: auto !important;
        position: relative;
    }
    
    /* Asegurar que el modal-body sea interactivo */
    .modal.show .modal-body {
        pointer-events: auto !important;
        position: relative !important;
    }
    
    /* Asegurar que el navbar no interfiera con modales */
    #main-navbar.sticky-top {
        z-index: 1020 !important; /* Bootstrap default, menor que modales */
    }
    
    /* Cuando hay un modal abierto, el navbar debe estar por debajo */
    body.modal-open #main-navbar {
        z-index: 1019 !important;
    }
    
    /* Asegurar que elementos sticky dentro del modal tengan z-index correcto */
    .modal .table-responsive thead.sticky-top,
    .modal .table thead[style*="sticky"] {
        z-index: 1063 !important;
        position: sticky !important;
    }
    
    /* Asegurar que toda la tabla dentro del modal sea interactiva */
    .modal .table-responsive,
    .modal .table,
    .modal .table tbody,
    .modal .table thead {
        pointer-events: auto !important;
        position: relative !important;
    }
    
    .modal.show .modal-content {
        pointer-events: auto !important;
        position: relative !important;
    }
    
    /* Asegurar que el modal en sí sea interactivo */
    .modal.show {
        pointer-events: auto !important;
    }
    
    /* Forzar que el overlay NUNCA bloquee modales - máxima prioridad */
    body.modal-open #pageTransitionOverlay,
    .modal.show ~ #pageTransitionOverlay,
    .modal.show #pageTransitionOverlay {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
        pointer-events: none !important;
        z-index: -1 !important;
    }
    
    /* Cuando hay un modal abierto, forzar que el overlay esté oculto */
    body.modal-open .page-transition-overlay,
    .modal.show ~ .page-transition-overlay,
    .modal.in ~ .page-transition-overlay {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
        pointer-events: none !important;
        z-index: -1 !important;
    }
    
    /* Asegurar que el overlay NUNCA bloquee modales - Z-INDEX MUY BAJO */
    .page-transition-overlay {
        z-index: -9999 !important; /* MUY bajo para que nunca bloquee nada */
    }
    
    /* Modales siempre por encima - z-index más alto que navbar sticky (1020) */
    .modal {
        z-index: 1060 !important;
    }
    
    .modal.show {
        z-index: 1060 !important;
    }
    
    .modal-backdrop {
        z-index: 1055 !important;
        pointer-events: auto !important; /* Permitir clicks en backdrop para cerrar */
    }
    
    /* CRÍTICO: Asegurar que el backdrop no bloquee el contenido del modal */
    .modal-backdrop.show {
        z-index: 1055 !important;
    }
    
    /* Asegurar que el modal-dialog esté por encima del backdrop */
    .modal-dialog {
        z-index: 1061 !important;
    }
    
    .modal.show .modal-dialog {
        z-index: 1061 !important;
    }
    
    /* Asegurar que el modal-content esté por encima del dialog */
    .modal-content {
        z-index: 1062 !important;
    }
    
    .modal.show .modal-content {
        z-index: 1062 !important;
    }
    
    /* El fondo del body se mantiene normal, solo el overlay cambia */
    
    /* Spinner de carga */
    .page-transition-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Ocultar contenido inicialmente y asegurar que esté detrás del overlay */
    #main-content {
        opacity: 0;
        position: relative;
        /* z-index removido para evitar conflictos de stacking context con modales */
        pointer-events: auto !important; /* Asegurar que siempre sea interactivo */
    }
    
    /* CRÍTICO: Cuando hay un modal abierto, asegurar que main-content no bloquee */
    body.modal-open #main-content {
        pointer-events: auto !important;
        opacity: 1 !important;
    }
    
    /* Contenedor principal con animación de entrada */
    #main-content.loaded {
        animation: fadeInUp 0.5s ease-out forwards;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(15px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Animación para cards y elementos que aparecen - solo después de que el contenido esté listo */
    #main-content.loaded .card,
    #main-content.loaded .table-responsive,
    #main-content.loaded .alert {
        animation: fadeInScale 0.4s ease-out;
        animation-fill-mode: both;
    }
    
    #main-content.loaded .card:nth-child(1) { animation-delay: 0.05s; }
    #main-content.loaded .card:nth-child(2) { animation-delay: 0.1s; }
    #main-content.loaded .card:nth-child(3) { animation-delay: 0.15s; }
    #main-content.loaded .card:nth-child(4) { animation-delay: 0.2s; }
    
    @keyframes fadeInScale {
        from {
            opacity: 0;
            transform: scale(0.98);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
    
    /* Las animaciones de botones ahora están en main.css para evitar conflictos */
    
    /* Animación para elementos de lista */
    .list-group-item {
        transition: all 0.3s ease;
    }
    
    .list-group-item:hover {
        transform: translateX(5px);
        background-color: rgba(255, 255, 255, 0.1) !important;
    }
    
    /* Animación de entrada para tablas - solo después de que el contenido esté listo */
    #main-content.loaded .table tbody tr {
        animation: slideInLeft 0.3s ease-out;
        animation-fill-mode: both;
    }
    
    #main-content.loaded .table tbody tr:nth-child(1) { animation-delay: 0.1s; }
    #main-content.loaded .table tbody tr:nth-child(2) { animation-delay: 0.12s; }
    #main-content.loaded .table tbody tr:nth-child(3) { animation-delay: 0.14s; }
    #main-content.loaded .table tbody tr:nth-child(4) { animation-delay: 0.16s; }
    #main-content.loaded .table tbody tr:nth-child(5) { animation-delay: 0.18s; }
    
    @keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    /* Animación para modales */
    .modal-content {
        animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Animación para dropdowns */
    .dropdown-menu {
        animation: dropdownFadeIn 0.2s ease-out;
    }
    
    @keyframes dropdownFadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Animación para badges y etiquetas */
    .badge {
        animation: badgePulse 0.5s ease-out;
    }
    
    @keyframes badgePulse {
        0% {
            transform: scale(0);
        }
        50% {
            transform: scale(1.2);
        }
        100% {
            transform: scale(1);
        }
    }
    
    /* Prevenir animaciones durante la carga inicial - EXCEPTO BOTONES */
    .no-animations * {
        animation: none !important;
        transition: none !important;
    }
    
    /* Los botones SIEMPRE deben tener animaciones, incluso durante la carga */
    .no-animations .btn,
    .no-animations button.btn,
    .no-animations a.btn,
    .no-animations input.btn,
    .no-animations [class*="btn"] {
        animation: auto !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
    
</style>

{# ============================================ #}
{# ESTILOS DE ANIMACIÓN PARA BOTONES - CARGADOS AL FINAL PARA MÁXIMA PRIORIDAD #}
{# ============================================ #}
<style>
    /* IMPORTANTE: Las animaciones de botones siempre deben funcionar, incluso con no-animations */
    .btn,
    button.btn,
    a.btn,
    input.btn[type="button"],
    input.btn[type="submit"],
    button[class*="btn"],
    a[class*="btn"],
    [class*="btn"] {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        position: relative !important;
        overflow: hidden !important;
        cursor: pointer !important;
        will-change: transform !important;
    }
    
    /* EFECTO HOVER - Muy visible y notorio */
    .btn:hover,
    button.btn:hover,
    a.btn:hover,
    input.btn:hover,
    button[class*="btn"]:hover,
    a[class*="btn"]:hover,
    [class*="btn"]:hover {
        transform: translateY(-5px) scale(1.08) !important;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25) !important;
        filter: brightness(1.15) !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
    
    /* EFECTO ACTIVE - Al hacer click */
    .btn:active,
    button.btn:active,
    a.btn:active,
    input.btn:active,
    button[class*="btn"]:active,
    a[class*="btn"]:active,
    [class*="btn"]:active {
        transform: translateY(-2px) scale(0.95) !important;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
        transition: all 0.1s ease !important;
        filter: brightness(0.85) !important;
    }
    
    /* Efecto de onda al hacer click */
    .btn::after,
    button.btn::after,
    a.btn::after {
        content: '' !important;
        position: absolute !important;
        top: 50% !important;
        left: 50% !important;
        width: 0 !important;
        height: 0 !important;
        border-radius: 50% !important;
        background: rgba(255, 255, 255, 0.5) !important;
        transform: translate(-50%, -50%) !important;
        transition: width 0.4s ease, height 0.4s ease, opacity 0.4s ease !important;
        opacity: 0 !important;
        pointer-events: none !important;
        z-index: 1 !important;
    }
    
    .btn:active::after,
    button.btn:active::after,
    a.btn:active::after {
        width: 400px !important;
        height: 400px !important;
        opacity: 0.8 !important;
        transition: width 0s ease, height 0s ease, opacity 0.2s ease !important;
    }
    
    /* Asegurar que el contenido del botón esté encima de la onda */
    .btn > *,
    button.btn > *,
    a.btn > * {
        position: relative !important;
        z-index: 2 !important;
    }
    
    /* FORZAR que las animaciones funcionen incluso con no-animations */
    .no-animations .btn,
    .no-animations button.btn,
    .no-animations a.btn {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }

/* ===== Usabilidad de dropdowns (Select2 u otros) ===== */
/* Limita altura de listas y evita que el scroll de la página se dispare al llegar al final */
.select2-container--default .select2-results > .select2-results__options {
    max-height: 260px;
    overflow-y: auto;
    pointer-events: auto;
}
.select2-results__option {
    pointer-events: auto;
}
</style>

{% block extra_head %}{% endblock %}


</head>
<body class="no-animations">

<div class="d-flex" id="wrapper">
    
    <div class="text-white border-end" id="sidebar-wrapper">
        <div class="sidebar-heading border-bottom">
            <div class="logo-area">
                <img src="{% static 'img/logo_mini.png' %}" alt="Logo Movums" class="logo-img">
            </div>
        </div>
        
        <div class="list-group list-group-flush">
            <a href="{% url 'dashboard' %}" class="list-group-item list-group-item-action text-white p-3"><i class="fas fa-chart-line fa-fw me-2"></i> Dashboard</a>
            
            {# Pre-calcular el rol en mayúsculas una sola vez para el sidebar #}
            {% with user.perfil.rol|default:""|upper as user_full_rol_upper %}
            
                {# ACCESO A CLIENTES: JEFE, VENDEDOR, CONTADOR #}
                {% if "JEFE" in user_full_rol_upper or "VENDEDOR" in user_full_rol_upper or "CONTADOR" in user_full_rol_upper %}
                    <a href="{% url 'lista_clientes' %}" class="list-group-item list-group-item-action text-white p-3"><i class="fas fa-users fa-fw me-2"></i> Clientes</a>
                {% endif %}
                
                {# ACCESO A VENTAS: Todos los roles #}
                <a href="{% url 'lista_ventas' %}" class="list-group-item list-group-item-action text-white p-3"><i class="fas fa-handshake fa-fw me-2"></i> Ventas</a>
                <a href="{% url 'cotizaciones_lista' %}" class="list-group-item list-group-item-action text-white p-3"><i class="fas fa-file-invoice-dollar fa-fw me-2"></i> Cotizaciones</a>

                {# ACCESO RESTRINGIDO: Logística, Proveedores y Gestión de Roles (Solo JEFE) #}
                {% if "JEFE" in user_full_rol_upper %}
                    <a href="{% url 'logistica_pendiente' %}" class="list-group-item list-group-item-action text-white p-3"><i class="fas fa-shipping-fast fa-fw me-2"></i> Logística Pendiente</a>
                    <a href="{% url 'proveedores' %}" class="list-group-item list-group-item-action text-white p-3"><i class="fas fa-handshake-angle fa-fw me-2"></i> Proveedores</a>
                    <a href="{% url 'gestion_roles' %}" class="list-group-item list-group-item-action text-white p-3"><i class="fas fa-users-cog fa-fw me-2"></i> Gestión de Roles</a>
                {% endif %}
                
                {# ACCESO A PAGOS POR CONFIRMAR: Solo CONTADOR #}
                {% if "CONTADOR" in user_full_rol_upper %}
                <a href="{% url 'pagos_por_confirmar' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-clock me-2"></i> Pagos por Confirmar
                </a>
                {% endif %}
                
                {# ACCESO A REPORTE FINANCIERO: JEFE, CONTADOR #}
                {% if "JEFE" in user_full_rol_upper or "CONTADOR" in user_full_rol_upper %}
                    <a href="{% url 'reporte_financiero' %}" class="list-group-item list-group-item-action text-white p-3"><i class="fas fa-file-invoice-dollar fa-fw me-2"></i> Reporte Financiero</a>
                    <a href="{% url 'kilometros_dashboard' %}" class="list-group-item list-group-item-action text-white p-3"><i class="fas fa-route fa-fw me-2"></i> Kilómetros Movums</a>
                {% endif %}
                
                {# ACCESO A COMISIONES: Todos (JEFE, CONTADOR, VENDEDOR) #}
                {% if "JEFE" in user_full_rol_upper or "CONTADOR" in user_full_rol_upper or "VENDEDOR" in user_full_rol_upper %}
                    <a href="{% url 'reporte_comisiones' %}" class="list-group-item list-group-item-action text-white p-3"><i class="fas fa-calculator fa-fw me-2"></i> Reporte de Comisiones</a>
                {% endif %}
                
                {% if user.is_superuser %}
                    <a href="{% url 'admin:index' %}" class="list-group-item list-group-item-action text-white p-3"><i class="fas fa-cog fa-fw me-2"></i> Admin</a>
                {% endif %}

            {% endwith %}

        </div>
    </div>
    
    {# El div principal de contenido. #}
    <div id="page-content-wrapper"> 
        
        {# NAV BAR #}
        <nav class="navbar navbar-expand-lg navbar-dark border-bottom sticky-top" id="main-navbar">
            <div class="container-fluid">
                <ul class="navbar-nav ms-auto mt-2 mt-lg-0">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-user-circle me-1"></i> Bienvenido, {{ user.get_username|default:"Invitado" }} ({{ user.perfil.rol|default:"INV" }})
                        </a>
                        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="#">Mi Perfil</a>
                            <div class="dropdown-divider"></div>
                            
                            <form method="post" action="{% url 'logout' %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="dropdown-item">
                                    Cerrar Sesión
                                </button>
                            </form>
                        </div>
                    </li>
                </ul>
            </div>
        </nav>
        
        <div class="container-fluid py-4" id="main-content" style="opacity: 0; pointer-events: auto !important;">
            {# Área de Mensajes (Flash Messages) - NO mostrar aquí si el bloque content también los muestra #}
            {# Los mensajes se mostrarán en el bloque content de cada template para evitar duplicados #}
            
            {# ESTE ES EL BLOQUE QUE CARGA EL CONTENIDO DEL DASHBOARD #}
            {% block content %}{% endblock %}
        </div>
    </div>
    
</div>

<!-- Overlay de transición de página - MOVIDO AL FINAL Y CON Z-INDEX NEGATIVO -->
<div class="page-transition-overlay" id="pageTransitionOverlay" style="display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; z-index: -9999 !important; position: fixed !important;">
    <div class="page-transition-spinner"></div>
</div>

{% block modals %}{% endblock %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ============================================
    // SISTEMA DE ANIMACIONES DE TRANSICIÓN
    // ============================================
    
    // Variable para controlar si estamos en transición
    let isTransitioning = false;
    
    // Función para verificar si un elemento es un botón de modal
    function isModalButton(element) {
        if (!element) return false;
        const target = element.closest('button, a, [role="button"]');
        if (!target) return false;
        return target.hasAttribute('data-bs-toggle') && target.getAttribute('data-bs-toggle') === 'modal' ||
               target.hasAttribute('data-bs-target') && target.getAttribute('data-bs-target').startsWith('#');
                }
    
    // Función para verificar si hay un modal abierto
    function hasOpenModal() {
        return document.body.classList.contains('modal-open') || 
                document.querySelector('.modal.show') ||
               document.querySelector('.modal.in') ||
               document.querySelector('.modal[class*="show"]');
            }
    
    // Sidebar fijo: se mantiene siempre visible, sin toggle

    // Evitar que el scroll de listas (ej. Select2) arrastre la página
    (function() {
        function handleListWheel(e) {
            let list = null;
            if (e.target && e.target.closest) {
                const option = e.target.closest('.select2-results__option');
                if (option && option.parentElement && option.parentElement.classList.contains('select2-results__options')) {
                    list = option.parentElement;
                } else {
                    list = e.target.closest('.select2-results__options');
                }
            }
            if (!list) return;
            const deltaY = e.deltaY || -e.wheelDelta || e.detail || 0;
            e.preventDefault();
            e.stopPropagation();
            list.scrollTop = Math.min(
                list.scrollHeight - list.clientHeight,
                Math.max(0, list.scrollTop + deltaY)
            );
        }
        ['wheel', 'mousewheel', 'DOMMouseScroll'].forEach(evt => {
            document.addEventListener(evt, handleListWheel, { passive: false, capture: true });
        });
    })();
    
    // Función para mostrar overlay de transición
    function showPageTransition() {
        // DESACTIVAR COMPLETAMENTE si hay un modal abierto, abriéndose, o si _modalIsOpening está activo
        if (hasOpenModal() || document.body.classList.contains('modal-open') || window._modalIsOpening) {
            forceHideOverlay();
            return;
        }
        
        // NO activar si ya estamos en transición
        if (isTransitioning) return;
        
        isTransitioning = true;
        const overlay = document.getElementById('pageTransitionOverlay');
        const mainContent = document.getElementById('main-content');
        
        if (overlay) {
            // Verificar nuevamente antes de mostrar (por si cambió el estado)
            if (hasOpenModal() || document.body.classList.contains('modal-open') || window._modalIsOpening) {
                forceHideOverlay();
                return;
            }
            
            // Ocultar contenido antes de mostrar overlay
            if (mainContent) {
                mainContent.classList.remove('loaded');
                mainContent.style.opacity = '0';
            }
            // CRÍTICO: Verificar UNA VEZ MÁS antes de activar el overlay
            // NO activar si hay modal, se está abriendo, o si _modalIsOpening está activo
            if (hasOpenModal() || document.body.classList.contains('modal-open') || window._modalIsOpening) {
                forceHideOverlay();
                isTransitioning = false;
                return;
            }
            
            // Solo mostrar overlay si TODAS las condiciones están bien
            overlay.style.zIndex = '1030';
            overlay.classList.add('active');
        }
    }
    
    // Función para ocultar overlay de transición y mostrar contenido
    function hidePageTransition() {
        const overlay = document.getElementById('pageTransitionOverlay');
        const mainContent = document.getElementById('main-content');
        
        if (!overlay || !mainContent) {
            // Si no existen aún, intentar de nuevo en un momento
            setTimeout(hidePageTransition, 50);
            return;
        }
        
        // Asegurar que el overlay esté oculto
        overlay.classList.remove('active');
        
        // Esperar un momento para que el overlay se oculte
        setTimeout(() => {
            // Remover clase de no-animaciones
            document.body.classList.remove('no-animations');
            
            // Activar animaciones del contenido
            mainContent.classList.add('loaded');
            
            isTransitioning = false;
        }, 200); // Pequeño delay para que el overlay se oculte primero
    }
    
    // SOLUCIÓN #3: Función simplificada para ocultar overlay
    function forceHideOverlay() {
        const overlay = document.getElementById('pageTransitionOverlay');
        if (overlay) {
            overlay.classList.remove('active');
            // Z-index MUY bajo para asegurar que nunca bloquee
            overlay.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; z-index: -9999 !important;';
        }
        const mainContent = document.getElementById('main-content');
        if (mainContent) {
            mainContent.style.opacity = '1';
            mainContent.classList.add('loaded');
        }
        if (document.body) {
            document.body.classList.remove('no-animations');
        }
        isTransitioning = false;
    }
    
    // SOLUCIÓN MEJORADA: Listeners de modal - FORZAR ocultamiento del overlay
    document.addEventListener('show.bs.modal', function(event) {
        isTransitioning = false;
        window._modalIsOpening = true;
        
        // FORZAR ocultamiento del overlay de todas las formas posibles
        const overlay = document.getElementById('pageTransitionOverlay');
        if (overlay) {
            overlay.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; z-index: -9999 !important; position: fixed !important;';
            overlay.classList.remove('active');
            // Remover del DOM completamente
            try {
                overlay.remove();
            } catch(e) {
                // Si falla, forzar ocultamiento
                overlay.style.display = 'none';
            }
        }
        
        // También buscar por clase
        const overlaysByClass = document.querySelectorAll('.page-transition-overlay');
        overlaysByClass.forEach(function(ov) {
            ov.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; z-index: -9999 !important;';
            ov.classList.remove('active');
            try {
                ov.remove();
            } catch(e) {
                ov.style.display = 'none';
            }
        });
        
    }, false);
    
    document.addEventListener('shown.bs.modal', function(event) {
        // Asegurar que el overlay esté completamente oculto
        const overlay = document.getElementById('pageTransitionOverlay');
        if (overlay) {
            overlay.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; z-index: -9999 !important;';
            overlay.classList.remove('active');
            try {
                overlay.remove();
            } catch(e) {
                overlay.style.display = 'none';
            }
        }
        
        // También buscar por clase
        const overlaysByClass = document.querySelectorAll('.page-transition-overlay');
        overlaysByClass.forEach(function(ov) {
            ov.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; z-index: -9999 !important;';
            ov.classList.remove('active');
            try {
                ov.remove();
            } catch(e) {
                ov.style.display = 'none';
            }
        });
        
        // Reactivar transición después de 2 segundos
        setTimeout(function() {
            window._modalIsOpening = false;
        }, 2000);
    }, false);
    
    document.addEventListener('hide.bs.modal', function(event) {
        // Restaurar el overlay cuando se cierra el modal (solo si no existe)
        const overlay = document.getElementById('pageTransitionOverlay');
        if (!overlay) {
            const newOverlay = document.createElement('div');
            newOverlay.id = 'pageTransitionOverlay';
            newOverlay.className = 'page-transition-overlay';
            newOverlay.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; z-index: -9999 !important; position: fixed !important;';
            const spinner = document.createElement('div');
            spinner.className = 'page-transition-spinner';
            newOverlay.appendChild(spinner);
            document.body.appendChild(newOverlay);
        }
        window._modalIsOpening = false;
    }, false);
    
    // SOLUCIÓN #3: MutationObserver SIMPLIFICADO - solo ocultar overlay cuando hay modal
    if (document.body) {
        const bodyObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (document.body.classList.contains('modal-open')) {
                        // Solo ocultar overlay, no hacer nada más
                        const overlay = document.getElementById('pageTransitionOverlay');
                        if (overlay) {
                            overlay.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; z-index: -9999 !important;';
                            overlay.classList.remove('active');
                        }
                        isTransitioning = false;
                    }
                }
            });
        });
        
        bodyObserver.observe(document.body, {
            attributes: true,
            attributeFilter: ['class']
        });
    }
    
    // Ocultar overlay inmediatamente (antes de DOMContentLoaded)
    (function() {
        const overlay = document.getElementById('pageTransitionOverlay');
        if (overlay) {
            overlay.style.display = 'none';
            overlay.style.opacity = '0';
            overlay.style.visibility = 'hidden';
            overlay.classList.remove('active');
        }
    })();
    
    // Inicializar página
    document.addEventListener('DOMContentLoaded', function() {
        // Forzar ocultamiento del overlay
        forceHideOverlay();
        
        // Manejar el botón de retroceso del navegador (popstate)
        window.addEventListener('popstate', function(event) {
            // Asegurar que cualquier modal abierto se cierre al retroceder
            const openModals = document.querySelectorAll('.modal.show, .modal.in');
            openModals.forEach(modal => {
                const modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) {
                    modalInstance.hide();
                }
            });
            setTimeout(forceHideOverlay, 10);
        });
        
        // También manejar el evento pageshow (se dispara cuando se carga desde cache o se navega hacia atrás)
        window.addEventListener('pageshow', function(event) {
            // Cerrar cualquier modal que pueda estar abierto
            const openModals = document.querySelectorAll('.modal.show, .modal.in');
            openModals.forEach(modal => {
                const modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) {
                    modalInstance.hide();
                }
            });
            // Siempre ocultar el overlay cuando se muestra la página
            forceHideOverlay();
        });
        
        // Ocultar overlay cuando la página esté completamente cargada
        if (document.readyState === 'complete') {
            forceHideOverlay();
        } else {
            window.addEventListener('load', function() {
                forceHideOverlay();
            }, { once: true });
        }
        
        // Respaldo: Forzar ocultamiento después de un delay para asegurar que siempre se oculte
        setTimeout(function() {
            forceHideOverlay();
        }, 200);
        
        // Configurar enlaces para interceptar navegación (solo enlaces internos)
        // SIN setTimeout - ejecutar inmediatamente
            const links = document.querySelectorAll('a[href]');
            
            links.forEach(link => {
                const href = link.getAttribute('href');
                
                if (!href) return;
                
                // Excluir enlaces especiales y externos, modales, y elementos interactivos
                // CRÍTICO: Excluir también botones que abren modales
                const isModalButton = (link.hasAttribute('data-bs-toggle') && link.getAttribute('data-bs-toggle') === 'modal') ||
                                     (link.hasAttribute('data-bs-target') && link.getAttribute('data-bs-target') && link.getAttribute('data-bs-target').startsWith('#'));
                
                if (href.startsWith('http://') || href.startsWith('https://') || 
                    href.startsWith('mailto:') || href.startsWith('tel:') ||
                    link.getAttribute('target') === '_blank' ||
                    href.startsWith('#') ||
                    isModalButton ||
                    link.hasAttribute('data-toggle') ||
                    link.hasAttribute('data-target') ||
                    link.closest('.modal') || // Si está dentro de un modal
                    link.querySelector('form') ||
                    link.closest('form')) { // Si está dentro de un formulario
                    // Si es un botón de modal, asegurar que el overlay esté oculto
                    if (isModalButton) {
                        link.addEventListener('click', function(e) {
                            forceHideOverlay();
                            isTransitioning = false;
                            window._modalIsOpening = true;
                        }, true); // Capture phase para ejecutar ANTES
                    }
                    return;
                }
                
                // Solo interceptar enlaces internos que realmente navegan
                if (href.startsWith('/') || href.startsWith('./') || (!href.includes('://') && !href.startsWith('#'))) {
                    link.addEventListener('click', function(e) {
                        // NO interceptar si es un modal o tiene atributos especiales
                        if (this.getAttribute('onclick') && this.getAttribute('onclick').includes('window.location')) {
                            return;
                        }
                        // NO interceptar si está relacionado con Bootstrap modals - VERIFICACIÓN MEJORADA
                        const isModalLink = (this.hasAttribute('data-bs-toggle') && this.getAttribute('data-bs-toggle') === 'modal') ||
                                           (this.hasAttribute('data-bs-target') && this.getAttribute('data-bs-target') && this.getAttribute('data-bs-target').startsWith('#')) ||
                                           this.closest('.modal') ||
                                           this.closest('[data-bs-toggle="modal"]');
                        
                        if (isModalLink) {
                            // FORZAR ocultamiento del overlay
                            forceHideOverlay();
                            isTransitioning = false;
                            window._modalIsOpening = true;
                            return;
                        }
                        // Verificar nuevamente antes de mostrar transición
                        // NO mostrar transición si hay un modal o se está abriendo
                        if (!document.body.classList.contains('modal-open') && 
                            !document.querySelector('.modal.show') &&
                            !document.querySelector('.modal.in') &&
                            !window._modalIsOpening) {
                            const url = this.getAttribute('href') || '';
                            const isDownload = /\.(docx|pdf|xlsx?|pptx?|zip)$/i.test(url);
                            const skipTransition = this.getAttribute('data-no-transition') === 'true';
                            if (isDownload || skipTransition) {
                                forceHideOverlay();
                            } else {
                                showPageTransition();
                            }
                        } else {
                            // Si hay un modal, asegurar que el overlay esté oculto
                            forceHideOverlay();
                            isTransitioning = false;
                        }
                    }, false); // Bubble phase
                }
            });
            
        // SOLUCIÓN CRÍTICA: Listener global en CAPTURE phase - ejecutar ANTES de cualquier otra cosa
        // Este listener se ejecuta PRIMERO para detectar clicks en botones de modal y ocultar el overlay
        document.addEventListener('click', function(e) {
            // Buscar el botón de modal - buscar en el target y todos sus padres
            let element = e.target;
            let isModalTrigger = false;
            
            // Buscar hasta encontrar un elemento con data-bs-toggle="modal" o data-bs-target que empiece con #
            for (let i = 0; i < 10 && element && element !== document; i++) {
                if (element.nodeType === 1) { // Element node
                    // Verificar si tiene data-bs-toggle="modal"
                    if (element.hasAttribute('data-bs-toggle') && element.getAttribute('data-bs-toggle') === 'modal') {
                        isModalTrigger = true;
                        break;
                    }
                    // Verificar si tiene data-bs-target que empiece con #
                    const dataTarget = element.getAttribute('data-bs-target');
                    if (dataTarget && dataTarget.startsWith('#')) {
                        isModalTrigger = true;
                        break;
                    }
                }
                element = element.parentElement;
            }
            
            if (isModalTrigger) {
                // FORZAR ocultamiento del overlay INMEDIATAMENTE - ANTES de cualquier otra cosa
                isTransitioning = false;
                window._modalIsOpening = true;
                
                // Función para ocultar overlay completamente
                function forceHide() {
                    const overlay = document.getElementById('pageTransitionOverlay');
                    if (overlay) {
                        overlay.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; z-index: -9999 !important; position: fixed !important;';
                        overlay.classList.remove('active');
                        try {
                            overlay.remove();
                        } catch(err) {
                            overlay.style.display = 'none';
                        }
                    }
                    document.querySelectorAll('.page-transition-overlay').forEach(function(ov) {
                        ov.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; z-index: -9999 !important;';
                        ov.classList.remove('active');
                        try {
                            ov.remove();
                        } catch(err) {
                            ov.style.display = 'none';
                        }
                    });
                }
                
                // Ejecutar inmediatamente y varias veces para asegurar
                forceHide();
                setTimeout(forceHide, 0);
                setTimeout(forceHide, 10);
                setTimeout(forceHide, 50);
                
                // NO prevenir el evento - dejar que Bootstrap lo maneje normalmente
            }
        }, true); // CAPTURE phase - se ejecuta ANTES que cualquier otro listener (incluyendo Bootstrap)
        
        // ADICIONAL: Listener específico para eventos de modal de Bootstrap
        document.addEventListener('show.bs.modal', function(e) {
            // Cuando Bootstrap detecta que se va a abrir un modal, ocultar overlay inmediatamente
            isTransitioning = false;
            window._modalIsOpening = true;
            const overlay = document.getElementById('pageTransitionOverlay');
            if (overlay) {
                overlay.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; z-index: -9999 !important; position: fixed !important;';
                overlay.classList.remove('active');
                try {
                    overlay.remove();
                } catch(err) {
                    overlay.style.display = 'none';
                }
            }
            document.querySelectorAll('.page-transition-overlay').forEach(function(ov) {
                ov.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; z-index: -9999 !important;';
                ov.classList.remove('active');
                try {
                    ov.remove();
                } catch(err) {
                    ov.style.display = 'none';
                }
            });
        }, false);
        
        document.addEventListener('shown.bs.modal', function(e) {
            // Asegurar que el overlay esté oculto cuando el modal ya está visible
            const overlay = document.getElementById('pageTransitionOverlay');
            if (overlay) {
                overlay.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; z-index: -9999 !important; position: fixed !important;';
                overlay.classList.remove('active');
                try {
                    overlay.remove();
                } catch(err) {
                    overlay.style.display = 'none';
                }
            }
            document.querySelectorAll('.page-transition-overlay').forEach(function(ov) {
                ov.style.cssText = 'display: none !important; opacity: 0 !important; visibility: hidden !important; pointer-events: none !important; z-index: -9999 !important;';
                ov.classList.remove('active');
                try {
                    ov.remove();
                } catch(err) {
                    ov.style.display = 'none';
                }
            });
        }, false);
    });
    
    // Animación suave para scroll
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            const href = this.getAttribute('href');
            if (href !== '#' && href.length > 1) {
                e.preventDefault();
                const target = document.querySelector(href);
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            }
        });
    });
    
    // Animación para elementos que aparecen al hacer scroll (Intersection Observer)
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
                observer.unobserve(entry.target);
            }
        });
    }, observerOptions);
    
    // Observar elementos con clase 'animate-on-scroll'
    document.querySelectorAll('.animate-on-scroll').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
        el.style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
        observer.observe(el);
    });
    
    // Limpiar cualquier estructura residual del efecto hover interactivo
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.btn-interactive-hover, .btn[data-interactive-setup="true"]').forEach(function(btn) {
            // Buscar el contenido original en el wrapper
            const textEl = btn.querySelector('.btn-text');
            if (textEl) {
                const originalContent = textEl.innerHTML;
                btn.innerHTML = originalContent;
            }
            btn.classList.remove('btn-interactive-hover');
            btn.removeAttribute('data-interactive-setup');
        });
    });
</script>

{% block extra_js %}{% endblock %}


</body>
</html>