#!/usr/bin/expect -f
set timeout 60
set server "tellez@206.189.223.176"
set password "[REDACTED_PASSWORD]"

puts "ğŸš€ Iniciando despliegue al servidor DigitalOcean..."
puts "ğŸ“… Fecha: [exec date]"
puts ""

# Conectar
spawn ssh -o StrictHostKeyChecking=no $server

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "Password:" {
        send "$password\r"
        exp_continue
    }
    "Are you sure you want to continue connecting" {
        send "yes\r"
        exp_continue
    }
    "$ " {
        puts "âœ… ConexiÃ³n establecida"
    }
    "# " {
        puts "âœ… ConexiÃ³n establecida"
    }
    timeout {
        puts "âŒ Timeout al conectar"
        exit 1
    }
    eof {
        puts "âŒ Error de conexiÃ³n"
        exit 1
    }
}

# Encontrar proyecto
puts "\nğŸ“‹ Buscando directorio del proyecto..."
send "find ~ -name 'agencia-web-project' -type d 2>/dev/null | head -1\r"
expect {
    -re "(.*agencia-web-project.*)" {
        set project_dir $expect_out(1,string)
        set project_dir [string trim $project_dir]
        puts "âœ… Proyecto encontrado: $project_dir"
    }
    "$ " {
        send "find /var/www -name 'agencia-web-project' -type d 2>/dev/null | head -1\r"
        expect {
            -re "(.*agencia-web-project.*)" {
                set project_dir $expect_out(1,string)
                set project_dir [string trim $project_dir]
                puts "âœ… Proyecto encontrado: $project_dir"
            }
            "$ " {
                send "find /home -name 'agencia-web-project' -type d 2>/dev/null | head -1\r"
                expect {
                    -re "(.*agencia-web-project.*)" {
                        set project_dir $expect_out(1,string)
                        set project_dir [string trim $project_dir]
                        puts "âœ… Proyecto encontrado: $project_dir"
                    }
                    "$ " {
                        set project_dir "~/agencia-web-project"
                        puts "âš ï¸  Usando directorio por defecto: $project_dir"
                    }
                }
            }
        }
    }
}

# Ir al directorio
send "cd $project_dir\r"
expect "$ "

# Backup
puts "\nğŸ“‹ Haciendo backup de la base de datos..."
send "if [ -f db.sqlite3 ]; then cp db.sqlite3 db.sqlite3.backup_\$(date +%Y%m%d_%H%M%S) && echo 'âœ… Backup de BD creado'; elif command -v pg_dump >/dev/null 2>&1; then pg_dump nombre_db > backup_db_\$(date +%Y%m%d_%H%M%S).sql && echo 'âœ… Backup PostgreSQL creado'; elif command -v mysqldump >/dev/null 2>&1; then mysqldump -u usuario nombre_db > backup_db_\$(date +%Y%m%d_%H%M%S).sql && echo 'âœ… Backup MySQL creado'; else echo 'âš ï¸  No se encontrÃ³ base de datos para backup'; fi\r"
expect "$ "

# Verificar rama
puts "\nğŸ“‹ Verificando rama actual..."
send "git branch\r"
expect "$ "

# Pull
puts "\nğŸ“‹ Haciendo pull de los cambios..."
send "git pull origin master\r"
expect {
    "Already up to date" {
        puts "âœ… Ya estÃ¡ actualizado"
        expect "$ "
    }
    -re ".*files? changed" {
        puts "âœ… Cambios descargados"
        expect "$ "
    }
    "error:" {
        puts "âŒ Error en pull"
        expect "$ "
        send "exit\r"
        expect eof
        exit 1
    }
    "$ " {
        puts "âœ… Pull completado"
    }
    timeout {
        puts "âš ï¸  Timeout en pull, continuando..."
    }
}

# Activar venv
puts "\nğŸ“‹ Activando entorno virtual..."
send "if [ -d venv ]; then source venv/bin/activate && echo 'âœ… Venv activado'; elif [ -d env ]; then source env/bin/activate && echo 'âœ… Env activado'; else echo 'âš ï¸  No se encontrÃ³ entorno virtual'; fi\r"
expect "$ "

# Dependencias
puts "\nğŸ“‹ Instalando dependencias..."
send "if [ -f requirements.txt ]; then pip install -q -r requirements.txt && echo 'âœ… Dependencias instaladas'; else echo 'âš ï¸  No se encontrÃ³ requirements.txt'; fi\r"
expect "$ "

# Migraciones
puts "\nğŸ“‹ Aplicando migraciones..."
send "python manage.py migrate --noinput\r"
expect {
    -re "Applying.*" {
        puts "âœ… Migraciones aplicadas"
        expect "$ "
    }
    "No migrations to apply" {
        puts "âœ… No hay migraciones pendientes"
        expect "$ "
    }
    "error:" {
        puts "âŒ Error en migraciones"
        expect "$ "
    }
    "$ " {
        puts "âœ… Migraciones completadas"
    }
    timeout {
        puts "âš ï¸  Timeout en migraciones"
    }
}

# Collectstatic
puts "\nğŸ“‹ Recolectando archivos estÃ¡ticos..."
send "python manage.py collectstatic --noinput\r"
expect "$ "

# Reiniciar servicio
puts "\nğŸ“‹ Reiniciando servicio..."
send "sudo systemctl restart gunicorn 2>/dev/null || sudo systemctl restart agencia-web 2>/dev/null || sudo supervisorctl restart agencia-web 2>/dev/null || (pkill -HUP gunicorn && echo 'âœ… Gunicorn reiniciado') || echo 'âš ï¸  No se pudo reiniciar automÃ¡ticamente'\r"
expect {
    "password" {
        send "$password\r"
        expect "$ "
    }
    "$ " {
        puts "âœ… Servicio reiniciado"
    }
}

# Verificar
puts "\nğŸ“‹ Verificando servicio..."
send "sleep 3 && curl -s -o /dev/null -w '%{http_code}' http://localhost:8000 && echo ''\r"
expect "$ "

puts "\nâœ… Despliegue completado!"
puts ""
puts "ğŸ“ PrÃ³ximos pasos:"
puts "   1. Verificar que la aplicaciÃ³n funciona"
puts "   2. Probar las nuevas funcionalidades"
puts "   3. Revisar logs si hay problemas: sudo journalctl -u gunicorn -n 50"

send "exit\r"
expect eof

