#!/usr/bin/expect -f
set timeout 30
set server "tellez@206.189.223.176"
set password "[REDACTED_SSH_PASSWORD]"

# Leer la clave pÃºblica
set f [open "$env(HOME)/.ssh/id_ed25519.pub"]
set public_key [read $f]
close $f
set public_key [string trim $public_key]

puts "ğŸ“¤ Copiando clave SSH al servidor..."

spawn ssh-copy-id -o StrictHostKeyChecking=no $server

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "Password:" {
        send "$password\r"
        exp_continue
    }
    "Are you sure you want to continue connecting" {
        send "yes\r"
        exp_continue
    }
    "Number of key(s) added:" {
        puts "âœ… Clave copiada exitosamente"
        expect eof
        exit 0
    }
    "already installed" {
        puts "âœ… La clave ya estaba instalada"
        expect eof
        exit 0
    }
    "Permission denied" {
        puts "âŒ Permiso denegado. El servidor no acepta autenticaciÃ³n por contraseÃ±a."
        puts ""
        puts "ğŸ“‹ Copia manualmente la clave pÃºblica:"
        puts "$public_key"
        puts ""
        puts "O ejecuta en el servidor:"
        puts "echo '$public_key' >> ~/.ssh/authorized_keys"
        exit 1
    }
    timeout {
        puts "âŒ Timeout"
        exit 1
    }
    eof {
        puts "âœ… Proceso completado"
    }
}

